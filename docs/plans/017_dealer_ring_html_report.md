# Plan 017: Dealer Ring HTML Report Generator

## Overview

Create an HTML report generator for the dealer ring simulation that produces clean, readable output matching the style of the Kalecki ring reports. The report will show day-by-day simulation state including dealer/VBT states, events, and trader balance sheets.

## Goals

1. Generate self-contained HTML reports for dealer ring simulations
2. Match the modern, readable style of existing Kalecki ring reports
3. Display all relevant simulation data: dealers, VBTs, events, traders
4. Support both programmatic generation and CLI usage
5. Reuse existing CSS assets for consistent styling

## Data to Display

### Header Section
- Simulation title (configurable)
- Configuration summary: S (ticket size), bucket config, VBT anchors
- Meta info: total days, total events, number of traders/tickets

### Per-Day Sections

Each day section will contain:

#### 1. Events Table
Display all events from `EventLog` for that day:
- **trade**: side, trader_id, ticket_id, bucket, price, is_passthrough
- **rebucket**: ticket_id, old_bucket, new_bucket, price, holder_type
- **settlement**: issuer_id, total_paid, n_tickets, recovery_rate
- **default**: issuer_id, recovery_rate, total_due, total_paid, n_tickets, bucket
- **quote**: bucket, dealer_bid, dealer_ask, vbt_bid, vbt_ask, inventory
- **vbt_anchor_update**: bucket, M_old, M_new, O_old, O_new, loss_rate

#### 2. Dealer States (per bucket)
Display kernel parameters for each dealer:
- Inventory (a), Face inventory (x), Cash (C)
- Mid-valued inventory (V), Capacity (K*, X*)
- Layoff probability (Î»), Inside width (I)
- Midline p(x), Bid b(x), Ask a(x)
- Pin flags (is_pinned_bid, is_pinned_ask)

#### 3. VBT States (per bucket)
Display VBT anchors and quotes:
- Mid anchor (M), Spread anchor (O)
- Outside quotes: Ask (A), Bid (B)

#### 4. Trader Balance Sheets
For each trader, show T-account style:
- **Assets**: Cash + Tickets owned (with issuer, face, maturity)
- **Liabilities**: Tickets issued (with owner, face, maturity)

### Summary Section
- Total events by type
- Final dealer states
- Convergence status

## Implementation Plan

### Step 1: Create `src/bilancio/dealer/report.py`

New module with the following functions:

```python
def generate_dealer_ring_html(
    sim: DealerRingSimulation,
    title: str | None = None,
    subtitle: str | None = None,
) -> str:
    """Generate complete HTML report from simulation state."""

def export_dealer_ring_html(
    sim: DealerRingSimulation,
    path: Path | str,
    title: str | None = None,
    subtitle: str | None = None,
) -> None:
    """Export simulation to HTML file."""
```

### Step 2: HTML Structure

```
<!DOCTYPE html>
<html>
<head>
  <title>{title}</title>
  <style>{CSS from export.css + dealer-specific extensions}</style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Dealer Ring Simulation</h1>
      <h2>{subtitle}</h2>
      <p class="description">{config summary}</p>
      <div class="meta">
        <span>Days: {n}</span>
        <span>Events: {n}</span>
        <span>Traders: {n}</span>
        <span>Tickets: {n}</span>
      </div>
    </header>

    <main>
      <!-- Day 0 (Setup) -->
      <section class="day-section">
        <h2 class="day-header">ðŸ“… Day 0 (Setup)</h2>
        {initial states}
      </section>

      <!-- Day 1..N -->
      <section class="day-section">
        <h2 class="day-header">ðŸ“… Day {n}</h2>
        <div class="events-section">{events table}</div>
        <div class="dealers-section">{dealer states}</div>
        <div class="vbts-section">{VBT states}</div>
        <div class="balances-section">{trader balances}</div>
      </section>
    </main>

    <footer>Generated by Bilancio</footer>
  </div>
</body>
</html>
```

### Step 3: Helper Functions

```python
def _load_css() -> str:
    """Load base CSS from assets/export.css."""

def _render_header(sim: DealerRingSimulation, title: str, subtitle: str) -> str:
    """Render header section with config summary."""

def _render_events_table(events: list[dict], title: str) -> str:
    """Render events table for a day."""

def _render_dealer_state(dealer: DealerState, vbt: VBTState) -> str:
    """Render dealer state card with kernel parameters."""

def _render_vbt_state(vbt: VBTState) -> str:
    """Render VBT state card."""

def _render_trader_balance(trader: TraderState, tickets: dict[str, Ticket]) -> str:
    """Render trader T-account balance sheet."""

def _render_day_section(
    day: int,
    events: list[dict],
    dealers: dict[str, DealerState],
    vbts: dict[str, VBTState],
    traders: dict[str, TraderState],
    tickets: dict[str, Ticket],
) -> str:
    """Render complete day section."""

def _fmt_decimal(d: Decimal, precision: int = 4) -> str:
    """Format Decimal for display, trimming trailing zeros."""

def _html_escape(value: Any) -> str:
    """Escape text for safe HTML display."""
```

### Step 4: Dealer State Card Design

New CSS class `.dealer-card` for displaying kernel state:

```html
<section class="dealer-card">
  <h3>Long Dealer (bucket=long)</h3>
  <div class="kernel-params">
    <table class="params-table">
      <tr><th>Inventory (a)</th><td>2</td></tr>
      <tr><th>Face (x)</th><td>2</td></tr>
      <tr><th>Cash (C)</th><td>0.05</td></tr>
      <tr><th>Mid-valued (V)</th><td>2.05</td></tr>
      <tr><th>Capacity (K*)</th><td>2</td></tr>
      <tr><th>X*</th><td>2</td></tr>
      <tr><th>Î»</th><td>0.333</td></tr>
      <tr><th>Inside (I)</th><td>0.10</td></tr>
      <tr><th>Midline p(x)</th><td>0.925</td></tr>
      <tr><th>Bid</th><td>0.875</td></tr>
      <tr><th>Ask</th><td>0.975</td></tr>
    </table>
  </div>
  <div class="inventory-list">
    <h4>Inventory</h4>
    <ul>
      <li>T_star (issuer: A2, face: 1, Ï„: 8)</li>
      <li>L0 (issuer: other, face: 1, Ï„: 14)</li>
    </ul>
  </div>
</section>
```

### Step 5: Event Type Styling

Different event types get different colors:
- `trade` (interior): blue (#3b82f6)
- `trade` (passthrough): purple (#8b5cf6)
- `rebucket`: orange (#f59e0b)
- `settlement`: green (#16a34a)
- `default`: red (#dc2626)
- `quote`: gray (#64748b)
- `vbt_anchor_update`: teal (#14b8a6)

### Step 6: Snapshot Capture

Modify `DealerRingSimulation` to capture state snapshots after each day:

```python
@dataclass
class DaySnapshot:
    """Snapshot of simulation state at end of day."""
    day: int
    dealers: dict[str, DealerState]  # Deep copies
    vbts: dict[str, VBTState]
    traders: dict[str, TraderState]
    tickets: dict[str, Ticket]
    events: list[dict]  # Events for this day only
```

Add to `DealerRingSimulation`:
```python
def __init__(self, ...):
    ...
    self.snapshots: list[DaySnapshot] = []

def run_day(self):
    ...
    # At end of day, capture snapshot
    self._capture_snapshot()
```

### Step 7: Integration Points

#### 7a. Add `to_html()` method to simulation
```python
class DealerRingSimulation:
    def to_html(self, path: Path | str, title: str = None) -> None:
        """Export simulation to HTML report."""
        from .report import export_dealer_ring_html
        export_dealer_ring_html(self, path, title)
```

#### 7b. Update `__init__.py` exports
```python
from .report import generate_dealer_ring_html, export_dealer_ring_html
```

### Step 8: Testing

Create `tests/dealer/test_report.py`:

1. `test_generate_html_basic` - Basic HTML generation
2. `test_generate_html_with_trades` - Verify trade events rendered
3. `test_generate_html_with_rebucket` - Verify rebucket events
4. `test_generate_html_with_defaults` - Verify default events
5. `test_export_to_file` - File export works
6. `test_html_escaping` - Special characters escaped properly

## File Changes

### New Files
- `src/bilancio/dealer/report.py` (~400 lines)
- `tests/dealer/test_report.py` (~150 lines)

### Modified Files
- `src/bilancio/dealer/__init__.py` - Add exports
- `src/bilancio/dealer/simulation.py` - Add snapshot capture and `to_html()` method

## CSS Extensions

Add dealer-specific styles (can be inline or in a new asset file):

```css
/* Dealer card styling */
.dealer-card {
  background: #fff;
  border-radius: 8px;
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.dealer-card h3 {
  color: #1e40af;
  margin-bottom: 16px;
  border-bottom: 2px solid #dbeafe;
  padding-bottom: 8px;
}

.params-table {
  width: 100%;
  border-collapse: collapse;
}

.params-table th {
  text-align: left;
  padding: 6px 12px;
  color: #64748b;
  font-weight: 500;
  width: 40%;
}

.params-table td {
  text-align: right;
  padding: 6px 12px;
  font-family: 'SF Mono', Monaco, monospace;
  color: #1f2937;
}

/* VBT card */
.vbt-card {
  background: linear-gradient(135deg, #f0fdf4, #fff);
  border-left: 4px solid #16a34a;
}

/* Event type colors */
.event-trade { color: #3b82f6; }
.event-passthrough { color: #8b5cf6; }
.event-rebucket { color: #f59e0b; }
.event-settlement { color: #16a34a; }
.event-default { color: #dc2626; }
.event-quote { color: #64748b; }
.event-anchor { color: #14b8a6; }

/* Pin indicators */
.pin-indicator {
  display: inline-block;
  width: 8px;
  height: 8px;
  border-radius: 50%;
  margin-left: 4px;
}
.pin-indicator.pinned { background: #f59e0b; }
.pin-indicator.not-pinned { background: #d1d5db; }
```

## Example Output Structure

```
Day 1
â”œâ”€â”€ Events
â”‚   â”œâ”€â”€ trade: A1 SELL to long dealer at 0.95
â”‚   â””â”€â”€ quote: long dealer bid=0.875, ask=0.975
â”œâ”€â”€ Dealers
â”‚   â”œâ”€â”€ Long: a=2, C=0.05, V=2.05, bid=0.875, ask=0.975
â”‚   â”œâ”€â”€ Mid: a=1, C=1.00, V=2.00, bid=0.967, ask=1.033
â”‚   â””â”€â”€ Short: a=0, C=1.00, V=1.00, bid=0.90, ask=1.10
â”œâ”€â”€ VBTs
â”‚   â”œâ”€â”€ Long: M=1.00, O=0.30, B=0.85, A=1.15
â”‚   â”œâ”€â”€ Mid: M=1.00, O=0.20, B=0.90, A=1.10
â”‚   â””â”€â”€ Short: M=1.00, O=0.20, B=0.90, A=1.10
â””â”€â”€ Traders
    â”œâ”€â”€ A1: Cash=2.00, Tickets=[], Obligations=[T_star]
    â””â”€â”€ A2: Cash=10.00, Tickets=[T_star], Obligations=[]

Day 2
â”œâ”€â”€ Events
â”‚   â”œâ”€â”€ rebucket: T_star longâ†’mid at 1.00 (dealer)
â”‚   â””â”€â”€ quote: mid dealer bid=0.917, ask=0.983
...
```

## Implementation Order

1. Create `report.py` with basic structure and CSS
2. Implement `_render_header()` and `_render_events_table()`
3. Implement `_render_dealer_state()` and `_render_vbt_state()`
4. Implement `_render_trader_balance()`
5. Add snapshot capture to simulation
6. Implement `_render_day_section()` and main `generate_dealer_ring_html()`
7. Add `to_html()` method to simulation
8. Write tests
9. Test with Example 1 scenario

## Success Criteria

1. Running Example 1 produces readable HTML showing:
   - Initial dealer states with correct kernel parameters
   - Trade event when A1 sells to long dealer
   - Rebucket event when T* moves longâ†’mid
   - Updated dealer states after each phase

2. HTML renders correctly in browser with:
   - Clean, modern styling matching Kalecki ring reports
   - Responsive layout on different screen sizes
   - Proper escaping of special characters

3. All tests pass

## Estimated Effort

- `report.py`: 3-4 hours
- Snapshot capture: 1 hour
- Tests: 1 hour
- Integration & polish: 1 hour

**Total: ~6-7 hours**
