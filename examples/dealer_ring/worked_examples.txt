================================================================================
DEALER RING WORKED EXAMPLES
================================================================================

This file contains all dealer ring example implementations and their
corresponding HTML reports for verification against the specification.

Specification PDF: docs/dealer_ring/dealer_examples.pdf

--------------------------------------------------------------------------------
FILE STRUCTURE
--------------------------------------------------------------------------------

examples/dealer_ring/
├── out
│   ├── example10_report.html
│   ├── example11_report.html
│   ├── example12_report.html
│   ├── example13_report.html
│   ├── example14_report.html
│   ├── example1_report.html
│   ├── example2_report.html
│   ├── example3_report.html
│   ├── example4_report.html
│   ├── example5_report.html
│   ├── example6_report.html
│   ├── example7_report.html
│   ├── example8_report.html
│   └── example9_report.html
├── README.md
├── VERIFICATION_PROMPT.md
├── assemble_examples.py
├── example10_trader_rebucket.py
├── example11_partial_recovery.py
├── example12_capacity_crossing.py
├── example13_event_loop.py
├── example14_ticket_transfer.py
├── example1_migrating_claim.py
├── example2_cross_bucket.py
├── example3_clip_toggle.py
├── example4_vbt_layoff.py
├── example5_dealer_earns.py
├── example6_bid_passthrough.py
├── example7_no_interior_clipping.py
├── example8_guard_low_M.py
├── example9_partial_recovery.py
├── verify_example1_prompt.md
└── worked_examples.txt

--------------------------------------------------------------------------------
EXAMPLE TO PDF SECTION MAPPING
--------------------------------------------------------------------------------

  Example 1    -> PDF Section 2  : Selling a Migrating Claim
  Example 2    -> PDF Section 3  : Maturing Debt and Cross-Bucket Reallocation
  Example 3    -> PDF Section 4  : Outside-Bid Clipping Toggle
  Example 4    -> PDF Section 5  : Dealer Reaches Inventory Limit and VBT Layoff
  Example 5    -> PDF Section 6  : Dealer Earns Over Time
  Example 6    -> PDF Section 7  : Bid-Side Pass-Through
  Example 7    -> PDF Section 8  : Edge Rung Without Interior Clipping
  Example 8    -> PDF Section 9  : Guard at Very Low Mid M
  Example 9    -> PDF Section 10 : Partial-Recovery Default (R=0.375)
  Example 10   -> PDF Section 11 : Trader-Held Rebucketing
  Example 11   -> PDF Section 12 : Partial-Recovery Default (R=0.6)
  Example 12   -> PDF Section 13 : Capacity Integer Crossing
  Example 13   -> PDF Section 14 : Minimal Event-Loop Harness
  Example 14   -> PDF Section 15 : Ticket-Level Transfer

================================================================================
PYTHON SOURCE FILES
================================================================================

################################################################################
# FILE: example1_migrating_claim.py
# PATH: examples/dealer_ring/example1_migrating_claim.py
################################################################################

"""
Example 1: Selling a Migrating Claim and Dealer Rebucketing.

From the dealer ring specification:
- Trader A1 sells ticket T* to Long dealer at bid ~0.95
- T* migrates Long -> Mid when tau crosses bucket boundary
- Internal dealer sale occurs at receiving bucket's mid M

This script generates an HTML report of the simulation.

Usage:
    uv run python examples/dealer_ring/example1_migrating_claim.py

Output:
    examples/dealer_ring/out/example1_report.html
"""

from decimal import Decimal
from pathlib import Path

from bilancio.dealer import (
    DealerRingConfig,
    DealerRingSimulation,
    Ticket,
    TraderState,
    recompute_dealer_state,
)


def setup_example1() -> DealerRingSimulation:
    """Set up Example 1 scenario: migrating claim and rebucketing."""
    config = DealerRingConfig(
        dealer_share=Decimal("1.0"),   # All customer flow to dealer
        vbt_share=Decimal("0.0"),      # No VBT flow
        N_max=0,                        # Disable random order flow
        max_days=1,
        seed=42,
    )

    sim = DealerRingSimulation(config)

    # Set VBT anchors to match Example 1
    # Long: M=1.00, O=0.30 -> A=1.15, B=0.85
    # Mid: M=1.00, O=0.20 -> A=1.10, B=0.90
    sim.vbts["long"].M = Decimal("1.00")
    sim.vbts["long"].O = Decimal("0.30")
    sim.vbts["long"].recompute_quotes()

    sim.vbts["mid"].M = Decimal("1.00")
    sim.vbts["mid"].O = Decimal("0.20")
    sim.vbts["mid"].recompute_quotes()

    sim.vbts["short"].M = Decimal("1.00")
    sim.vbts["short"].O = Decimal("0.20")
    sim.vbts["short"].recompute_quotes()

    # Create trader A1 (holds T*)
    trader_a1 = TraderState(
        agent_id="A1_trader",
        cash=Decimal("1.05"),
    )

    # Create issuer A2 (who issued T*)
    issuer_a2 = TraderState(
        agent_id="A2_issuer",
        cash=Decimal("10.00"),
    )

    # Create ticket T* - held by A1, issued by A2
    # tau=9 is Long bucket, will become tau=8 (Mid) after day 1
    ticket_tstar = Ticket(
        id="T_star",
        issuer_id=issuer_a2.agent_id,
        owner_id=trader_a1.agent_id,
        face=Decimal(1),
        maturity_day=100,
        remaining_tau=9,   # Long bucket initially (9 > 8)
        bucket_id="long",
        serial=0,
    )

    # Set up dealers with initial inventory: a=1, C=1 each
    sim.dealers["long"].cash = Decimal("1.00")
    sim.dealers["mid"].cash = Decimal("1.00")

    # Add background ticket to Long dealer
    long_ticket = Ticket(
        id="L0",
        issuer_id="other_issuer",
        owner_id=sim.dealers["long"].agent_id,
        face=Decimal(1),
        maturity_day=200,
        remaining_tau=15,  # Stays in Long
        bucket_id="long",
        serial=1,
    )

    # Add background ticket to Mid dealer
    mid_ticket = Ticket(
        id="M0",
        issuer_id="other_issuer",
        owner_id=sim.dealers["mid"].agent_id,
        face=Decimal(1),
        maturity_day=200,
        remaining_tau=6,   # Stays in Mid
        bucket_id="mid",
        serial=2,
    )

    sim.dealers["long"].inventory.append(long_ticket)
    sim.dealers["mid"].inventory.append(mid_ticket)
    sim.all_tickets["L0"] = long_ticket
    sim.all_tickets["M0"] = mid_ticket

    # Recompute dealer states to get quotes
    for bucket_id in sim.dealers:
        recompute_dealer_state(
            sim.dealers[bucket_id],
            sim.vbts[bucket_id],
            sim.params,
        )

    # Register traders and T* with simulation
    sim.traders[trader_a1.agent_id] = trader_a1
    sim.traders[issuer_a2.agent_id] = issuer_a2
    sim.all_tickets[ticket_tstar.id] = ticket_tstar

    # Link T* to A1's assets (as receivable from A2)
    trader_a1.tickets_owned.append(ticket_tstar)

    # Link T* to A2's obligations
    issuer_a2.obligations.append(ticket_tstar)

    return sim


def run_example1_trade(sim: DealerRingSimulation) -> None:
    """Execute the Example 1 trade: A1 sells T* to Long dealer."""
    trader_a1 = sim.traders["A1_trader"]
    ticket_tstar = sim.all_tickets["T_star"]
    long_dealer = sim.dealers["long"]
    long_vbt = sim.vbts["long"]

    # Get bid price
    bid_price = long_dealer.bid

    # Execute trade: A1 sells T* to Long dealer
    trader_a1.cash += bid_price
    trader_a1.tickets_owned.remove(ticket_tstar)

    long_dealer.cash -= bid_price
    long_dealer.inventory.append(ticket_tstar)
    ticket_tstar.owner_id = long_dealer.agent_id

    # Recompute dealer state
    recompute_dealer_state(long_dealer, long_vbt, sim.params)

    # Log the trade
    sim.events.log_trade(
        day=1,
        side="SELL",
        trader_id=trader_a1.agent_id,
        ticket_id=ticket_tstar.id,
        bucket="long",
        price=bid_price,
        is_passthrough=False,
    )


def main():
    # Set up scenario
    sim = setup_example1()

    # Capture Day 0 snapshot (initial state)
    sim._capture_snapshot()

    print("Example 1: Selling a Migrating Claim")
    print("=" * 50)
    print(f"\nDay 0 State:")
    print(f"  Long dealer: a=1, C={sim.dealers['long'].cash}, bid={sim.dealers['long'].bid}")
    print(f"  Mid dealer:  a=1, C={sim.dealers['mid'].cash}")
    print(f"  A1: cash={sim.traders['A1_trader'].cash}, owns T* (tau=9)")

    # Start Day 1
    sim.day = 1
    sim.events.log_day_start(1)

    # Execute trade
    run_example1_trade(sim)

    print(f"\nAfter trade (Day 1):")
    print(f"  Long dealer: a={sim.dealers['long'].a}, C={sim.dealers['long'].cash}")
    print(f"  A1: cash={sim.traders['A1_trader'].cash}")

    # Run maturity update (decrements tau) then rebucket
    sim._update_maturities()
    sim._rebucket_tickets()

    # Log quote updates
    for bucket_id, dealer in sim.dealers.items():
        vbt = sim.vbts[bucket_id]
        sim.events.log_quote(
            day=1,
            bucket=bucket_id,
            dealer_bid=dealer.bid,
            dealer_ask=dealer.ask,
            vbt_bid=vbt.B,
            vbt_ask=vbt.A,
            inventory=dealer.a,
            capacity=dealer.X_star,
            is_pinned_bid=dealer.is_pinned_bid,
            is_pinned_ask=dealer.is_pinned_ask,
        )

    # Capture Day 1 snapshot
    sim._capture_snapshot()

    print(f"\nAfter rebucket (Day 1 end):")
    print(f"  Long dealer: a={sim.dealers['long'].a}, C={sim.dealers['long'].cash}")
    print(f"  Mid dealer:  a={sim.dealers['mid'].a}, C={sim.dealers['mid'].cash}")
    print(f"  T* bucket: {sim.all_tickets['T_star'].bucket_id}")

    # Verify equity conservation
    long_equity = sim.dealers['long'].cash + sim.vbts['long'].M * sim.dealers['long'].a
    mid_equity = sim.dealers['mid'].cash + sim.vbts['mid'].M * sim.dealers['mid'].a
    print(f"\nEquity check:")
    print(f"  Long E = C + M*a = {long_equity}")
    print(f"  Mid E = C + M*a = {mid_equity}")

    # Export HTML report
    out_dir = Path(__file__).parent / "out"
    out_dir.mkdir(exist_ok=True)
    out_path = out_dir / "example1_report.html"

    sim.to_html(
        out_path,
        title="Example 1: Selling a Migrating Claim",
        subtitle="Dealer rebucketing when T* crosses Long->Mid boundary",
    )

    print(f"\nReport saved to: {out_path}")


if __name__ == "__main__":
    main()



################################################################################
# FILE: example2_cross_bucket.py
# PATH: examples/dealer_ring/example2_cross_bucket.py
################################################################################

"""
Example 2: Maturing Debt and Cross-Bucket Reallocation.

From the dealer ring specification:
- Three dealers (Short, Mid, Long) each start with a=1, C=1
- Short ticket S* matures and repays in full at t1 end
- At t2: D_S buys from D_M at Mid's ask, D_M buys from D_L at Long's ask
- Tests kernel independence: cross-bucket holdings don't affect home kernel

Key formulas for verification:
- VBT anchors: M=1 for all, O_S=0.20, O_M=0.30, O_L=0.40
- Initial: V=2, K*=2, X*=2, λ=1/3 for all dealers at x=1
- Short: I=λO=1/3*0.20≈0.0666, p(1)=1, a(1)≈1.0333, b(1)≈0.9667
- Mid: I=1/3*0.30=0.10, p(1)=1, a(1)=1.05, b(1)=0.95
- Long: I=1/3*0.40≈0.1333, p(1)=1, a(1)≈1.0667, b(1)≈0.9333

After t1 settlement (Short ticket repays):
- D_S: a 1→0, C 1→2, V=2 unchanged
- At x=0: p(0)=1+0.20/4*1=1.05, a(0)≈1.0833, b(0)≈1.0167

t2 trades:
1. D_S buys Mid ticket at a_M(1)=1.05
   - D_M: a 1→0, C 1→2.05
   - At x=0: p(0)=1.075, a(0)=1.125, b(0)=1.025
   - D_S: C 2→0.95
2. D_M buys Long ticket at a_L(1)≈1.0667
   - D_L: a 1→0, C 1→2.0667
   - At x=0: p(0)=1.10, a(0)≈1.1667, b(0)≈1.0333
   - D_M: C 2.05→0.9833

Usage:
    uv run python examples/dealer_ring/example2_cross_bucket.py

Output:
    examples/dealer_ring/out/example2_report.html
"""

from decimal import Decimal
from pathlib import Path

from bilancio.dealer import (
    DealerRingConfig,
    DealerRingSimulation,
    Ticket,
    TraderState,
    recompute_dealer_state,
)


def setup_example2() -> DealerRingSimulation:
    """Set up Example 2 scenario: maturing debt and cross-bucket reallocation."""
    config = DealerRingConfig(
        dealer_share=Decimal("1.0"),   # All flow to dealer
        vbt_share=Decimal("0.0"),      # No VBT flow
        N_max=0,                        # Disable random order flow
        max_days=2,
        seed=42,
        # VBT anchors per Example 2: M=1 for all, different O values
        vbt_anchors={
            "short": (Decimal("1.00"), Decimal("0.20")),
            "mid": (Decimal("1.00"), Decimal("0.30")),
            "long": (Decimal("1.00"), Decimal("0.40")),
        },
    )

    sim = DealerRingSimulation(config)

    # Create issuer for background tickets (dummy issuer with lots of cash)
    issuer_other = TraderState(
        agent_id="issuer_other",
        cash=Decimal("100.00"),  # Enough to settle all tickets
    )

    # Create issuer for the Short ticket that will mature at t1
    issuer_short = TraderState(
        agent_id="issuer_short",
        cash=Decimal("1.00"),  # Enough to fully repay 1 ticket at face=1
    )

    sim.traders[issuer_other.agent_id] = issuer_other
    sim.traders[issuer_short.agent_id] = issuer_short

    # Set up dealers with initial inventory: a=1, C=1 each
    # Short dealer ticket - matures at day 1 (end of t1)
    short_ticket = Ticket(
        id="S_star",
        issuer_id=issuer_short.agent_id,
        owner_id=sim.dealers["short"].agent_id,
        face=Decimal(1),
        maturity_day=1,      # Matures at t1
        remaining_tau=1,      # Short bucket
        bucket_id="short",
        serial=0,
    )

    # Mid dealer ticket - doesn't mature yet
    mid_ticket = Ticket(
        id="M0",
        issuer_id=issuer_other.agent_id,
        owner_id=sim.dealers["mid"].agent_id,
        face=Decimal(1),
        maturity_day=200,
        remaining_tau=6,      # Mid bucket
        bucket_id="mid",
        serial=1,
    )

    # Long dealer ticket - doesn't mature yet
    long_ticket = Ticket(
        id="L0",
        issuer_id=issuer_other.agent_id,
        owner_id=sim.dealers["long"].agent_id,
        face=Decimal(1),
        maturity_day=200,
        remaining_tau=15,     # Long bucket
        bucket_id="long",
        serial=2,
    )

    # Register tickets
    sim.all_tickets["S_star"] = short_ticket
    sim.all_tickets["M0"] = mid_ticket
    sim.all_tickets["L0"] = long_ticket

    # Link tickets to issuers' obligations
    issuer_short.obligations.append(short_ticket)
    issuer_other.obligations.append(mid_ticket)
    issuer_other.obligations.append(long_ticket)

    # Initialize dealers with a=1, C=1 each
    for bucket_id in ["short", "mid", "long"]:
        sim.dealers[bucket_id].cash = Decimal("1.00")

    sim.dealers["short"].inventory.append(short_ticket)
    sim.dealers["mid"].inventory.append(mid_ticket)
    sim.dealers["long"].inventory.append(long_ticket)

    # Recompute dealer states to get initial quotes
    for bucket_id in sim.dealers:
        recompute_dealer_state(
            sim.dealers[bucket_id],
            sim.vbts[bucket_id],
            sim.params,
        )

    return sim


def verify_initial_quotes(sim: DealerRingSimulation) -> None:
    """Verify t1 initial quotes match specification."""
    print("\n=== Initial State (t0/t1 start) ===")

    # Short dealer: a=1, C=1, λ=1/3, I=0.0666, at x=1: a(1)≈1.0333, b(1)≈0.9667
    ds = sim.dealers["short"]
    print(f"Short dealer: a={ds.a}, C={ds.cash}, λ={ds.lambda_:.4f}, I={ds.I:.4f}")
    print(f"  Quotes at x={ds.x}: ask={ds.ask:.4f}, bid={ds.bid:.4f}")
    print(f"  Expected: a≈1.0333, b≈0.9667")
    assert ds.a == 1, f"Short a should be 1, got {ds.a}"
    assert abs(ds.ask - Decimal("1.0333")) < Decimal("0.001"), f"Short ask off: {ds.ask}"
    assert abs(ds.bid - Decimal("0.9667")) < Decimal("0.001"), f"Short bid off: {ds.bid}"

    # Mid dealer: a=1, C=1, λ=1/3, I=0.10, at x=1: a(1)=1.05, b(1)=0.95
    dm = sim.dealers["mid"]
    print(f"Mid dealer: a={dm.a}, C={dm.cash}, λ={dm.lambda_:.4f}, I={dm.I:.4f}")
    print(f"  Quotes at x={dm.x}: ask={dm.ask:.4f}, bid={dm.bid:.4f}")
    print(f"  Expected: a=1.05, b=0.95")
    assert dm.a == 1, f"Mid a should be 1, got {dm.a}"
    assert abs(dm.ask - Decimal("1.05")) < Decimal("0.001"), f"Mid ask off: {dm.ask}"
    assert abs(dm.bid - Decimal("0.95")) < Decimal("0.001"), f"Mid bid off: {dm.bid}"

    # Long dealer: a=1, C=1, λ=1/3, I=0.1333, at x=1: a(1)≈1.0667, b(1)≈0.9333
    dl = sim.dealers["long"]
    print(f"Long dealer: a={dl.a}, C={dl.cash}, λ={dl.lambda_:.4f}, I={dl.I:.4f}")
    print(f"  Quotes at x={dl.x}: ask={dl.ask:.4f}, bid={dl.bid:.4f}")
    print(f"  Expected: a≈1.0667, b≈0.9333")
    assert dl.a == 1, f"Long a should be 1, got {dl.a}"
    assert abs(dl.ask - Decimal("1.0667")) < Decimal("0.001"), f"Long ask off: {dl.ask}"
    assert abs(dl.bid - Decimal("0.9333")) < Decimal("0.001"), f"Long bid off: {dl.bid}"

    print("✓ All initial quotes verified!")


def run_t1_settlement(sim: DealerRingSimulation) -> None:
    """Run t1: Short ticket S* matures and repays in full."""
    print("\n=== End of t1: Settlement ===")

    # Start day 1
    sim.day = 1
    sim.events.log_day_start(1)

    # Execute settlement (short ticket matures)
    sim._settle_maturing_debt()

    # Recompute dealer states after settlement
    for bucket_id in sim.dealers:
        recompute_dealer_state(
            sim.dealers[bucket_id],
            sim.vbts[bucket_id],
            sim.params,
        )

    # Log quotes after settlement
    for bucket_id, dealer in sim.dealers.items():
        vbt = sim.vbts[bucket_id]
        sim.events.log_quote(
            day=1,
            bucket=bucket_id,
            dealer_bid=dealer.bid,
            dealer_ask=dealer.ask,
            vbt_bid=vbt.B,
            vbt_ask=vbt.A,
            inventory=dealer.a,
            capacity=dealer.X_star,
            is_pinned_bid=dealer.is_pinned_bid,
            is_pinned_ask=dealer.is_pinned_ask,
        )

    # Capture Day 1 snapshot
    sim._capture_snapshot()

    # Verify Short dealer state after settlement
    ds = sim.dealers["short"]
    print(f"Short dealer after settlement: a={ds.a}, C={ds.cash}")
    print(f"  Quotes at x={ds.x}: ask={ds.ask:.4f}, bid={ds.bid:.4f}")
    print(f"  Expected: a=0, C=2, x=0, a(0)≈1.0833, b(0)≈1.0167")
    assert ds.a == 0, f"Short a should be 0 after settlement, got {ds.a}"
    assert ds.cash == Decimal("2.00"), f"Short C should be 2.00, got {ds.cash}"
    assert abs(ds.ask - Decimal("1.0833")) < Decimal("0.001"), f"Short ask off: {ds.ask}"
    assert abs(ds.bid - Decimal("1.0167")) < Decimal("0.001"), f"Short bid off: {ds.bid}"

    print("✓ Settlement verified!")


def run_t2_cross_bucket_trades(sim: DealerRingSimulation) -> None:
    """
    Run t2: Cross-bucket trades where dealers buy from other dealers.

    Trade 1: D_S (Short dealer) buys from D_M (Mid dealer) at Mid's ask
    Trade 2: D_M (Mid dealer) buys from D_L (Long dealer) at Long's ask

    Per the spec: these are dealer-as-customer trades. The buying dealer
    acts as a customer in the selling bucket.
    """
    print("\n=== Start of t2: Cross-bucket trades ===")

    # Start day 2
    sim.day = 2
    sim.events.log_day_start(2)

    ds = sim.dealers["short"]
    dm = sim.dealers["mid"]
    dl = sim.dealers["long"]
    vbt_mid = sim.vbts["mid"]
    vbt_long = sim.vbts["long"]

    # --- Trade 1: D_S buys from D_M at Mid's ask a_M(1) = 1.05 ---
    print("\nTrade 1: Short dealer buys Mid ticket at ask 1.05")

    # Get the ask price before trade
    mid_ask_before = dm.ask
    print(f"  Mid ask before: {mid_ask_before}")
    assert abs(mid_ask_before - Decimal("1.05")) < Decimal("0.001")

    # Execute: D_M sells to D_S
    # This is an interior dealer SELL at the ask
    result = sim.executor.execute_customer_buy(
        dealer=dm,
        vbt=vbt_mid,
        buyer_id=ds.agent_id,  # Short dealer is the buyer
    )

    # Update Short dealer cash (buyer pays)
    ds.cash -= result.price

    # The ticket now belongs to Short dealer (as off-bucket holding)
    # Per kernel independence: D_S's home-bucket kernel uses only (a_S, C_S)
    # The acquired Mid ticket doesn't affect Short's kernel, only cash changes

    # But the ticket should be tracked somewhere - add to a cross-bucket holdings list
    # For now, just track that Short dealer paid and Mid dealer received

    # Log the cross-bucket trade
    sim.events.log_trade(
        day=2,
        side="BUY",
        trader_id=ds.agent_id,
        ticket_id=result.ticket.id,
        bucket="mid",
        price=result.price,
        is_passthrough=result.is_passthrough,
    )

    print(f"  Executed at price: {result.price}")
    print(f"  Mid dealer after: a={dm.a}, C={dm.cash}")
    print(f"  Short dealer cash after: {ds.cash}")

    # Verify Mid dealer state after Trade 1
    print(f"  Expected Mid: a=0, C=2.05")
    assert dm.a == 0, f"Mid a should be 0, got {dm.a}"
    assert abs(dm.cash - Decimal("2.05")) < Decimal("0.001"), f"Mid C should be 2.05, got {dm.cash}"

    # Verify Short dealer cash
    print(f"  Expected Short C: 0.95")
    assert abs(ds.cash - Decimal("0.95")) < Decimal("0.001"), f"Short C should be 0.95, got {ds.cash}"

    # Verify Mid quotes at x=0
    print(f"  Mid quotes at x=0: ask={dm.ask:.4f}, bid={dm.bid:.4f}")
    print(f"  Expected: a(0)=1.125, b(0)=1.025")
    assert abs(dm.ask - Decimal("1.125")) < Decimal("0.001"), f"Mid ask off: {dm.ask}"
    assert abs(dm.bid - Decimal("1.025")) < Decimal("0.001"), f"Mid bid off: {dm.bid}"

    print("✓ Trade 1 verified!")

    # --- Trade 2: D_M buys from D_L at Long's ask a_L(1) ≈ 1.0667 ---
    print("\nTrade 2: Mid dealer buys Long ticket at ask ~1.0667")

    # Get the ask price before trade
    long_ask_before = dl.ask
    print(f"  Long ask before: {long_ask_before}")
    assert abs(long_ask_before - Decimal("1.0667")) < Decimal("0.001")

    # Execute: D_L sells to D_M
    result2 = sim.executor.execute_customer_buy(
        dealer=dl,
        vbt=vbt_long,
        buyer_id=dm.agent_id,  # Mid dealer is the buyer
    )

    # Update Mid dealer cash (buyer pays)
    dm.cash -= result2.price

    # Log the cross-bucket trade
    sim.events.log_trade(
        day=2,
        side="BUY",
        trader_id=dm.agent_id,
        ticket_id=result2.ticket.id,
        bucket="long",
        price=result2.price,
        is_passthrough=result2.is_passthrough,
    )

    print(f"  Executed at price: {result2.price}")
    print(f"  Long dealer after: a={dl.a}, C={dl.cash}")
    print(f"  Mid dealer cash after: {dm.cash}")

    # Verify Long dealer state after Trade 2
    print(f"  Expected Long: a=0, C≈2.0667")
    assert dl.a == 0, f"Long a should be 0, got {dl.a}"
    assert abs(dl.cash - Decimal("2.0667")) < Decimal("0.001"), f"Long C should be ~2.0667, got {dl.cash}"

    # Verify Mid dealer cash
    print(f"  Expected Mid C: 0.9833")
    assert abs(dm.cash - Decimal("0.9833")) < Decimal("0.001"), f"Mid C should be ~0.9833, got {dm.cash}"

    # Verify Long quotes at x=0
    print(f"  Long quotes at x=0: ask={dl.ask:.4f}, bid={dl.bid:.4f}")
    print(f"  Expected: a(0)≈1.1667, b(0)≈1.0333")
    assert abs(dl.ask - Decimal("1.1667")) < Decimal("0.001"), f"Long ask off: {dl.ask}"
    assert abs(dl.bid - Decimal("1.0333")) < Decimal("0.001"), f"Long bid off: {dl.bid}"

    print("✓ Trade 2 verified!")

    # Log quote updates for day 2
    for bucket_id, dealer in sim.dealers.items():
        vbt = sim.vbts[bucket_id]
        sim.events.log_quote(
            day=2,
            bucket=bucket_id,
            dealer_bid=dealer.bid,
            dealer_ask=dealer.ask,
            vbt_bid=vbt.B,
            vbt_ask=vbt.A,
            inventory=dealer.a,
            capacity=dealer.X_star,
            is_pinned_bid=dealer.is_pinned_bid,
            is_pinned_ask=dealer.is_pinned_ask,
        )

    # Capture Day 2 snapshot
    sim._capture_snapshot()


def main():
    # Set up scenario
    sim = setup_example2()

    # Capture Day 0 snapshot (initial state)
    sim._capture_snapshot()

    print("Example 2: Maturing Debt and Cross-Bucket Reallocation")
    print("=" * 60)

    # Verify initial quotes
    verify_initial_quotes(sim)

    # Run t1 settlement
    run_t1_settlement(sim)

    # Run t2 cross-bucket trades
    run_t2_cross_bucket_trades(sim)

    # Final summary
    print("\n=== Final Summary ===")
    print(f"Short dealer: a={sim.dealers['short'].a}, C={sim.dealers['short'].cash}")
    print(f"Mid dealer:   a={sim.dealers['mid'].a}, C={sim.dealers['mid'].cash}")
    print(f"Long dealer:  a={sim.dealers['long'].a}, C={sim.dealers['long'].cash}")

    # Export HTML report
    out_dir = Path(__file__).parent / "out"
    out_dir.mkdir(exist_ok=True)
    out_path = out_dir / "example2_report.html"

    sim.to_html(
        out_path,
        title="Example 2: Cross-Bucket Reallocation",
        subtitle="Maturing debt and dealer-as-customer trades",
    )

    print(f"\nReport saved to: {out_path}")
    print("\n✓ All Example 2 checks passed!")


if __name__ == "__main__":
    main()



################################################################################
# FILE: example3_clip_toggle.py
# PATH: examples/dealer_ring/example3_clip_toggle.py
################################################################################

"""
Example 3: Outside-Bid Clipping Toggle (A/B).

From the dealer ring specification:
Tests the VBT anchor update after defaults and the optional B >= 0 clip.

Setup:
- At t0: M=1.0, O=0.30, A=1.15, B=0.85
- Dealer holds a=3 tickets (all maturing at t1), C=1
- At t1: 1 ticket repays (full), 2 tickets default (zero recovery)
- Loss rate l = 2/3

Anchor update (phi_M=1.0, phi_O=0.6):
- M_t2 = M_t1 - phi_M * l = 1 - 1*2/3 = 1/3 ≈ 0.3333
- O_t2 = O_t1 + phi_O * l = 0.30 + 0.6*2/3 = 0.70

Raw outside quotes for t2:
- A_t2 = M_t2 + O_t2/2 = 1/3 + 0.35 = 0.6833
- B_t2 = M_t2 - O_t2/2 = 1/3 - 0.35 = -0.0167

Dealer state at t2: a=0, C=2
- X*_t2 = floor(2 / (1/3)) = 6
- λ_t2 = 1/7, I_t2 = λ_t2 * O_t2 = 0.10
- At x=0: p(0) ≈ 0.5958, a(0) ≈ 0.6458, b(0) ≈ 0.5458

Variant A (no clip): B_t2 = -0.0167
Variant B (with clip): B_t2 = max{0, -0.0167} = 0

Note: Interior quotes don't depend on B until a pin is hit.
Both variants have identical interior quotes at x=0.

Usage:
    uv run python examples/dealer_ring/example3_clip_toggle.py

Output:
    examples/dealer_ring/out/example3_report.html
"""

from decimal import Decimal
from pathlib import Path

from bilancio.dealer import (
    DealerRingConfig,
    DealerRingSimulation,
    Ticket,
    TraderState,
    recompute_dealer_state,
)


def setup_example3(clip_nonneg_B: bool) -> DealerRingSimulation:
    """
    Set up Example 3 scenario: default and VBT anchor update.

    Uses a single issuer with partial recovery (R = 1/3) so loss rate = 2/3.

    Args:
        clip_nonneg_B: Whether to clip B to non-negative
    """
    config = DealerRingConfig(
        dealer_share=Decimal("1.0"),
        vbt_share=Decimal("0.0"),
        N_max=0,
        max_days=1,
        seed=42,
        # VBT anchors: M=1.0, O=0.30
        vbt_anchors={
            "short": (Decimal("1.00"), Decimal("0.30")),
            "mid": (Decimal("1.00"), Decimal("0.30")),
            "long": (Decimal("1.00"), Decimal("0.30")),
        },
        # phi_M=1.0 and phi_O=0.6 are defaults
        phi_M=Decimal("1.0"),
        phi_O=Decimal("0.6"),
        clip_nonneg_B=clip_nonneg_B,
        enable_vbt_anchor_updates=True,
    )

    sim = DealerRingSimulation(config)

    # Create single issuer with cash=1 (partial recovery on 3 tickets)
    # R = cash/due = 1/3, loss_rate = 1 - R = 2/3
    issuer = TraderState(
        agent_id="issuer",
        cash=Decimal("1.00"),  # Only enough to repay 1/3 of obligations
    )
    sim.traders[issuer.agent_id] = issuer

    # Set up dealer with a=3, C=1 (using mid bucket)
    dealer = sim.dealers["mid"]
    dealer.cash = Decimal("1.00")

    # Create 3 tickets from same issuer (all mature at t1 with partial recovery)
    for i in range(3):
        ticket = Ticket(
            id=f"T{i}",
            issuer_id=issuer.agent_id,
            owner_id=dealer.agent_id,
            face=Decimal(1),
            maturity_day=1,  # Matures at t1
            remaining_tau=6,
            bucket_id="mid",
            serial=i,
        )
        dealer.inventory.append(ticket)
        sim.all_tickets[ticket.id] = ticket
        issuer.obligations.append(ticket)

    # Create VBT inventory (backup)
    vbt = sim.vbts["mid"]
    vbt_ticket = Ticket(
        id="VBT0",
        issuer_id=issuer.agent_id,
        owner_id=vbt.agent_id,
        face=Decimal(1),
        maturity_day=200,
        remaining_tau=6,
        bucket_id="mid",
        serial=100,
    )
    vbt.inventory.append(vbt_ticket)
    sim.all_tickets[vbt_ticket.id] = vbt_ticket

    # Recompute dealer state
    recompute_dealer_state(dealer, vbt, sim.params)

    return sim


def verify_initial_state(sim: DealerRingSimulation) -> None:
    """Verify initial state at t0."""
    print("\n=== Initial State (t0) ===")

    dealer = sim.dealers["mid"]
    vbt = sim.vbts["mid"]

    print(f"Dealer: a={dealer.a}, C={dealer.cash}, x={dealer.x}")
    print(f"VBT: M={vbt.M}, O={vbt.O}, A={vbt.A}, B={vbt.B}")
    print(f"  clip_nonneg_B={vbt.clip_nonneg_B}")

    assert dealer.a == 3, f"a should be 3, got {dealer.a}"
    assert dealer.cash == Decimal("1.00"), f"C should be 1, got {dealer.cash}"

    assert vbt.M == Decimal("1.00"), f"M should be 1.00, got {vbt.M}"
    assert vbt.O == Decimal("0.30"), f"O should be 0.30, got {vbt.O}"
    assert vbt.A == Decimal("1.15"), f"A should be 1.15, got {vbt.A}"
    assert vbt.B == Decimal("0.85"), f"B should be 0.85, got {vbt.B}"

    print("✓ Initial state verified!")


def run_settlement_and_update(sim: DealerRingSimulation, clip_nonneg_B: bool) -> None:
    """Run settlement with defaults and VBT anchor update."""
    print("\n=== Day 1: Settlement and Anchor Update ===")

    sim.day = 1
    sim.events.log_day_start(1)

    dealer = sim.dealers["mid"]
    vbt = sim.vbts["mid"]

    # Run settlement (single issuer with partial recovery R=1/3)
    print("\nSettlement:")
    print("  Single issuer: cash=1, due=3, R=1/3, loss_rate=2/3")
    print("  Dealer receives 3 * 1/3 = 1 in recovery")
    sim._settle_maturing_debt()

    # Compute expected loss rate
    # Total face = 3, recovered = 1 (from A) + 0 (from B) = 1
    # Loss = 2/3
    print(f"\nExpected loss rate: 2/3 ≈ {Decimal(2)/Decimal(3):.4f}")

    # Update VBT anchors
    print("\nVBT anchor update (phi_M=1, phi_O=0.6):")
    sim._update_vbt_anchors()

    # Expected values after update:
    # M_new = 1 - 1*2/3 = 1/3
    # O_new = 0.30 + 0.6*2/3 = 0.70
    M_expected = Decimal(1) - Decimal(1) * (Decimal(2) / Decimal(3))
    O_expected = Decimal("0.30") + Decimal("0.6") * (Decimal(2) / Decimal(3))

    print(f"  M_new = 1 - 1*2/3 = {M_expected:.4f}")
    print(f"  O_new = 0.30 + 0.6*2/3 = {O_expected:.4f}")

    # Raw quotes
    A_raw = M_expected + O_expected / 2
    B_raw = M_expected - O_expected / 2

    print(f"\nRaw outside quotes:")
    print(f"  A = M + O/2 = {A_raw:.4f}")
    print(f"  B = M - O/2 = {B_raw:.4f}")

    # Check actual VBT values
    print(f"\nActual VBT state:")
    print(f"  M = {vbt.M:.4f}")
    print(f"  O = {vbt.O:.4f}")
    print(f"  A = {vbt.A:.4f}")
    print(f"  B = {vbt.B:.4f}")

    # Verify M and O
    assert abs(vbt.M - M_expected) < Decimal("0.0001"), f"M off: {vbt.M} vs {M_expected}"
    assert abs(vbt.O - O_expected) < Decimal("0.0001"), f"O off: {vbt.O} vs {O_expected}"

    # Verify A
    assert abs(vbt.A - A_raw) < Decimal("0.0001"), f"A off: {vbt.A} vs {A_raw}"

    # Verify B based on clip setting
    if clip_nonneg_B:
        B_expected = max(Decimal(0), B_raw)
        print(f"\n  With clip: B = max(0, {B_raw:.4f}) = {B_expected}")
    else:
        B_expected = B_raw
        print(f"\n  Without clip: B = {B_expected:.4f} (can be negative)")

    assert abs(vbt.B - B_expected) < Decimal("0.0001"), f"B off: {vbt.B} vs {B_expected}"

    # Verify dealer state after settlement
    print(f"\nDealer after settlement: a={dealer.a}, C={dealer.cash}")
    print(f"  Expected: a=0, C=2 (received 1 from repayment)")

    # Dealer should have a=0 (all tickets settled) and C=2 (original 1 + 1 repayment)
    assert dealer.a == 0, f"a should be 0, got {dealer.a}"
    assert abs(dealer.cash - Decimal("2.00")) < Decimal("0.0001"), f"C should be 2, got {dealer.cash}"

    # Recompute dealer state with new anchors
    recompute_dealer_state(dealer, vbt, sim.params)

    # Verify dealer kernel at t2
    # X* = floor(2 / (1/3)) = floor(6) = 6
    # λ = 1/(6+1) = 1/7
    # I = λ*O = 1/7 * 0.70 = 0.10
    print(f"\nDealer kernel at t2:")
    print(f"  X* = {dealer.X_star} (expected: 6)")
    print(f"  λ = {dealer.lambda_:.4f} (expected: 0.1429)")
    print(f"  I = {dealer.I:.4f} (expected: 0.10)")

    # At x=0:
    # p(0) = M - O/(X*+2S) * (0 - X*/2) = 1/3 - 0.70/8 * (-3) = 1/3 + 0.2625 ≈ 0.5958
    # a(0) = p(0) + I/2 ≈ 0.6458
    # b(0) = p(0) - I/2 ≈ 0.5458
    print(f"  At x=0: ask={dealer.ask:.4f}, bid={dealer.bid:.4f}")
    print(f"  Expected: ask≈0.6458, bid≈0.5458")

    # Log quotes
    sim.events.log_quote(
        day=1,
        bucket="mid",
        dealer_bid=dealer.bid,
        dealer_ask=dealer.ask,
        vbt_bid=vbt.B,
        vbt_ask=vbt.A,
        inventory=dealer.a,
        capacity=dealer.X_star,
        is_pinned_bid=dealer.is_pinned_bid,
        is_pinned_ask=dealer.is_pinned_ask,
    )

    print("\n✓ Settlement and anchor update verified!")


def main():
    print("Example 3: Outside-Bid Clipping Toggle")
    print("=" * 60)

    # Run Variant A (no clip)
    print("\n" + "=" * 60)
    print("VARIANT A: No outside-bid clip (B can be negative)")
    print("=" * 60)

    sim_a = setup_example3(clip_nonneg_B=False)
    sim_a._capture_snapshot()
    verify_initial_state(sim_a)
    run_settlement_and_update(sim_a, clip_nonneg_B=False)
    sim_a._capture_snapshot()

    vbt_a = sim_a.vbts["mid"]
    print(f"\nVariant A result: B = {vbt_a.B:.4f} (negative allowed)")

    # Run Variant B (with clip)
    print("\n" + "=" * 60)
    print("VARIANT B: With outside-bid clip (B >= 0)")
    print("=" * 60)

    sim_b = setup_example3(clip_nonneg_B=True)
    sim_b._capture_snapshot()
    verify_initial_state(sim_b)
    run_settlement_and_update(sim_b, clip_nonneg_B=True)
    sim_b._capture_snapshot()

    vbt_b = sim_b.vbts["mid"]
    print(f"\nVariant B result: B = {vbt_b.B:.4f} (clipped to 0)")

    # Summary
    print("\n" + "=" * 60)
    print("COMPARISON SUMMARY")
    print("=" * 60)
    print(f"\nBoth variants have identical M={vbt_a.M:.4f}, O={vbt_a.O:.4f}, A={vbt_a.A:.4f}")
    print(f"\nDifference in B:")
    print(f"  Variant A (no clip):   B = {vbt_a.B:.4f}")
    print(f"  Variant B (with clip): B = {vbt_b.B:.4f}")

    dealer_a = sim_a.dealers["mid"]
    dealer_b = sim_b.dealers["mid"]
    print(f"\nInterior quotes are identical at x=0:")
    print(f"  Variant A: ask={dealer_a.ask:.4f}, bid={dealer_a.bid:.4f}")
    print(f"  Variant B: ask={dealer_b.ask:.4f}, bid={dealer_b.bid:.4f}")

    # Export HTML report (using Variant B for cleaner display)
    out_dir = Path(__file__).parent / "out"
    out_dir.mkdir(exist_ok=True)
    out_path = out_dir / "example3_report.html"

    sim_b.to_html(
        out_path,
        title="Example 3: VBT Anchor Update with Clipping",
        subtitle="Default triggers anchor update, B clipped to 0",
    )

    print(f"\nReport saved to: {out_path}")
    print("\n✓ All Example 3 checks passed!")


if __name__ == "__main__":
    main()



################################################################################
# FILE: example4_vbt_layoff.py
# PATH: examples/dealer_ring/example4_vbt_layoff.py
################################################################################

"""
Example 4: Dealer Reaches Inventory Limit and VBT Layoff Occurs.

From the dealer ring specification:
- One bucket with dealer and VBT
- M=1.0, O=0.30, A=1.15, B=0.85
- Initial: a=2, C=2 → V=4, K*=4, X*=4, x=2
- λ=1/5=0.2, I=0.06, p(x)=1-0.05(x-2)
- At x=2: a(2)=1.03, b(2)=0.97

Step 1: Customer BUY (interior) at ask a(2)=1.03
- x: 2→1, C: 2→3.03
- p(1)=1.05, a(1)=1.08, b(1)=1.02

Step 2: Second BUY (interior) at ask a(1)=1.08
- x: 1→0, C: 3.03→4.11
- Counterfactual quotes at x=0: p(0)=1.10, a(0)=1.13, b(0)=1.07

Step 3: Third BUY (VBT layoff) at ask A=1.15
- x=0, so interior SELL is infeasible
- Pin to A=1.15 and passthrough to VBT
- x stays 0, C stays 4.11 (dealer state unchanged)

Key insight: At x=0 boundary, operational ask pins to A=1.15 and
the trade routes to VBT. Dealer's (x, C) are unchanged by passthrough.

Usage:
    uv run python examples/dealer_ring/example4_vbt_layoff.py

Output:
    examples/dealer_ring/out/example4_report.html
"""

from decimal import Decimal
from pathlib import Path

from bilancio.dealer import (
    DealerRingConfig,
    DealerRingSimulation,
    Ticket,
    TraderState,
    recompute_dealer_state,
)


def setup_example4() -> DealerRingSimulation:
    """Set up Example 4 scenario: dealer inventory limit and VBT layoff."""
    config = DealerRingConfig(
        dealer_share=Decimal("1.0"),   # All flow to dealer
        vbt_share=Decimal("0.0"),      # No VBT flow initially
        N_max=0,                        # Disable random order flow
        max_days=1,
        seed=42,
        # VBT anchors: M=1.0, O=0.30 for mid bucket (we'll use mid)
        vbt_anchors={
            "short": (Decimal("1.00"), Decimal("0.30")),
            "mid": (Decimal("1.00"), Decimal("0.30")),
            "long": (Decimal("1.00"), Decimal("0.30")),
        },
    )

    sim = DealerRingSimulation(config)

    # Create issuer for dealer tickets
    issuer = TraderState(
        agent_id="issuer",
        cash=Decimal("100.00"),
    )
    sim.traders[issuer.agent_id] = issuer

    # Create 3 buyers that will execute the BUYs
    for i in range(1, 4):
        buyer = TraderState(
            agent_id=f"buyer_{i}",
            cash=Decimal("10.00"),  # Plenty of cash
        )
        sim.traders[buyer.agent_id] = buyer

    # Set up dealer with a=2, C=2 (using mid bucket)
    dealer = sim.dealers["mid"]
    dealer.cash = Decimal("2.00")

    # Create 2 tickets for dealer inventory
    for i in range(2):
        ticket = Ticket(
            id=f"D{i}",
            issuer_id=issuer.agent_id,
            owner_id=dealer.agent_id,
            face=Decimal(1),
            maturity_day=200,
            remaining_tau=6,  # Mid bucket
            bucket_id="mid",
            serial=i,
        )
        dealer.inventory.append(ticket)
        sim.all_tickets[ticket.id] = ticket
        issuer.obligations.append(ticket)

    # Create VBT inventory (needed for passthrough)
    vbt = sim.vbts["mid"]
    vbt_ticket = Ticket(
        id="VBT0",
        issuer_id=issuer.agent_id,
        owner_id=vbt.agent_id,
        face=Decimal(1),
        maturity_day=200,
        remaining_tau=6,
        bucket_id="mid",
        serial=100,
    )
    vbt.inventory.append(vbt_ticket)
    sim.all_tickets[vbt_ticket.id] = vbt_ticket
    issuer.obligations.append(vbt_ticket)

    # Recompute dealer state
    recompute_dealer_state(dealer, vbt, sim.params)

    return sim


def verify_initial_state(sim: DealerRingSimulation) -> None:
    """Verify initial state matches specification."""
    print("\n=== Initial State (t0) ===")

    dealer = sim.dealers["mid"]
    vbt = sim.vbts["mid"]

    print(f"Dealer: a={dealer.a}, C={dealer.cash}, x={dealer.x}")
    print(f"  V={dealer.V}, K*={dealer.K_star}, X*={dealer.X_star}")
    print(f"  λ={dealer.lambda_:.4f}, I={dealer.I:.4f}")
    print(f"  Quotes at x={dealer.x}: ask={dealer.ask:.4f}, bid={dealer.bid:.4f}")
    print(f"  Expected: a=2, C=2, x=2, X*=4, λ=0.20, I=0.06, ask=1.03, bid=0.97")

    print(f"\nVBT: M={vbt.M}, O={vbt.O}, A={vbt.A}, B={vbt.B}")

    # Assertions
    assert dealer.a == 2, f"a should be 2, got {dealer.a}"
    assert dealer.cash == Decimal("2.00"), f"C should be 2, got {dealer.cash}"
    assert dealer.x == 2, f"x should be 2, got {dealer.x}"
    assert dealer.X_star == 4, f"X* should be 4, got {dealer.X_star}"
    assert abs(dealer.lambda_ - Decimal("0.20")) < Decimal("0.001"), f"λ off: {dealer.lambda_}"
    assert abs(dealer.I - Decimal("0.06")) < Decimal("0.001"), f"I off: {dealer.I}"
    assert abs(dealer.ask - Decimal("1.03")) < Decimal("0.001"), f"ask off: {dealer.ask}"
    assert abs(dealer.bid - Decimal("0.97")) < Decimal("0.001"), f"bid off: {dealer.bid}"

    # VBT assertions
    assert vbt.A == Decimal("1.15"), f"VBT A should be 1.15, got {vbt.A}"
    assert vbt.B == Decimal("0.85"), f"VBT B should be 0.85, got {vbt.B}"

    print("✓ Initial state verified!")


def run_step1(sim: DealerRingSimulation) -> None:
    """Step 1: First customer BUY (interior) at ask a(2)=1.03."""
    print("\n=== Step 1: First BUY (interior) ===")

    sim.day = 1
    sim.events.log_day_start(1)

    dealer = sim.dealers["mid"]
    vbt = sim.vbts["mid"]
    buyer = sim.traders["buyer_1"]

    ask_before = dealer.ask
    print(f"Ask before: {ask_before:.4f}, expected: 1.03")
    assert abs(ask_before - Decimal("1.03")) < Decimal("0.001")

    # Execute BUY
    result = sim.executor.execute_customer_buy(
        dealer=dealer,
        vbt=vbt,
        buyer_id=buyer.agent_id,
    )

    # Update buyer's cash
    buyer.cash -= result.price

    # Link ticket to buyer
    buyer.tickets_owned.append(result.ticket)

    # Log trade
    sim.events.log_trade(
        day=1,
        side="BUY",
        trader_id=buyer.agent_id,
        ticket_id=result.ticket.id,
        bucket="mid",
        price=result.price,
        is_passthrough=result.is_passthrough,
    )

    print(f"Executed at: {result.price:.4f}, passthrough: {result.is_passthrough}")
    print(f"Dealer after: x={dealer.x}, C={dealer.cash:.4f}")
    print(f"  Quotes: ask={dealer.ask:.4f}, bid={dealer.bid:.4f}")
    print(f"  Expected: x=1, C=3.03, ask=1.08, bid=1.02")

    # Assertions
    assert not result.is_passthrough, "Should be interior trade"
    assert abs(result.price - Decimal("1.03")) < Decimal("0.001"), f"price off: {result.price}"
    assert dealer.x == 1, f"x should be 1, got {dealer.x}"
    assert abs(dealer.cash - Decimal("3.03")) < Decimal("0.001"), f"C off: {dealer.cash}"
    assert abs(dealer.ask - Decimal("1.08")) < Decimal("0.001"), f"ask off: {dealer.ask}"
    assert abs(dealer.bid - Decimal("1.02")) < Decimal("0.001"), f"bid off: {dealer.bid}"

    print("✓ Step 1 verified!")


def run_step2(sim: DealerRingSimulation) -> None:
    """Step 2: Second customer BUY (interior to boundary) at ask a(1)=1.08."""
    print("\n=== Step 2: Second BUY (interior to boundary) ===")

    dealer = sim.dealers["mid"]
    vbt = sim.vbts["mid"]
    buyer = sim.traders["buyer_2"]

    ask_before = dealer.ask
    print(f"Ask before: {ask_before:.4f}, expected: 1.08")
    assert abs(ask_before - Decimal("1.08")) < Decimal("0.001")

    # Execute BUY
    result = sim.executor.execute_customer_buy(
        dealer=dealer,
        vbt=vbt,
        buyer_id=buyer.agent_id,
    )

    # Update buyer's cash
    buyer.cash -= result.price
    buyer.tickets_owned.append(result.ticket)

    # Log trade
    sim.events.log_trade(
        day=1,
        side="BUY",
        trader_id=buyer.agent_id,
        ticket_id=result.ticket.id,
        bucket="mid",
        price=result.price,
        is_passthrough=result.is_passthrough,
    )

    print(f"Executed at: {result.price:.4f}, passthrough: {result.is_passthrough}")
    print(f"Dealer after: x={dealer.x}, C={dealer.cash:.4f}")
    print(f"  Quotes: ask={dealer.ask:.4f}, bid={dealer.bid:.4f}")
    print(f"  Expected: x=0, C=4.11, ask=1.13 (counterfactual), bid=1.07")

    # Assertions
    assert not result.is_passthrough, "Should be interior trade"
    assert abs(result.price - Decimal("1.08")) < Decimal("0.001"), f"price off: {result.price}"
    assert dealer.x == 0, f"x should be 0, got {dealer.x}"
    assert abs(dealer.cash - Decimal("4.11")) < Decimal("0.001"), f"C off: {dealer.cash}"
    # At x=0, quotes are counterfactual (not executable without inventory)
    assert abs(dealer.ask - Decimal("1.13")) < Decimal("0.001"), f"ask off: {dealer.ask}"
    assert abs(dealer.bid - Decimal("1.07")) < Decimal("0.001"), f"bid off: {dealer.bid}"

    print("✓ Step 2 verified!")


def run_step3(sim: DealerRingSimulation) -> None:
    """Step 3: Third customer BUY (VBT layoff at the boundary) at A=1.15."""
    print("\n=== Step 3: Third BUY (VBT layoff) ===")

    dealer = sim.dealers["mid"]
    vbt = sim.vbts["mid"]
    buyer = sim.traders["buyer_3"]

    # Store dealer state before
    x_before = dealer.x
    C_before = dealer.cash
    print(f"Dealer before: x={x_before}, C={C_before:.4f}")
    print(f"VBT A (outside ask): {vbt.A}")

    # Execute BUY - should trigger passthrough
    result = sim.executor.execute_customer_buy(
        dealer=dealer,
        vbt=vbt,
        buyer_id=buyer.agent_id,
    )

    # Update buyer's cash
    buyer.cash -= result.price
    buyer.tickets_owned.append(result.ticket)

    # Log trade
    sim.events.log_trade(
        day=1,
        side="BUY",
        trader_id=buyer.agent_id,
        ticket_id=result.ticket.id,
        bucket="mid",
        price=result.price,
        is_passthrough=result.is_passthrough,
    )

    print(f"Executed at: {result.price}, passthrough: {result.is_passthrough}")
    print(f"Dealer after: x={dealer.x}, C={dealer.cash:.4f}")
    print(f"  Expected: x=0 (unchanged), C=4.11 (unchanged), price=A=1.15")

    # Assertions
    assert result.is_passthrough, "Should be passthrough trade at boundary"
    assert result.price == vbt.A, f"price should be A=1.15, got {result.price}"
    assert dealer.x == x_before, f"x should be unchanged, was {x_before}, got {dealer.x}"
    assert dealer.cash == C_before, f"C should be unchanged, was {C_before}, got {dealer.cash}"

    print("✓ Step 3 verified!")


def main():
    # Set up scenario
    sim = setup_example4()

    # Capture Day 0 snapshot
    sim._capture_snapshot()

    print("Example 4: Dealer Reaches Inventory Limit and VBT Layoff")
    print("=" * 60)

    # Verify initial state
    verify_initial_state(sim)

    # Run the three steps
    run_step1(sim)
    run_step2(sim)
    run_step3(sim)

    # Log final quotes
    dealer = sim.dealers["mid"]
    vbt = sim.vbts["mid"]
    sim.events.log_quote(
        day=1,
        bucket="mid",
        dealer_bid=dealer.bid,
        dealer_ask=dealer.ask,
        vbt_bid=vbt.B,
        vbt_ask=vbt.A,
        inventory=dealer.a,
        capacity=dealer.X_star,
        is_pinned_bid=dealer.is_pinned_bid,
        is_pinned_ask=dealer.is_pinned_ask,
    )

    # Capture Day 1 snapshot
    sim._capture_snapshot()

    # Final summary
    print("\n=== Final Summary ===")
    print(f"Dealer: a={dealer.a}, x={dealer.x}, C={dealer.cash:.4f}")
    print(f"  Quotes: ask={dealer.ask:.4f}, bid={dealer.bid:.4f}")
    print("  Note: At x=0, interior quotes are counterfactual only.")
    print("        Operational ask pins to A=1.15 for passthrough.")

    # Export HTML report
    out_dir = Path(__file__).parent / "out"
    out_dir.mkdir(exist_ok=True)
    out_path = out_dir / "example4_report.html"

    sim.to_html(
        out_path,
        title="Example 4: VBT Layoff at Inventory Limit",
        subtitle="Dealer runs out of inventory, trades route to VBT at outside ask",
    )

    print(f"\nReport saved to: {out_path}")
    print("\n✓ All Example 4 checks passed!")


if __name__ == "__main__":
    main()



################################################################################
# FILE: example5_dealer_earns.py
# PATH: examples/dealer_ring/example5_dealer_earns.py
################################################################################

"""
Example 5: Dealer Earns Over Time and Inventory Grows.

From the dealer ring specification:
- One bucket with dealer and VBT
- M=1.0, O=0.30, A=1.15, B=0.85
- Initial: a=2, C=2 → V=4, K*=4, X*=4, x=2
- λ=1/5=0.20, I=0.06, p(x)=1-0.05(x-2)
- At x=2: a(2)=1.03, b(2)=0.97
- Invariant: E = C + M*a = 4

Trade path (three trades):

Trade 1: Customer SELL (dealer buys) at b(2)=0.97
- x: 2→3, C: 2→1.03
- p(3)=0.95, a(3)=0.98, b(3)=0.92
- E = 1.03 + 3 = 4.03

Trade 2: Customer BUY (dealer sells) at a(3)=0.98
- x: 3→2, C: 1.03→2.01
- p(2)=1, a(2)=1.03, b(2)=0.97
- E = 2.01 + 2 = 4.01

Trade 3: Customer SELL (dealer buys) at b(2)=0.97
- x: 2→3, C: 2.01→1.04
- p(3)=0.95, a(3)=0.98, b(3)=0.92
- E = 1.04 + 3 = 4.04

Outcome: (a, C, E) goes from (2, 2, 4) to (3, 1.04, 4.04)
- Inventory grows 2→3
- Equity grows 4→4.04 (dealer earns through bid-ask spread)

Invariant checks at each step:
- E = C + M*a equals computed V
- a(x) >= b(x)
- B <= b(x) <= a(x) <= A (no outside breach)

Usage:
    uv run python examples/dealer_ring/example5_dealer_earns.py

Output:
    examples/dealer_ring/out/example5_report.html
"""

from decimal import Decimal
from pathlib import Path

from bilancio.dealer import (
    DealerRingConfig,
    DealerRingSimulation,
    Ticket,
    TraderState,
    recompute_dealer_state,
)


def setup_example5() -> DealerRingSimulation:
    """Set up Example 5 scenario: dealer earning through trades."""
    config = DealerRingConfig(
        dealer_share=Decimal("1.0"),
        vbt_share=Decimal("0.0"),
        N_max=0,
        max_days=1,
        seed=42,
        vbt_anchors={
            "short": (Decimal("1.00"), Decimal("0.30")),
            "mid": (Decimal("1.00"), Decimal("0.30")),
            "long": (Decimal("1.00"), Decimal("0.30")),
        },
    )

    sim = DealerRingSimulation(config)

    # Create issuer
    issuer = TraderState(
        agent_id="issuer",
        cash=Decimal("100.00"),
    )
    sim.traders[issuer.agent_id] = issuer

    # Create sellers (for SELL trades)
    seller1 = TraderState(agent_id="seller_1", cash=Decimal("0.00"))
    seller2 = TraderState(agent_id="seller_2", cash=Decimal("0.00"))

    # Create buyer (for BUY trade)
    buyer = TraderState(agent_id="buyer_1", cash=Decimal("10.00"))

    sim.traders[seller1.agent_id] = seller1
    sim.traders[seller2.agent_id] = seller2
    sim.traders[buyer.agent_id] = buyer

    # Set up dealer with a=2, C=2 (using mid bucket)
    dealer = sim.dealers["mid"]
    dealer.cash = Decimal("2.00")

    # Create 2 tickets for dealer inventory
    for i in range(2):
        ticket = Ticket(
            id=f"D{i}",
            issuer_id=issuer.agent_id,
            owner_id=dealer.agent_id,
            face=Decimal(1),
            maturity_day=200,
            remaining_tau=6,
            bucket_id="mid",
            serial=i,
        )
        dealer.inventory.append(ticket)
        sim.all_tickets[ticket.id] = ticket
        issuer.obligations.append(ticket)

    # Create tickets for sellers to sell
    sell_ticket1 = Ticket(
        id="S1",
        issuer_id=issuer.agent_id,
        owner_id=seller1.agent_id,
        face=Decimal(1),
        maturity_day=200,
        remaining_tau=6,
        bucket_id="mid",
        serial=10,
    )
    seller1.tickets_owned.append(sell_ticket1)
    sim.all_tickets[sell_ticket1.id] = sell_ticket1
    issuer.obligations.append(sell_ticket1)

    sell_ticket2 = Ticket(
        id="S2",
        issuer_id=issuer.agent_id,
        owner_id=seller2.agent_id,
        face=Decimal(1),
        maturity_day=200,
        remaining_tau=6,
        bucket_id="mid",
        serial=11,
    )
    seller2.tickets_owned.append(sell_ticket2)
    sim.all_tickets[sell_ticket2.id] = sell_ticket2
    issuer.obligations.append(sell_ticket2)

    # Create VBT inventory (backup)
    vbt = sim.vbts["mid"]
    vbt_ticket = Ticket(
        id="VBT0",
        issuer_id=issuer.agent_id,
        owner_id=vbt.agent_id,
        face=Decimal(1),
        maturity_day=200,
        remaining_tau=6,
        bucket_id="mid",
        serial=100,
    )
    vbt.inventory.append(vbt_ticket)
    sim.all_tickets[vbt_ticket.id] = vbt_ticket
    issuer.obligations.append(vbt_ticket)

    # Recompute dealer state
    recompute_dealer_state(dealer, vbt, sim.params)

    return sim


def check_invariants(dealer, vbt, label: str) -> None:
    """Check invariants after each trade."""
    M = vbt.M
    E = dealer.cash + M * dealer.a

    print(f"  Invariants ({label}):")
    print(f"    E = C + M*a = {dealer.cash:.4f} + {M}*{dealer.a} = {E:.4f}")
    print(f"    V = {dealer.V:.4f} (should equal E)")
    print(f"    a(x) >= b(x): {dealer.ask:.4f} >= {dealer.bid:.4f} = {dealer.ask >= dealer.bid}")
    print(f"    B <= b(x) <= a(x) <= A: {vbt.B} <= {dealer.bid:.4f} <= {dealer.ask:.4f} <= {vbt.A}")

    assert abs(E - dealer.V) < Decimal("0.0001"), f"E != V: {E} != {dealer.V}"
    assert dealer.ask >= dealer.bid, "ask < bid"
    assert dealer.bid >= vbt.B, f"bid < B: {dealer.bid} < {vbt.B}"
    assert dealer.ask <= vbt.A, f"ask > A: {dealer.ask} > {vbt.A}"

    print("    ✓ All invariants hold")


def verify_initial_state(sim: DealerRingSimulation) -> None:
    """Verify initial state."""
    print("\n=== Initial State ===")

    dealer = sim.dealers["mid"]
    vbt = sim.vbts["mid"]

    print(f"Dealer: a={dealer.a}, C={dealer.cash}, x={dealer.x}")
    print(f"  Quotes: ask={dealer.ask:.4f}, bid={dealer.bid:.4f}")
    print(f"  Expected: a=2, C=2, x=2, ask=1.03, bid=0.97")

    assert dealer.a == 2
    assert dealer.cash == Decimal("2.00")
    assert abs(dealer.ask - Decimal("1.03")) < Decimal("0.001")
    assert abs(dealer.bid - Decimal("0.97")) < Decimal("0.001")

    check_invariants(dealer, vbt, "initial")
    print("✓ Initial state verified!")


def run_trade1(sim: DealerRingSimulation) -> None:
    """Trade 1: Customer SELL (dealer buys) at b(2)=0.97."""
    print("\n=== Trade 1: Customer SELL at bid 0.97 ===")

    sim.day = 1
    sim.events.log_day_start(1)

    dealer = sim.dealers["mid"]
    vbt = sim.vbts["mid"]
    seller = sim.traders["seller_1"]
    ticket = seller.tickets_owned[0]

    bid_before = dealer.bid
    print(f"Bid before: {bid_before:.4f}, expected: 0.97")
    assert abs(bid_before - Decimal("0.97")) < Decimal("0.001")

    # Execute SELL
    result = sim.executor.execute_customer_sell(
        dealer=dealer,
        vbt=vbt,
        ticket=ticket,
    )

    # Update seller
    seller.cash += result.price
    seller.tickets_owned.remove(ticket)

    # Log trade
    sim.events.log_trade(
        day=1,
        side="SELL",
        trader_id=seller.agent_id,
        ticket_id=ticket.id,
        bucket="mid",
        price=result.price,
        is_passthrough=result.is_passthrough,
    )

    print(f"Executed at: {result.price:.4f}, passthrough: {result.is_passthrough}")
    print(f"Dealer after: a={dealer.a}, x={dealer.x}, C={dealer.cash:.4f}")
    print(f"  Quotes: ask={dealer.ask:.4f}, bid={dealer.bid:.4f}")
    print(f"  Expected: x=3, C=1.03, ask=0.98, bid=0.92")

    assert not result.is_passthrough
    assert dealer.x == 3
    assert abs(dealer.cash - Decimal("1.03")) < Decimal("0.001")
    assert abs(dealer.ask - Decimal("0.98")) < Decimal("0.001")
    assert abs(dealer.bid - Decimal("0.92")) < Decimal("0.001")

    check_invariants(dealer, vbt, "after Trade 1")
    print("✓ Trade 1 verified!")


def run_trade2(sim: DealerRingSimulation) -> None:
    """Trade 2: Customer BUY (dealer sells) at a(3)=0.98."""
    print("\n=== Trade 2: Customer BUY at ask 0.98 ===")

    dealer = sim.dealers["mid"]
    vbt = sim.vbts["mid"]
    buyer = sim.traders["buyer_1"]

    ask_before = dealer.ask
    print(f"Ask before: {ask_before:.4f}, expected: 0.98")
    assert abs(ask_before - Decimal("0.98")) < Decimal("0.001")

    # Execute BUY
    result = sim.executor.execute_customer_buy(
        dealer=dealer,
        vbt=vbt,
        buyer_id=buyer.agent_id,
    )

    # Update buyer
    buyer.cash -= result.price
    buyer.tickets_owned.append(result.ticket)

    # Log trade
    sim.events.log_trade(
        day=1,
        side="BUY",
        trader_id=buyer.agent_id,
        ticket_id=result.ticket.id,
        bucket="mid",
        price=result.price,
        is_passthrough=result.is_passthrough,
    )

    print(f"Executed at: {result.price:.4f}, passthrough: {result.is_passthrough}")
    print(f"Dealer after: a={dealer.a}, x={dealer.x}, C={dealer.cash:.4f}")
    print(f"  Quotes: ask={dealer.ask:.4f}, bid={dealer.bid:.4f}")
    print(f"  Expected: x=2, C=2.01, ask=1.03, bid=0.97")

    assert not result.is_passthrough
    assert dealer.x == 2
    assert abs(dealer.cash - Decimal("2.01")) < Decimal("0.001")
    assert abs(dealer.ask - Decimal("1.03")) < Decimal("0.001")
    assert abs(dealer.bid - Decimal("0.97")) < Decimal("0.001")

    check_invariants(dealer, vbt, "after Trade 2")
    print("✓ Trade 2 verified!")


def run_trade3(sim: DealerRingSimulation) -> None:
    """Trade 3: Customer SELL (dealer buys) at b(2)=0.97."""
    print("\n=== Trade 3: Customer SELL at bid 0.97 ===")

    dealer = sim.dealers["mid"]
    vbt = sim.vbts["mid"]
    seller = sim.traders["seller_2"]
    ticket = seller.tickets_owned[0]

    bid_before = dealer.bid
    print(f"Bid before: {bid_before:.4f}, expected: 0.97")
    assert abs(bid_before - Decimal("0.97")) < Decimal("0.001")

    # Execute SELL
    result = sim.executor.execute_customer_sell(
        dealer=dealer,
        vbt=vbt,
        ticket=ticket,
    )

    # Update seller
    seller.cash += result.price
    seller.tickets_owned.remove(ticket)

    # Log trade
    sim.events.log_trade(
        day=1,
        side="SELL",
        trader_id=seller.agent_id,
        ticket_id=ticket.id,
        bucket="mid",
        price=result.price,
        is_passthrough=result.is_passthrough,
    )

    print(f"Executed at: {result.price:.4f}, passthrough: {result.is_passthrough}")
    print(f"Dealer after: a={dealer.a}, x={dealer.x}, C={dealer.cash:.4f}")
    print(f"  Quotes: ask={dealer.ask:.4f}, bid={dealer.bid:.4f}")
    print(f"  Expected: x=3, C=1.04, ask=0.98, bid=0.92")

    assert not result.is_passthrough
    assert dealer.x == 3
    assert abs(dealer.cash - Decimal("1.04")) < Decimal("0.001")
    assert abs(dealer.ask - Decimal("0.98")) < Decimal("0.001")
    assert abs(dealer.bid - Decimal("0.92")) < Decimal("0.001")

    check_invariants(dealer, vbt, "after Trade 3")
    print("✓ Trade 3 verified!")


def main():
    sim = setup_example5()
    sim._capture_snapshot()

    print("Example 5: Dealer Earns Over Time and Inventory Grows")
    print("=" * 60)

    verify_initial_state(sim)
    run_trade1(sim)
    run_trade2(sim)
    run_trade3(sim)

    # Log final quotes
    dealer = sim.dealers["mid"]
    vbt = sim.vbts["mid"]
    sim.events.log_quote(
        day=1,
        bucket="mid",
        dealer_bid=dealer.bid,
        dealer_ask=dealer.ask,
        vbt_bid=vbt.B,
        vbt_ask=vbt.A,
        inventory=dealer.a,
        capacity=dealer.X_star,
        is_pinned_bid=dealer.is_pinned_bid,
        is_pinned_ask=dealer.is_pinned_ask,
    )

    sim._capture_snapshot()

    # Final summary
    print("\n=== Final Summary ===")
    print(f"Initial: (a, C, E) = (2, 2, 4)")
    E_final = dealer.cash + vbt.M * dealer.a
    print(f"Final:   (a, C, E) = ({dealer.a}, {dealer.cash:.4f}, {E_final:.4f})")
    print(f"\nDealer earned: E_final - E_initial = {E_final - 4:.4f}")
    print("This profit comes from the bid-ask spread (buy at 0.97, sell at 0.98).")

    # Export HTML report
    out_dir = Path(__file__).parent / "out"
    out_dir.mkdir(exist_ok=True)
    out_path = out_dir / "example5_report.html"

    sim.to_html(
        out_path,
        title="Example 5: Dealer Earns Over Time",
        subtitle="Inventory grows and equity increases through bid-ask spread",
    )

    print(f"\nReport saved to: {out_path}")
    print("\n✓ All Example 5 checks passed!")


if __name__ == "__main__":
    main()



################################################################################
# FILE: example6_bid_passthrough.py
# PATH: examples/dealer_ring/example6_bid_passthrough.py
################################################################################

"""
Example 6: Bid-Side Pass-Through (Dealer Lays Off at Outside Bid).

From the dealer ring specification:
A customer SELL arrives when the dealer cannot buy one more ticket.
Per commit-to-quote rules, dealer pins to outside bid B and executes
via atomic pass-through to VBT. Dealer's state (x, C) is unchanged.
This is Event 9 in the spec.

Subcase A: Capacity binding at the right edge (x = X*)
- S=1, a=2, C=0.10
- V=2.10, K*=2, X*=2, x=2=X*
- λ=1/3, I=0.10
- p(2) = 1 - 0.30/(2+2)*(2-1) = 0.925
- b(2) = 0.925 - 0.05 = 0.875
- b_c(2) = max{B, b(2)} = max{0.85, 0.875} = 0.875

Customer SELL:
- Interior BUY fails because x + S = 3 > X* = 2 (capacity bound)
- Also cash insufficient: C = 0.10 < b_c(2) = 0.875
- Execute passthrough at B = 0.85
- Dealer state unchanged: (x, C) = (2, 0.10)

Test assertions:
- Dealer invariants (Event 9): Δx_D = 0, ΔC_D = 0
- Clipping bound: b_c(x) >= B
- Double-entry: trader cash gain = VBT cash outflow

Usage:
    uv run python examples/dealer_ring/example6_bid_passthrough.py

Output:
    examples/dealer_ring/out/example6_report.html
"""

from decimal import Decimal
from pathlib import Path

from bilancio.dealer import (
    DealerRingConfig,
    DealerRingSimulation,
    Ticket,
    TraderState,
    recompute_dealer_state,
)


def setup_example6() -> DealerRingSimulation:
    """Set up Example 6 scenario: bid-side passthrough."""
    config = DealerRingConfig(
        dealer_share=Decimal("1.0"),
        vbt_share=Decimal("0.0"),
        N_max=0,
        max_days=1,
        seed=42,
        # VBT anchors: M=1.0, O=0.30
        vbt_anchors={
            "short": (Decimal("1.00"), Decimal("0.30")),
            "mid": (Decimal("1.00"), Decimal("0.30")),
            "long": (Decimal("1.00"), Decimal("0.30")),
        },
    )

    sim = DealerRingSimulation(config)

    # Create issuer
    issuer = TraderState(
        agent_id="issuer",
        cash=Decimal("100.00"),
    )
    sim.traders[issuer.agent_id] = issuer

    # Create seller who will trigger the passthrough
    seller = TraderState(
        agent_id="seller",
        cash=Decimal("0.00"),
    )
    sim.traders[seller.agent_id] = seller

    # Set up dealer with a=2, C=0.10 (using mid bucket)
    # This puts dealer at x=X*=2 with insufficient cash
    dealer = sim.dealers["mid"]
    dealer.cash = Decimal("0.10")

    # Create 2 tickets for dealer inventory
    for i in range(2):
        ticket = Ticket(
            id=f"D{i}",
            issuer_id=issuer.agent_id,
            owner_id=dealer.agent_id,
            face=Decimal(1),
            maturity_day=200,
            remaining_tau=6,
            bucket_id="mid",
            serial=i,
        )
        dealer.inventory.append(ticket)
        sim.all_tickets[ticket.id] = ticket
        issuer.obligations.append(ticket)

    # Create ticket for seller to sell
    sell_ticket = Ticket(
        id="SELL1",
        issuer_id=issuer.agent_id,
        owner_id=seller.agent_id,
        face=Decimal(1),
        maturity_day=200,
        remaining_tau=6,
        bucket_id="mid",
        serial=10,
    )
    seller.tickets_owned.append(sell_ticket)
    sim.all_tickets[sell_ticket.id] = sell_ticket
    issuer.obligations.append(sell_ticket)

    # VBT needs cash for passthrough (will pay B=0.85)
    vbt = sim.vbts["mid"]
    vbt.cash = Decimal("10.00")

    # Recompute dealer state
    recompute_dealer_state(dealer, vbt, sim.params)

    return sim


def verify_initial_state(sim: DealerRingSimulation) -> None:
    """Verify initial state matches specification."""
    print("\n=== Initial State (Subcase A: Capacity Binding) ===")

    dealer = sim.dealers["mid"]
    vbt = sim.vbts["mid"]

    print(f"Dealer: a={dealer.a}, C={dealer.cash}, x={dealer.x}")
    print(f"  V={dealer.V:.4f}, K*={dealer.K_star}, X*={dealer.X_star}")
    print(f"  λ={dealer.lambda_:.4f}, I={dealer.I:.4f}")
    print(f"  midline p(2)={dealer.midline:.4f}")
    print(f"  Quotes: ask={dealer.ask:.4f}, bid={dealer.bid:.4f}")

    print(f"\nVBT: M={vbt.M}, O={vbt.O}, A={vbt.A}, B={vbt.B}")
    print(f"VBT cash: {vbt.cash}")

    # Verify dealer state
    # Expected: a=2, C=0.10, x=2, X*=2
    # V = M*a + C = 1*2 + 0.10 = 2.10, K* = floor(2.10/1) = 2
    # λ = 1/(X*+1) = 1/3, I = λO = 0.10
    # p(2) = 1 - 0.30/(2+2)*(2-1) = 1 - 0.075 = 0.925
    # b(2) = p(2) - I/2 = 0.925 - 0.05 = 0.875

    assert dealer.a == 2, f"a should be 2, got {dealer.a}"
    assert dealer.cash == Decimal("0.10"), f"C should be 0.10, got {dealer.cash}"
    assert dealer.x == 2, f"x should be 2, got {dealer.x}"
    assert dealer.X_star == 2, f"X* should be 2, got {dealer.X_star}"
    assert abs(dealer.V - Decimal("2.10")) < Decimal("0.001"), f"V off: {dealer.V}"
    assert dealer.K_star == 2, f"K* should be 2, got {dealer.K_star}"

    # Check bid computation
    # b(2) = 0.875, but if clipped: b_c = max{B, b(2)} = max{0.85, 0.875} = 0.875
    expected_bid = Decimal("0.875")
    assert abs(dealer.bid - expected_bid) < Decimal("0.001"), f"bid should be ~{expected_bid}, got {dealer.bid}"

    # Verify x = X* (at capacity boundary)
    assert dealer.x == dealer.X_star, f"x should equal X* for capacity binding"

    print(f"\n  Expected: a=2, C=0.10, x=2, X*=2, bid≈0.875")
    print(f"  Note: x = X* means at capacity boundary")
    print("✓ Initial state verified!")


def run_passthrough_sell(sim: DealerRingSimulation) -> None:
    """Execute bid-side passthrough when dealer can't absorb SELL."""
    print("\n=== Bid-Side Passthrough (Event 9) ===")

    sim.day = 1
    sim.events.log_day_start(1)

    dealer = sim.dealers["mid"]
    vbt = sim.vbts["mid"]
    seller = sim.traders["seller"]
    ticket = seller.tickets_owned[0]

    # Record state before trade
    x_before = dealer.x
    C_before = dealer.cash
    a_before = dealer.a
    vbt_cash_before = vbt.cash
    seller_cash_before = seller.cash

    print(f"Dealer before: x={x_before}, C={C_before}, a={a_before}")
    print(f"VBT cash before: {vbt_cash_before}")
    print(f"Seller cash before: {seller_cash_before}")

    # Check why interior BUY is infeasible:
    # 1. Capacity check: x + S = 2 + 1 = 3 > X* = 2 ❌
    # 2. Cash check: C = 0.10 < bid = 0.875 ❌
    print(f"\nFeasibility check:")
    print(f"  Capacity: x + S = {dealer.x} + 1 = {dealer.x + 1} > X* = {dealer.X_star}? {dealer.x + 1 > dealer.X_star}")
    print(f"  Cash: C = {dealer.cash} >= bid = {dealer.bid}? {dealer.cash >= dealer.bid}")
    print(f"  Interior BUY infeasible → passthrough at B = {vbt.B}")

    # Execute SELL
    result = sim.executor.execute_customer_sell(
        dealer=dealer,
        vbt=vbt,
        ticket=ticket,
    )

    # Update seller
    seller.cash += result.price
    seller.tickets_owned.remove(ticket)

    # Log trade
    sim.events.log_trade(
        day=1,
        side="SELL",
        trader_id=seller.agent_id,
        ticket_id=ticket.id,
        bucket="mid",
        price=result.price,
        is_passthrough=result.is_passthrough,
    )

    print(f"\nExecution:")
    print(f"  Price: {result.price} (should be B = {vbt.B})")
    print(f"  Passthrough: {result.is_passthrough} (should be True)")

    print(f"\nDealer after: x={dealer.x}, C={dealer.cash}, a={dealer.a}")
    print(f"VBT cash after: {vbt.cash}")
    print(f"Seller cash after: {seller.cash}")

    # Verify passthrough
    assert result.is_passthrough, "Should be passthrough trade"
    assert result.price == vbt.B, f"Price should be B={vbt.B}, got {result.price}"

    # Verify dealer state unchanged (C4 assertion)
    assert dealer.x == x_before, f"x should be unchanged: {x_before}, got {dealer.x}"
    assert dealer.cash == C_before, f"C should be unchanged: {C_before}, got {dealer.cash}"
    assert dealer.a == a_before, f"a should be unchanged: {a_before}, got {dealer.a}"

    # Verify double-entry
    seller_gain = seller.cash - seller_cash_before
    vbt_payment = vbt_cash_before - vbt.cash
    assert seller_gain == result.price, f"Seller gain should equal price"
    assert vbt_payment == result.price, f"VBT payment should equal price"

    print(f"\n  Dealer invariants: Δx=0, ΔC=0 ✓")
    print(f"  Double-entry: seller +{seller_gain}, VBT -{vbt_payment} ✓")
    print("✓ Passthrough verified!")


def main():
    sim = setup_example6()
    sim._capture_snapshot()

    print("Example 6: Bid-Side Pass-Through")
    print("=" * 60)

    verify_initial_state(sim)
    run_passthrough_sell(sim)

    # Log final quotes
    dealer = sim.dealers["mid"]
    vbt = sim.vbts["mid"]
    sim.events.log_quote(
        day=1,
        bucket="mid",
        dealer_bid=dealer.bid,
        dealer_ask=dealer.ask,
        vbt_bid=vbt.B,
        vbt_ask=vbt.A,
        inventory=dealer.a,
        capacity=dealer.X_star,
        is_pinned_bid=dealer.is_pinned_bid,
        is_pinned_ask=dealer.is_pinned_ask,
    )

    sim._capture_snapshot()

    # Final summary
    print("\n=== Final Summary ===")
    print(f"Dealer: a={dealer.a}, x={dealer.x}, C={dealer.cash}")
    print(f"  Quotes unchanged: ask={dealer.ask:.4f}, bid={dealer.bid:.4f}")
    print(f"VBT absorbed the ticket at outside bid B={vbt.B}")
    print(f"Dealer state (x, C) remained unchanged by passthrough.")

    # Export HTML report
    out_dir = Path(__file__).parent / "out"
    out_dir.mkdir(exist_ok=True)
    out_path = out_dir / "example6_report.html"

    sim.to_html(
        out_path,
        title="Example 6: Bid-Side Pass-Through",
        subtitle="Customer SELL routed to VBT when dealer at capacity",
    )

    print(f"\nReport saved to: {out_path}")
    print("\n✓ All Example 6 checks passed!")


if __name__ == "__main__":
    main()



################################################################################
# FILE: example7_no_interior_clipping.py
# PATH: examples/dealer_ring/example7_no_interior_clipping.py
################################################################################

"""
Example 7: Edge Rung Without Interior Clipping.

From the dealer ring specification:
Demonstrates that under the L1 kernel, interior quotes remain strictly inside
the outside quotes for all feasible inventories x ∈ [0, X*]. As x approaches
the boundaries, {a(x), b(x)} approach {A, B} but do not reach them.
Outside pins occur only at the boundary via pass-through.

Setup:
- S=1, M=1.0, O=0.30, A=1.15, B=0.85
- Dealer: a=4, C=0.90
- V=4.90, K*=4, X*=4, λ=1/5=0.2, I=0.06
- Midline p(x) = 1 - 0.05(x-2)

At x=1 (one rung before running out of inventory):
- p(1) = 1.05, a(1) = 1.08 < A = 1.15
- Interior SELL feasible (x >= S)
- Gap to outside ask: A - a(1) = 0.07

At x=3 (one rung before capacity):
- p(3) = 0.95, b(3) = 0.92 > B = 0.85
- Interior BUY feasible (x+S <= X* and C >= b)
- Gap to outside bid: b(3) - B = 0.07

Harness checks:
1. a(x) < A and b(x) > B for all x in {0,1,2,3}
2. Gaps A - a(x) and b(x) - B are positive
3. Interior trades feasible at x=1 and x=3
4. Boundary pins only at x=0 (BUY) and x=X* (SELL)

Usage:
    uv run python examples/dealer_ring/example7_no_interior_clipping.py

Output:
    examples/dealer_ring/out/example7_report.html
"""

from decimal import Decimal
from pathlib import Path

from bilancio.dealer import (
    DealerRingConfig,
    DealerRingSimulation,
    Ticket,
    TraderState,
    recompute_dealer_state,
    can_interior_buy,
    can_interior_sell,
)


def setup_example7() -> DealerRingSimulation:
    """Set up Example 7: Edge rung without interior clipping."""
    config = DealerRingConfig(
        dealer_share=Decimal("1.0"),
        vbt_share=Decimal("0.0"),
        N_max=0,
        max_days=1,
        seed=42,
        vbt_anchors={
            "short": (Decimal("1.00"), Decimal("0.30")),
            "mid": (Decimal("1.00"), Decimal("0.30")),
            "long": (Decimal("1.00"), Decimal("0.30")),
        },
    )

    sim = DealerRingSimulation(config)

    # Create issuer
    issuer = TraderState(agent_id="issuer", cash=Decimal("100.00"))
    sim.traders[issuer.agent_id] = issuer

    # Set up dealer with a=4, C=0.90 (using mid bucket)
    dealer = sim.dealers["mid"]
    dealer.cash = Decimal("0.90")

    # Create 4 tickets for dealer inventory
    for i in range(4):
        ticket = Ticket(
            id=f"D{i}",
            issuer_id=issuer.agent_id,
            owner_id=dealer.agent_id,
            face=Decimal(1),
            maturity_day=200,
            remaining_tau=6,
            bucket_id="mid",
            serial=i,
        )
        dealer.inventory.append(ticket)
        sim.all_tickets[ticket.id] = ticket
        issuer.obligations.append(ticket)

    # Create VBT inventory
    vbt = sim.vbts["mid"]
    for i in range(5):
        vbt_ticket = Ticket(
            id=f"VBT{i}",
            issuer_id=issuer.agent_id,
            owner_id=vbt.agent_id,
            face=Decimal(1),
            maturity_day=200,
            remaining_tau=6,
            bucket_id="mid",
            serial=100 + i,
        )
        vbt.inventory.append(vbt_ticket)
        sim.all_tickets[vbt_ticket.id] = vbt_ticket

    # Recompute dealer state
    recompute_dealer_state(dealer, vbt, sim.params)

    return sim


def verify_initial_state(sim: DealerRingSimulation) -> None:
    """Verify initial state."""
    print("\n=== Initial State ===")

    dealer = sim.dealers["mid"]
    vbt = sim.vbts["mid"]

    print(f"Dealer: a={dealer.a}, C={dealer.cash}, x={dealer.x}")
    print(f"  V={dealer.V:.4f}, K*={dealer.K_star}, X*={dealer.X_star}")
    print(f"  λ={dealer.lambda_:.4f}, I={dealer.I:.4f}")
    print(f"\nVBT: M={vbt.M}, O={vbt.O}, A={vbt.A}, B={vbt.B}")

    assert dealer.a == 4
    assert dealer.cash == Decimal("0.90")
    assert dealer.X_star == 4
    assert abs(dealer.lambda_ - Decimal("0.20")) < Decimal("0.001")
    assert abs(dealer.I - Decimal("0.06")) < Decimal("0.001")

    print("✓ Initial state verified!")


def check_no_interior_clipping(sim: DealerRingSimulation) -> None:
    """
    Check that interior quotes never hit outside quotes.

    For all x in {0, 1, 2, ..., X*-1}:
    - a(x) < A (ask always below outside ask)
    - b(x) > B (bid always above outside bid)
    """
    print("\n=== Interior Clipping Check ===")

    dealer = sim.dealers["mid"]
    vbt = sim.vbts["mid"]

    A = vbt.A
    B = vbt.B
    X_star = dealer.X_star

    print(f"Outside quotes: A={A}, B={B}")
    print(f"Capacity X*={X_star}")
    print(f"\nChecking interior rungs x ∈ {{1, 2, ..., {int(X_star)-1}}} (excluding boundaries):\n")

    # We need to check quotes at each rung
    # Save current state
    original_inventory = dealer.inventory.copy()
    original_cash = dealer.cash

    all_passed = True

    # Check rungs x ∈ {1, 2, ..., X*-1} (interior, not boundaries)
    # At x=0: ask pins to A (no inventory to sell) - this is expected
    # At x=X*: bid pins to B (at capacity) - this is expected
    #
    # IMPORTANT: To keep X* = 4 fixed, we adjust cash to maintain V = 4.90
    # V = M*a + C, so C = V - M*a = 4.90 - a
    V_target = Decimal("4.90")
    M = vbt.M

    for x in range(1, int(X_star)):
        # Adjust inventory and cash to maintain V = 4.90
        dealer.inventory = original_inventory[:x]
        dealer.cash = V_target - M * x  # Keep V constant
        recompute_dealer_state(dealer, vbt, sim.params)

        ask = dealer.ask
        bid = dealer.bid
        gap_ask = A - ask
        gap_bid = bid - B

        ask_ok = ask < A
        bid_ok = bid > B

        status = "✓" if (ask_ok and bid_ok) else "✗"
        print(f"  x={x}: ask={ask:.4f} {'<' if ask_ok else '>='} A={A} (gap={gap_ask:.4f}), "
              f"bid={bid:.4f} {'>' if bid_ok else '<='} B={B} (gap={gap_bid:.4f}) {status}")

        if not (ask_ok and bid_ok):
            all_passed = False

    # Note: x=0 and x=X* are boundary cases where pins are expected
    print(f"\n  Note: x=0 and x=X* are boundaries where pins to A/B are expected")

    # Restore original state
    dealer.inventory = original_inventory
    dealer.cash = original_cash
    recompute_dealer_state(dealer, vbt, sim.params)

    if all_passed:
        print("\n✓ No interior clipping: a(x) < A and b(x) > B for all x!")
    else:
        print("\n✗ Interior clipping detected!")

    assert all_passed, "Interior clipping should not occur"


def check_edge_rungs(sim: DealerRingSimulation) -> None:
    """Check quotes at edge rungs x=1 and x=X*-1 with V kept constant."""
    print("\n=== Edge Rung Verification ===")

    dealer = sim.dealers["mid"]
    vbt = sim.vbts["mid"]

    # Save state
    original_inventory = dealer.inventory.copy()
    original_cash = dealer.cash

    # Keep V = 4.90 to maintain X* = 4
    V_target = Decimal("4.90")
    M = vbt.M

    # Check x=1 (one rung before running out)
    print("\nAt x=1 (one rung before empty), keeping V=4.90:")
    dealer.inventory = original_inventory[:1]
    dealer.cash = V_target - M * 1  # C = 3.90
    recompute_dealer_state(dealer, vbt, sim.params)

    print(f"  V={dealer.V:.4f}, X*={dealer.X_star}")
    print(f"  midline p(1) = {dealer.midline:.4f}")
    print(f"  ask a(1) = {dealer.ask:.4f}")
    print(f"  bid b(1) = {dealer.bid:.4f}")
    print(f"  Expected: p(1)=1.05, a(1)=1.08, b(1)=1.02")

    assert abs(dealer.midline - Decimal("1.05")) < Decimal("0.001"), f"midline off: {dealer.midline}"
    assert abs(dealer.ask - Decimal("1.08")) < Decimal("0.001"), f"ask off: {dealer.ask}"
    assert abs(dealer.bid - Decimal("1.02")) < Decimal("0.001"), f"bid off: {dealer.bid}"

    # Check feasibility at x=1
    can_sell = can_interior_sell(dealer, sim.params)
    print(f"  Interior SELL feasible (x >= S): {can_sell}")
    assert can_sell, "Interior SELL should be feasible at x=1"

    # Check x=3 (one rung before capacity)
    print("\nAt x=3 (one rung before capacity X*=4), keeping V=4.90:")
    dealer.inventory = original_inventory[:3]
    dealer.cash = V_target - M * 3  # C = 1.90
    recompute_dealer_state(dealer, vbt, sim.params)

    print(f"  V={dealer.V:.4f}, X*={dealer.X_star}")
    print(f"  midline p(3) = {dealer.midline:.4f}")
    print(f"  ask a(3) = {dealer.ask:.4f}")
    print(f"  bid b(3) = {dealer.bid:.4f}")
    print(f"  Expected: p(3)=0.95, a(3)=0.98, b(3)=0.92")

    assert abs(dealer.midline - Decimal("0.95")) < Decimal("0.001"), f"midline off: {dealer.midline}"
    assert abs(dealer.ask - Decimal("0.98")) < Decimal("0.001"), f"ask off: {dealer.ask}"
    assert abs(dealer.bid - Decimal("0.92")) < Decimal("0.001"), f"bid off: {dealer.bid}"

    # Check feasibility at x=3
    can_buy = can_interior_buy(dealer, sim.params)
    print(f"  Interior BUY feasible (x+S <= X* and C >= b): {can_buy}")
    assert can_buy, "Interior BUY should be feasible at x=3"

    # Restore
    dealer.inventory = original_inventory
    dealer.cash = original_cash
    recompute_dealer_state(dealer, vbt, sim.params)

    print("\n✓ Edge rungs verified!")


def check_boundary_pins(sim: DealerRingSimulation) -> None:
    """Check that boundary conditions trigger pins to outside quotes."""
    print("\n=== Boundary Pin Verification ===")

    dealer = sim.dealers["mid"]
    vbt = sim.vbts["mid"]

    # Save state
    original_inventory = dealer.inventory.copy()
    original_cash = dealer.cash

    # At x=0: BUY order pins to A (dealer has no inventory to sell)
    print("\nAt x=0 (no inventory):")
    dealer.inventory = []
    recompute_dealer_state(dealer, vbt, sim.params)

    can_sell = can_interior_sell(dealer, sim.params)
    print(f"  Interior SELL feasible: {can_sell}")
    print(f"  → Customer BUY must pin to A={vbt.A} (passthrough)")
    assert not can_sell, "Interior SELL should be infeasible at x=0"

    # At x=X*: SELL order pins to B (dealer at capacity)
    print(f"\nAt x=X*={dealer.X_star} (at capacity):")
    dealer.inventory = original_inventory[:4]  # x=4
    dealer.cash = Decimal("0.00")  # No cash to buy more
    recompute_dealer_state(dealer, vbt, sim.params)

    can_buy = can_interior_buy(dealer, sim.params)
    print(f"  Interior BUY feasible: {can_buy}")
    print(f"  → Customer SELL must pin to B={vbt.B} (passthrough)")
    assert not can_buy, "Interior BUY should be infeasible at x=X*"

    # Restore
    dealer.inventory = original_inventory
    dealer.cash = original_cash
    recompute_dealer_state(dealer, vbt, sim.params)

    print("\n✓ Boundary pins verified!")


def main():
    sim = setup_example7()
    sim._capture_snapshot()

    print("Example 7: Edge Rung Without Interior Clipping")
    print("=" * 60)

    verify_initial_state(sim)
    check_no_interior_clipping(sim)
    check_edge_rungs(sim)
    check_boundary_pins(sim)

    # Capture final snapshot
    sim.day = 1
    sim._capture_snapshot()

    # Export HTML report
    out_dir = Path(__file__).parent / "out"
    out_dir.mkdir(exist_ok=True)
    out_path = out_dir / "example7_report.html"

    sim.to_html(
        out_path,
        title="Example 7: No Interior Clipping",
        subtitle="Interior quotes always strictly inside outside quotes",
    )

    print(f"\nReport saved to: {out_path}")
    print("\n✓ All Example 7 checks passed!")


if __name__ == "__main__":
    main()



################################################################################
# FILE: example8_guard_low_M.py
# PATH: examples/dealer_ring/example8_guard_low_M.py
################################################################################

"""
Example 8: Guard at Very Low Mid M <= M_min.

From the dealer ring specification:
When M drops below the minimum threshold M_min, the Guard regime activates.
The dealer collapses to a pass-through only mode with X* = 0, ladder {0}.
All customer trades route to VBT at outside quotes (A for BUY, B for SELL).

Setup:
- M = 0.01 < M_min = 0.02 (Guard condition)
- O = 0.01, so A = M + O/2 = 0.015, B = M - O/2 = 0.005
- Dealer has arbitrary inventory (irrelevant under Guard)
- VBT has inventory and cash

Arrival 1: customer SELL (Event 9)
- Bid is pinned b_c = B = 0.005
- X* = 0, so interior dealer BUY is infeasible (x + S <= X* fails)
- Execute passthrough at B: dealer state unchanged

Arrival 2: customer BUY (Event 10)
- Ask is pinned a_c = A = 0.015
- Guard regime routes all BUYs to VBT regardless of dealer inventory
- Execute passthrough at A: dealer state unchanged

Harness checks:
1. Guard activation: M <= M_min => X* = 0, ladder {0}
2. Pinned quotes: a_c(x) = A, b_c(x) = B (no interior schedule)
3. Pass-through only: execution price = A (BUY) or B (SELL)
4. Dealer invariants: Δx_D = 0, ΔC_D = 0 for both trades

Usage:
    uv run python examples/dealer_ring/example8_guard_low_M.py

Output:
    examples/dealer_ring/out/example8_report.html
"""

from decimal import Decimal
from pathlib import Path

from bilancio.dealer import (
    M_MIN,
    DealerRingConfig,
    DealerRingSimulation,
    Ticket,
    TraderState,
    recompute_dealer_state,
)


def setup_example8() -> DealerRingSimulation:
    """Set up Example 8: Guard at very low mid M."""
    # M = 0.01 < M_MIN = 0.02 triggers Guard mode
    M = Decimal("0.01")
    O = Decimal("0.01")

    config = DealerRingConfig(
        dealer_share=Decimal("1.0"),
        vbt_share=Decimal("0.0"),
        N_max=0,
        max_days=1,
        seed=42,
        # Very low M triggers Guard
        vbt_anchors={
            "short": (M, O),
            "mid": (M, O),
            "long": (M, O),
        },
    )

    sim = DealerRingSimulation(config)

    # Create issuer
    issuer = TraderState(agent_id="issuer", cash=Decimal("100.00"))
    sim.traders[issuer.agent_id] = issuer

    # Create seller who will execute SELL
    seller = TraderState(agent_id="seller", cash=Decimal("0.00"))
    sim.traders[seller.agent_id] = seller

    # Create buyer who will execute BUY
    buyer = TraderState(agent_id="buyer", cash=Decimal("10.00"))
    sim.traders[buyer.agent_id] = buyer

    # Set up dealer with some arbitrary inventory (should be irrelevant under Guard)
    dealer = sim.dealers["mid"]
    dealer.cash = Decimal("1.00")

    # Give dealer 2 tickets
    for i in range(2):
        ticket = Ticket(
            id=f"D{i}",
            issuer_id=issuer.agent_id,
            owner_id=dealer.agent_id,
            face=Decimal(1),
            maturity_day=200,
            remaining_tau=6,
            bucket_id="mid",
            serial=i,
        )
        dealer.inventory.append(ticket)
        sim.all_tickets[ticket.id] = ticket
        issuer.obligations.append(ticket)

    # Give seller a ticket to sell
    sell_ticket = Ticket(
        id="SELL1",
        issuer_id=issuer.agent_id,
        owner_id=seller.agent_id,
        face=Decimal(1),
        maturity_day=200,
        remaining_tau=6,
        bucket_id="mid",
        serial=10,
    )
    seller.tickets_owned.append(sell_ticket)
    sim.all_tickets[sell_ticket.id] = sell_ticket
    issuer.obligations.append(sell_ticket)

    # Set up VBT with inventory and cash
    vbt = sim.vbts["mid"]
    vbt.cash = Decimal("10.00")

    for i in range(5):
        vbt_ticket = Ticket(
            id=f"VBT{i}",
            issuer_id=issuer.agent_id,
            owner_id=vbt.agent_id,
            face=Decimal(1),
            maturity_day=200,
            remaining_tau=6,
            bucket_id="mid",
            serial=100 + i,
        )
        vbt.inventory.append(vbt_ticket)
        sim.all_tickets[vbt_ticket.id] = vbt_ticket

    # Recompute dealer state - should activate Guard
    recompute_dealer_state(dealer, vbt, sim.params)

    return sim


def verify_guard_activation(sim: DealerRingSimulation) -> None:
    """Verify Guard mode is activated."""
    print("\n=== Guard Activation Check ===")

    dealer = sim.dealers["mid"]
    vbt = sim.vbts["mid"]

    print(f"VBT anchors: M={vbt.M}, O={vbt.O}")
    print(f"Outside quotes: A={vbt.A}, B={vbt.B}")
    print(f"M_MIN threshold: {M_MIN}")
    print(f"Guard condition: M={vbt.M} <= M_MIN={M_MIN}? {vbt.M <= M_MIN}")

    print(f"\nDealer state under Guard:")
    print(f"  a={dealer.a}, C={dealer.cash}")
    print(f"  X*={dealer.X_star}, K*={dealer.K_star}")
    print(f"  lambda={dealer.lambda_}, I={dealer.I}")
    print(f"  Pinned ask: {dealer.is_pinned_ask}, Pinned bid: {dealer.is_pinned_bid}")
    print(f"  Quotes: ask={dealer.ask}, bid={dealer.bid}")

    # Verify Guard mode
    assert vbt.M <= M_MIN, f"M should be <= M_MIN: {vbt.M} vs {M_MIN}"
    assert dealer.X_star == 0, f"X* should be 0 under Guard, got {dealer.X_star}"
    assert dealer.K_star == 0, f"K* should be 0 under Guard, got {dealer.K_star}"
    assert dealer.is_pinned_ask, "Ask should be pinned under Guard"
    assert dealer.is_pinned_bid, "Bid should be pinned under Guard"
    assert dealer.ask == vbt.A, f"Ask should equal A={vbt.A}, got {dealer.ask}"
    assert dealer.bid == vbt.B, f"Bid should equal B={vbt.B}, got {dealer.bid}"

    print("\n✓ Guard mode activated correctly!")


def run_arrival1_sell(sim: DealerRingSimulation) -> None:
    """Arrival 1: Customer SELL at outside bid B."""
    print("\n=== Arrival 1: Customer SELL (Event 9) ===")

    sim.day = 1
    sim.events.log_day_start(1)

    dealer = sim.dealers["mid"]
    vbt = sim.vbts["mid"]
    seller = sim.traders["seller"]
    ticket = seller.tickets_owned[0]

    # Record state before trade
    x_before = dealer.x
    C_before = dealer.cash
    a_before = dealer.a
    vbt_cash_before = vbt.cash
    seller_cash_before = seller.cash

    print(f"Before: dealer x={x_before}, C={C_before}, a={a_before}")
    print(f"Before: VBT cash={vbt_cash_before}")
    print(f"Before: seller cash={seller_cash_before}")

    print(f"\nGuard regime: bid pinned to B={vbt.B}")
    print(f"Interior BUY infeasible: x + S = {dealer.x} + 1 > X* = {dealer.X_star}")

    # Execute SELL
    result = sim.executor.execute_customer_sell(
        dealer=dealer,
        vbt=vbt,
        ticket=ticket,
    )

    # Update seller
    seller.cash += result.price
    seller.tickets_owned.remove(ticket)

    sim.events.log_trade(
        day=1,
        side="SELL",
        trader_id=seller.agent_id,
        ticket_id=ticket.id,
        bucket="mid",
        price=result.price,
        is_passthrough=result.is_passthrough,
    )

    print(f"\nExecution:")
    print(f"  Price: {result.price} (expected B={vbt.B})")
    print(f"  Passthrough: {result.is_passthrough} (expected True)")

    print(f"\nAfter: dealer x={dealer.x}, C={dealer.cash}, a={dealer.a}")
    print(f"After: VBT cash={vbt.cash}")
    print(f"After: seller cash={seller.cash}")

    # Verify passthrough
    assert result.is_passthrough, "SELL should be passthrough under Guard"
    assert result.price == vbt.B, f"Price should be B={vbt.B}, got {result.price}"

    # Verify dealer state unchanged (Event 9)
    assert dealer.x == x_before, f"x should be unchanged, got {dealer.x}"
    assert dealer.cash == C_before, f"C should be unchanged, got {dealer.cash}"
    assert dealer.a == a_before, f"a should be unchanged, got {dealer.a}"

    # Verify double-entry
    seller_gain = seller.cash - seller_cash_before
    vbt_outflow = vbt_cash_before - vbt.cash
    assert seller_gain == result.price, f"Seller gain should equal price"
    assert vbt_outflow == result.price, f"VBT outflow should equal price"

    print(f"\n  Δx_D = 0, ΔC_D = 0 ✓")
    print(f"  ΔCash_Trader = +{seller_gain}, ΔCash_VBT = -{vbt_outflow} ✓")
    print("✓ Arrival 1 (SELL) verified!")


def run_arrival2_buy(sim: DealerRingSimulation) -> None:
    """Arrival 2: Customer BUY at outside ask A."""
    print("\n=== Arrival 2: Customer BUY (Event 10) ===")

    dealer = sim.dealers["mid"]
    vbt = sim.vbts["mid"]
    buyer = sim.traders["buyer"]

    # Record state before trade
    x_before = dealer.x
    C_before = dealer.cash
    a_before = dealer.a
    vbt_cash_before = vbt.cash
    buyer_cash_before = buyer.cash

    print(f"Before: dealer x={x_before}, C={C_before}, a={a_before}")
    print(f"Before: VBT cash={vbt_cash_before}")
    print(f"Before: buyer cash={buyer_cash_before}")

    print(f"\nGuard regime: ask pinned to A={vbt.A}")
    print(f"Regardless of dealer inventory a={dealer.a}, Guard routes to VBT")

    # Execute BUY
    result = sim.executor.execute_customer_buy(
        dealer=dealer,
        vbt=vbt,
        buyer_id=buyer.agent_id,
    )

    # Update buyer
    buyer.cash -= result.price
    if result.ticket:
        buyer.tickets_owned.append(result.ticket)

    sim.events.log_trade(
        day=1,
        side="BUY",
        trader_id=buyer.agent_id,
        ticket_id=result.ticket.id if result.ticket else "N/A",
        bucket="mid",
        price=result.price,
        is_passthrough=result.is_passthrough,
    )

    print(f"\nExecution:")
    print(f"  Price: {result.price} (expected A={vbt.A})")
    print(f"  Passthrough: {result.is_passthrough} (expected True)")

    print(f"\nAfter: dealer x={dealer.x}, C={dealer.cash}, a={dealer.a}")
    print(f"After: VBT cash={vbt.cash}")
    print(f"After: buyer cash={buyer.cash}")

    # Verify passthrough
    assert result.is_passthrough, "BUY should be passthrough under Guard"
    assert result.price == vbt.A, f"Price should be A={vbt.A}, got {result.price}"

    # Verify dealer state unchanged (Event 10)
    assert dealer.x == x_before, f"x should be unchanged, got {dealer.x}"
    assert dealer.cash == C_before, f"C should be unchanged, got {dealer.cash}"
    assert dealer.a == a_before, f"a should be unchanged, got {dealer.a}"

    # Verify double-entry
    buyer_outflow = buyer_cash_before - buyer.cash
    vbt_inflow = vbt.cash - vbt_cash_before
    assert buyer_outflow == result.price, f"Buyer outflow should equal price"
    assert vbt_inflow == result.price, f"VBT inflow should equal price"

    print(f"\n  Δx_D = 0, ΔC_D = 0 ✓")
    print(f"  ΔCash_Trader = -{buyer_outflow}, ΔCash_VBT = +{vbt_inflow} ✓")
    print("✓ Arrival 2 (BUY) verified!")


def verify_final_state(sim: DealerRingSimulation) -> None:
    """Verify final state after both trades."""
    print("\n=== Final Double-Entry Summary ===")

    dealer = sim.dealers["mid"]
    vbt = sim.vbts["mid"]

    print(f"Dealer inventory change: 0 (unchanged)")
    print(f"VBT inventory change: +1 (SELL) - 1 (BUY) = 0")
    print(f"VBT cash change: -{vbt.B} (SELL payout) + {vbt.A} (BUY receipt) = +{vbt.A - vbt.B}")

    # VBT should have net cash gain of A - B = spread
    expected_vbt_gain = vbt.A - vbt.B
    print(f"\nVBT earned spread: {expected_vbt_gain}")

    print("✓ All double-entry verified!")


def main():
    sim = setup_example8()
    sim._capture_snapshot()

    print("Example 8: Guard at Very Low Mid M")
    print("=" * 60)

    verify_guard_activation(sim)
    run_arrival1_sell(sim)
    run_arrival2_buy(sim)
    verify_final_state(sim)

    # Log final quotes
    dealer = sim.dealers["mid"]
    vbt = sim.vbts["mid"]
    sim.events.log_quote(
        day=1,
        bucket="mid",
        dealer_bid=dealer.bid,
        dealer_ask=dealer.ask,
        vbt_bid=vbt.B,
        vbt_ask=vbt.A,
        inventory=dealer.a,
        capacity=dealer.X_star,
        is_pinned_bid=dealer.is_pinned_bid,
        is_pinned_ask=dealer.is_pinned_ask,
    )

    sim._capture_snapshot()

    # Export HTML report
    out_dir = Path(__file__).parent / "out"
    out_dir.mkdir(exist_ok=True)
    out_path = out_dir / "example8_report.html"

    sim.to_html(
        out_path,
        title="Example 8: Guard at Low M",
        subtitle="All trades route to VBT when M <= M_min",
    )

    print(f"\nReport saved to: {out_path}")
    print("\n✓ All Example 8 checks passed!")


if __name__ == "__main__":
    main()



################################################################################
# FILE: example9_partial_recovery.py
# PATH: examples/dealer_ring/example9_partial_recovery.py
################################################################################

"""
Example 9: Partial-Recovery Default with Multiple Claimant Types (R=0.375).

From the dealer ring specification (Section 10):
A single issuer I with tickets maturing at period t. The maturing cohort is
held by three distinct claimant types: dealer D, VBT, and trader K.

Primitives:
- Ticket size (face): S = 1
- Total maturing tickets on I: N_I(t) = 8, so D_I(t) = 8
- Issuer cash before settlement: C_I(t) = 3
- Recovery rate: R_I(t) = 3/8 = 0.375 (partial recovery)

Holder composition:
- q_D = 3 (dealer holds 3 tickets)
- q_V = 2 (VBT holds 2 tickets)
- q_K = 3 (trader K holds 3 tickets)
- Total: q_D + q_V + q_K = 8

Payouts (each holder receives q * S * R):
- Dealer D: 3 * 1 * 0.375 = 1.125
- VBT: 2 * 1 * 0.375 = 0.75
- Trader K: 3 * 1 * 0.375 = 1.125

Checks:
1. Cash conservation: 1.125 + 0.75 + 1.125 = 3 (equals issuer outflow)
2. Ticket deletion: all 8 maturing tickets removed
3. Issuer cash to zero: C_I(t+) = 0 (partial recovery)
4. Type symmetry: all holders receive same per-ticket payout S*R

Usage:
    uv run python examples/dealer_ring/example9_partial_recovery.py

Output:
    examples/dealer_ring/out/example9_report.html
"""

from decimal import Decimal
from pathlib import Path

from bilancio.dealer import (
    DealerRingConfig,
    DealerRingSimulation,
    Ticket,
    TraderState,
    recompute_dealer_state,
)


def setup_example9() -> DealerRingSimulation:
    """Set up Example 9: Partial-recovery default with R=0.375."""
    config = DealerRingConfig(
        dealer_share=Decimal("1.0"),
        vbt_share=Decimal("0.0"),
        N_max=0,
        max_days=2,
        seed=42,
        vbt_anchors={
            "short": (Decimal("1.00"), Decimal("0.30")),
            "mid": (Decimal("1.00"), Decimal("0.30")),
            "long": (Decimal("1.00"), Decimal("0.30")),
        },
    )

    sim = DealerRingSimulation(config)

    # Create issuer I with limited cash (C=3, but owes 8)
    issuer = TraderState(agent_id="issuer_I", cash=Decimal("3.00"))
    sim.traders[issuer.agent_id] = issuer

    # Create trader K who holds 3 tickets
    trader_k = TraderState(agent_id="trader_K", cash=Decimal("0.00"))
    sim.traders[trader_k.agent_id] = trader_k

    # Set up dealer D with 3 maturing tickets
    dealer = sim.dealers["mid"]
    dealer.cash = Decimal("10.00")  # Starting cash

    # Create 3 tickets for dealer (q_D = 3)
    for i in range(3):
        ticket = Ticket(
            id=f"T_D{i}",
            issuer_id=issuer.agent_id,
            owner_id=dealer.agent_id,
            face=Decimal(1),
            maturity_day=sim.day + 1,  # Matures tomorrow
            remaining_tau=1,
            bucket_id="mid",
            serial=100 + i,
        )
        dealer.inventory.append(ticket)
        sim.all_tickets[ticket.id] = ticket
        issuer.obligations.append(ticket)

    # Set up VBT with 2 maturing tickets (q_V = 2)
    vbt = sim.vbts["mid"]
    vbt.cash = Decimal("5.00")

    for i in range(2):
        ticket = Ticket(
            id=f"T_V{i}",
            issuer_id=issuer.agent_id,
            owner_id=vbt.agent_id,
            face=Decimal(1),
            maturity_day=sim.day + 1,  # Matures tomorrow
            remaining_tau=1,
            bucket_id="mid",
            serial=200 + i,
        )
        vbt.inventory.append(ticket)
        sim.all_tickets[ticket.id] = ticket
        issuer.obligations.append(ticket)

    # Create 3 tickets for trader K (q_K = 3)
    for i in range(3):
        ticket = Ticket(
            id=f"T_K{i}",
            issuer_id=issuer.agent_id,
            owner_id=trader_k.agent_id,
            face=Decimal(1),
            maturity_day=sim.day + 1,  # Matures tomorrow
            remaining_tau=1,
            bucket_id="mid",
            serial=300 + i,
        )
        trader_k.tickets_owned.append(ticket)
        sim.all_tickets[ticket.id] = ticket
        issuer.obligations.append(ticket)

    recompute_dealer_state(dealer, vbt, sim.params)

    return sim


def verify_initial_state(sim: DealerRingSimulation) -> dict:
    """Verify initial state and record values."""
    print("\n=== Initial State (Before Settlement) ===")

    issuer = sim.traders["issuer_I"]
    dealer = sim.dealers["mid"]
    vbt = sim.vbts["mid"]
    trader_k = sim.traders["trader_K"]

    # Count tickets
    dealer_tickets = [t for t in dealer.inventory if t.issuer_id == issuer.agent_id]
    vbt_tickets = [t for t in vbt.inventory if t.issuer_id == issuer.agent_id]
    trader_tickets = trader_k.tickets_owned

    print(f"Issuer I: cash={issuer.cash}, obligations={len(issuer.obligations)}")
    print(f"Dealer D: cash={dealer.cash}, tickets on I = {len(dealer_tickets)}")
    print(f"VBT: cash={vbt.cash}, tickets on I = {len(vbt_tickets)}")
    print(f"Trader K: cash={trader_k.cash}, tickets on I = {len(trader_tickets)}")

    total_tickets = len(dealer_tickets) + len(vbt_tickets) + len(trader_tickets)
    print(f"\nTotal maturing tickets: N_I(t) = {total_tickets}")
    print(f"Total due: D_I(t) = {total_tickets} (face S=1)")

    # Expected recovery
    R = issuer.cash / Decimal(total_tickets)
    print(f"Recovery rate: R_I(t) = {issuer.cash}/{total_tickets} = {R}")

    assert len(dealer_tickets) == 3, f"Dealer should have 3 tickets, got {len(dealer_tickets)}"
    assert len(vbt_tickets) == 2, f"VBT should have 2 tickets, got {len(vbt_tickets)}"
    assert len(trader_tickets) == 3, f"Trader K should have 3 tickets, got {len(trader_tickets)}"
    assert total_tickets == 8, f"Total should be 8 tickets, got {total_tickets}"
    assert issuer.cash == Decimal("3.00"), f"Issuer cash should be 3, got {issuer.cash}"

    print("\n✓ Initial state verified!")

    return {
        "issuer_cash": issuer.cash,
        "dealer_cash": dealer.cash,
        "vbt_cash": vbt.cash,
        "trader_cash": trader_k.cash,
        "dealer_tickets": len(dealer_tickets),
        "vbt_tickets": len(vbt_tickets),
        "trader_tickets": len(trader_tickets),
        "total_tickets": total_tickets,
        "recovery_rate": R,
    }


def run_settlement(sim: DealerRingSimulation) -> None:
    """Run settlement by advancing the day."""
    print("\n=== Settlement Phase ===")

    # Advance to day 1 (maturity day)
    sim.day = 1
    sim.events.log_day_start(1)
    sim._update_maturities()
    sim._rebucket_tickets()

    # Process settlements
    sim._settle_maturing_debt()

    print("Settlement processed.")


def verify_settlement(sim: DealerRingSimulation, before: dict) -> None:
    """Verify settlement results match specification."""
    print("\n=== Settlement Verification ===")

    issuer = sim.traders["issuer_I"]
    dealer = sim.dealers["mid"]
    vbt = sim.vbts["mid"]
    trader_k = sim.traders["trader_K"]

    R = before["recovery_rate"]  # 3/8 = 0.375

    # Expected payouts
    expected_dealer_payout = 3 * 1 * R  # q_D * S * R = 1.125
    expected_vbt_payout = 2 * 1 * R      # q_V * S * R = 0.75
    expected_trader_payout = 3 * 1 * R   # q_K * S * R = 1.125

    print(f"Expected payouts (q * S * R = q * 0.375):")
    print(f"  Dealer D: 3 * 0.375 = {expected_dealer_payout}")
    print(f"  VBT: 2 * 0.375 = {expected_vbt_payout}")
    print(f"  Trader K: 3 * 0.375 = {expected_trader_payout}")

    # Actual changes
    dealer_delta = dealer.cash - before["dealer_cash"]
    vbt_delta = vbt.cash - before["vbt_cash"]
    trader_delta = trader_k.cash - before["trader_cash"]

    print(f"\nActual cash changes:")
    print(f"  Dealer D: {before['dealer_cash']} -> {dealer.cash} (delta = {dealer_delta})")
    print(f"  VBT: {before['vbt_cash']} -> {vbt.cash} (delta = {vbt_delta})")
    print(f"  Trader K: {before['trader_cash']} -> {trader_k.cash} (delta = {trader_delta})")

    # Allow small tolerance for decimal arithmetic
    tolerance = Decimal("0.0001")

    # 1. Cash conservation
    total_payout = dealer_delta + vbt_delta + trader_delta
    assert abs(total_payout - before["issuer_cash"]) < tolerance, \
        f"Total payout {total_payout} should equal issuer cash {before['issuer_cash']}"
    print(f"\n✓ Check 1: Cash conservation - total payout = {total_payout} = issuer cash outflow")

    # 2. Ticket deletion
    dealer_remaining = [t for t in dealer.inventory if t.issuer_id == issuer.agent_id and t.remaining_tau <= 0]
    vbt_remaining = [t for t in vbt.inventory if t.issuer_id == issuer.agent_id and t.remaining_tau <= 0]
    trader_remaining = [t for t in trader_k.tickets_owned if t.issuer_id == issuer.agent_id and t.remaining_tau <= 0]

    # All matured tickets should be deleted
    assert len(dealer_remaining) == 0, f"Dealer should have 0 matured tickets, got {len(dealer_remaining)}"
    assert len(vbt_remaining) == 0, f"VBT should have 0 matured tickets, got {len(vbt_remaining)}"
    assert len(trader_remaining) == 0, f"Trader should have 0 matured tickets, got {len(trader_remaining)}"
    print(f"✓ Check 2: Ticket deletion - all 8 matured tickets removed")

    # 3. Issuer cash to zero
    assert issuer.cash == Decimal("0"), f"Issuer cash should be 0 after partial recovery, got {issuer.cash}"
    print(f"✓ Check 3: Issuer cash to zero - C_I(t+) = {issuer.cash}")

    # 4. Type symmetry (per-ticket payout is same for all)
    per_ticket_dealer = dealer_delta / 3
    per_ticket_vbt = vbt_delta / 2
    per_ticket_trader = trader_delta / 3

    assert abs(per_ticket_dealer - per_ticket_vbt) < tolerance, \
        f"Per-ticket payout differs: dealer={per_ticket_dealer}, vbt={per_ticket_vbt}"
    assert abs(per_ticket_dealer - per_ticket_trader) < tolerance, \
        f"Per-ticket payout differs: dealer={per_ticket_dealer}, trader={per_ticket_trader}"
    assert abs(per_ticket_dealer - R) < tolerance, \
        f"Per-ticket payout {per_ticket_dealer} should equal R={R}"
    print(f"✓ Check 4: Type symmetry - per-ticket payout S*R = {R} for all holders")

    print("\n✓ All settlement checks passed!")


def main():
    sim = setup_example9()
    sim._capture_snapshot()

    print("Example 9: Partial-Recovery Default (R=0.375)")
    print("=" * 60)

    before = verify_initial_state(sim)
    run_settlement(sim)
    verify_settlement(sim, before)

    # Log final state
    dealer = sim.dealers["mid"]
    vbt = sim.vbts["mid"]
    recompute_dealer_state(dealer, vbt, sim.params)

    sim.events.log_quote(
        day=1,
        bucket="mid",
        dealer_bid=dealer.bid,
        dealer_ask=dealer.ask,
        vbt_bid=vbt.B,
        vbt_ask=vbt.A,
        inventory=dealer.a,
        capacity=dealer.X_star,
        is_pinned_bid=dealer.is_pinned_bid,
        is_pinned_ask=dealer.is_pinned_ask,
    )

    sim._capture_snapshot()

    # Export HTML report
    out_dir = Path(__file__).parent / "out"
    out_dir.mkdir(exist_ok=True)
    out_path = out_dir / "example9_report.html"

    sim.to_html(
        out_path,
        title="Example 9: Partial-Recovery Default (R=0.375)",
        subtitle="Multiple claimant types: Dealer (3), VBT (2), Trader (3)",
    )

    print(f"\nReport saved to: {out_path}")
    print("\n✓ All Example 9 checks passed!")


if __name__ == "__main__":
    main()



################################################################################
# FILE: example10_trader_rebucket.py
# PATH: examples/dealer_ring/example10_trader_rebucket.py
################################################################################

"""
Example 10: Trader-Held Rebucketing Without Dealer-Dealer Transfer.

From the dealer ring specification:
When a trader holds a ticket that moves across a bucket boundary, only the
ticket's bucket_id changes. No internal sale occurs (contrast with Event 11
for dealer-held tickets).

Setup:
- Bucket ranges: Short (1-3), Mid (4-8), Long (>=9)
- Trader T holds ticket T* with remaining_tau = 9 (Long bucket)
- Dealers D_Long, D_Mid with arbitrary states
- At t2: tau decrements 9 -> 8, bucket changes Long -> Mid

Rebucketing for trader-held ticket:
- Only bucket_id tag changes
- No cash movement
- Dealer states unchanged
- Ownership stays with trader

Contrast with Event 11:
- If dealer held the ticket, internal sale would occur
- Old dealer sells to new dealer at receiving bucket's mid M
- Both dealers' cash and inventory would change

Harness checks:
1. Ownership invariance: ticket owner remains T
2. No cash movement: all entities' cash unchanged
3. Dealer states unchanged: (x, C) of D_Long and D_Mid identical
4. Bucket_id updates: Long -> Mid

Usage:
    uv run python examples/dealer_ring/example10_trader_rebucket.py

Output:
    examples/dealer_ring/out/example10_report.html
"""

from decimal import Decimal
from pathlib import Path

from bilancio.dealer import (
    DealerRingConfig,
    DealerRingSimulation,
    Ticket,
    TraderState,
    recompute_dealer_state,
)


def setup_example10() -> DealerRingSimulation:
    """Set up Example 10: Trader-held rebucketing."""
    config = DealerRingConfig(
        dealer_share=Decimal("1.0"),
        vbt_share=Decimal("0.0"),
        N_max=0,
        max_days=2,
        seed=42,
        vbt_anchors={
            "short": (Decimal("1.00"), Decimal("0.30")),
            "mid": (Decimal("1.00"), Decimal("0.30")),
            "long": (Decimal("1.00"), Decimal("0.30")),
        },
    )

    sim = DealerRingSimulation(config)

    # Create issuer
    issuer = TraderState(agent_id="issuer_J", cash=Decimal("100.00"))
    sim.traders[issuer.agent_id] = issuer

    # Create trader T who holds the migrating ticket
    trader_t = TraderState(agent_id="trader_T", cash=Decimal("5.00"))
    sim.traders[trader_t.agent_id] = trader_t

    # Set up dealers with initial state
    dealer_long = sim.dealers["long"]
    dealer_mid = sim.dealers["mid"]
    dealer_long.cash = Decimal("2.00")
    dealer_mid.cash = Decimal("3.00")

    # Create ticket T* for trader T - starts in Long bucket (tau=9)
    ticket_t = Ticket(
        id="T_star",
        issuer_id=issuer.agent_id,
        owner_id=trader_t.agent_id,
        face=Decimal(1),
        maturity_day=sim.day + 9,  # Matures in 9 days
        remaining_tau=9,  # Starts in Long bucket (tau >= 9)
        bucket_id="long",
        serial=1,
    )
    trader_t.tickets_owned.append(ticket_t)
    sim.all_tickets[ticket_t.id] = ticket_t
    issuer.obligations.append(ticket_t)

    # Give dealers some initial inventory (to show they're unaffected)
    for i in range(2):
        d_ticket = Ticket(
            id=f"D_long_{i}",
            issuer_id=issuer.agent_id,
            owner_id=dealer_long.agent_id,
            face=Decimal(1),
            maturity_day=200,
            remaining_tau=15,  # Stays in Long
            bucket_id="long",
            serial=100 + i,
        )
        dealer_long.inventory.append(d_ticket)
        sim.all_tickets[d_ticket.id] = d_ticket

    for i in range(2):
        d_ticket = Ticket(
            id=f"D_mid_{i}",
            issuer_id=issuer.agent_id,
            owner_id=dealer_mid.agent_id,
            face=Decimal(1),
            maturity_day=200,
            remaining_tau=6,  # Stays in Mid
            bucket_id="mid",
            serial=200 + i,
        )
        dealer_mid.inventory.append(d_ticket)
        sim.all_tickets[d_ticket.id] = d_ticket

    # Recompute dealer states
    recompute_dealer_state(dealer_long, sim.vbts["long"], sim.params)
    recompute_dealer_state(dealer_mid, sim.vbts["mid"], sim.params)

    return sim


def verify_initial_state(sim: DealerRingSimulation) -> None:
    """Verify initial state at t1."""
    print("\n=== Initial State (t1: Before Rebucketing) ===")

    trader_t = sim.traders["trader_T"]
    dealer_long = sim.dealers["long"]
    dealer_mid = sim.dealers["mid"]

    ticket = trader_t.tickets_owned[0]

    print(f"Trader T: cash={trader_t.cash}, tickets={len(trader_t.tickets_owned)}")
    print(f"  Ticket T*: bucket={ticket.bucket_id}, tau={ticket.remaining_tau}")
    print(f"\nDealer Long: cash={dealer_long.cash}, x={dealer_long.x}, a={dealer_long.a}")
    print(f"Dealer Mid: cash={dealer_mid.cash}, x={dealer_mid.x}, a={dealer_mid.a}")

    # Verify setup
    assert ticket.bucket_id == "long", f"T* should be in Long bucket, got {ticket.bucket_id}"
    assert ticket.remaining_tau == 9, f"T* tau should be 9, got {ticket.remaining_tau}"
    assert ticket.owner_id == trader_t.agent_id, f"T* should be owned by trader T"

    print("\n✓ Initial state verified!")


def run_rebucketing(sim: DealerRingSimulation) -> dict:
    """Run one day step which includes maturity update and rebucketing."""
    print("\n=== Day 1: Update Maturities and Rebucket ===")

    # Record state before
    trader_t = sim.traders["trader_T"]
    dealer_long = sim.dealers["long"]
    dealer_mid = sim.dealers["mid"]
    ticket = trader_t.tickets_owned[0]

    before = {
        "trader_cash": trader_t.cash,
        "ticket_bucket": ticket.bucket_id,
        "ticket_tau": ticket.remaining_tau,
        "ticket_owner": ticket.owner_id,
        "dealer_long_cash": dealer_long.cash,
        "dealer_long_x": dealer_long.x,
        "dealer_long_a": dealer_long.a,
        "dealer_mid_cash": dealer_mid.cash,
        "dealer_mid_x": dealer_mid.x,
        "dealer_mid_a": dealer_mid.a,
    }

    print(f"Before:")
    print(f"  Ticket T*: bucket={before['ticket_bucket']}, tau={before['ticket_tau']}")
    print(f"  Trader T cash: {before['trader_cash']}")
    print(f"  Dealer Long: cash={before['dealer_long_cash']}, x={before['dealer_long_x']}")
    print(f"  Dealer Mid: cash={before['dealer_mid_cash']}, x={before['dealer_mid_x']}")

    # Run phase 1: maturity updates and rebucketing
    sim.day = 1
    sim.events.log_day_start(1)
    sim._update_maturities()
    sim._rebucket_tickets()

    # Record state after
    after = {
        "trader_cash": trader_t.cash,
        "ticket_bucket": ticket.bucket_id,
        "ticket_tau": ticket.remaining_tau,
        "ticket_owner": ticket.owner_id,
        "dealer_long_cash": dealer_long.cash,
        "dealer_long_x": dealer_long.x,
        "dealer_long_a": dealer_long.a,
        "dealer_mid_cash": dealer_mid.cash,
        "dealer_mid_x": dealer_mid.x,
        "dealer_mid_a": dealer_mid.a,
    }

    print(f"\nAfter:")
    print(f"  Ticket T*: bucket={after['ticket_bucket']}, tau={after['ticket_tau']}")
    print(f"  Trader T cash: {after['trader_cash']}")
    print(f"  Dealer Long: cash={after['dealer_long_cash']}, x={after['dealer_long_x']}")
    print(f"  Dealer Mid: cash={after['dealer_mid_cash']}, x={after['dealer_mid_x']}")

    return {"before": before, "after": after}


def verify_rebucketing(sim: DealerRingSimulation, results: dict) -> None:
    """Verify rebucketing results for trader-held ticket."""
    print("\n=== Rebucketing Verification ===")

    before = results["before"]
    after = results["after"]
    trader_t = sim.traders["trader_T"]

    # 1. Ownership invariance
    assert after["ticket_owner"] == trader_t.agent_id, \
        f"Ticket owner should remain trader_T, got {after['ticket_owner']}"
    print(f"✓ Ownership invariance: ticket owner remains trader_T")

    # 2. No cash movement for trader
    assert after["trader_cash"] == before["trader_cash"], \
        f"Trader cash should be unchanged: {before['trader_cash']} vs {after['trader_cash']}"
    print(f"✓ No cash movement for trader: {after['trader_cash']}")

    # 3. Dealer Long unchanged
    assert after["dealer_long_cash"] == before["dealer_long_cash"], \
        f"Dealer Long cash should be unchanged"
    assert after["dealer_long_x"] == before["dealer_long_x"], \
        f"Dealer Long x should be unchanged"
    assert after["dealer_long_a"] == before["dealer_long_a"], \
        f"Dealer Long a should be unchanged"
    print(f"✓ Dealer Long unchanged: cash={after['dealer_long_cash']}, x={after['dealer_long_x']}")

    # 4. Dealer Mid unchanged
    assert after["dealer_mid_cash"] == before["dealer_mid_cash"], \
        f"Dealer Mid cash should be unchanged"
    assert after["dealer_mid_x"] == before["dealer_mid_x"], \
        f"Dealer Mid x should be unchanged"
    assert after["dealer_mid_a"] == before["dealer_mid_a"], \
        f"Dealer Mid a should be unchanged"
    print(f"✓ Dealer Mid unchanged: cash={after['dealer_mid_cash']}, x={after['dealer_mid_x']}")

    # 5. Bucket_id updated
    assert after["ticket_bucket"] == "mid", \
        f"Ticket bucket should change to mid, got {after['ticket_bucket']}"
    print(f"✓ Bucket_id updated: long -> mid")

    # 6. Tau decremented
    assert after["ticket_tau"] == before["ticket_tau"] - 1, \
        f"Tau should decrement by 1: {before['ticket_tau']} -> {after['ticket_tau']}"
    print(f"✓ Tau decremented: {before['ticket_tau']} -> {after['ticket_tau']}")

    print("\n✓ All rebucketing checks passed!")


def verify_event_11_not_triggered(sim: DealerRingSimulation) -> None:
    """Verify that Event 11 (dealer-dealer transfer) was NOT triggered."""
    print("\n=== Event 11 Not Triggered ===")

    # Get rebucket events from log
    rebucket_events = [
        e for e in sim.events.events
        if e.get("event_type") == "rebucket"
    ]

    print(f"Rebucket events logged: {len(rebucket_events)}")

    # For trader-held tickets, no rebucket event should be logged
    # (the rebucket event is only logged for dealer/VBT transfers)
    trader_rebuckets = [
        e for e in rebucket_events
        if e.get("holder_type") == "trader"
    ]

    # Actually, looking at the code, trader rebuckets don't log events at all
    # Only dealer and VBT rebuckets log events
    print(f"Trader rebucket events: {len(trader_rebuckets)}")
    print(f"Dealer rebucket events: {len([e for e in rebucket_events if e.get('holder_type') == 'dealer'])}")

    print("\nWhat does NOT happen (contrast to Event 11):")
    print("  - If dealer held the ticket, internal sale would occur")
    print("  - Old dealer would sell to new dealer at receiving bucket's mid M")
    print("  - Both dealers' cash and inventory would change")
    print("\nWhat happens for trader-held:")
    print("  - Only bucket_id tag updated")
    print("  - Owner unchanged (T)")
    print("  - No cash movement anywhere")

    print("\n✓ Event 11 (dealer transfer) not triggered for trader-held ticket!")


def main():
    sim = setup_example10()
    sim._capture_snapshot()

    print("Example 10: Trader-Held Rebucketing")
    print("=" * 60)

    verify_initial_state(sim)
    results = run_rebucketing(sim)
    verify_rebucketing(sim, results)
    verify_event_11_not_triggered(sim)

    # Log quotes after rebucketing
    for bucket_id in ["long", "mid"]:
        dealer = sim.dealers[bucket_id]
        vbt = sim.vbts[bucket_id]
        recompute_dealer_state(dealer, vbt, sim.params)

        sim.events.log_quote(
            day=1,
            bucket=bucket_id,
            dealer_bid=dealer.bid,
            dealer_ask=dealer.ask,
            vbt_bid=vbt.B,
            vbt_ask=vbt.A,
            inventory=dealer.a,
            capacity=dealer.X_star,
            is_pinned_bid=dealer.is_pinned_bid,
            is_pinned_ask=dealer.is_pinned_ask,
        )

    sim._capture_snapshot()

    # Export HTML report
    out_dir = Path(__file__).parent / "out"
    out_dir.mkdir(exist_ok=True)
    out_path = out_dir / "example10_report.html"

    sim.to_html(
        out_path,
        title="Example 10: Trader-Held Rebucketing",
        subtitle="Only bucket_id changes, no dealer-dealer transfer",
    )

    print(f"\nReport saved to: {out_path}")
    print("\n✓ All Example 10 checks passed!")


if __name__ == "__main__":
    main()



################################################################################
# FILE: example11_partial_recovery.py
# PATH: examples/dealer_ring/example11_partial_recovery.py
################################################################################

"""
Example 11: Partial-Recovery Default with Multiple Claimant Types (R=0.6).

From the dealer ring specification (Section 12):
Tests proportional recovery settlement when a single issuer defaults and
multiple claimant types (dealer D, VBT, trader K) hold maturing tickets.

Setup:
- Ticket size S = 1
- Issuer I with N_I(t) = 5 maturing tickets, C_I(t) = 3
- Recovery rate R = C_I(t) / D_I(t) = 3/5 = 0.6
- Holder composition: q_D = 2, q_VBT = 2, q_K = 1

Settlement with proportional recovery R = 0.6:
- Dealer D: q_D * S * R = 2 * 1 * 0.6 = 1.2
- VBT: q_VBT * S * R = 2 * 1 * 0.6 = 1.2
- Trader K: q_K * S * R = 1 * 1 * 0.6 = 0.6

After settlement:
- Issuer cash: 3 - 0.6*5 = 0
- All 5 maturing tickets deleted
- Default recorded with R = 0.6

Harness checks:
1. Cash conservation: total paid = 1.2 + 1.2 + 0.6 = 3 = R * D_I(t)
2. Ticket deletion: all 5 maturing tickets removed
3. Issuer cash to zero: C_I(t+) = 0
4. Type symmetry: all holders receive same per-ticket payout S*R = 0.6

Usage:
    uv run python examples/dealer_ring/example11_partial_recovery.py

Output:
    examples/dealer_ring/out/example11_report.html
"""

from decimal import Decimal
from pathlib import Path

from bilancio.dealer import (
    DealerRingConfig,
    DealerRingSimulation,
    Ticket,
    TraderState,
    recompute_dealer_state,
)


def setup_example11() -> DealerRingSimulation:
    """Set up Example 9: Partial-recovery default with multiple claimants."""
    config = DealerRingConfig(
        dealer_share=Decimal("1.0"),
        vbt_share=Decimal("0.0"),
        N_max=0,
        max_days=2,
        seed=42,
        vbt_anchors={
            "short": (Decimal("1.00"), Decimal("0.30")),
            "mid": (Decimal("1.00"), Decimal("0.30")),
            "long": (Decimal("1.00"), Decimal("0.30")),
        },
        enable_vbt_anchor_updates=False,  # Test settlement in isolation
    )

    sim = DealerRingSimulation(config)

    # Create issuer with cash = 3 (will partially default on 5 tickets)
    issuer = TraderState(
        agent_id="issuer_I",
        cash=Decimal("3.00"),
    )
    sim.traders[issuer.agent_id] = issuer

    # Create trader K
    trader_k = TraderState(
        agent_id="trader_K",
        cash=Decimal("0.00"),
    )
    sim.traders[trader_k.agent_id] = trader_k

    # Get dealer and VBT
    dealer = sim.dealers["mid"]
    vbt = sim.vbts["mid"]

    # Set up initial cash for dealer and VBT
    dealer.cash = Decimal("5.00")
    vbt.cash = Decimal("10.00")

    # Create tickets - q_D = 2 for dealer
    for i in range(2):
        ticket = Ticket(
            id=f"D{i}",
            issuer_id=issuer.agent_id,
            owner_id=dealer.agent_id,
            face=Decimal(1),
            maturity_day=1,  # Matures at day 1
            remaining_tau=6,
            bucket_id="mid",
            serial=i,
        )
        dealer.inventory.append(ticket)
        sim.all_tickets[ticket.id] = ticket
        issuer.obligations.append(ticket)

    # Create tickets - q_VBT = 2 for VBT
    for i in range(2):
        ticket = Ticket(
            id=f"V{i}",
            issuer_id=issuer.agent_id,
            owner_id=vbt.agent_id,
            face=Decimal(1),
            maturity_day=1,  # Matures at day 1
            remaining_tau=6,
            bucket_id="mid",
            serial=10 + i,
        )
        vbt.inventory.append(ticket)
        sim.all_tickets[ticket.id] = ticket
        issuer.obligations.append(ticket)

    # Create ticket - q_K = 1 for trader K
    ticket = Ticket(
        id="K0",
        issuer_id=issuer.agent_id,
        owner_id=trader_k.agent_id,
        face=Decimal(1),
        maturity_day=1,  # Matures at day 1
        remaining_tau=6,
        bucket_id="mid",
        serial=20,
    )
    trader_k.tickets_owned.append(ticket)
    sim.all_tickets[ticket.id] = ticket
    issuer.obligations.append(ticket)

    # Recompute dealer state
    recompute_dealer_state(dealer, vbt, sim.params)

    return sim


def verify_initial_state(sim: DealerRingSimulation) -> None:
    """Verify initial state before settlement."""
    print("\n=== Initial State (Before Settlement) ===")

    issuer = sim.traders["issuer_I"]
    dealer = sim.dealers["mid"]
    vbt = sim.vbts["mid"]
    trader_k = sim.traders["trader_K"]

    print(f"Issuer I: cash={issuer.cash}, obligations={len(issuer.obligations)}")
    print(f"Dealer D: cash={dealer.cash}, inventory={len(dealer.inventory)}")
    print(f"VBT: cash={vbt.cash}, inventory={len(vbt.inventory)}")
    print(f"Trader K: cash={trader_k.cash}, tickets={len(trader_k.tickets_owned)}")

    # Count maturing tickets
    maturing = [t for t in sim.all_tickets.values() if t.maturity_day == 1]
    total_due = sum(t.face for t in maturing)
    expected_R = issuer.cash / total_due

    print(f"\nMaturing at day 1:")
    print(f"  Total tickets: {len(maturing)}")
    print(f"  Total due: {total_due}")
    print(f"  Issuer cash: {issuer.cash}")
    print(f"  Recovery rate R = {issuer.cash}/{total_due} = {expected_R}")

    # Verify setup
    assert len(issuer.obligations) == 5, f"Issuer should have 5 obligations"
    assert issuer.cash == Decimal("3.00"), f"Issuer cash should be 3"
    assert len(dealer.inventory) == 2, f"Dealer should have 2 tickets"
    assert len([t for t in vbt.inventory if t.issuer_id == issuer.agent_id]) == 2, \
        f"VBT should have 2 tickets from issuer"
    assert len(trader_k.tickets_owned) == 1, f"Trader K should have 1 ticket"

    print("\n✓ Initial state verified!")


def run_settlement(sim: DealerRingSimulation) -> dict:
    """Run settlement and return results."""
    print("\n=== Settlement Phase ===")

    # Record state before settlement
    issuer = sim.traders["issuer_I"]
    dealer = sim.dealers["mid"]
    vbt = sim.vbts["mid"]
    trader_k = sim.traders["trader_K"]

    before = {
        "issuer_cash": issuer.cash,
        "dealer_cash": dealer.cash,
        "dealer_inv": len(dealer.inventory),
        "vbt_cash": vbt.cash,
        "vbt_inv": len(vbt.inventory),
        "trader_cash": trader_k.cash,
        "trader_inv": len(trader_k.tickets_owned),
        "total_tickets": len(sim.all_tickets),
    }

    print(f"Before settlement:")
    print(f"  Issuer cash: {before['issuer_cash']}")
    print(f"  Dealer: cash={before['dealer_cash']}, inv={before['dealer_inv']}")
    print(f"  VBT: cash={before['vbt_cash']}, inv={before['vbt_inv']}")
    print(f"  Trader K: cash={before['trader_cash']}, inv={before['trader_inv']}")

    # Run day 1 (includes settlement)
    sim.day = 1
    sim.events.log_day_start(1)
    sim._settle_maturing_debt()

    # Record state after settlement
    after = {
        "issuer_cash": issuer.cash,
        "dealer_cash": dealer.cash,
        "dealer_inv": len(dealer.inventory),
        "vbt_cash": vbt.cash,
        "vbt_inv": len(vbt.inventory),
        "trader_cash": trader_k.cash,
        "trader_inv": len(trader_k.tickets_owned),
        "total_tickets": len([t for t in sim.all_tickets.values() if t.maturity_day != 1]),
    }

    print(f"\nAfter settlement:")
    print(f"  Issuer cash: {after['issuer_cash']}")
    print(f"  Dealer: cash={after['dealer_cash']}, inv={after['dealer_inv']}")
    print(f"  VBT: cash={after['vbt_cash']}, inv={after['vbt_inv']}")
    print(f"  Trader K: cash={after['trader_cash']}, inv={after['trader_inv']}")

    return {"before": before, "after": after}


def verify_settlement(sim: DealerRingSimulation, results: dict) -> None:
    """Verify settlement results match specification."""
    print("\n=== Settlement Verification ===")

    before = results["before"]
    after = results["after"]

    # Expected values
    R = Decimal("0.6")  # Recovery rate = 3/5
    S = Decimal("1")    # Ticket face

    # Expected payouts
    expected_dealer_payout = 2 * S * R  # 1.2
    expected_vbt_payout = 2 * S * R     # 1.2
    expected_trader_payout = 1 * S * R  # 0.6
    expected_total_paid = 5 * S * R     # 3.0

    print(f"Expected recovery rate R = {R}")
    print(f"Expected payouts:")
    print(f"  Dealer D: q_D * S * R = 2 * 1 * 0.6 = {expected_dealer_payout}")
    print(f"  VBT: q_VBT * S * R = 2 * 1 * 0.6 = {expected_vbt_payout}")
    print(f"  Trader K: q_K * S * R = 1 * 1 * 0.6 = {expected_trader_payout}")

    # Verify issuer cash to zero
    assert after["issuer_cash"] == Decimal("0"), \
        f"Issuer cash should be 0, got {after['issuer_cash']}"
    print(f"\n✓ Issuer cash to zero: {after['issuer_cash']}")

    # Verify dealer payout
    dealer_gain = after["dealer_cash"] - before["dealer_cash"]
    assert abs(dealer_gain - expected_dealer_payout) < Decimal("0.0001"), \
        f"Dealer should gain {expected_dealer_payout}, got {dealer_gain}"
    print(f"✓ Dealer payout: +{dealer_gain} (expected {expected_dealer_payout})")

    # Verify VBT payout
    vbt_gain = after["vbt_cash"] - before["vbt_cash"]
    assert abs(vbt_gain - expected_vbt_payout) < Decimal("0.0001"), \
        f"VBT should gain {expected_vbt_payout}, got {vbt_gain}"
    print(f"✓ VBT payout: +{vbt_gain} (expected {expected_vbt_payout})")

    # Verify trader K payout
    trader_gain = after["trader_cash"] - before["trader_cash"]
    assert abs(trader_gain - expected_trader_payout) < Decimal("0.0001"), \
        f"Trader K should gain {expected_trader_payout}, got {trader_gain}"
    print(f"✓ Trader K payout: +{trader_gain} (expected {expected_trader_payout})")

    # Verify cash conservation
    total_paid = dealer_gain + vbt_gain + trader_gain
    assert abs(total_paid - expected_total_paid) < Decimal("0.0001"), \
        f"Total paid should be {expected_total_paid}, got {total_paid}"
    print(f"\n✓ Cash conservation: {total_paid} = R * D_I(t) = 0.6 * 5 = 3")

    # Verify ticket deletion
    # Dealer inventory should decrease by 2
    dealer_inv_change = after["dealer_inv"] - before["dealer_inv"]
    assert dealer_inv_change == -2, \
        f"Dealer inventory should decrease by 2, got {dealer_inv_change}"

    # VBT inventory should decrease by 2 (from issuer I)
    vbt_inv_change = after["vbt_inv"] - before["vbt_inv"]
    assert vbt_inv_change == -2, \
        f"VBT inventory should decrease by 2, got {vbt_inv_change}"

    # Trader K inventory should decrease by 1
    trader_inv_change = after["trader_inv"] - before["trader_inv"]
    assert trader_inv_change == -1, \
        f"Trader K inventory should decrease by 1, got {trader_inv_change}"

    print(f"✓ Ticket deletion: dealer -2, VBT -2, trader K -1 (all 5 deleted)")

    # Verify type symmetry (same per-ticket payout)
    per_ticket = S * R
    print(f"\n✓ Type symmetry: all holders receive S*R = {per_ticket} per ticket")

    print("\n✓ All settlement checks passed!")


def verify_loss_rate(sim: DealerRingSimulation) -> None:
    """Verify the bucket loss rate computation."""
    print("\n=== Loss Rate Verification ===")

    # Get loss rate from events
    loss_rate = sim.events.get_bucket_loss_rate(day=1, bucket_id="mid")

    # Expected: 1 - R = 1 - 0.6 = 0.4
    expected_loss = Decimal("0.4")

    print(f"Bucket loss rate: {loss_rate}")
    print(f"Expected: 1 - R = 1 - 0.6 = {expected_loss}")

    assert abs(loss_rate - expected_loss) < Decimal("0.0001"), \
        f"Loss rate should be {expected_loss}, got {loss_rate}"

    print("✓ Loss rate verified!")


def main():
    sim = setup_example11()
    sim._capture_snapshot()

    print("Example 11: Partial-Recovery Default (R=0.6)")
    print("=" * 60)

    verify_initial_state(sim)
    results = run_settlement(sim)
    verify_settlement(sim, results)
    verify_loss_rate(sim)

    # Log final quotes (after settlement)
    dealer = sim.dealers["mid"]
    vbt = sim.vbts["mid"]

    # Recompute after settlement
    recompute_dealer_state(dealer, vbt, sim.params)

    sim.events.log_quote(
        day=1,
        bucket="mid",
        dealer_bid=dealer.bid,
        dealer_ask=dealer.ask,
        vbt_bid=vbt.B,
        vbt_ask=vbt.A,
        inventory=dealer.a,
        capacity=dealer.X_star,
        is_pinned_bid=dealer.is_pinned_bid,
        is_pinned_ask=dealer.is_pinned_ask,
    )

    sim._capture_snapshot()

    # Export HTML report
    out_dir = Path(__file__).parent / "out"
    out_dir.mkdir(exist_ok=True)
    out_path = out_dir / "example11_report.html"

    sim.to_html(
        out_path,
        title="Example 11: Partial-Recovery Default (R=0.6)",
        subtitle="Multiple claimant types receive proportional recovery",
    )

    print(f"\nReport saved to: {out_path}")
    print("\n✓ All Example 11 checks passed!")


if __name__ == "__main__":
    main()



################################################################################
# FILE: example12_capacity_crossing.py
# PATH: examples/dealer_ring/example12_capacity_crossing.py
################################################################################

"""
Example 12: One-Ticket Trade Pushes Capacity Across an Integer.

From the dealer ring specification (Section 13):
Demonstrates how a single trade can cause K* (and hence X*, lambda, I) to
jump discretely when V crosses an integer boundary.

Setup:
- S=1, M=1.0, O=0.30, A=1.15, B=0.85
- Kernel formulas: V=Ma+C, K*=floor(V/M), X*=SK*, lambda=S/(X*+S), I=lambda*O

Case A: Up-jump K* : 3 -> 4 after one interior BUY
- Initial: a=2, C=1.97 => V=3.97, K*=3, X*=3
- x=2, lambda=1/4=0.25, I=0.075
- p(2)=0.97, b(2)=0.9325
- Interior BUY feasible: x+S=3 <= X*=3, C=1.97 >= b=0.9325
- After BUY: x=3, C=1.0375, V=4.0375, K*=4, X*=4
- lambda: 0.25 -> 0.20, I: 0.075 -> 0.06

Case B: Down-jump K* : 4 -> 3 after one interior SELL
- Initial: a=4, C=0.02 => V=4.02, K*=4, X*=4
- x=4, lambda=1/5=0.20, I=0.06
- p(4)=0.90, a(4)=0.93
- Interior SELL feasible: x=4 >= S=1
- After SELL: x=3, C=0.95, V=3.95, K*=3, X*=3
- lambda: 0.20 -> 0.25, I: 0.06 -> 0.075

Harness checks:
1. Capacity jump: K* changes by exactly ±1
2. Width jump: lambda and I change discretely
3. Feasibility: trades satisfy interior conditions
4. No clipping/passthrough: trades execute at interior quotes

Usage:
    uv run python examples/dealer_ring/example12_capacity_crossing.py

Output:
    examples/dealer_ring/out/example12_report.html
"""

from decimal import Decimal
from pathlib import Path

from bilancio.dealer import (
    DealerRingConfig,
    DealerRingSimulation,
    Ticket,
    TraderState,
    recompute_dealer_state,
    can_interior_buy,
    can_interior_sell,
)


def setup_case_a() -> DealerRingSimulation:
    """Set up Case A: Up-jump K* : 3 -> 4."""
    config = DealerRingConfig(
        dealer_share=Decimal("1.0"),
        vbt_share=Decimal("0.0"),
        N_max=0,
        max_days=1,
        seed=42,
        vbt_anchors={
            "short": (Decimal("1.00"), Decimal("0.30")),
            "mid": (Decimal("1.00"), Decimal("0.30")),
            "long": (Decimal("1.00"), Decimal("0.30")),
        },
    )

    sim = DealerRingSimulation(config)

    # Create issuer
    issuer = TraderState(agent_id="issuer", cash=Decimal("100.00"))
    sim.traders[issuer.agent_id] = issuer

    # Create seller
    seller = TraderState(agent_id="seller", cash=Decimal("0.00"))
    sim.traders[seller.agent_id] = seller

    # Set up dealer: a=2, C=1.97 => V=3.97, K*=3
    dealer = sim.dealers["mid"]
    dealer.cash = Decimal("1.97")

    for i in range(2):
        ticket = Ticket(
            id=f"D{i}",
            issuer_id=issuer.agent_id,
            owner_id=dealer.agent_id,
            face=Decimal(1),
            maturity_day=200,
            remaining_tau=6,
            bucket_id="mid",
            serial=i,
        )
        dealer.inventory.append(ticket)
        sim.all_tickets[ticket.id] = ticket
        issuer.obligations.append(ticket)

    # Create ticket for seller
    sell_ticket = Ticket(
        id="SELL1",
        issuer_id=issuer.agent_id,
        owner_id=seller.agent_id,
        face=Decimal(1),
        maturity_day=200,
        remaining_tau=6,
        bucket_id="mid",
        serial=10,
    )
    seller.tickets_owned.append(sell_ticket)
    sim.all_tickets[sell_ticket.id] = sell_ticket
    issuer.obligations.append(sell_ticket)

    # VBT needs inventory (backup)
    vbt = sim.vbts["mid"]
    vbt.cash = Decimal("10.00")

    recompute_dealer_state(dealer, vbt, sim.params)

    return sim


def setup_case_b() -> DealerRingSimulation:
    """Set up Case B: Down-jump K* : 4 -> 3."""
    config = DealerRingConfig(
        dealer_share=Decimal("1.0"),
        vbt_share=Decimal("0.0"),
        N_max=0,
        max_days=1,
        seed=42,
        vbt_anchors={
            "short": (Decimal("1.00"), Decimal("0.30")),
            "mid": (Decimal("1.00"), Decimal("0.30")),
            "long": (Decimal("1.00"), Decimal("0.30")),
        },
    )

    sim = DealerRingSimulation(config)

    # Create issuer
    issuer = TraderState(agent_id="issuer", cash=Decimal("100.00"))
    sim.traders[issuer.agent_id] = issuer

    # Create buyer
    buyer = TraderState(agent_id="buyer", cash=Decimal("10.00"))
    sim.traders[buyer.agent_id] = buyer

    # Set up dealer: a=4, C=0.02 => V=4.02, K*=4
    dealer = sim.dealers["mid"]
    dealer.cash = Decimal("0.02")

    for i in range(4):
        ticket = Ticket(
            id=f"D{i}",
            issuer_id=issuer.agent_id,
            owner_id=dealer.agent_id,
            face=Decimal(1),
            maturity_day=200,
            remaining_tau=6,
            bucket_id="mid",
            serial=i,
        )
        dealer.inventory.append(ticket)
        sim.all_tickets[ticket.id] = ticket
        issuer.obligations.append(ticket)

    # VBT (backup)
    vbt = sim.vbts["mid"]
    vbt.cash = Decimal("10.00")

    recompute_dealer_state(dealer, vbt, sim.params)

    return sim


def run_case_a(sim: DealerRingSimulation) -> None:
    """Case A: Up-jump K* : 3 -> 4 after one interior BUY."""
    print("\n=== CASE A: Up-Jump K* : 3 -> 4 ===")

    dealer = sim.dealers["mid"]
    vbt = sim.vbts["mid"]
    seller = sim.traders["seller"]
    ticket = seller.tickets_owned[0]

    # Verify initial state
    print("\nInitial state (just below integer boundary):")
    print(f"  a={dealer.a}, C={dealer.cash}")
    print(f"  V={dealer.V:.4f}, K*={dealer.K_star}, X*={dealer.X_star}")
    print(f"  x={dealer.x}, lambda={dealer.lambda_:.4f}, I={dealer.I:.4f}")
    print(f"  p(x)={dealer.midline:.4f}, b(x)={dealer.bid:.4f}")

    assert dealer.a == 2, f"a should be 2, got {dealer.a}"
    assert dealer.cash == Decimal("1.97"), f"C should be 1.97"
    assert dealer.K_star == 3, f"K* should be 3, got {dealer.K_star}"
    assert dealer.X_star == 3, f"X* should be 3, got {dealer.X_star}"
    assert abs(dealer.lambda_ - Decimal("0.25")) < Decimal("0.001"), f"lambda should be 0.25"
    assert abs(dealer.I - Decimal("0.075")) < Decimal("0.001"), f"I should be 0.075"

    # Verify feasibility
    can_buy = can_interior_buy(dealer, sim.params)
    print(f"\nFeasibility check:")
    print(f"  x + S = {dealer.x} + 1 = {dealer.x + 1} <= X* = {dealer.X_star}? {dealer.x + 1 <= dealer.X_star}")
    print(f"  C = {dealer.cash} >= b = {dealer.bid}? {dealer.cash >= dealer.bid}")
    print(f"  Interior BUY feasible: {can_buy}")
    assert can_buy, "Interior BUY should be feasible"

    # Record state before
    K_star_before = dealer.K_star
    lambda_before = dealer.lambda_
    I_before = dealer.I

    # Execute customer SELL (dealer BUYs)
    print(f"\nExecution (customer SELL; dealer BUYs at b={dealer.bid:.4f}):")
    result = sim.executor.execute_customer_sell(dealer, vbt, ticket)
    seller.cash += result.price
    seller.tickets_owned.remove(ticket)

    print(f"  Price: {result.price:.4f}")
    print(f"  Passthrough: {result.is_passthrough}")

    assert not result.is_passthrough, "Should be interior trade"
    assert abs(result.price - Decimal("0.9325")) < Decimal("0.001"), f"Price should be ~0.9325"

    # Verify post-trade state
    print(f"\nPost-trade state:")
    print(f"  a={dealer.a}, C={dealer.cash:.4f}")
    print(f"  V={dealer.V:.4f}, K*={dealer.K_star}, X*={dealer.X_star}")
    print(f"  x={dealer.x}, lambda={dealer.lambda_:.4f}, I={dealer.I:.4f}")

    # Verify capacity jump
    assert dealer.K_star == 4, f"K* should be 4 after trade, got {dealer.K_star}"
    assert dealer.X_star == 4, f"X* should be 4 after trade"
    print(f"\n✓ Capacity jump: K* {K_star_before} -> {dealer.K_star}")

    # Verify width jump
    assert abs(dealer.lambda_ - Decimal("0.20")) < Decimal("0.001"), f"lambda should be 0.20"
    assert abs(dealer.I - Decimal("0.06")) < Decimal("0.001"), f"I should be 0.06"
    print(f"✓ Width jump: lambda {lambda_before:.4f} -> {dealer.lambda_:.4f}, I {I_before:.4f} -> {dealer.I:.4f}")

    # Verify post-trade quotes
    # p(3) = 1 - 0.30/(4+2) * (3-2) = 1 - 0.05 = 0.95
    expected_midline = Decimal("0.95")
    assert abs(dealer.midline - expected_midline) < Decimal("0.001"), f"midline should be ~0.95"
    print(f"✓ New quotes at x={dealer.x}: p={dealer.midline:.4f}, a={dealer.ask:.4f}, b={dealer.bid:.4f}")

    print("\n✓ Case A passed!")


def run_case_b(sim: DealerRingSimulation) -> None:
    """Case B: Down-jump K* : 4 -> 3 after one interior SELL."""
    print("\n=== CASE B: Down-Jump K* : 4 -> 3 ===")

    dealer = sim.dealers["mid"]
    vbt = sim.vbts["mid"]
    buyer = sim.traders["buyer"]

    # Verify initial state
    print("\nInitial state (just above integer boundary):")
    print(f"  a={dealer.a}, C={dealer.cash}")
    print(f"  V={dealer.V:.4f}, K*={dealer.K_star}, X*={dealer.X_star}")
    print(f"  x={dealer.x}, lambda={dealer.lambda_:.4f}, I={dealer.I:.4f}")
    print(f"  p(x)={dealer.midline:.4f}, a(x)={dealer.ask:.4f}")

    assert dealer.a == 4, f"a should be 4, got {dealer.a}"
    assert dealer.cash == Decimal("0.02"), f"C should be 0.02"
    assert dealer.K_star == 4, f"K* should be 4, got {dealer.K_star}"
    assert dealer.X_star == 4, f"X* should be 4, got {dealer.X_star}"
    assert abs(dealer.lambda_ - Decimal("0.20")) < Decimal("0.001"), f"lambda should be 0.20"
    assert abs(dealer.I - Decimal("0.06")) < Decimal("0.001"), f"I should be 0.06"

    # Verify p(4) = 0.90
    # p(4) = 1 - 0.30/(4+2) * (4-2) = 1 - 0.05*2 = 0.90
    assert abs(dealer.midline - Decimal("0.90")) < Decimal("0.001"), f"p(4) should be 0.90"

    # Verify feasibility
    can_sell = can_interior_sell(dealer, sim.params)
    print(f"\nFeasibility check:")
    print(f"  x = {dealer.x} >= S = 1? {dealer.x >= 1}")
    print(f"  Interior SELL feasible: {can_sell}")
    assert can_sell, "Interior SELL should be feasible"

    # Record state before
    K_star_before = dealer.K_star
    lambda_before = dealer.lambda_
    I_before = dealer.I

    # Execute customer BUY (dealer SELLs)
    print(f"\nExecution (customer BUY; dealer SELLs at a={dealer.ask:.4f}):")
    result = sim.executor.execute_customer_buy(dealer, vbt, buyer.agent_id)
    buyer.cash -= result.price
    if result.ticket:
        buyer.tickets_owned.append(result.ticket)

    print(f"  Price: {result.price:.4f}")
    print(f"  Passthrough: {result.is_passthrough}")

    assert not result.is_passthrough, "Should be interior trade"
    assert abs(result.price - Decimal("0.93")) < Decimal("0.001"), f"Price should be ~0.93"

    # Verify post-trade state
    print(f"\nPost-trade state:")
    print(f"  a={dealer.a}, C={dealer.cash:.4f}")
    print(f"  V={dealer.V:.4f}, K*={dealer.K_star}, X*={dealer.X_star}")
    print(f"  x={dealer.x}, lambda={dealer.lambda_:.4f}, I={dealer.I:.4f}")

    # Verify capacity jump
    assert dealer.K_star == 3, f"K* should be 3 after trade, got {dealer.K_star}"
    assert dealer.X_star == 3, f"X* should be 3 after trade"
    print(f"\n✓ Capacity jump: K* {K_star_before} -> {dealer.K_star}")

    # Verify width jump (widens because capacity decreased)
    assert abs(dealer.lambda_ - Decimal("0.25")) < Decimal("0.001"), f"lambda should be 0.25"
    assert abs(dealer.I - Decimal("0.075")) < Decimal("0.001"), f"I should be 0.075"
    print(f"✓ Width jump: lambda {lambda_before:.4f} -> {dealer.lambda_:.4f}, I {I_before:.4f} -> {dealer.I:.4f}")

    # Verify post-trade quotes
    # p(3) = 1 - 0.30/(3+2) * (3 - 1.5) = 1 - 0.06 * 1.5 = 0.91
    expected_midline = Decimal("0.91")
    assert abs(dealer.midline - expected_midline) < Decimal("0.001"), f"midline should be ~0.91"
    print(f"✓ New quotes at x={dealer.x}: p={dealer.midline:.4f}, a={dealer.ask:.4f}, b={dealer.bid:.4f}")

    print("\n✓ Case B passed!")


def main():
    print("Example 11: Capacity Integer Crossing")
    print("=" * 60)

    # Case A: Up-jump
    sim_a = setup_case_a()
    sim_a._capture_snapshot()
    run_case_a(sim_a)

    # Log final state
    dealer_a = sim_a.dealers["mid"]
    vbt_a = sim_a.vbts["mid"]
    sim_a.day = 1
    sim_a.events.log_day_start(1)
    sim_a.events.log_quote(
        day=1,
        bucket="mid",
        dealer_bid=dealer_a.bid,
        dealer_ask=dealer_a.ask,
        vbt_bid=vbt_a.B,
        vbt_ask=vbt_a.A,
        inventory=dealer_a.a,
        capacity=dealer_a.X_star,
        is_pinned_bid=dealer_a.is_pinned_bid,
        is_pinned_ask=dealer_a.is_pinned_ask,
    )
    sim_a._capture_snapshot()

    # Case B: Down-jump
    print("\n" + "=" * 60)
    sim_b = setup_case_b()
    sim_b._capture_snapshot()
    run_case_b(sim_b)

    # Log final state
    dealer_b = sim_b.dealers["mid"]
    vbt_b = sim_b.vbts["mid"]
    sim_b.day = 1
    sim_b.events.log_day_start(1)
    sim_b.events.log_quote(
        day=1,
        bucket="mid",
        dealer_bid=dealer_b.bid,
        dealer_ask=dealer_b.ask,
        vbt_bid=vbt_b.B,
        vbt_ask=vbt_b.A,
        inventory=dealer_b.a,
        capacity=dealer_b.X_star,
        is_pinned_bid=dealer_b.is_pinned_bid,
        is_pinned_ask=dealer_b.is_pinned_ask,
    )
    sim_b._capture_snapshot()

    # Summary
    print("\n" + "=" * 60)
    print("SUMMARY")
    print("=" * 60)
    print("\nCase A (Up-jump):")
    print("  Before: K*=3, X*=3, lambda=0.25, I=0.075")
    print("  After:  K*=4, X*=4, lambda=0.20, I=0.06")
    print("  (Width tightens as capacity increases)")
    print("\nCase B (Down-jump):")
    print("  Before: K*=4, X*=4, lambda=0.20, I=0.06")
    print("  After:  K*=3, X*=3, lambda=0.25, I=0.075")
    print("  (Width widens as capacity decreases)")

    # Export HTML report (use Case A for report)
    out_dir = Path(__file__).parent / "out"
    out_dir.mkdir(exist_ok=True)
    out_path = out_dir / "example12_report.html"

    sim_a.to_html(
        out_path,
        title="Example 12: Capacity Integer Crossing",
        subtitle="K* jumps discretely when V crosses integer boundary",
    )

    print(f"\nReport saved to: {out_path}")
    print("\n✓ All Example 12 checks passed!")


if __name__ == "__main__":
    main()



################################################################################
# FILE: example13_event_loop.py
# PATH: examples/dealer_ring/example13_event_loop.py
################################################################################

"""
Example 13: Minimal Event-Loop Harness for Arrivals.

From the dealer ring specification (Section 14):
Tests the randomized order-flow subroutine in isolation with fixed pi_sell
and N_max. Verifies eligibility set discipline, fallback behavior, and
no-feasible retention.

Setup:
- S=1, M=1.0, O=0.30, A=1.15, B=0.85
- Dealer: a=2, C=2, V=4, K*=4, X*=4
- At x=2: a(2)=1.03, b(2)=0.97

Agent pools:
- SELL side: S_1 owns one ticket, has shortfall > 0
- BUY side: B_1 (rich, cash=2.00), B_2 (poor, cash=0.90)

Worked micro-run (three arrivals):
- Arrival 1 (Z=1, SELL): S_1 sells at b=0.97, removed from S_t
- Arrival 2 (Z=1, SELL but S_t empty): Fallback to BUY, B_2 picked but
  cash=0.90 < ask=0.98, no execution, B_2 stays in B_t
- Arrival 3 (Z=0, BUY): B_1 buys at a=0.98, removed from B_t

Harness checks:
1. Set discipline: once i executes SELL/BUY, i not in S_t/B_t for period
2. Fallback correctness: if preferred side empty, process on nonempty side
3. No-feasible retention: if can't execute, agent stays in set
4. Kernel consistency: recompute after each trade

Usage:
    uv run python examples/dealer_ring/example13_event_loop.py

Output:
    examples/dealer_ring/out/example13_report.html
"""

from decimal import Decimal
from pathlib import Path

from bilancio.dealer import (
    DealerRingConfig,
    DealerRingSimulation,
    Ticket,
    TraderState,
    recompute_dealer_state,
    can_interior_buy,
    can_interior_sell,
)


def setup_example13() -> DealerRingSimulation:
    """Set up Example 14: Event-loop harness."""
    config = DealerRingConfig(
        dealer_share=Decimal("1.0"),
        vbt_share=Decimal("0.0"),
        N_max=3,  # Max arrivals per period
        max_days=1,
        seed=42,
        vbt_anchors={
            "short": (Decimal("1.00"), Decimal("0.30")),
            "mid": (Decimal("1.00"), Decimal("0.30")),
            "long": (Decimal("1.00"), Decimal("0.30")),
        },
    )

    sim = DealerRingSimulation(config)

    # Create issuer
    issuer = TraderState(agent_id="issuer", cash=Decimal("100.00"))
    sim.traders[issuer.agent_id] = issuer

    # Create SELL-eligible agent S_1 (has shortfall, owns ticket)
    s1 = TraderState(agent_id="S_1", cash=Decimal("0.50"))
    s1.shortfall = Decimal("0.50")  # Needs to sell
    sim.traders[s1.agent_id] = s1

    # Create ticket for S_1
    s1_ticket = Ticket(
        id="S1_T",
        issuer_id=issuer.agent_id,
        owner_id=s1.agent_id,
        face=Decimal(1),
        maturity_day=200,
        remaining_tau=6,
        bucket_id="mid",
        serial=1,
    )
    s1.tickets_owned.append(s1_ticket)
    sim.all_tickets[s1_ticket.id] = s1_ticket
    issuer.obligations.append(s1_ticket)

    # Create BUY-eligible agents
    # B_1: rich (can afford ask)
    b1 = TraderState(agent_id="B_1", cash=Decimal("2.00"))
    sim.traders[b1.agent_id] = b1

    # B_2: poor (cannot afford ask)
    b2 = TraderState(agent_id="B_2", cash=Decimal("0.90"))
    sim.traders[b2.agent_id] = b2

    # Set up dealer: a=2, C=2
    dealer = sim.dealers["mid"]
    dealer.cash = Decimal("2.00")

    for i in range(2):
        ticket = Ticket(
            id=f"D{i}",
            issuer_id=issuer.agent_id,
            owner_id=dealer.agent_id,
            face=Decimal(1),
            maturity_day=200,
            remaining_tau=6,
            bucket_id="mid",
            serial=100 + i,
        )
        dealer.inventory.append(ticket)
        sim.all_tickets[ticket.id] = ticket
        issuer.obligations.append(ticket)

    # VBT backup
    vbt = sim.vbts["mid"]
    vbt.cash = Decimal("10.00")
    for i in range(3):
        vbt_ticket = Ticket(
            id=f"VBT{i}",
            issuer_id=issuer.agent_id,
            owner_id=vbt.agent_id,
            face=Decimal(1),
            maturity_day=200,
            remaining_tau=6,
            bucket_id="mid",
            serial=200 + i,
        )
        vbt.inventory.append(vbt_ticket)
        sim.all_tickets[vbt_ticket.id] = vbt_ticket

    recompute_dealer_state(dealer, vbt, sim.params)

    return sim


def verify_initial_state(sim: DealerRingSimulation) -> None:
    """Verify initial dealer state."""
    print("\n=== Initial State ===")

    dealer = sim.dealers["mid"]
    vbt = sim.vbts["mid"]

    print(f"Dealer: a={dealer.a}, C={dealer.cash}, x={dealer.x}")
    print(f"  V={dealer.V:.4f}, K*={dealer.K_star}, X*={dealer.X_star}")
    print(f"  lambda={dealer.lambda_:.4f}, I={dealer.I:.4f}")
    print(f"  At x={dealer.x}: ask={dealer.ask:.4f}, bid={dealer.bid:.4f}")

    assert dealer.a == 2
    assert dealer.cash == Decimal("2.00")
    assert dealer.K_star == 4
    assert dealer.X_star == 4

    print("\nAgent pools:")
    print("  S_t (SELL eligible): {S_1}")
    print("  B_t (BUY eligible): {B_1, B_2}")

    print("\n✓ Initial state verified!")


def run_arrival_1(sim: DealerRingSimulation, sell_set: set, buy_set: set) -> None:
    """Arrival 1: Z=1 (SELL), S_1 sells at bid."""
    print("\n=== Arrival 1: Z=1 (SELL preferred) ===")

    dealer = sim.dealers["mid"]
    vbt = sim.vbts["mid"]
    s1 = sim.traders["S_1"]

    print(f"S_t = {sell_set}, B_t = {buy_set}")
    print(f"S_t not empty, pick S_1")

    # Check feasibility
    can_buy = can_interior_buy(dealer, sim.params)
    print(f"\nFeasibility: x + S = {dealer.x} + 1 <= X* = {dealer.X_star}? {can_buy}")
    print(f"  C = {dealer.cash} >= b = {dealer.bid}? {dealer.cash >= dealer.bid}")

    assert can_buy, "Interior BUY should be feasible"

    # Execute SELL
    ticket = s1.tickets_owned[0]
    result = sim.executor.execute_customer_sell(dealer, vbt, ticket)
    s1.cash += result.price
    s1.tickets_owned.remove(ticket)

    print(f"\nExecution: SELL at p = {result.price:.4f}")
    print(f"  Dealer: x={dealer.x}, C={dealer.cash:.4f}")

    # Remove S_1 from sell set
    sell_set.remove("S_1")
    print(f"\nPost-arrival: S_t = {sell_set}")

    # Verify kernel consistency
    print(f"  New quotes: ask={dealer.ask:.4f}, bid={dealer.bid:.4f}")

    print("\n✓ Arrival 1 complete!")


def run_arrival_2(sim: DealerRingSimulation, sell_set: set, buy_set: set) -> None:
    """Arrival 2: Z=1 (SELL preferred but S_t empty), fallback to BUY, B_2 fails."""
    print("\n=== Arrival 2: Z=1 (SELL preferred, but S_t empty) ===")

    dealer = sim.dealers["mid"]
    vbt = sim.vbts["mid"]
    b2 = sim.traders["B_2"]

    print(f"S_t = {sell_set}, B_t = {buy_set}")
    print(f"S_t is empty but B_t not empty -> FALLBACK to BUY")
    print(f"Random pick from B_t: B_2 (poor)")

    # Check feasibility for B_2
    can_sell = can_interior_sell(dealer, sim.params)
    can_afford = b2.cash >= dealer.ask

    print(f"\nFeasibility for B_2:")
    print(f"  Dealer can sell (x >= S): {can_sell}")
    print(f"  B_2 cash = {b2.cash} >= ask = {dealer.ask:.4f}? {can_afford}")

    assert can_sell, "Interior SELL should be feasible"
    assert not can_afford, "B_2 should NOT be able to afford"

    print(f"\nNo execution: B_2 cannot afford ask")
    print(f"B_2 stays in B_t (no-feasible retention)")
    print(f"\nPost-arrival: B_t = {buy_set} (unchanged)")

    print("\n✓ Arrival 2 complete (no-feasible retention)!")


def run_arrival_3(sim: DealerRingSimulation, sell_set: set, buy_set: set) -> None:
    """Arrival 3: Z=0 (BUY), B_1 buys at ask."""
    print("\n=== Arrival 3: Z=0 (BUY preferred) ===")

    dealer = sim.dealers["mid"]
    vbt = sim.vbts["mid"]
    b1 = sim.traders["B_1"]

    print(f"S_t = {sell_set}, B_t = {buy_set}")
    print(f"Pick B_1 (rich)")

    # Check feasibility for B_1
    can_sell = can_interior_sell(dealer, sim.params)
    can_afford = b1.cash >= dealer.ask

    print(f"\nFeasibility for B_1:")
    print(f"  Dealer can sell (x >= S): {can_sell}")
    print(f"  B_1 cash = {b1.cash} >= ask = {dealer.ask:.4f}? {can_afford}")

    assert can_sell, "Interior SELL should be feasible"
    assert can_afford, "B_1 should be able to afford"

    # Execute BUY
    result = sim.executor.execute_customer_buy(dealer, vbt, b1.agent_id)
    b1.cash -= result.price
    if result.ticket:
        b1.tickets_owned.append(result.ticket)

    print(f"\nExecution: BUY at p = {result.price:.4f}")
    print(f"  Dealer: x={dealer.x}, C={dealer.cash:.4f}")

    # Remove B_1 from buy set
    buy_set.remove("B_1")
    print(f"\nPost-arrival: B_t = {buy_set}")

    # Verify kernel consistency
    print(f"  New quotes: ask={dealer.ask:.4f}, bid={dealer.bid:.4f}")

    print("\n✓ Arrival 3 complete!")


def verify_outcomes(sim: DealerRingSimulation) -> None:
    """Verify outcomes match specification."""
    print("\n=== Outcomes Verification ===")

    s1 = sim.traders["S_1"]
    b1 = sim.traders["B_1"]
    b2 = sim.traders["B_2"]

    print(f"S_1: cash={s1.cash:.4f}, tickets={len(s1.tickets_owned)}")
    print(f"B_1: cash={b1.cash:.4f}, tickets={len(b1.tickets_owned)}")
    print(f"B_2: cash={b2.cash:.4f}, tickets={len(b2.tickets_owned)}")

    # S_1 should have sold and received ~0.97
    assert len(s1.tickets_owned) == 0, "S_1 should have sold their ticket"
    assert s1.cash > Decimal("0.50"), "S_1 should have received payment"

    # B_1 should have bought and paid ~0.98
    assert len(b1.tickets_owned) == 1, "B_1 should have bought a ticket"
    assert b1.cash < Decimal("2.00"), "B_1 should have paid"

    # B_2 should be unchanged (no-feasible retention)
    assert len(b2.tickets_owned) == 0, "B_2 should have no tickets"
    assert b2.cash == Decimal("0.90"), "B_2 cash should be unchanged"

    print("\n✓ Outcomes verified!")
    print("\nSummary:")
    print("  - Executed trades: 1 SELL (Arrival 1), 1 BUY (Arrival 3)")
    print("  - Empty-set fallback used at Arrival 2 (SELL->BUY)")
    print("  - No feasible execution for B_2; B_2 remained in B_t")
    print("  - Post-trade removal enforced: S_1 from S_t, B_1 from B_t")


def main():
    sim = setup_example13()
    sim._capture_snapshot()

    print("Example 13: Minimal Event-Loop Harness")
    print("=" * 60)

    verify_initial_state(sim)

    sim.day = 1
    sim.events.log_day_start(1)

    # Initialize eligibility sets
    sell_set = {"S_1"}
    buy_set = {"B_1", "B_2"}

    # Run three arrivals as per specification
    run_arrival_1(sim, sell_set, buy_set)
    run_arrival_2(sim, sell_set, buy_set)
    run_arrival_3(sim, sell_set, buy_set)

    verify_outcomes(sim)

    # Log final quotes
    dealer = sim.dealers["mid"]
    vbt = sim.vbts["mid"]
    sim.events.log_quote(
        day=1,
        bucket="mid",
        dealer_bid=dealer.bid,
        dealer_ask=dealer.ask,
        vbt_bid=vbt.B,
        vbt_ask=vbt.A,
        inventory=dealer.a,
        capacity=dealer.X_star,
        is_pinned_bid=dealer.is_pinned_bid,
        is_pinned_ask=dealer.is_pinned_ask,
    )

    sim._capture_snapshot()

    # Export HTML report
    out_dir = Path(__file__).parent / "out"
    out_dir.mkdir(exist_ok=True)
    out_path = out_dir / "example13_report.html"

    sim.to_html(
        out_path,
        title="Example 13: Event-Loop Harness",
        subtitle="Eligibility sets, fallback, and no-feasible retention",
    )

    print(f"\nReport saved to: {out_path}")
    print("\n✓ All Example 13 checks passed!")


if __name__ == "__main__":
    main()



################################################################################
# FILE: example14_ticket_transfer.py
# PATH: examples/dealer_ring/example14_ticket_transfer.py
################################################################################

"""
Example 14: Ticket-Level Transfer (No Generic Materialization).

From the dealer ring specification (Section 15):
Verifies that on a customer BUY, the execution transfers a specific ticket ID
from the seller of record to the buyer. No generic tickets are created.

Setup:
- S=1, M=1.0, O=0.30, A=1.15, B=0.85
- Dealer: x=2, a=2, C=2, V=4, K*=4, X*=4
- Dealer inventory: K_D = {k1=(I1,t+6,#101), k2=(I2,t+5,#202)}
- VBT inventory: K_VBT = {v1=(I3,t+7,#303), v2=(I4,t+6,#404)}

Case A (interior BUY): Dealer transfers specific ticket
- Buyer B has no issuer preference
- Dealer SELL at a(2)=1.03 (interior)
- Tie-breaker (lowest maturity): k2=(I2,t+5,#202) selected
- k2 moves from K_D to K_B, buyer's issuer set to I2

Case B (pinned BUY / passthrough): VBT transfers specific ticket
- Dealer at x=0 (no inventory)
- Passthrough at A=1.15
- Tie-breaker selects v2=(I4,t+6,#404)
- v2 moves from K_VBT to K_B, buyer's issuer set to I4

Harness checks:
1. Transferred ID belonged to seller immediately before
2. After execution, ID in buyer's inventory, not seller's
3. Inventory length decreases by exactly 1
4. No generic ticket created anywhere

Usage:
    uv run python examples/dealer_ring/example14_ticket_transfer.py

Output:
    examples/dealer_ring/out/example14_report.html
"""

from decimal import Decimal
from pathlib import Path

from bilancio.dealer import (
    DealerRingConfig,
    DealerRingSimulation,
    Ticket,
    TraderState,
    recompute_dealer_state,
)


def setup_case_a() -> DealerRingSimulation:
    """Set up Case A: Interior BUY from dealer."""
    config = DealerRingConfig(
        dealer_share=Decimal("1.0"),
        vbt_share=Decimal("0.0"),
        N_max=0,
        max_days=1,
        seed=42,
        vbt_anchors={
            "short": (Decimal("1.00"), Decimal("0.30")),
            "mid": (Decimal("1.00"), Decimal("0.30")),
            "long": (Decimal("1.00"), Decimal("0.30")),
        },
    )

    sim = DealerRingSimulation(config)

    # Create issuers
    issuer1 = TraderState(agent_id="I1", cash=Decimal("100.00"))
    issuer2 = TraderState(agent_id="I2", cash=Decimal("100.00"))
    sim.traders[issuer1.agent_id] = issuer1
    sim.traders[issuer2.agent_id] = issuer2

    # Create buyer
    buyer = TraderState(agent_id="buyer_B", cash=Decimal("2.00"))
    sim.traders[buyer.agent_id] = buyer

    # Set up dealer: a=2, C=2
    dealer = sim.dealers["mid"]
    dealer.cash = Decimal("2.00")

    # Create dealer inventory with specific IDs
    # k1 = (I1, t+6, #101) - maturity_day = current + 6
    k1 = Ticket(
        id="k1",
        issuer_id=issuer1.agent_id,
        owner_id=dealer.agent_id,
        face=Decimal(1),
        maturity_day=sim.day + 6,
        remaining_tau=6,
        bucket_id="mid",
        serial=101,
    )
    dealer.inventory.append(k1)
    sim.all_tickets[k1.id] = k1
    issuer1.obligations.append(k1)

    # k2 = (I2, t+5, #202) - maturity_day = current + 5 (lower, will be selected)
    k2 = Ticket(
        id="k2",
        issuer_id=issuer2.agent_id,
        owner_id=dealer.agent_id,
        face=Decimal(1),
        maturity_day=sim.day + 5,
        remaining_tau=5,
        bucket_id="mid",
        serial=202,
    )
    dealer.inventory.append(k2)
    sim.all_tickets[k2.id] = k2
    issuer2.obligations.append(k2)

    # VBT backup
    vbt = sim.vbts["mid"]
    vbt.cash = Decimal("10.00")

    recompute_dealer_state(dealer, vbt, sim.params)

    return sim


def setup_case_b() -> DealerRingSimulation:
    """Set up Case B: Passthrough BUY from VBT."""
    config = DealerRingConfig(
        dealer_share=Decimal("1.0"),
        vbt_share=Decimal("0.0"),
        N_max=0,
        max_days=1,
        seed=42,
        vbt_anchors={
            "short": (Decimal("1.00"), Decimal("0.30")),
            "mid": (Decimal("1.00"), Decimal("0.30")),
            "long": (Decimal("1.00"), Decimal("0.30")),
        },
    )

    sim = DealerRingSimulation(config)

    # Create issuers
    issuer3 = TraderState(agent_id="I3", cash=Decimal("100.00"))
    issuer4 = TraderState(agent_id="I4", cash=Decimal("100.00"))
    sim.traders[issuer3.agent_id] = issuer3
    sim.traders[issuer4.agent_id] = issuer4

    # Create buyer
    buyer = TraderState(agent_id="buyer_B_tilde", cash=Decimal("2.00"))
    sim.traders[buyer.agent_id] = buyer

    # Set up dealer with no inventory (x=0) to force passthrough
    dealer = sim.dealers["mid"]
    dealer.cash = Decimal("2.00")
    # No tickets in dealer inventory

    # Set up VBT with specific ticket IDs
    vbt = sim.vbts["mid"]
    vbt.cash = Decimal("10.00")

    # v1 = (I3, t+7, #303)
    v1 = Ticket(
        id="v1",
        issuer_id=issuer3.agent_id,
        owner_id=vbt.agent_id,
        face=Decimal(1),
        maturity_day=sim.day + 7,
        remaining_tau=7,
        bucket_id="mid",
        serial=303,
    )
    vbt.inventory.append(v1)
    sim.all_tickets[v1.id] = v1

    # v2 = (I4, t+6, #404) - lower maturity, will be selected
    v2 = Ticket(
        id="v2",
        issuer_id=issuer4.agent_id,
        owner_id=vbt.agent_id,
        face=Decimal(1),
        maturity_day=sim.day + 6,
        remaining_tau=6,
        bucket_id="mid",
        serial=404,
    )
    vbt.inventory.append(v2)
    sim.all_tickets[v2.id] = v2

    recompute_dealer_state(dealer, vbt, sim.params)

    return sim


def run_case_a(sim: DealerRingSimulation) -> None:
    """Case A: Interior BUY - dealer transfers specific ticket."""
    print("\n=== CASE A: Interior BUY (Dealer Transfers Specific Ticket) ===")

    dealer = sim.dealers["mid"]
    vbt = sim.vbts["mid"]
    buyer = sim.traders["buyer_B"]

    # Record initial state
    print("\nInitial state:")
    print(f"  Dealer inventory K_D = {[t.id for t in dealer.inventory]}")
    print(f"  Dealer: x={dealer.x}, a={dealer.a}, C={dealer.cash}")
    print(f"  Buyer K_B = {[t.id for t in buyer.tickets_owned]}")

    dealer_inv_before = set(t.id for t in dealer.inventory)
    dealer_len_before = len(dealer.inventory)

    # Expected: k2 selected (lowest maturity_day)
    expected_ticket_id = "k2"
    print(f"\n  Tie-breaker (lowest maturity): expect {expected_ticket_id} selected")

    # Execute BUY
    print(f"\nExecution (customer BUY at ask={dealer.ask:.4f}):")
    result = sim.executor.execute_customer_buy(dealer, vbt, buyer.agent_id)
    buyer.cash -= result.price
    if result.ticket:
        buyer.tickets_owned.append(result.ticket)

    print(f"  Price: {result.price:.4f}")
    print(f"  Passthrough: {result.is_passthrough}")
    print(f"  Transferred ticket: {result.ticket.id if result.ticket else 'None'}")

    # Verify assertions
    assert not result.is_passthrough, "Should be interior trade"
    assert result.ticket is not None, "Ticket should be transferred"
    assert result.ticket.id == expected_ticket_id, f"Expected {expected_ticket_id}, got {result.ticket.id}"

    # 1. Transferred ID belonged to dealer before
    assert result.ticket.id in dealer_inv_before, "Transferred ticket was in dealer inventory"
    print(f"\n✓ Assertion 1: {result.ticket.id} was in K_D before execution")

    # 2. After execution: ID in buyer, not in dealer
    dealer_inv_after = set(t.id for t in dealer.inventory)
    buyer_inv_after = set(t.id for t in buyer.tickets_owned)

    assert result.ticket.id not in dealer_inv_after, "Transferred ticket no longer in dealer"
    assert result.ticket.id in buyer_inv_after, "Transferred ticket now in buyer"
    print(f"✓ Assertion 2: {result.ticket.id} in K_B, not in K_D after execution")

    # 3. Inventory length decreases by exactly 1
    assert len(dealer.inventory) == dealer_len_before - 1, "Dealer inventory decreased by 1"
    print(f"✓ Assertion 3: |K_D| decreased by 1 ({dealer_len_before} -> {len(dealer.inventory)})")

    # 4. No new ticket created
    print(f"✓ Assertion 4: No generic ticket created (same ticket object transferred)")

    print(f"\nFinal state:")
    print(f"  Dealer K_D = {[t.id for t in dealer.inventory]}")
    print(f"  Buyer K_B = {[t.id for t in buyer.tickets_owned]}")
    print(f"  Buyer's issuer set to: {result.ticket.issuer_id}")

    print("\n✓ Case A passed!")


def run_case_b(sim: DealerRingSimulation) -> None:
    """Case B: Passthrough BUY - VBT transfers specific ticket."""
    print("\n=== CASE B: Passthrough BUY (VBT Transfers Specific Ticket) ===")

    dealer = sim.dealers["mid"]
    vbt = sim.vbts["mid"]
    buyer = sim.traders["buyer_B_tilde"]

    # Record initial state
    print("\nInitial state:")
    print(f"  Dealer inventory K_D = {[t.id for t in dealer.inventory]} (empty)")
    print(f"  Dealer: x={dealer.x}, a={dealer.a}, C={dealer.cash}")
    print(f"  VBT inventory K_VBT = {[t.id for t in vbt.inventory]}")
    print(f"  Buyer K_B = {[t.id for t in buyer.tickets_owned]}")

    dealer_x_before = dealer.x
    dealer_C_before = dealer.cash
    vbt_inv_before = set(t.id for t in vbt.inventory)
    vbt_len_before = len(vbt.inventory)

    # Expected: v2 selected (lowest maturity_day)
    expected_ticket_id = "v2"
    print(f"\n  Tie-breaker (lowest maturity): expect {expected_ticket_id} selected")
    print(f"  Dealer x=0, so interior SELL infeasible -> passthrough at A={vbt.A}")

    # Execute BUY
    print(f"\nExecution (customer BUY, passthrough at A={vbt.A}):")
    result = sim.executor.execute_customer_buy(dealer, vbt, buyer.agent_id)
    buyer.cash -= result.price
    if result.ticket:
        buyer.tickets_owned.append(result.ticket)

    print(f"  Price: {result.price:.4f}")
    print(f"  Passthrough: {result.is_passthrough}")
    print(f"  Transferred ticket: {result.ticket.id if result.ticket else 'None'}")

    # Verify assertions
    assert result.is_passthrough, "Should be passthrough trade"
    assert result.price == vbt.A, f"Price should be A={vbt.A}"
    assert result.ticket is not None, "Ticket should be transferred"
    assert result.ticket.id == expected_ticket_id, f"Expected {expected_ticket_id}, got {result.ticket.id}"

    # 1. Dealer state unchanged (passthrough property)
    assert dealer.x == dealer_x_before, "Dealer x unchanged"
    assert dealer.cash == dealer_C_before, "Dealer C unchanged"
    print(f"\n✓ Assertion 1: Dealer (x, C) unchanged ({dealer.x}, {dealer.cash})")

    # 2. Transferred ID belonged to VBT before
    assert result.ticket.id in vbt_inv_before, "Transferred ticket was in VBT inventory"
    print(f"✓ Assertion 2: {result.ticket.id} was in K_VBT before execution")

    # 3. After execution: ID in buyer, not in VBT
    vbt_inv_after = set(t.id for t in vbt.inventory)
    buyer_inv_after = set(t.id for t in buyer.tickets_owned)

    assert result.ticket.id not in vbt_inv_after, "Transferred ticket no longer in VBT"
    assert result.ticket.id in buyer_inv_after, "Transferred ticket now in buyer"
    print(f"✓ Assertion 3: {result.ticket.id} in K_B, not in K_VBT after execution")

    # 4. No generic ticket created
    assert len(vbt.inventory) == vbt_len_before - 1, "VBT inventory decreased by 1"
    print(f"✓ Assertion 4: |K_VBT| decreased by 1, no generic ticket created")

    print(f"\nFinal state:")
    print(f"  Dealer K_D = {[t.id for t in dealer.inventory]} (unchanged)")
    print(f"  VBT K_VBT = {[t.id for t in vbt.inventory]}")
    print(f"  Buyer K_B = {[t.id for t in buyer.tickets_owned]}")
    print(f"  Buyer's issuer set to: {result.ticket.issuer_id}")

    print("\n✓ Case B passed!")


def main():
    print("Example 15: Ticket-Level Transfer")
    print("=" * 60)

    # Case A: Interior BUY
    sim_a = setup_case_a()
    sim_a._capture_snapshot()
    run_case_a(sim_a)

    sim_a.day = 1
    sim_a.events.log_day_start(1)
    dealer_a = sim_a.dealers["mid"]
    vbt_a = sim_a.vbts["mid"]
    sim_a.events.log_quote(
        day=1, bucket="mid",
        dealer_bid=dealer_a.bid, dealer_ask=dealer_a.ask,
        vbt_bid=vbt_a.B, vbt_ask=vbt_a.A,
        inventory=dealer_a.a, capacity=dealer_a.X_star,
        is_pinned_bid=dealer_a.is_pinned_bid, is_pinned_ask=dealer_a.is_pinned_ask,
    )
    sim_a._capture_snapshot()

    # Case B: Passthrough BUY
    print("\n" + "=" * 60)
    sim_b = setup_case_b()
    sim_b._capture_snapshot()
    run_case_b(sim_b)

    sim_b.day = 1
    sim_b.events.log_day_start(1)
    dealer_b = sim_b.dealers["mid"]
    vbt_b = sim_b.vbts["mid"]
    sim_b.events.log_quote(
        day=1, bucket="mid",
        dealer_bid=dealer_b.bid, dealer_ask=dealer_b.ask,
        vbt_bid=vbt_b.B, vbt_ask=vbt_b.A,
        inventory=dealer_b.a, capacity=dealer_b.X_star,
        is_pinned_bid=dealer_b.is_pinned_bid, is_pinned_ask=dealer_b.is_pinned_ask,
    )
    sim_b._capture_snapshot()

    # Summary
    print("\n" + "=" * 60)
    print("GLOBAL INVARIANTS VERIFIED")
    print("=" * 60)
    print("\n1. Ownership conservation: ticket IDs preserved under trading")
    print("2. Inventory monotonicity: SELL reduces |K| by exactly 1")
    print("3. Feasibility conformity: interior vs pinned paths correct")
    print("4. Double-entry balance: cash and ticket moves match")

    # Export HTML report
    out_dir = Path(__file__).parent / "out"
    out_dir.mkdir(exist_ok=True)
    out_path = out_dir / "example14_report.html"

    sim_a.to_html(
        out_path,
        title="Example 14: Ticket-Level Transfer",
        subtitle="No generic materialization - specific IDs transferred",
    )

    print(f"\nReport saved to: {out_path}")
    print("\n✓ All Example 14 checks passed!")


if __name__ == "__main__":
    main()



================================================================================
HTML REPORT FILES
================================================================================

################################################################################
# FILE: example1_report.html
# PATH: examples/dealer_ring/out/example1_report.html
################################################################################

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Example 1: Selling a Migrating Claim</title>
  <style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;line-height:1.6;color:#333;background:#f5f5f5}
.container{max-width:1400px;margin:0 auto;padding:20px}
header{background:#fff;border-radius:8px;padding:24px;margin-bottom:24px;box-shadow:0 2px 4px rgba(0,0,0,0.1)}
h1{color:#2563eb;font-size:28px;margin-bottom:8px}
h2{color:#475569;font-size:20px;margin-bottom:16px}
h3{color:#334155;font-size:18px;margin-bottom:12px}
h4{color:#475569;font-size:16px;margin:8px 0;font-weight:600}
.description{color:#64748b;font-style:italic;margin-bottom:16px}
.meta{display:flex;gap:24px;color:#64748b;font-size:14px}
.meta span{display:inline-block}
.t-account{background:#fff;border-radius:8px;padding:20px;margin-bottom:20px;box-shadow:0 2px 4px rgba(0,0,0,0.1)}
.t-account .grid{display:grid;grid-template-columns:1fr 1fr;gap:20px}
.t-account table.side{width:100%;border-collapse:collapse;font-size:14px}
.t-account th,.t-account td{border-bottom:1px solid #e5e7eb;border-right:1px solid #eef2f7;padding:8px;text-align:left}
.t-account th:last-child,.t-account td:last-child{border-right:none}
.t-account tbody tr:nth-child(even){background:#fafafa}
.t-account th{background:#f9fafb;font-weight:600;color:#374151}
.t-account td.qty,.t-account td.val,.t-account td.mat{text-align:right;white-space:nowrap}
.t-account td.name{font-weight:500}
.t-account td.empty{text-align:center;color:#9ca3af}
.assets-side h4{color:#16a34a}
.liabilities-side h4{color:#dc2626}
.events-table{background:#fff;border-radius:8px;padding:20px;margin-bottom:24px;box-shadow:0 2px 4px rgba(0,0,0,0.1)}
.events-table table{width:100%;border-collapse:collapse;font-size:14px}
.events-table th,.events-table td{border-bottom:1px solid #e5e7eb;border-right:1px solid #eef2f7;padding:8px;text-align:left}
.events-table th:last-child,.events-table td:last-child{border-right:none}
.events-table tbody tr:nth-child(even){background:#f7f9fc}
.events-table th{background:#f9fafb;font-weight:600;color:#374151}
.events-table td.qty,.events-table td.amount{text-align:center;white-space:nowrap}
.events-table td.event-kind{font-weight:500;color:#3b82f6}
.events-table td.notes{font-size:13px;color:#64748b}
.agents>h2{margin-bottom:20px;padding:0 20px}
.day-section{margin-bottom:40px;padding-bottom:40px;border-bottom:2px solid #e5e7eb}
.day-section:last-child{border-bottom:none}
.day-header{color:#1f2937;font-size:24px;margin-bottom:24px;padding:12px 0;border-bottom:1px solid #e5e7eb}
.events-section{margin-bottom:24px}
.balances-section{margin-top:24px}
.balances-section>h3{margin-bottom:20px;color:#374151;font-size:20px}
footer{text-align:center;color:#9ca3af;font-size:14px;margin-top:40px;padding:20px}
@media (max-width:768px){.t-account .grid{grid-template-columns:1fr}.meta{flex-direction:column;gap:8px}}



/* Dealer card styling */
.dealer-card {
  background: #fff;
  border-radius: 8px;
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.dealer-card h3 {
  color: #1e40af;
  margin-bottom: 16px;
  border-bottom: 2px solid #dbeafe;
  padding-bottom: 8px;
}
.params-table {
  width: 100%;
  border-collapse: collapse;
}
.params-table th {
  text-align: left;
  padding: 6px 12px;
  color: #64748b;
  font-weight: 500;
  width: 40%;
}
.params-table td {
  text-align: right;
  padding: 6px 12px;
  font-family: 'SF Mono', Monaco, monospace;
  color: #1f2937;
}
.params-table tr.section-header th {
  color: #374151;
  font-weight: 600;
  padding-top: 12px;
  border-bottom: 1px solid #e5e7eb;
}
/* VBT card */
.vbt-card {
  background: linear-gradient(135deg, #f0fdf4, #fff);
  border-left: 4px solid #16a34a;
}
.vbt-card h3 {
  color: #16a34a;
  border-bottom-color: #bbf7d0;
}
/* Event type colors */
.event-trade { color: #3b82f6; }
.event-passthrough { color: #8b5cf6; }
.event-rebucket { color: #f59e0b; }
.event-settlement { color: #16a34a; }
.event-default { color: #dc2626; }
.event-quote { color: #64748b; }
.event-vbt-anchor-update { color: #14b8a6; }
/* Pin indicators */
.pin-indicator {
  display: inline-block;
  width: 8px;
  height: 8px;
  border-radius: 50%;
  margin-left: 4px;
}
.pin-indicator.pinned { background: #f59e0b; }
.pin-indicator.not-pinned { background: #d1d5db; }
/* Grid layouts */
.dealers-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 20px;
  margin-bottom: 24px;
}
.traders-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
  gap: 20px;
}
/* Inventory list */
.inventory-list {
  margin-top: 12px;
  padding-top: 12px;
  border-top: 1px solid #e5e7eb;
}
.inventory-list h4 {
  color: #64748b;
  font-size: 14px;
  margin-bottom: 8px;
}
.inventory-list ul {
  list-style: none;
  padding: 0;
  margin: 0;
  font-size: 13px;
}
.inventory-list li {
  padding: 4px 0;
  color: #4b5563;
  font-family: 'SF Mono', Monaco, monospace;
}

  </style>
</head>
<body>
  <div class="container">
    
<header>
  <h1>Example 1: Selling a Migrating Claim</h1>
  <p class="description">Dealer rebucketing when T* crosses Long-&gt;Mid boundary</p>
  <div class="meta">
    <span><strong>Days:</strong> 1</span>
    <span><strong>Buckets:</strong> short, mid, long</span>
    <span><strong>Traders:</strong> 2</span>
    <span><strong>Tickets:</strong> 3</span>
    <span><strong>Ticket Size (S):</strong> 1</span>
  </div>
</header>


    <main>
      
<section class="day-section">
  <h2 class="day-header">🏁 Day 0 (Setup)</h2>

  
<div class="events-table">
  <h3>Day 0 (Setup) Events</h3>
  <p style="color: #9ca3af; font-style: italic;">No events for this day</p>
</div>


  <div class="balances-section">
    <h3>Market State</h3>
    <div class="dealers-grid">
      
<div class="dealer-card">
  <h3>Dealer: SHORT</h3>
  <table class="params-table">
    <tbody>
      <tr class="section-header"><th colspan="2">Inventory</th></tr>
      <tr><th>Tickets (a)</th><td>0</td></tr>
      <tr><th>Face inventory (x)</th><td>0</td></tr>
      <tr><th>Cash (C)</th><td>0</td></tr>
      <tr><th>Mid-valued (V)</th><td>0</td></tr>
      <tr class="section-header"><th colspan="2">Capacity</th></tr>
      <tr><th>Max tickets (K*)</th><td>0</td></tr>
      <tr><th>One-sided cap (X*)</th><td>0</td></tr>
      <tr><th>Ladder rungs (N)</th><td>1</td></tr>
      <tr><th>Layoff prob (λ)</th><td>1</td></tr>
      <tr class="section-header"><th colspan="2">Quotes</th></tr>
      <tr><th>Inside width (I)</th><td>0.2</td></tr>
      <tr><th>Midline p(x)</th><td>1</td></tr>
      <tr><th>Bid <span class="pin-indicator pinned" title="Pinned at VBT bid"></span></th><td>0.9</td></tr>
      <tr><th>Ask <span class="pin-indicator pinned" title="Pinned at VBT ask"></span></th><td>1.1</td></tr>
    </tbody>
  </table>
  
</div>

<div class="dealer-card">
  <h3>Dealer: MID</h3>
  <table class="params-table">
    <tbody>
      <tr class="section-header"><th colspan="2">Inventory</th></tr>
      <tr><th>Tickets (a)</th><td>1</td></tr>
      <tr><th>Face inventory (x)</th><td>1</td></tr>
      <tr><th>Cash (C)</th><td>1</td></tr>
      <tr><th>Mid-valued (V)</th><td>2</td></tr>
      <tr class="section-header"><th colspan="2">Capacity</th></tr>
      <tr><th>Max tickets (K*)</th><td>2</td></tr>
      <tr><th>One-sided cap (X*)</th><td>2</td></tr>
      <tr><th>Ladder rungs (N)</th><td>3</td></tr>
      <tr><th>Layoff prob (λ)</th><td>0.3333</td></tr>
      <tr class="section-header"><th colspan="2">Quotes</th></tr>
      <tr><th>Inside width (I)</th><td>0.0667</td></tr>
      <tr><th>Midline p(x)</th><td>1</td></tr>
      <tr><th>Bid <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0.9667</td></tr>
      <tr><th>Ask <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>1.0333</td></tr>
    </tbody>
  </table>
  
  <div class="inventory-list">
    <h4>Inventory (1 tickets)</h4>
    <ul>
      <li>M0 (issuer: other_issuer, face: 1, τ: 6)</li>
    </ul>
  </div>

</div>

<div class="dealer-card">
  <h3>Dealer: LONG</h3>
  <table class="params-table">
    <tbody>
      <tr class="section-header"><th colspan="2">Inventory</th></tr>
      <tr><th>Tickets (a)</th><td>1</td></tr>
      <tr><th>Face inventory (x)</th><td>1</td></tr>
      <tr><th>Cash (C)</th><td>1</td></tr>
      <tr><th>Mid-valued (V)</th><td>2</td></tr>
      <tr class="section-header"><th colspan="2">Capacity</th></tr>
      <tr><th>Max tickets (K*)</th><td>2</td></tr>
      <tr><th>One-sided cap (X*)</th><td>2</td></tr>
      <tr><th>Ladder rungs (N)</th><td>3</td></tr>
      <tr><th>Layoff prob (λ)</th><td>0.3333</td></tr>
      <tr class="section-header"><th colspan="2">Quotes</th></tr>
      <tr><th>Inside width (I)</th><td>0.1</td></tr>
      <tr><th>Midline p(x)</th><td>1</td></tr>
      <tr><th>Bid <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0.95</td></tr>
      <tr><th>Ask <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>1.05</td></tr>
    </tbody>
  </table>
  
  <div class="inventory-list">
    <h4>Inventory (1 tickets)</h4>
    <ul>
      <li>L0 (issuer: other_issuer, face: 1, τ: 15)</li>
    </ul>
  </div>

</div>

    </div>
    <div class="dealers-grid">
      
<div class="dealer-card vbt-card">
  <h3>VBT: SHORT</h3>
  <table class="params-table">
    <tbody>
      <tr><th>Mid anchor (M)</th><td>1</td></tr>
      <tr><th>Spread anchor (O)</th><td>0.2</td></tr>
      <tr><th>Ask (A = M + O/2)</th><td>1.1</td></tr>
      <tr><th>Bid (B = M - O/2)</th><td>0.9</td></tr>
      <tr><th>Cash</th><td>0</td></tr>
      <tr><th>Inventory</th><td>0 tickets</td></tr>
    </tbody>
  </table>
</div>

<div class="dealer-card vbt-card">
  <h3>VBT: MID</h3>
  <table class="params-table">
    <tbody>
      <tr><th>Mid anchor (M)</th><td>1</td></tr>
      <tr><th>Spread anchor (O)</th><td>0.2</td></tr>
      <tr><th>Ask (A = M + O/2)</th><td>1.1</td></tr>
      <tr><th>Bid (B = M - O/2)</th><td>0.9</td></tr>
      <tr><th>Cash</th><td>0</td></tr>
      <tr><th>Inventory</th><td>0 tickets</td></tr>
    </tbody>
  </table>
</div>

<div class="dealer-card vbt-card">
  <h3>VBT: LONG</h3>
  <table class="params-table">
    <tbody>
      <tr><th>Mid anchor (M)</th><td>1</td></tr>
      <tr><th>Spread anchor (O)</th><td>0.3</td></tr>
      <tr><th>Ask (A = M + O/2)</th><td>1.15</td></tr>
      <tr><th>Bid (B = M - O/2)</th><td>0.85</td></tr>
      <tr><th>Cash</th><td>0</td></tr>
      <tr><th>Inventory</th><td>0 tickets</td></tr>
    </tbody>
  </table>
</div>

    </div>
  </div>

  
  <div class="balances-section">
    <h3>Trader Balances</h3>
    <div class="traders-grid">
      
<div class="t-account">
  <h3>A1_trader</h3>
  <div class="grid">
    <div class="assets-side">
      <h4>Assets (2.05)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">Cash</td>
        <td class="val">1.05</td>
      </tr>
    
      <tr>
        <td class="name">T_star</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(A2_issuer, τ=9)</span></td>
      </tr>
        
        </tbody>
      </table>
    </div>
    <div class="liabilities-side">
      <h4>Liabilities (0)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td colspan="2" class="empty">No obligations</td>
      </tr>
        
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="t-account">
  <h3>A2_issuer</h3>
  <div class="grid">
    <div class="assets-side">
      <h4>Assets (10)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">Cash</td>
        <td class="val">10</td>
      </tr>
    
      <tr>
        <td colspan="2" class="empty">No tickets owned</td>
      </tr>
        
        </tbody>
      </table>
    </div>
    <div class="liabilities-side">
      <h4>Liabilities (1)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">T_star</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(to A1_trader, mat=100)</span></td>
      </tr>
        
        </tbody>
      </table>
    </div>
  </div>
</div>

    </div>
  </div>

</section>

<section class="day-section">
  <h2 class="day-header">📅 Day 1</h2>

  
<div class="events-table">
  <h3>Day 1 Events</h3>
  <table>
    <thead>
      <tr>
        <th style="width: 120px;">Kind</th>
        <th>Details</th>
        <th style="width: 200px;">Notes</th>
      </tr>
    </thead>
    <tbody>
      
          <tr>
            <td class="event-trade">trade</td>
            <td>SELL @ 0.95 [long]</td>
            <td class="notes">trader: A1_trader, ticket: T_star</td>
          </tr>
        
          <tr>
            <td class="event-rebucket">rebucket</td>
            <td>long → mid @ 1</td>
            <td class="notes">dealer ticket T_star</td>
          </tr>
        
          <tr>
            <td class="event-quote">quote</td>
            <td>[short] D: 0.9/1.1, VBT: 0.9/1.1</td>
            <td class="notes">inv=0, cap=0</td>
          </tr>
        
          <tr>
            <td class="event-quote">quote</td>
            <td>[mid] D: 0.9167/0.9833, VBT: 0.9/1.1</td>
            <td class="notes">inv=2, cap=2</td>
          </tr>
        
          <tr>
            <td class="event-quote">quote</td>
            <td>[long] D: 0.95/1.05, VBT: 0.85/1.15</td>
            <td class="notes">inv=1, cap=2</td>
          </tr>
        
    </tbody>
  </table>
</div>


  <div class="balances-section">
    <h3>Market State</h3>
    <div class="dealers-grid">
      
<div class="dealer-card">
  <h3>Dealer: SHORT</h3>
  <table class="params-table">
    <tbody>
      <tr class="section-header"><th colspan="2">Inventory</th></tr>
      <tr><th>Tickets (a)</th><td>0</td></tr>
      <tr><th>Face inventory (x)</th><td>0</td></tr>
      <tr><th>Cash (C)</th><td>0</td></tr>
      <tr><th>Mid-valued (V)</th><td>0</td></tr>
      <tr class="section-header"><th colspan="2">Capacity</th></tr>
      <tr><th>Max tickets (K*)</th><td>0</td></tr>
      <tr><th>One-sided cap (X*)</th><td>0</td></tr>
      <tr><th>Ladder rungs (N)</th><td>1</td></tr>
      <tr><th>Layoff prob (λ)</th><td>1</td></tr>
      <tr class="section-header"><th colspan="2">Quotes</th></tr>
      <tr><th>Inside width (I)</th><td>0.2</td></tr>
      <tr><th>Midline p(x)</th><td>1</td></tr>
      <tr><th>Bid <span class="pin-indicator pinned" title="Pinned at VBT bid"></span></th><td>0.9</td></tr>
      <tr><th>Ask <span class="pin-indicator pinned" title="Pinned at VBT ask"></span></th><td>1.1</td></tr>
    </tbody>
  </table>
  
</div>

<div class="dealer-card">
  <h3>Dealer: MID</h3>
  <table class="params-table">
    <tbody>
      <tr class="section-header"><th colspan="2">Inventory</th></tr>
      <tr><th>Tickets (a)</th><td>2</td></tr>
      <tr><th>Face inventory (x)</th><td>2</td></tr>
      <tr><th>Cash (C)</th><td>0</td></tr>
      <tr><th>Mid-valued (V)</th><td>2</td></tr>
      <tr class="section-header"><th colspan="2">Capacity</th></tr>
      <tr><th>Max tickets (K*)</th><td>2</td></tr>
      <tr><th>One-sided cap (X*)</th><td>2</td></tr>
      <tr><th>Ladder rungs (N)</th><td>3</td></tr>
      <tr><th>Layoff prob (λ)</th><td>0.3333</td></tr>
      <tr class="section-header"><th colspan="2">Quotes</th></tr>
      <tr><th>Inside width (I)</th><td>0.0667</td></tr>
      <tr><th>Midline p(x)</th><td>0.95</td></tr>
      <tr><th>Bid <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0.9167</td></tr>
      <tr><th>Ask <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0.9833</td></tr>
    </tbody>
  </table>
  
  <div class="inventory-list">
    <h4>Inventory (2 tickets)</h4>
    <ul>
      <li>M0 (issuer: other_issuer, face: 1, τ: 5)</li><li>T_star (issuer: A2_issuer, face: 1, τ: 8)</li>
    </ul>
  </div>

</div>

<div class="dealer-card">
  <h3>Dealer: LONG</h3>
  <table class="params-table">
    <tbody>
      <tr class="section-header"><th colspan="2">Inventory</th></tr>
      <tr><th>Tickets (a)</th><td>1</td></tr>
      <tr><th>Face inventory (x)</th><td>1</td></tr>
      <tr><th>Cash (C)</th><td>1.05</td></tr>
      <tr><th>Mid-valued (V)</th><td>2.05</td></tr>
      <tr class="section-header"><th colspan="2">Capacity</th></tr>
      <tr><th>Max tickets (K*)</th><td>2</td></tr>
      <tr><th>One-sided cap (X*)</th><td>2</td></tr>
      <tr><th>Ladder rungs (N)</th><td>3</td></tr>
      <tr><th>Layoff prob (λ)</th><td>0.3333</td></tr>
      <tr class="section-header"><th colspan="2">Quotes</th></tr>
      <tr><th>Inside width (I)</th><td>0.1</td></tr>
      <tr><th>Midline p(x)</th><td>1</td></tr>
      <tr><th>Bid <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0.95</td></tr>
      <tr><th>Ask <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>1.05</td></tr>
    </tbody>
  </table>
  
  <div class="inventory-list">
    <h4>Inventory (1 tickets)</h4>
    <ul>
      <li>L0 (issuer: other_issuer, face: 1, τ: 14)</li>
    </ul>
  </div>

</div>

    </div>
    <div class="dealers-grid">
      
<div class="dealer-card vbt-card">
  <h3>VBT: SHORT</h3>
  <table class="params-table">
    <tbody>
      <tr><th>Mid anchor (M)</th><td>1</td></tr>
      <tr><th>Spread anchor (O)</th><td>0.2</td></tr>
      <tr><th>Ask (A = M + O/2)</th><td>1.1</td></tr>
      <tr><th>Bid (B = M - O/2)</th><td>0.9</td></tr>
      <tr><th>Cash</th><td>0</td></tr>
      <tr><th>Inventory</th><td>0 tickets</td></tr>
    </tbody>
  </table>
</div>

<div class="dealer-card vbt-card">
  <h3>VBT: MID</h3>
  <table class="params-table">
    <tbody>
      <tr><th>Mid anchor (M)</th><td>1</td></tr>
      <tr><th>Spread anchor (O)</th><td>0.2</td></tr>
      <tr><th>Ask (A = M + O/2)</th><td>1.1</td></tr>
      <tr><th>Bid (B = M - O/2)</th><td>0.9</td></tr>
      <tr><th>Cash</th><td>0</td></tr>
      <tr><th>Inventory</th><td>0 tickets</td></tr>
    </tbody>
  </table>
</div>

<div class="dealer-card vbt-card">
  <h3>VBT: LONG</h3>
  <table class="params-table">
    <tbody>
      <tr><th>Mid anchor (M)</th><td>1</td></tr>
      <tr><th>Spread anchor (O)</th><td>0.3</td></tr>
      <tr><th>Ask (A = M + O/2)</th><td>1.15</td></tr>
      <tr><th>Bid (B = M - O/2)</th><td>0.85</td></tr>
      <tr><th>Cash</th><td>0</td></tr>
      <tr><th>Inventory</th><td>0 tickets</td></tr>
    </tbody>
  </table>
</div>

    </div>
  </div>

  
  <div class="balances-section">
    <h3>Trader Balances</h3>
    <div class="traders-grid">
      
<div class="t-account">
  <h3>A1_trader</h3>
  <div class="grid">
    <div class="assets-side">
      <h4>Assets (2)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">Cash</td>
        <td class="val">2</td>
      </tr>
    
      <tr>
        <td colspan="2" class="empty">No tickets owned</td>
      </tr>
        
        </tbody>
      </table>
    </div>
    <div class="liabilities-side">
      <h4>Liabilities (0)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td colspan="2" class="empty">No obligations</td>
      </tr>
        
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="t-account">
  <h3>A2_issuer</h3>
  <div class="grid">
    <div class="assets-side">
      <h4>Assets (10)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">Cash</td>
        <td class="val">10</td>
      </tr>
    
      <tr>
        <td colspan="2" class="empty">No tickets owned</td>
      </tr>
        
        </tbody>
      </table>
    </div>
    <div class="liabilities-side">
      <h4>Liabilities (1)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">T_star</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(to dealer_mid_b, mat=100)</span></td>
      </tr>
        
        </tbody>
      </table>
    </div>
  </div>
</div>

    </div>
  </div>

</section>

    </main>

    <footer>
      Generated by bilancio dealer ring simulation
    </footer>
  </div>
</body>
</html>



################################################################################
# FILE: example2_report.html
# PATH: examples/dealer_ring/out/example2_report.html
################################################################################

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Example 2: Cross-Bucket Reallocation</title>
  <style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;line-height:1.6;color:#333;background:#f5f5f5}
.container{max-width:1400px;margin:0 auto;padding:20px}
header{background:#fff;border-radius:8px;padding:24px;margin-bottom:24px;box-shadow:0 2px 4px rgba(0,0,0,0.1)}
h1{color:#2563eb;font-size:28px;margin-bottom:8px}
h2{color:#475569;font-size:20px;margin-bottom:16px}
h3{color:#334155;font-size:18px;margin-bottom:12px}
h4{color:#475569;font-size:16px;margin:8px 0;font-weight:600}
.description{color:#64748b;font-style:italic;margin-bottom:16px}
.meta{display:flex;gap:24px;color:#64748b;font-size:14px}
.meta span{display:inline-block}
.t-account{background:#fff;border-radius:8px;padding:20px;margin-bottom:20px;box-shadow:0 2px 4px rgba(0,0,0,0.1)}
.t-account .grid{display:grid;grid-template-columns:1fr 1fr;gap:20px}
.t-account table.side{width:100%;border-collapse:collapse;font-size:14px}
.t-account th,.t-account td{border-bottom:1px solid #e5e7eb;border-right:1px solid #eef2f7;padding:8px;text-align:left}
.t-account th:last-child,.t-account td:last-child{border-right:none}
.t-account tbody tr:nth-child(even){background:#fafafa}
.t-account th{background:#f9fafb;font-weight:600;color:#374151}
.t-account td.qty,.t-account td.val,.t-account td.mat{text-align:right;white-space:nowrap}
.t-account td.name{font-weight:500}
.t-account td.empty{text-align:center;color:#9ca3af}
.assets-side h4{color:#16a34a}
.liabilities-side h4{color:#dc2626}
.events-table{background:#fff;border-radius:8px;padding:20px;margin-bottom:24px;box-shadow:0 2px 4px rgba(0,0,0,0.1)}
.events-table table{width:100%;border-collapse:collapse;font-size:14px}
.events-table th,.events-table td{border-bottom:1px solid #e5e7eb;border-right:1px solid #eef2f7;padding:8px;text-align:left}
.events-table th:last-child,.events-table td:last-child{border-right:none}
.events-table tbody tr:nth-child(even){background:#f7f9fc}
.events-table th{background:#f9fafb;font-weight:600;color:#374151}
.events-table td.qty,.events-table td.amount{text-align:center;white-space:nowrap}
.events-table td.event-kind{font-weight:500;color:#3b82f6}
.events-table td.notes{font-size:13px;color:#64748b}
.agents>h2{margin-bottom:20px;padding:0 20px}
.day-section{margin-bottom:40px;padding-bottom:40px;border-bottom:2px solid #e5e7eb}
.day-section:last-child{border-bottom:none}
.day-header{color:#1f2937;font-size:24px;margin-bottom:24px;padding:12px 0;border-bottom:1px solid #e5e7eb}
.events-section{margin-bottom:24px}
.balances-section{margin-top:24px}
.balances-section>h3{margin-bottom:20px;color:#374151;font-size:20px}
footer{text-align:center;color:#9ca3af;font-size:14px;margin-top:40px;padding:20px}
@media (max-width:768px){.t-account .grid{grid-template-columns:1fr}.meta{flex-direction:column;gap:8px}}



/* Dealer card styling */
.dealer-card {
  background: #fff;
  border-radius: 8px;
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.dealer-card h3 {
  color: #1e40af;
  margin-bottom: 16px;
  border-bottom: 2px solid #dbeafe;
  padding-bottom: 8px;
}
.params-table {
  width: 100%;
  border-collapse: collapse;
}
.params-table th {
  text-align: left;
  padding: 6px 12px;
  color: #64748b;
  font-weight: 500;
  width: 40%;
}
.params-table td {
  text-align: right;
  padding: 6px 12px;
  font-family: 'SF Mono', Monaco, monospace;
  color: #1f2937;
}
.params-table tr.section-header th {
  color: #374151;
  font-weight: 600;
  padding-top: 12px;
  border-bottom: 1px solid #e5e7eb;
}
/* VBT card */
.vbt-card {
  background: linear-gradient(135deg, #f0fdf4, #fff);
  border-left: 4px solid #16a34a;
}
.vbt-card h3 {
  color: #16a34a;
  border-bottom-color: #bbf7d0;
}
/* Event type colors */
.event-trade { color: #3b82f6; }
.event-passthrough { color: #8b5cf6; }
.event-rebucket { color: #f59e0b; }
.event-settlement { color: #16a34a; }
.event-default { color: #dc2626; }
.event-quote { color: #64748b; }
.event-vbt-anchor-update { color: #14b8a6; }
/* Pin indicators */
.pin-indicator {
  display: inline-block;
  width: 8px;
  height: 8px;
  border-radius: 50%;
  margin-left: 4px;
}
.pin-indicator.pinned { background: #f59e0b; }
.pin-indicator.not-pinned { background: #d1d5db; }
/* Grid layouts */
.dealers-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 20px;
  margin-bottom: 24px;
}
.traders-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
  gap: 20px;
}
/* Inventory list */
.inventory-list {
  margin-top: 12px;
  padding-top: 12px;
  border-top: 1px solid #e5e7eb;
}
.inventory-list h4 {
  color: #64748b;
  font-size: 14px;
  margin-bottom: 8px;
}
.inventory-list ul {
  list-style: none;
  padding: 0;
  margin: 0;
  font-size: 13px;
}
.inventory-list li {
  padding: 4px 0;
  color: #4b5563;
  font-family: 'SF Mono', Monaco, monospace;
}

  </style>
</head>
<body>
  <div class="container">
    
<header>
  <h1>Example 2: Cross-Bucket Reallocation</h1>
  <p class="description">Maturing debt and dealer-as-customer trades</p>
  <div class="meta">
    <span><strong>Days:</strong> 2</span>
    <span><strong>Buckets:</strong> short, mid, long</span>
    <span><strong>Traders:</strong> 2</span>
    <span><strong>Tickets:</strong> 3</span>
    <span><strong>Ticket Size (S):</strong> 1</span>
  </div>
</header>


    <main>
      
<section class="day-section">
  <h2 class="day-header">🏁 Day 0 (Setup)</h2>

  
<div class="events-table">
  <h3>Day 0 (Setup) Events</h3>
  <p style="color: #9ca3af; font-style: italic;">No events for this day</p>
</div>


  <div class="balances-section">
    <h3>Market State</h3>
    <div class="dealers-grid">
      
<div class="dealer-card">
  <h3>Dealer: SHORT</h3>
  <table class="params-table">
    <tbody>
      <tr class="section-header"><th colspan="2">Inventory</th></tr>
      <tr><th>Tickets (a)</th><td>1</td></tr>
      <tr><th>Face inventory (x)</th><td>1</td></tr>
      <tr><th>Cash (C)</th><td>1</td></tr>
      <tr><th>Mid-valued (V)</th><td>2</td></tr>
      <tr class="section-header"><th colspan="2">Capacity</th></tr>
      <tr><th>Max tickets (K*)</th><td>2</td></tr>
      <tr><th>One-sided cap (X*)</th><td>2</td></tr>
      <tr><th>Ladder rungs (N)</th><td>3</td></tr>
      <tr><th>Layoff prob (λ)</th><td>0.3333</td></tr>
      <tr class="section-header"><th colspan="2">Quotes</th></tr>
      <tr><th>Inside width (I)</th><td>0.0667</td></tr>
      <tr><th>Midline p(x)</th><td>1</td></tr>
      <tr><th>Bid <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0.9667</td></tr>
      <tr><th>Ask <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>1.0333</td></tr>
    </tbody>
  </table>
  
  <div class="inventory-list">
    <h4>Inventory (1 tickets)</h4>
    <ul>
      <li>S_star (issuer: issuer_short, face: 1, τ: 1)</li>
    </ul>
  </div>

</div>

<div class="dealer-card">
  <h3>Dealer: MID</h3>
  <table class="params-table">
    <tbody>
      <tr class="section-header"><th colspan="2">Inventory</th></tr>
      <tr><th>Tickets (a)</th><td>1</td></tr>
      <tr><th>Face inventory (x)</th><td>1</td></tr>
      <tr><th>Cash (C)</th><td>1</td></tr>
      <tr><th>Mid-valued (V)</th><td>2</td></tr>
      <tr class="section-header"><th colspan="2">Capacity</th></tr>
      <tr><th>Max tickets (K*)</th><td>2</td></tr>
      <tr><th>One-sided cap (X*)</th><td>2</td></tr>
      <tr><th>Ladder rungs (N)</th><td>3</td></tr>
      <tr><th>Layoff prob (λ)</th><td>0.3333</td></tr>
      <tr class="section-header"><th colspan="2">Quotes</th></tr>
      <tr><th>Inside width (I)</th><td>0.1</td></tr>
      <tr><th>Midline p(x)</th><td>1</td></tr>
      <tr><th>Bid <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0.95</td></tr>
      <tr><th>Ask <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>1.05</td></tr>
    </tbody>
  </table>
  
  <div class="inventory-list">
    <h4>Inventory (1 tickets)</h4>
    <ul>
      <li>M0 (issuer: issuer_other, face: 1, τ: 6)</li>
    </ul>
  </div>

</div>

<div class="dealer-card">
  <h3>Dealer: LONG</h3>
  <table class="params-table">
    <tbody>
      <tr class="section-header"><th colspan="2">Inventory</th></tr>
      <tr><th>Tickets (a)</th><td>1</td></tr>
      <tr><th>Face inventory (x)</th><td>1</td></tr>
      <tr><th>Cash (C)</th><td>1</td></tr>
      <tr><th>Mid-valued (V)</th><td>2</td></tr>
      <tr class="section-header"><th colspan="2">Capacity</th></tr>
      <tr><th>Max tickets (K*)</th><td>2</td></tr>
      <tr><th>One-sided cap (X*)</th><td>2</td></tr>
      <tr><th>Ladder rungs (N)</th><td>3</td></tr>
      <tr><th>Layoff prob (λ)</th><td>0.3333</td></tr>
      <tr class="section-header"><th colspan="2">Quotes</th></tr>
      <tr><th>Inside width (I)</th><td>0.1333</td></tr>
      <tr><th>Midline p(x)</th><td>1</td></tr>
      <tr><th>Bid <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0.9333</td></tr>
      <tr><th>Ask <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>1.0667</td></tr>
    </tbody>
  </table>
  
  <div class="inventory-list">
    <h4>Inventory (1 tickets)</h4>
    <ul>
      <li>L0 (issuer: issuer_other, face: 1, τ: 15)</li>
    </ul>
  </div>

</div>

    </div>
    <div class="dealers-grid">
      
<div class="dealer-card vbt-card">
  <h3>VBT: SHORT</h3>
  <table class="params-table">
    <tbody>
      <tr><th>Mid anchor (M)</th><td>1</td></tr>
      <tr><th>Spread anchor (O)</th><td>0.2</td></tr>
      <tr><th>Ask (A = M + O/2)</th><td>1.1</td></tr>
      <tr><th>Bid (B = M - O/2)</th><td>0.9</td></tr>
      <tr><th>Cash</th><td>0</td></tr>
      <tr><th>Inventory</th><td>0 tickets</td></tr>
    </tbody>
  </table>
</div>

<div class="dealer-card vbt-card">
  <h3>VBT: MID</h3>
  <table class="params-table">
    <tbody>
      <tr><th>Mid anchor (M)</th><td>1</td></tr>
      <tr><th>Spread anchor (O)</th><td>0.3</td></tr>
      <tr><th>Ask (A = M + O/2)</th><td>1.15</td></tr>
      <tr><th>Bid (B = M - O/2)</th><td>0.85</td></tr>
      <tr><th>Cash</th><td>0</td></tr>
      <tr><th>Inventory</th><td>0 tickets</td></tr>
    </tbody>
  </table>
</div>

<div class="dealer-card vbt-card">
  <h3>VBT: LONG</h3>
  <table class="params-table">
    <tbody>
      <tr><th>Mid anchor (M)</th><td>1</td></tr>
      <tr><th>Spread anchor (O)</th><td>0.4</td></tr>
      <tr><th>Ask (A = M + O/2)</th><td>1.2</td></tr>
      <tr><th>Bid (B = M - O/2)</th><td>0.8</td></tr>
      <tr><th>Cash</th><td>0</td></tr>
      <tr><th>Inventory</th><td>0 tickets</td></tr>
    </tbody>
  </table>
</div>

    </div>
  </div>

  
  <div class="balances-section">
    <h3>Trader Balances</h3>
    <div class="traders-grid">
      
<div class="t-account">
  <h3>issuer_other</h3>
  <div class="grid">
    <div class="assets-side">
      <h4>Assets (100)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">Cash</td>
        <td class="val">100</td>
      </tr>
    
      <tr>
        <td colspan="2" class="empty">No tickets owned</td>
      </tr>
        
        </tbody>
      </table>
    </div>
    <div class="liabilities-side">
      <h4>Liabilities (2)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">M0</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(to dealer_mid_c, mat=200)</span></td>
      </tr>
        
      <tr>
        <td class="name">L0</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(to dealer_long_, mat=200)</span></td>
      </tr>
        
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="t-account">
  <h3>issuer_short</h3>
  <div class="grid">
    <div class="assets-side">
      <h4>Assets (1)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">Cash</td>
        <td class="val">1</td>
      </tr>
    
      <tr>
        <td colspan="2" class="empty">No tickets owned</td>
      </tr>
        
        </tbody>
      </table>
    </div>
    <div class="liabilities-side">
      <h4>Liabilities (1)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">S_star</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(to dealer_short, mat=1)</span></td>
      </tr>
        
        </tbody>
      </table>
    </div>
  </div>
</div>

    </div>
  </div>

</section>

<section class="day-section">
  <h2 class="day-header">📅 Day 1</h2>

  
<div class="events-table">
  <h3>Day 1 Events</h3>
  <table>
    <thead>
      <tr>
        <th style="width: 120px;">Kind</th>
        <th>Details</th>
        <th style="width: 200px;">Notes</th>
      </tr>
    </thead>
    <tbody>
      
          <tr>
            <td class="event-settlement">settlement</td>
            <td>Paid 1 on 1 tickets</td>
            <td class="notes">issuer: issuer_short</td>
          </tr>
        
          <tr>
            <td class="event-quote">quote</td>
            <td>[short] D: 1.0167/1.0833, VBT: 0.9/1.1</td>
            <td class="notes">inv=0, cap=2</td>
          </tr>
        
          <tr>
            <td class="event-quote">quote</td>
            <td>[mid] D: 0.95/1.05, VBT: 0.85/1.15</td>
            <td class="notes">inv=1, cap=2</td>
          </tr>
        
          <tr>
            <td class="event-quote">quote</td>
            <td>[long] D: 0.9333/1.0667, VBT: 0.8/1.2</td>
            <td class="notes">inv=1, cap=2</td>
          </tr>
        
    </tbody>
  </table>
</div>


  <div class="balances-section">
    <h3>Market State</h3>
    <div class="dealers-grid">
      
<div class="dealer-card">
  <h3>Dealer: SHORT</h3>
  <table class="params-table">
    <tbody>
      <tr class="section-header"><th colspan="2">Inventory</th></tr>
      <tr><th>Tickets (a)</th><td>0</td></tr>
      <tr><th>Face inventory (x)</th><td>0</td></tr>
      <tr><th>Cash (C)</th><td>2</td></tr>
      <tr><th>Mid-valued (V)</th><td>2</td></tr>
      <tr class="section-header"><th colspan="2">Capacity</th></tr>
      <tr><th>Max tickets (K*)</th><td>2</td></tr>
      <tr><th>One-sided cap (X*)</th><td>2</td></tr>
      <tr><th>Ladder rungs (N)</th><td>3</td></tr>
      <tr><th>Layoff prob (λ)</th><td>0.3333</td></tr>
      <tr class="section-header"><th colspan="2">Quotes</th></tr>
      <tr><th>Inside width (I)</th><td>0.0667</td></tr>
      <tr><th>Midline p(x)</th><td>1.05</td></tr>
      <tr><th>Bid <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>1.0167</td></tr>
      <tr><th>Ask <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>1.0833</td></tr>
    </tbody>
  </table>
  
</div>

<div class="dealer-card">
  <h3>Dealer: MID</h3>
  <table class="params-table">
    <tbody>
      <tr class="section-header"><th colspan="2">Inventory</th></tr>
      <tr><th>Tickets (a)</th><td>1</td></tr>
      <tr><th>Face inventory (x)</th><td>1</td></tr>
      <tr><th>Cash (C)</th><td>1</td></tr>
      <tr><th>Mid-valued (V)</th><td>2</td></tr>
      <tr class="section-header"><th colspan="2">Capacity</th></tr>
      <tr><th>Max tickets (K*)</th><td>2</td></tr>
      <tr><th>One-sided cap (X*)</th><td>2</td></tr>
      <tr><th>Ladder rungs (N)</th><td>3</td></tr>
      <tr><th>Layoff prob (λ)</th><td>0.3333</td></tr>
      <tr class="section-header"><th colspan="2">Quotes</th></tr>
      <tr><th>Inside width (I)</th><td>0.1</td></tr>
      <tr><th>Midline p(x)</th><td>1</td></tr>
      <tr><th>Bid <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0.95</td></tr>
      <tr><th>Ask <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>1.05</td></tr>
    </tbody>
  </table>
  
  <div class="inventory-list">
    <h4>Inventory (1 tickets)</h4>
    <ul>
      <li>M0 (issuer: issuer_other, face: 1, τ: 6)</li>
    </ul>
  </div>

</div>

<div class="dealer-card">
  <h3>Dealer: LONG</h3>
  <table class="params-table">
    <tbody>
      <tr class="section-header"><th colspan="2">Inventory</th></tr>
      <tr><th>Tickets (a)</th><td>1</td></tr>
      <tr><th>Face inventory (x)</th><td>1</td></tr>
      <tr><th>Cash (C)</th><td>1</td></tr>
      <tr><th>Mid-valued (V)</th><td>2</td></tr>
      <tr class="section-header"><th colspan="2">Capacity</th></tr>
      <tr><th>Max tickets (K*)</th><td>2</td></tr>
      <tr><th>One-sided cap (X*)</th><td>2</td></tr>
      <tr><th>Ladder rungs (N)</th><td>3</td></tr>
      <tr><th>Layoff prob (λ)</th><td>0.3333</td></tr>
      <tr class="section-header"><th colspan="2">Quotes</th></tr>
      <tr><th>Inside width (I)</th><td>0.1333</td></tr>
      <tr><th>Midline p(x)</th><td>1</td></tr>
      <tr><th>Bid <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0.9333</td></tr>
      <tr><th>Ask <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>1.0667</td></tr>
    </tbody>
  </table>
  
  <div class="inventory-list">
    <h4>Inventory (1 tickets)</h4>
    <ul>
      <li>L0 (issuer: issuer_other, face: 1, τ: 15)</li>
    </ul>
  </div>

</div>

    </div>
    <div class="dealers-grid">
      
<div class="dealer-card vbt-card">
  <h3>VBT: SHORT</h3>
  <table class="params-table">
    <tbody>
      <tr><th>Mid anchor (M)</th><td>1</td></tr>
      <tr><th>Spread anchor (O)</th><td>0.2</td></tr>
      <tr><th>Ask (A = M + O/2)</th><td>1.1</td></tr>
      <tr><th>Bid (B = M - O/2)</th><td>0.9</td></tr>
      <tr><th>Cash</th><td>0</td></tr>
      <tr><th>Inventory</th><td>0 tickets</td></tr>
    </tbody>
  </table>
</div>

<div class="dealer-card vbt-card">
  <h3>VBT: MID</h3>
  <table class="params-table">
    <tbody>
      <tr><th>Mid anchor (M)</th><td>1</td></tr>
      <tr><th>Spread anchor (O)</th><td>0.3</td></tr>
      <tr><th>Ask (A = M + O/2)</th><td>1.15</td></tr>
      <tr><th>Bid (B = M - O/2)</th><td>0.85</td></tr>
      <tr><th>Cash</th><td>0</td></tr>
      <tr><th>Inventory</th><td>0 tickets</td></tr>
    </tbody>
  </table>
</div>

<div class="dealer-card vbt-card">
  <h3>VBT: LONG</h3>
  <table class="params-table">
    <tbody>
      <tr><th>Mid anchor (M)</th><td>1</td></tr>
      <tr><th>Spread anchor (O)</th><td>0.4</td></tr>
      <tr><th>Ask (A = M + O/2)</th><td>1.2</td></tr>
      <tr><th>Bid (B = M - O/2)</th><td>0.8</td></tr>
      <tr><th>Cash</th><td>0</td></tr>
      <tr><th>Inventory</th><td>0 tickets</td></tr>
    </tbody>
  </table>
</div>

    </div>
  </div>

  
  <div class="balances-section">
    <h3>Trader Balances</h3>
    <div class="traders-grid">
      
<div class="t-account">
  <h3>issuer_other</h3>
  <div class="grid">
    <div class="assets-side">
      <h4>Assets (100)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">Cash</td>
        <td class="val">100</td>
      </tr>
    
      <tr>
        <td colspan="2" class="empty">No tickets owned</td>
      </tr>
        
        </tbody>
      </table>
    </div>
    <div class="liabilities-side">
      <h4>Liabilities (2)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">M0</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(to dealer_mid_c, mat=200)</span></td>
      </tr>
        
      <tr>
        <td class="name">L0</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(to dealer_long_, mat=200)</span></td>
      </tr>
        
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="t-account">
  <h3>issuer_short</h3>
  <div class="grid">
    <div class="assets-side">
      <h4>Assets (0)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">Cash</td>
        <td class="val">0</td>
      </tr>
    
      <tr>
        <td colspan="2" class="empty">No tickets owned</td>
      </tr>
        
        </tbody>
      </table>
    </div>
    <div class="liabilities-side">
      <h4>Liabilities (0)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td colspan="2" class="empty">No obligations</td>
      </tr>
        
        </tbody>
      </table>
    </div>
  </div>
</div>

    </div>
  </div>

</section>

<section class="day-section">
  <h2 class="day-header">📅 Day 2</h2>

  
<div class="events-table">
  <h3>Day 2 Events</h3>
  <table>
    <thead>
      <tr>
        <th style="width: 120px;">Kind</th>
        <th>Details</th>
        <th style="width: 200px;">Notes</th>
      </tr>
    </thead>
    <tbody>
      
          <tr>
            <td class="event-trade">trade</td>
            <td>BUY @ 1.05 [mid]</td>
            <td class="notes">trader: dealer_short_d9373c8, ticket: M0</td>
          </tr>
        
          <tr>
            <td class="event-trade">trade</td>
            <td>BUY @ 1.0667 [long]</td>
            <td class="notes">trader: dealer_mid_cd628a763, ticket: L0</td>
          </tr>
        
          <tr>
            <td class="event-quote">quote</td>
            <td>[short] D: 1.0167/1.0833, VBT: 0.9/1.1</td>
            <td class="notes">inv=0, cap=2</td>
          </tr>
        
          <tr>
            <td class="event-quote">quote</td>
            <td>[mid] D: 1.025/1.125, VBT: 0.85/1.15</td>
            <td class="notes">inv=0, cap=2</td>
          </tr>
        
          <tr>
            <td class="event-quote">quote</td>
            <td>[long] D: 1.0333/1.1667, VBT: 0.8/1.2</td>
            <td class="notes">inv=0, cap=2</td>
          </tr>
        
    </tbody>
  </table>
</div>


  <div class="balances-section">
    <h3>Market State</h3>
    <div class="dealers-grid">
      
<div class="dealer-card">
  <h3>Dealer: SHORT</h3>
  <table class="params-table">
    <tbody>
      <tr class="section-header"><th colspan="2">Inventory</th></tr>
      <tr><th>Tickets (a)</th><td>0</td></tr>
      <tr><th>Face inventory (x)</th><td>0</td></tr>
      <tr><th>Cash (C)</th><td>0.95</td></tr>
      <tr><th>Mid-valued (V)</th><td>2</td></tr>
      <tr class="section-header"><th colspan="2">Capacity</th></tr>
      <tr><th>Max tickets (K*)</th><td>2</td></tr>
      <tr><th>One-sided cap (X*)</th><td>2</td></tr>
      <tr><th>Ladder rungs (N)</th><td>3</td></tr>
      <tr><th>Layoff prob (λ)</th><td>0.3333</td></tr>
      <tr class="section-header"><th colspan="2">Quotes</th></tr>
      <tr><th>Inside width (I)</th><td>0.0667</td></tr>
      <tr><th>Midline p(x)</th><td>1.05</td></tr>
      <tr><th>Bid <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>1.0167</td></tr>
      <tr><th>Ask <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>1.0833</td></tr>
    </tbody>
  </table>
  
</div>

<div class="dealer-card">
  <h3>Dealer: MID</h3>
  <table class="params-table">
    <tbody>
      <tr class="section-header"><th colspan="2">Inventory</th></tr>
      <tr><th>Tickets (a)</th><td>0</td></tr>
      <tr><th>Face inventory (x)</th><td>0</td></tr>
      <tr><th>Cash (C)</th><td>0.9833</td></tr>
      <tr><th>Mid-valued (V)</th><td>2.05</td></tr>
      <tr class="section-header"><th colspan="2">Capacity</th></tr>
      <tr><th>Max tickets (K*)</th><td>2</td></tr>
      <tr><th>One-sided cap (X*)</th><td>2</td></tr>
      <tr><th>Ladder rungs (N)</th><td>3</td></tr>
      <tr><th>Layoff prob (λ)</th><td>0.3333</td></tr>
      <tr class="section-header"><th colspan="2">Quotes</th></tr>
      <tr><th>Inside width (I)</th><td>0.1</td></tr>
      <tr><th>Midline p(x)</th><td>1.075</td></tr>
      <tr><th>Bid <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>1.025</td></tr>
      <tr><th>Ask <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>1.125</td></tr>
    </tbody>
  </table>
  
</div>

<div class="dealer-card">
  <h3>Dealer: LONG</h3>
  <table class="params-table">
    <tbody>
      <tr class="section-header"><th colspan="2">Inventory</th></tr>
      <tr><th>Tickets (a)</th><td>0</td></tr>
      <tr><th>Face inventory (x)</th><td>0</td></tr>
      <tr><th>Cash (C)</th><td>2.0667</td></tr>
      <tr><th>Mid-valued (V)</th><td>2.0667</td></tr>
      <tr class="section-header"><th colspan="2">Capacity</th></tr>
      <tr><th>Max tickets (K*)</th><td>2</td></tr>
      <tr><th>One-sided cap (X*)</th><td>2</td></tr>
      <tr><th>Ladder rungs (N)</th><td>3</td></tr>
      <tr><th>Layoff prob (λ)</th><td>0.3333</td></tr>
      <tr class="section-header"><th colspan="2">Quotes</th></tr>
      <tr><th>Inside width (I)</th><td>0.1333</td></tr>
      <tr><th>Midline p(x)</th><td>1.1</td></tr>
      <tr><th>Bid <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>1.0333</td></tr>
      <tr><th>Ask <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>1.1667</td></tr>
    </tbody>
  </table>
  
</div>

    </div>
    <div class="dealers-grid">
      
<div class="dealer-card vbt-card">
  <h3>VBT: SHORT</h3>
  <table class="params-table">
    <tbody>
      <tr><th>Mid anchor (M)</th><td>1</td></tr>
      <tr><th>Spread anchor (O)</th><td>0.2</td></tr>
      <tr><th>Ask (A = M + O/2)</th><td>1.1</td></tr>
      <tr><th>Bid (B = M - O/2)</th><td>0.9</td></tr>
      <tr><th>Cash</th><td>0</td></tr>
      <tr><th>Inventory</th><td>0 tickets</td></tr>
    </tbody>
  </table>
</div>

<div class="dealer-card vbt-card">
  <h3>VBT: MID</h3>
  <table class="params-table">
    <tbody>
      <tr><th>Mid anchor (M)</th><td>1</td></tr>
      <tr><th>Spread anchor (O)</th><td>0.3</td></tr>
      <tr><th>Ask (A = M + O/2)</th><td>1.15</td></tr>
      <tr><th>Bid (B = M - O/2)</th><td>0.85</td></tr>
      <tr><th>Cash</th><td>0</td></tr>
      <tr><th>Inventory</th><td>0 tickets</td></tr>
    </tbody>
  </table>
</div>

<div class="dealer-card vbt-card">
  <h3>VBT: LONG</h3>
  <table class="params-table">
    <tbody>
      <tr><th>Mid anchor (M)</th><td>1</td></tr>
      <tr><th>Spread anchor (O)</th><td>0.4</td></tr>
      <tr><th>Ask (A = M + O/2)</th><td>1.2</td></tr>
      <tr><th>Bid (B = M - O/2)</th><td>0.8</td></tr>
      <tr><th>Cash</th><td>0</td></tr>
      <tr><th>Inventory</th><td>0 tickets</td></tr>
    </tbody>
  </table>
</div>

    </div>
  </div>

  
  <div class="balances-section">
    <h3>Trader Balances</h3>
    <div class="traders-grid">
      
<div class="t-account">
  <h3>issuer_other</h3>
  <div class="grid">
    <div class="assets-side">
      <h4>Assets (100)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">Cash</td>
        <td class="val">100</td>
      </tr>
    
      <tr>
        <td colspan="2" class="empty">No tickets owned</td>
      </tr>
        
        </tbody>
      </table>
    </div>
    <div class="liabilities-side">
      <h4>Liabilities (2)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">M0</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(to dealer_short, mat=200)</span></td>
      </tr>
        
      <tr>
        <td class="name">L0</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(to dealer_mid_c, mat=200)</span></td>
      </tr>
        
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="t-account">
  <h3>issuer_short</h3>
  <div class="grid">
    <div class="assets-side">
      <h4>Assets (0)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">Cash</td>
        <td class="val">0</td>
      </tr>
    
      <tr>
        <td colspan="2" class="empty">No tickets owned</td>
      </tr>
        
        </tbody>
      </table>
    </div>
    <div class="liabilities-side">
      <h4>Liabilities (0)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td colspan="2" class="empty">No obligations</td>
      </tr>
        
        </tbody>
      </table>
    </div>
  </div>
</div>

    </div>
  </div>

</section>

    </main>

    <footer>
      Generated by bilancio dealer ring simulation
    </footer>
  </div>
</body>
</html>



################################################################################
# FILE: example3_report.html
# PATH: examples/dealer_ring/out/example3_report.html
################################################################################

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Example 3: VBT Anchor Update with Clipping</title>
  <style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;line-height:1.6;color:#333;background:#f5f5f5}
.container{max-width:1400px;margin:0 auto;padding:20px}
header{background:#fff;border-radius:8px;padding:24px;margin-bottom:24px;box-shadow:0 2px 4px rgba(0,0,0,0.1)}
h1{color:#2563eb;font-size:28px;margin-bottom:8px}
h2{color:#475569;font-size:20px;margin-bottom:16px}
h3{color:#334155;font-size:18px;margin-bottom:12px}
h4{color:#475569;font-size:16px;margin:8px 0;font-weight:600}
.description{color:#64748b;font-style:italic;margin-bottom:16px}
.meta{display:flex;gap:24px;color:#64748b;font-size:14px}
.meta span{display:inline-block}
.t-account{background:#fff;border-radius:8px;padding:20px;margin-bottom:20px;box-shadow:0 2px 4px rgba(0,0,0,0.1)}
.t-account .grid{display:grid;grid-template-columns:1fr 1fr;gap:20px}
.t-account table.side{width:100%;border-collapse:collapse;font-size:14px}
.t-account th,.t-account td{border-bottom:1px solid #e5e7eb;border-right:1px solid #eef2f7;padding:8px;text-align:left}
.t-account th:last-child,.t-account td:last-child{border-right:none}
.t-account tbody tr:nth-child(even){background:#fafafa}
.t-account th{background:#f9fafb;font-weight:600;color:#374151}
.t-account td.qty,.t-account td.val,.t-account td.mat{text-align:right;white-space:nowrap}
.t-account td.name{font-weight:500}
.t-account td.empty{text-align:center;color:#9ca3af}
.assets-side h4{color:#16a34a}
.liabilities-side h4{color:#dc2626}
.events-table{background:#fff;border-radius:8px;padding:20px;margin-bottom:24px;box-shadow:0 2px 4px rgba(0,0,0,0.1)}
.events-table table{width:100%;border-collapse:collapse;font-size:14px}
.events-table th,.events-table td{border-bottom:1px solid #e5e7eb;border-right:1px solid #eef2f7;padding:8px;text-align:left}
.events-table th:last-child,.events-table td:last-child{border-right:none}
.events-table tbody tr:nth-child(even){background:#f7f9fc}
.events-table th{background:#f9fafb;font-weight:600;color:#374151}
.events-table td.qty,.events-table td.amount{text-align:center;white-space:nowrap}
.events-table td.event-kind{font-weight:500;color:#3b82f6}
.events-table td.notes{font-size:13px;color:#64748b}
.agents>h2{margin-bottom:20px;padding:0 20px}
.day-section{margin-bottom:40px;padding-bottom:40px;border-bottom:2px solid #e5e7eb}
.day-section:last-child{border-bottom:none}
.day-header{color:#1f2937;font-size:24px;margin-bottom:24px;padding:12px 0;border-bottom:1px solid #e5e7eb}
.events-section{margin-bottom:24px}
.balances-section{margin-top:24px}
.balances-section>h3{margin-bottom:20px;color:#374151;font-size:20px}
footer{text-align:center;color:#9ca3af;font-size:14px;margin-top:40px;padding:20px}
@media (max-width:768px){.t-account .grid{grid-template-columns:1fr}.meta{flex-direction:column;gap:8px}}



/* Dealer card styling */
.dealer-card {
  background: #fff;
  border-radius: 8px;
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.dealer-card h3 {
  color: #1e40af;
  margin-bottom: 16px;
  border-bottom: 2px solid #dbeafe;
  padding-bottom: 8px;
}
.params-table {
  width: 100%;
  border-collapse: collapse;
}
.params-table th {
  text-align: left;
  padding: 6px 12px;
  color: #64748b;
  font-weight: 500;
  width: 40%;
}
.params-table td {
  text-align: right;
  padding: 6px 12px;
  font-family: 'SF Mono', Monaco, monospace;
  color: #1f2937;
}
.params-table tr.section-header th {
  color: #374151;
  font-weight: 600;
  padding-top: 12px;
  border-bottom: 1px solid #e5e7eb;
}
/* VBT card */
.vbt-card {
  background: linear-gradient(135deg, #f0fdf4, #fff);
  border-left: 4px solid #16a34a;
}
.vbt-card h3 {
  color: #16a34a;
  border-bottom-color: #bbf7d0;
}
/* Event type colors */
.event-trade { color: #3b82f6; }
.event-passthrough { color: #8b5cf6; }
.event-rebucket { color: #f59e0b; }
.event-settlement { color: #16a34a; }
.event-default { color: #dc2626; }
.event-quote { color: #64748b; }
.event-vbt-anchor-update { color: #14b8a6; }
/* Pin indicators */
.pin-indicator {
  display: inline-block;
  width: 8px;
  height: 8px;
  border-radius: 50%;
  margin-left: 4px;
}
.pin-indicator.pinned { background: #f59e0b; }
.pin-indicator.not-pinned { background: #d1d5db; }
/* Grid layouts */
.dealers-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 20px;
  margin-bottom: 24px;
}
.traders-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
  gap: 20px;
}
/* Inventory list */
.inventory-list {
  margin-top: 12px;
  padding-top: 12px;
  border-top: 1px solid #e5e7eb;
}
.inventory-list h4 {
  color: #64748b;
  font-size: 14px;
  margin-bottom: 8px;
}
.inventory-list ul {
  list-style: none;
  padding: 0;
  margin: 0;
  font-size: 13px;
}
.inventory-list li {
  padding: 4px 0;
  color: #4b5563;
  font-family: 'SF Mono', Monaco, monospace;
}

  </style>
</head>
<body>
  <div class="container">
    
<header>
  <h1>Example 3: VBT Anchor Update with Clipping</h1>
  <p class="description">Default triggers anchor update, B clipped to 0</p>
  <div class="meta">
    <span><strong>Days:</strong> 1</span>
    <span><strong>Buckets:</strong> short, mid, long</span>
    <span><strong>Traders:</strong> 1</span>
    <span><strong>Tickets:</strong> 4</span>
    <span><strong>Ticket Size (S):</strong> 1</span>
  </div>
</header>


    <main>
      
<section class="day-section">
  <h2 class="day-header">🏁 Day 0 (Setup)</h2>

  
<div class="events-table">
  <h3>Day 0 (Setup) Events</h3>
  <p style="color: #9ca3af; font-style: italic;">No events for this day</p>
</div>


  <div class="balances-section">
    <h3>Market State</h3>
    <div class="dealers-grid">
      
<div class="dealer-card">
  <h3>Dealer: SHORT</h3>
  <table class="params-table">
    <tbody>
      <tr class="section-header"><th colspan="2">Inventory</th></tr>
      <tr><th>Tickets (a)</th><td>0</td></tr>
      <tr><th>Face inventory (x)</th><td>0</td></tr>
      <tr><th>Cash (C)</th><td>0</td></tr>
      <tr><th>Mid-valued (V)</th><td>0</td></tr>
      <tr class="section-header"><th colspan="2">Capacity</th></tr>
      <tr><th>Max tickets (K*)</th><td>0</td></tr>
      <tr><th>One-sided cap (X*)</th><td>0</td></tr>
      <tr><th>Ladder rungs (N)</th><td>1</td></tr>
      <tr><th>Layoff prob (λ)</th><td>1</td></tr>
      <tr class="section-header"><th colspan="2">Quotes</th></tr>
      <tr><th>Inside width (I)</th><td>0</td></tr>
      <tr><th>Midline p(x)</th><td>0</td></tr>
      <tr><th>Bid <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0</td></tr>
      <tr><th>Ask <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0</td></tr>
    </tbody>
  </table>
  
</div>

<div class="dealer-card">
  <h3>Dealer: MID</h3>
  <table class="params-table">
    <tbody>
      <tr class="section-header"><th colspan="2">Inventory</th></tr>
      <tr><th>Tickets (a)</th><td>3</td></tr>
      <tr><th>Face inventory (x)</th><td>3</td></tr>
      <tr><th>Cash (C)</th><td>1</td></tr>
      <tr><th>Mid-valued (V)</th><td>4</td></tr>
      <tr class="section-header"><th colspan="2">Capacity</th></tr>
      <tr><th>Max tickets (K*)</th><td>4</td></tr>
      <tr><th>One-sided cap (X*)</th><td>4</td></tr>
      <tr><th>Ladder rungs (N)</th><td>5</td></tr>
      <tr><th>Layoff prob (λ)</th><td>0.2</td></tr>
      <tr class="section-header"><th colspan="2">Quotes</th></tr>
      <tr><th>Inside width (I)</th><td>0.06</td></tr>
      <tr><th>Midline p(x)</th><td>0.95</td></tr>
      <tr><th>Bid <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0.92</td></tr>
      <tr><th>Ask <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0.98</td></tr>
    </tbody>
  </table>
  
  <div class="inventory-list">
    <h4>Inventory (3 tickets)</h4>
    <ul>
      <li>T0 (issuer: issuer, face: 1, τ: 6)</li><li>T1 (issuer: issuer, face: 1, τ: 6)</li><li>T2 (issuer: issuer, face: 1, τ: 6)</li>
    </ul>
  </div>

</div>

<div class="dealer-card">
  <h3>Dealer: LONG</h3>
  <table class="params-table">
    <tbody>
      <tr class="section-header"><th colspan="2">Inventory</th></tr>
      <tr><th>Tickets (a)</th><td>0</td></tr>
      <tr><th>Face inventory (x)</th><td>0</td></tr>
      <tr><th>Cash (C)</th><td>0</td></tr>
      <tr><th>Mid-valued (V)</th><td>0</td></tr>
      <tr class="section-header"><th colspan="2">Capacity</th></tr>
      <tr><th>Max tickets (K*)</th><td>0</td></tr>
      <tr><th>One-sided cap (X*)</th><td>0</td></tr>
      <tr><th>Ladder rungs (N)</th><td>1</td></tr>
      <tr><th>Layoff prob (λ)</th><td>1</td></tr>
      <tr class="section-header"><th colspan="2">Quotes</th></tr>
      <tr><th>Inside width (I)</th><td>0</td></tr>
      <tr><th>Midline p(x)</th><td>0</td></tr>
      <tr><th>Bid <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0</td></tr>
      <tr><th>Ask <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0</td></tr>
    </tbody>
  </table>
  
</div>

    </div>
    <div class="dealers-grid">
      
<div class="dealer-card vbt-card">
  <h3>VBT: SHORT</h3>
  <table class="params-table">
    <tbody>
      <tr><th>Mid anchor (M)</th><td>1</td></tr>
      <tr><th>Spread anchor (O)</th><td>0.3</td></tr>
      <tr><th>Ask (A = M + O/2)</th><td>1.15</td></tr>
      <tr><th>Bid (B = M - O/2)</th><td>0.85</td></tr>
      <tr><th>Cash</th><td>0</td></tr>
      <tr><th>Inventory</th><td>0 tickets</td></tr>
    </tbody>
  </table>
</div>

<div class="dealer-card vbt-card">
  <h3>VBT: MID</h3>
  <table class="params-table">
    <tbody>
      <tr><th>Mid anchor (M)</th><td>1</td></tr>
      <tr><th>Spread anchor (O)</th><td>0.3</td></tr>
      <tr><th>Ask (A = M + O/2)</th><td>1.15</td></tr>
      <tr><th>Bid (B = M - O/2)</th><td>0.85</td></tr>
      <tr><th>Cash</th><td>0</td></tr>
      <tr><th>Inventory</th><td>1 tickets</td></tr>
    </tbody>
  </table>
</div>

<div class="dealer-card vbt-card">
  <h3>VBT: LONG</h3>
  <table class="params-table">
    <tbody>
      <tr><th>Mid anchor (M)</th><td>1</td></tr>
      <tr><th>Spread anchor (O)</th><td>0.3</td></tr>
      <tr><th>Ask (A = M + O/2)</th><td>1.15</td></tr>
      <tr><th>Bid (B = M - O/2)</th><td>0.85</td></tr>
      <tr><th>Cash</th><td>0</td></tr>
      <tr><th>Inventory</th><td>0 tickets</td></tr>
    </tbody>
  </table>
</div>

    </div>
  </div>

  
  <div class="balances-section">
    <h3>Trader Balances</h3>
    <div class="traders-grid">
      
<div class="t-account">
  <h3>issuer</h3>
  <div class="grid">
    <div class="assets-side">
      <h4>Assets (1)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">Cash</td>
        <td class="val">1</td>
      </tr>
    
      <tr>
        <td colspan="2" class="empty">No tickets owned</td>
      </tr>
        
        </tbody>
      </table>
    </div>
    <div class="liabilities-side">
      <h4>Liabilities (3)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">T0</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(to dealer_mid_6, mat=1)</span></td>
      </tr>
        
      <tr>
        <td class="name">T1</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(to dealer_mid_6, mat=1)</span></td>
      </tr>
        
      <tr>
        <td class="name">T2</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(to dealer_mid_6, mat=1)</span></td>
      </tr>
        
        </tbody>
      </table>
    </div>
  </div>
</div>

    </div>
  </div>

</section>

<section class="day-section">
  <h2 class="day-header">📅 Day 1</h2>

  
<div class="events-table">
  <h3>Day 1 Events</h3>
  <table>
    <thead>
      <tr>
        <th style="width: 120px;">Kind</th>
        <th>Details</th>
        <th style="width: 200px;">Notes</th>
      </tr>
    </thead>
    <tbody>
      
          <tr>
            <td class="event-default">default</td>
            <td>Recovery 0.33 (due: 3, paid: 1)</td>
            <td class="notes">issuer: issuer, bucket: mid</td>
          </tr>
        
          <tr>
            <td class="event-vbt-anchor-update">vbt_anchor_update</td>
            <td>[mid] M: 1→0.3333, O: 0.3→0.7</td>
            <td class="notes">loss rate: 0.6667</td>
          </tr>
        
          <tr>
            <td class="event-quote">quote</td>
            <td>[mid] D: 0.5458/0.6458, VBT: 0/0.6833</td>
            <td class="notes">inv=0, cap=6</td>
          </tr>
        
    </tbody>
  </table>
</div>


  <div class="balances-section">
    <h3>Market State</h3>
    <div class="dealers-grid">
      
<div class="dealer-card">
  <h3>Dealer: SHORT</h3>
  <table class="params-table">
    <tbody>
      <tr class="section-header"><th colspan="2">Inventory</th></tr>
      <tr><th>Tickets (a)</th><td>0</td></tr>
      <tr><th>Face inventory (x)</th><td>0</td></tr>
      <tr><th>Cash (C)</th><td>0</td></tr>
      <tr><th>Mid-valued (V)</th><td>0</td></tr>
      <tr class="section-header"><th colspan="2">Capacity</th></tr>
      <tr><th>Max tickets (K*)</th><td>0</td></tr>
      <tr><th>One-sided cap (X*)</th><td>0</td></tr>
      <tr><th>Ladder rungs (N)</th><td>1</td></tr>
      <tr><th>Layoff prob (λ)</th><td>1</td></tr>
      <tr class="section-header"><th colspan="2">Quotes</th></tr>
      <tr><th>Inside width (I)</th><td>0</td></tr>
      <tr><th>Midline p(x)</th><td>0</td></tr>
      <tr><th>Bid <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0</td></tr>
      <tr><th>Ask <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0</td></tr>
    </tbody>
  </table>
  
</div>

<div class="dealer-card">
  <h3>Dealer: MID</h3>
  <table class="params-table">
    <tbody>
      <tr class="section-header"><th colspan="2">Inventory</th></tr>
      <tr><th>Tickets (a)</th><td>0</td></tr>
      <tr><th>Face inventory (x)</th><td>0</td></tr>
      <tr><th>Cash (C)</th><td>2</td></tr>
      <tr><th>Mid-valued (V)</th><td>2</td></tr>
      <tr class="section-header"><th colspan="2">Capacity</th></tr>
      <tr><th>Max tickets (K*)</th><td>6</td></tr>
      <tr><th>One-sided cap (X*)</th><td>6</td></tr>
      <tr><th>Ladder rungs (N)</th><td>7</td></tr>
      <tr><th>Layoff prob (λ)</th><td>0.1429</td></tr>
      <tr class="section-header"><th colspan="2">Quotes</th></tr>
      <tr><th>Inside width (I)</th><td>0.1</td></tr>
      <tr><th>Midline p(x)</th><td>0.5958</td></tr>
      <tr><th>Bid <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0.5458</td></tr>
      <tr><th>Ask <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0.6458</td></tr>
    </tbody>
  </table>
  
</div>

<div class="dealer-card">
  <h3>Dealer: LONG</h3>
  <table class="params-table">
    <tbody>
      <tr class="section-header"><th colspan="2">Inventory</th></tr>
      <tr><th>Tickets (a)</th><td>0</td></tr>
      <tr><th>Face inventory (x)</th><td>0</td></tr>
      <tr><th>Cash (C)</th><td>0</td></tr>
      <tr><th>Mid-valued (V)</th><td>0</td></tr>
      <tr class="section-header"><th colspan="2">Capacity</th></tr>
      <tr><th>Max tickets (K*)</th><td>0</td></tr>
      <tr><th>One-sided cap (X*)</th><td>0</td></tr>
      <tr><th>Ladder rungs (N)</th><td>1</td></tr>
      <tr><th>Layoff prob (λ)</th><td>1</td></tr>
      <tr class="section-header"><th colspan="2">Quotes</th></tr>
      <tr><th>Inside width (I)</th><td>0</td></tr>
      <tr><th>Midline p(x)</th><td>0</td></tr>
      <tr><th>Bid <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0</td></tr>
      <tr><th>Ask <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0</td></tr>
    </tbody>
  </table>
  
</div>

    </div>
    <div class="dealers-grid">
      
<div class="dealer-card vbt-card">
  <h3>VBT: SHORT</h3>
  <table class="params-table">
    <tbody>
      <tr><th>Mid anchor (M)</th><td>1</td></tr>
      <tr><th>Spread anchor (O)</th><td>0.3</td></tr>
      <tr><th>Ask (A = M + O/2)</th><td>1.15</td></tr>
      <tr><th>Bid (B = M - O/2)</th><td>0.85</td></tr>
      <tr><th>Cash</th><td>0</td></tr>
      <tr><th>Inventory</th><td>0 tickets</td></tr>
    </tbody>
  </table>
</div>

<div class="dealer-card vbt-card">
  <h3>VBT: MID</h3>
  <table class="params-table">
    <tbody>
      <tr><th>Mid anchor (M)</th><td>0.3333</td></tr>
      <tr><th>Spread anchor (O)</th><td>0.7</td></tr>
      <tr><th>Ask (A = M + O/2)</th><td>0.6833</td></tr>
      <tr><th>Bid (B = M - O/2)</th><td>0</td></tr>
      <tr><th>Cash</th><td>0</td></tr>
      <tr><th>Inventory</th><td>1 tickets</td></tr>
    </tbody>
  </table>
</div>

<div class="dealer-card vbt-card">
  <h3>VBT: LONG</h3>
  <table class="params-table">
    <tbody>
      <tr><th>Mid anchor (M)</th><td>1</td></tr>
      <tr><th>Spread anchor (O)</th><td>0.3</td></tr>
      <tr><th>Ask (A = M + O/2)</th><td>1.15</td></tr>
      <tr><th>Bid (B = M - O/2)</th><td>0.85</td></tr>
      <tr><th>Cash</th><td>0</td></tr>
      <tr><th>Inventory</th><td>0 tickets</td></tr>
    </tbody>
  </table>
</div>

    </div>
  </div>

  
  <div class="balances-section">
    <h3>Trader Balances</h3>
    <div class="traders-grid">
      
<div class="t-account">
  <h3>issuer<span style="color: #dc2626; font-weight: 600;"> [DEFAULTED]</span></h3>
  <div class="grid">
    <div class="assets-side">
      <h4>Assets (0)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">Cash</td>
        <td class="val">0</td>
      </tr>
    
      <tr>
        <td colspan="2" class="empty">No tickets owned</td>
      </tr>
        
        </tbody>
      </table>
    </div>
    <div class="liabilities-side">
      <h4>Liabilities (0)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td colspan="2" class="empty">No obligations</td>
      </tr>
        
        </tbody>
      </table>
    </div>
  </div>
</div>

    </div>
  </div>

</section>

    </main>

    <footer>
      Generated by bilancio dealer ring simulation
    </footer>
  </div>
</body>
</html>



################################################################################
# FILE: example4_report.html
# PATH: examples/dealer_ring/out/example4_report.html
################################################################################

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Example 4: VBT Layoff at Inventory Limit</title>
  <style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;line-height:1.6;color:#333;background:#f5f5f5}
.container{max-width:1400px;margin:0 auto;padding:20px}
header{background:#fff;border-radius:8px;padding:24px;margin-bottom:24px;box-shadow:0 2px 4px rgba(0,0,0,0.1)}
h1{color:#2563eb;font-size:28px;margin-bottom:8px}
h2{color:#475569;font-size:20px;margin-bottom:16px}
h3{color:#334155;font-size:18px;margin-bottom:12px}
h4{color:#475569;font-size:16px;margin:8px 0;font-weight:600}
.description{color:#64748b;font-style:italic;margin-bottom:16px}
.meta{display:flex;gap:24px;color:#64748b;font-size:14px}
.meta span{display:inline-block}
.t-account{background:#fff;border-radius:8px;padding:20px;margin-bottom:20px;box-shadow:0 2px 4px rgba(0,0,0,0.1)}
.t-account .grid{display:grid;grid-template-columns:1fr 1fr;gap:20px}
.t-account table.side{width:100%;border-collapse:collapse;font-size:14px}
.t-account th,.t-account td{border-bottom:1px solid #e5e7eb;border-right:1px solid #eef2f7;padding:8px;text-align:left}
.t-account th:last-child,.t-account td:last-child{border-right:none}
.t-account tbody tr:nth-child(even){background:#fafafa}
.t-account th{background:#f9fafb;font-weight:600;color:#374151}
.t-account td.qty,.t-account td.val,.t-account td.mat{text-align:right;white-space:nowrap}
.t-account td.name{font-weight:500}
.t-account td.empty{text-align:center;color:#9ca3af}
.assets-side h4{color:#16a34a}
.liabilities-side h4{color:#dc2626}
.events-table{background:#fff;border-radius:8px;padding:20px;margin-bottom:24px;box-shadow:0 2px 4px rgba(0,0,0,0.1)}
.events-table table{width:100%;border-collapse:collapse;font-size:14px}
.events-table th,.events-table td{border-bottom:1px solid #e5e7eb;border-right:1px solid #eef2f7;padding:8px;text-align:left}
.events-table th:last-child,.events-table td:last-child{border-right:none}
.events-table tbody tr:nth-child(even){background:#f7f9fc}
.events-table th{background:#f9fafb;font-weight:600;color:#374151}
.events-table td.qty,.events-table td.amount{text-align:center;white-space:nowrap}
.events-table td.event-kind{font-weight:500;color:#3b82f6}
.events-table td.notes{font-size:13px;color:#64748b}
.agents>h2{margin-bottom:20px;padding:0 20px}
.day-section{margin-bottom:40px;padding-bottom:40px;border-bottom:2px solid #e5e7eb}
.day-section:last-child{border-bottom:none}
.day-header{color:#1f2937;font-size:24px;margin-bottom:24px;padding:12px 0;border-bottom:1px solid #e5e7eb}
.events-section{margin-bottom:24px}
.balances-section{margin-top:24px}
.balances-section>h3{margin-bottom:20px;color:#374151;font-size:20px}
footer{text-align:center;color:#9ca3af;font-size:14px;margin-top:40px;padding:20px}
@media (max-width:768px){.t-account .grid{grid-template-columns:1fr}.meta{flex-direction:column;gap:8px}}



/* Dealer card styling */
.dealer-card {
  background: #fff;
  border-radius: 8px;
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.dealer-card h3 {
  color: #1e40af;
  margin-bottom: 16px;
  border-bottom: 2px solid #dbeafe;
  padding-bottom: 8px;
}
.params-table {
  width: 100%;
  border-collapse: collapse;
}
.params-table th {
  text-align: left;
  padding: 6px 12px;
  color: #64748b;
  font-weight: 500;
  width: 40%;
}
.params-table td {
  text-align: right;
  padding: 6px 12px;
  font-family: 'SF Mono', Monaco, monospace;
  color: #1f2937;
}
.params-table tr.section-header th {
  color: #374151;
  font-weight: 600;
  padding-top: 12px;
  border-bottom: 1px solid #e5e7eb;
}
/* VBT card */
.vbt-card {
  background: linear-gradient(135deg, #f0fdf4, #fff);
  border-left: 4px solid #16a34a;
}
.vbt-card h3 {
  color: #16a34a;
  border-bottom-color: #bbf7d0;
}
/* Event type colors */
.event-trade { color: #3b82f6; }
.event-passthrough { color: #8b5cf6; }
.event-rebucket { color: #f59e0b; }
.event-settlement { color: #16a34a; }
.event-default { color: #dc2626; }
.event-quote { color: #64748b; }
.event-vbt-anchor-update { color: #14b8a6; }
/* Pin indicators */
.pin-indicator {
  display: inline-block;
  width: 8px;
  height: 8px;
  border-radius: 50%;
  margin-left: 4px;
}
.pin-indicator.pinned { background: #f59e0b; }
.pin-indicator.not-pinned { background: #d1d5db; }
/* Grid layouts */
.dealers-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 20px;
  margin-bottom: 24px;
}
.traders-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
  gap: 20px;
}
/* Inventory list */
.inventory-list {
  margin-top: 12px;
  padding-top: 12px;
  border-top: 1px solid #e5e7eb;
}
.inventory-list h4 {
  color: #64748b;
  font-size: 14px;
  margin-bottom: 8px;
}
.inventory-list ul {
  list-style: none;
  padding: 0;
  margin: 0;
  font-size: 13px;
}
.inventory-list li {
  padding: 4px 0;
  color: #4b5563;
  font-family: 'SF Mono', Monaco, monospace;
}

  </style>
</head>
<body>
  <div class="container">
    
<header>
  <h1>Example 4: VBT Layoff at Inventory Limit</h1>
  <p class="description">Dealer runs out of inventory, trades route to VBT at outside ask</p>
  <div class="meta">
    <span><strong>Days:</strong> 1</span>
    <span><strong>Buckets:</strong> short, mid, long</span>
    <span><strong>Traders:</strong> 4</span>
    <span><strong>Tickets:</strong> 3</span>
    <span><strong>Ticket Size (S):</strong> 1</span>
  </div>
</header>


    <main>
      
<section class="day-section">
  <h2 class="day-header">🏁 Day 0 (Setup)</h2>

  
<div class="events-table">
  <h3>Day 0 (Setup) Events</h3>
  <p style="color: #9ca3af; font-style: italic;">No events for this day</p>
</div>


  <div class="balances-section">
    <h3>Market State</h3>
    <div class="dealers-grid">
      
<div class="dealer-card">
  <h3>Dealer: SHORT</h3>
  <table class="params-table">
    <tbody>
      <tr class="section-header"><th colspan="2">Inventory</th></tr>
      <tr><th>Tickets (a)</th><td>0</td></tr>
      <tr><th>Face inventory (x)</th><td>0</td></tr>
      <tr><th>Cash (C)</th><td>0</td></tr>
      <tr><th>Mid-valued (V)</th><td>0</td></tr>
      <tr class="section-header"><th colspan="2">Capacity</th></tr>
      <tr><th>Max tickets (K*)</th><td>0</td></tr>
      <tr><th>One-sided cap (X*)</th><td>0</td></tr>
      <tr><th>Ladder rungs (N)</th><td>1</td></tr>
      <tr><th>Layoff prob (λ)</th><td>1</td></tr>
      <tr class="section-header"><th colspan="2">Quotes</th></tr>
      <tr><th>Inside width (I)</th><td>0</td></tr>
      <tr><th>Midline p(x)</th><td>0</td></tr>
      <tr><th>Bid <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0</td></tr>
      <tr><th>Ask <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0</td></tr>
    </tbody>
  </table>
  
</div>

<div class="dealer-card">
  <h3>Dealer: MID</h3>
  <table class="params-table">
    <tbody>
      <tr class="section-header"><th colspan="2">Inventory</th></tr>
      <tr><th>Tickets (a)</th><td>2</td></tr>
      <tr><th>Face inventory (x)</th><td>2</td></tr>
      <tr><th>Cash (C)</th><td>2</td></tr>
      <tr><th>Mid-valued (V)</th><td>4</td></tr>
      <tr class="section-header"><th colspan="2">Capacity</th></tr>
      <tr><th>Max tickets (K*)</th><td>4</td></tr>
      <tr><th>One-sided cap (X*)</th><td>4</td></tr>
      <tr><th>Ladder rungs (N)</th><td>5</td></tr>
      <tr><th>Layoff prob (λ)</th><td>0.2</td></tr>
      <tr class="section-header"><th colspan="2">Quotes</th></tr>
      <tr><th>Inside width (I)</th><td>0.06</td></tr>
      <tr><th>Midline p(x)</th><td>1</td></tr>
      <tr><th>Bid <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0.97</td></tr>
      <tr><th>Ask <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>1.03</td></tr>
    </tbody>
  </table>
  
  <div class="inventory-list">
    <h4>Inventory (2 tickets)</h4>
    <ul>
      <li>D0 (issuer: issuer, face: 1, τ: 6)</li><li>D1 (issuer: issuer, face: 1, τ: 6)</li>
    </ul>
  </div>

</div>

<div class="dealer-card">
  <h3>Dealer: LONG</h3>
  <table class="params-table">
    <tbody>
      <tr class="section-header"><th colspan="2">Inventory</th></tr>
      <tr><th>Tickets (a)</th><td>0</td></tr>
      <tr><th>Face inventory (x)</th><td>0</td></tr>
      <tr><th>Cash (C)</th><td>0</td></tr>
      <tr><th>Mid-valued (V)</th><td>0</td></tr>
      <tr class="section-header"><th colspan="2">Capacity</th></tr>
      <tr><th>Max tickets (K*)</th><td>0</td></tr>
      <tr><th>One-sided cap (X*)</th><td>0</td></tr>
      <tr><th>Ladder rungs (N)</th><td>1</td></tr>
      <tr><th>Layoff prob (λ)</th><td>1</td></tr>
      <tr class="section-header"><th colspan="2">Quotes</th></tr>
      <tr><th>Inside width (I)</th><td>0</td></tr>
      <tr><th>Midline p(x)</th><td>0</td></tr>
      <tr><th>Bid <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0</td></tr>
      <tr><th>Ask <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0</td></tr>
    </tbody>
  </table>
  
</div>

    </div>
    <div class="dealers-grid">
      
<div class="dealer-card vbt-card">
  <h3>VBT: SHORT</h3>
  <table class="params-table">
    <tbody>
      <tr><th>Mid anchor (M)</th><td>1</td></tr>
      <tr><th>Spread anchor (O)</th><td>0.3</td></tr>
      <tr><th>Ask (A = M + O/2)</th><td>1.15</td></tr>
      <tr><th>Bid (B = M - O/2)</th><td>0.85</td></tr>
      <tr><th>Cash</th><td>0</td></tr>
      <tr><th>Inventory</th><td>0 tickets</td></tr>
    </tbody>
  </table>
</div>

<div class="dealer-card vbt-card">
  <h3>VBT: MID</h3>
  <table class="params-table">
    <tbody>
      <tr><th>Mid anchor (M)</th><td>1</td></tr>
      <tr><th>Spread anchor (O)</th><td>0.3</td></tr>
      <tr><th>Ask (A = M + O/2)</th><td>1.15</td></tr>
      <tr><th>Bid (B = M - O/2)</th><td>0.85</td></tr>
      <tr><th>Cash</th><td>0</td></tr>
      <tr><th>Inventory</th><td>1 tickets</td></tr>
    </tbody>
  </table>
</div>

<div class="dealer-card vbt-card">
  <h3>VBT: LONG</h3>
  <table class="params-table">
    <tbody>
      <tr><th>Mid anchor (M)</th><td>1</td></tr>
      <tr><th>Spread anchor (O)</th><td>0.3</td></tr>
      <tr><th>Ask (A = M + O/2)</th><td>1.15</td></tr>
      <tr><th>Bid (B = M - O/2)</th><td>0.85</td></tr>
      <tr><th>Cash</th><td>0</td></tr>
      <tr><th>Inventory</th><td>0 tickets</td></tr>
    </tbody>
  </table>
</div>

    </div>
  </div>

  
  <div class="balances-section">
    <h3>Trader Balances</h3>
    <div class="traders-grid">
      
<div class="t-account">
  <h3>buyer_1</h3>
  <div class="grid">
    <div class="assets-side">
      <h4>Assets (10)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">Cash</td>
        <td class="val">10</td>
      </tr>
    
      <tr>
        <td colspan="2" class="empty">No tickets owned</td>
      </tr>
        
        </tbody>
      </table>
    </div>
    <div class="liabilities-side">
      <h4>Liabilities (0)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td colspan="2" class="empty">No obligations</td>
      </tr>
        
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="t-account">
  <h3>buyer_2</h3>
  <div class="grid">
    <div class="assets-side">
      <h4>Assets (10)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">Cash</td>
        <td class="val">10</td>
      </tr>
    
      <tr>
        <td colspan="2" class="empty">No tickets owned</td>
      </tr>
        
        </tbody>
      </table>
    </div>
    <div class="liabilities-side">
      <h4>Liabilities (0)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td colspan="2" class="empty">No obligations</td>
      </tr>
        
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="t-account">
  <h3>buyer_3</h3>
  <div class="grid">
    <div class="assets-side">
      <h4>Assets (10)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">Cash</td>
        <td class="val">10</td>
      </tr>
    
      <tr>
        <td colspan="2" class="empty">No tickets owned</td>
      </tr>
        
        </tbody>
      </table>
    </div>
    <div class="liabilities-side">
      <h4>Liabilities (0)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td colspan="2" class="empty">No obligations</td>
      </tr>
        
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="t-account">
  <h3>issuer</h3>
  <div class="grid">
    <div class="assets-side">
      <h4>Assets (100)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">Cash</td>
        <td class="val">100</td>
      </tr>
    
      <tr>
        <td colspan="2" class="empty">No tickets owned</td>
      </tr>
        
        </tbody>
      </table>
    </div>
    <div class="liabilities-side">
      <h4>Liabilities (3)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">D0</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(to dealer_mid_f, mat=200)</span></td>
      </tr>
        
      <tr>
        <td class="name">D1</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(to dealer_mid_f, mat=200)</span></td>
      </tr>
        
      <tr>
        <td class="name">VBT0</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(to vbt_mid_ea94, mat=200)</span></td>
      </tr>
        
        </tbody>
      </table>
    </div>
  </div>
</div>

    </div>
  </div>

</section>

<section class="day-section">
  <h2 class="day-header">📅 Day 1</h2>

  
<div class="events-table">
  <h3>Day 1 Events</h3>
  <table>
    <thead>
      <tr>
        <th style="width: 120px;">Kind</th>
        <th>Details</th>
        <th style="width: 200px;">Notes</th>
      </tr>
    </thead>
    <tbody>
      
          <tr>
            <td class="event-trade">trade</td>
            <td>BUY @ 1.03 [mid]</td>
            <td class="notes">trader: buyer_1, ticket: D0</td>
          </tr>
        
          <tr>
            <td class="event-trade">trade</td>
            <td>BUY @ 1.08 [mid]</td>
            <td class="notes">trader: buyer_2, ticket: D1</td>
          </tr>
        
          <tr>
            <td class="event-passthrough">trade</td>
            <td>BUY @ 1.15 [mid]</td>
            <td class="notes">trader: buyer_3, ticket: VBT0 (passthrough to VBT)</td>
          </tr>
        
          <tr>
            <td class="event-quote">quote</td>
            <td>[mid] D: 1.07/1.13, VBT: 0.85/1.15</td>
            <td class="notes">inv=0, cap=4</td>
          </tr>
        
    </tbody>
  </table>
</div>


  <div class="balances-section">
    <h3>Market State</h3>
    <div class="dealers-grid">
      
<div class="dealer-card">
  <h3>Dealer: SHORT</h3>
  <table class="params-table">
    <tbody>
      <tr class="section-header"><th colspan="2">Inventory</th></tr>
      <tr><th>Tickets (a)</th><td>0</td></tr>
      <tr><th>Face inventory (x)</th><td>0</td></tr>
      <tr><th>Cash (C)</th><td>0</td></tr>
      <tr><th>Mid-valued (V)</th><td>0</td></tr>
      <tr class="section-header"><th colspan="2">Capacity</th></tr>
      <tr><th>Max tickets (K*)</th><td>0</td></tr>
      <tr><th>One-sided cap (X*)</th><td>0</td></tr>
      <tr><th>Ladder rungs (N)</th><td>1</td></tr>
      <tr><th>Layoff prob (λ)</th><td>1</td></tr>
      <tr class="section-header"><th colspan="2">Quotes</th></tr>
      <tr><th>Inside width (I)</th><td>0</td></tr>
      <tr><th>Midline p(x)</th><td>0</td></tr>
      <tr><th>Bid <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0</td></tr>
      <tr><th>Ask <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0</td></tr>
    </tbody>
  </table>
  
</div>

<div class="dealer-card">
  <h3>Dealer: MID</h3>
  <table class="params-table">
    <tbody>
      <tr class="section-header"><th colspan="2">Inventory</th></tr>
      <tr><th>Tickets (a)</th><td>0</td></tr>
      <tr><th>Face inventory (x)</th><td>0</td></tr>
      <tr><th>Cash (C)</th><td>4.11</td></tr>
      <tr><th>Mid-valued (V)</th><td>4.11</td></tr>
      <tr class="section-header"><th colspan="2">Capacity</th></tr>
      <tr><th>Max tickets (K*)</th><td>4</td></tr>
      <tr><th>One-sided cap (X*)</th><td>4</td></tr>
      <tr><th>Ladder rungs (N)</th><td>5</td></tr>
      <tr><th>Layoff prob (λ)</th><td>0.2</td></tr>
      <tr class="section-header"><th colspan="2">Quotes</th></tr>
      <tr><th>Inside width (I)</th><td>0.06</td></tr>
      <tr><th>Midline p(x)</th><td>1.1</td></tr>
      <tr><th>Bid <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>1.07</td></tr>
      <tr><th>Ask <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>1.13</td></tr>
    </tbody>
  </table>
  
</div>

<div class="dealer-card">
  <h3>Dealer: LONG</h3>
  <table class="params-table">
    <tbody>
      <tr class="section-header"><th colspan="2">Inventory</th></tr>
      <tr><th>Tickets (a)</th><td>0</td></tr>
      <tr><th>Face inventory (x)</th><td>0</td></tr>
      <tr><th>Cash (C)</th><td>0</td></tr>
      <tr><th>Mid-valued (V)</th><td>0</td></tr>
      <tr class="section-header"><th colspan="2">Capacity</th></tr>
      <tr><th>Max tickets (K*)</th><td>0</td></tr>
      <tr><th>One-sided cap (X*)</th><td>0</td></tr>
      <tr><th>Ladder rungs (N)</th><td>1</td></tr>
      <tr><th>Layoff prob (λ)</th><td>1</td></tr>
      <tr class="section-header"><th colspan="2">Quotes</th></tr>
      <tr><th>Inside width (I)</th><td>0</td></tr>
      <tr><th>Midline p(x)</th><td>0</td></tr>
      <tr><th>Bid <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0</td></tr>
      <tr><th>Ask <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0</td></tr>
    </tbody>
  </table>
  
</div>

    </div>
    <div class="dealers-grid">
      
<div class="dealer-card vbt-card">
  <h3>VBT: SHORT</h3>
  <table class="params-table">
    <tbody>
      <tr><th>Mid anchor (M)</th><td>1</td></tr>
      <tr><th>Spread anchor (O)</th><td>0.3</td></tr>
      <tr><th>Ask (A = M + O/2)</th><td>1.15</td></tr>
      <tr><th>Bid (B = M - O/2)</th><td>0.85</td></tr>
      <tr><th>Cash</th><td>0</td></tr>
      <tr><th>Inventory</th><td>0 tickets</td></tr>
    </tbody>
  </table>
</div>

<div class="dealer-card vbt-card">
  <h3>VBT: MID</h3>
  <table class="params-table">
    <tbody>
      <tr><th>Mid anchor (M)</th><td>1</td></tr>
      <tr><th>Spread anchor (O)</th><td>0.3</td></tr>
      <tr><th>Ask (A = M + O/2)</th><td>1.15</td></tr>
      <tr><th>Bid (B = M - O/2)</th><td>0.85</td></tr>
      <tr><th>Cash</th><td>1.15</td></tr>
      <tr><th>Inventory</th><td>0 tickets</td></tr>
    </tbody>
  </table>
</div>

<div class="dealer-card vbt-card">
  <h3>VBT: LONG</h3>
  <table class="params-table">
    <tbody>
      <tr><th>Mid anchor (M)</th><td>1</td></tr>
      <tr><th>Spread anchor (O)</th><td>0.3</td></tr>
      <tr><th>Ask (A = M + O/2)</th><td>1.15</td></tr>
      <tr><th>Bid (B = M - O/2)</th><td>0.85</td></tr>
      <tr><th>Cash</th><td>0</td></tr>
      <tr><th>Inventory</th><td>0 tickets</td></tr>
    </tbody>
  </table>
</div>

    </div>
  </div>

  
  <div class="balances-section">
    <h3>Trader Balances</h3>
    <div class="traders-grid">
      
<div class="t-account">
  <h3>buyer_1</h3>
  <div class="grid">
    <div class="assets-side">
      <h4>Assets (9.97)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">Cash</td>
        <td class="val">8.97</td>
      </tr>
    
      <tr>
        <td class="name">D0</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(issuer, τ=6)</span></td>
      </tr>
        
        </tbody>
      </table>
    </div>
    <div class="liabilities-side">
      <h4>Liabilities (0)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td colspan="2" class="empty">No obligations</td>
      </tr>
        
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="t-account">
  <h3>buyer_2</h3>
  <div class="grid">
    <div class="assets-side">
      <h4>Assets (9.92)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">Cash</td>
        <td class="val">8.92</td>
      </tr>
    
      <tr>
        <td class="name">D1</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(issuer, τ=6)</span></td>
      </tr>
        
        </tbody>
      </table>
    </div>
    <div class="liabilities-side">
      <h4>Liabilities (0)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td colspan="2" class="empty">No obligations</td>
      </tr>
        
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="t-account">
  <h3>buyer_3</h3>
  <div class="grid">
    <div class="assets-side">
      <h4>Assets (9.85)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">Cash</td>
        <td class="val">8.85</td>
      </tr>
    
      <tr>
        <td class="name">VBT0</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(issuer, τ=6)</span></td>
      </tr>
        
        </tbody>
      </table>
    </div>
    <div class="liabilities-side">
      <h4>Liabilities (0)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td colspan="2" class="empty">No obligations</td>
      </tr>
        
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="t-account">
  <h3>issuer</h3>
  <div class="grid">
    <div class="assets-side">
      <h4>Assets (100)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">Cash</td>
        <td class="val">100</td>
      </tr>
    
      <tr>
        <td colspan="2" class="empty">No tickets owned</td>
      </tr>
        
        </tbody>
      </table>
    </div>
    <div class="liabilities-side">
      <h4>Liabilities (3)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">D0</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(to buyer_1, mat=200)</span></td>
      </tr>
        
      <tr>
        <td class="name">D1</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(to buyer_2, mat=200)</span></td>
      </tr>
        
      <tr>
        <td class="name">VBT0</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(to buyer_3, mat=200)</span></td>
      </tr>
        
        </tbody>
      </table>
    </div>
  </div>
</div>

    </div>
  </div>

</section>

    </main>

    <footer>
      Generated by bilancio dealer ring simulation
    </footer>
  </div>
</body>
</html>



################################################################################
# FILE: example5_report.html
# PATH: examples/dealer_ring/out/example5_report.html
################################################################################

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Example 5: Dealer Earns Over Time</title>
  <style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;line-height:1.6;color:#333;background:#f5f5f5}
.container{max-width:1400px;margin:0 auto;padding:20px}
header{background:#fff;border-radius:8px;padding:24px;margin-bottom:24px;box-shadow:0 2px 4px rgba(0,0,0,0.1)}
h1{color:#2563eb;font-size:28px;margin-bottom:8px}
h2{color:#475569;font-size:20px;margin-bottom:16px}
h3{color:#334155;font-size:18px;margin-bottom:12px}
h4{color:#475569;font-size:16px;margin:8px 0;font-weight:600}
.description{color:#64748b;font-style:italic;margin-bottom:16px}
.meta{display:flex;gap:24px;color:#64748b;font-size:14px}
.meta span{display:inline-block}
.t-account{background:#fff;border-radius:8px;padding:20px;margin-bottom:20px;box-shadow:0 2px 4px rgba(0,0,0,0.1)}
.t-account .grid{display:grid;grid-template-columns:1fr 1fr;gap:20px}
.t-account table.side{width:100%;border-collapse:collapse;font-size:14px}
.t-account th,.t-account td{border-bottom:1px solid #e5e7eb;border-right:1px solid #eef2f7;padding:8px;text-align:left}
.t-account th:last-child,.t-account td:last-child{border-right:none}
.t-account tbody tr:nth-child(even){background:#fafafa}
.t-account th{background:#f9fafb;font-weight:600;color:#374151}
.t-account td.qty,.t-account td.val,.t-account td.mat{text-align:right;white-space:nowrap}
.t-account td.name{font-weight:500}
.t-account td.empty{text-align:center;color:#9ca3af}
.assets-side h4{color:#16a34a}
.liabilities-side h4{color:#dc2626}
.events-table{background:#fff;border-radius:8px;padding:20px;margin-bottom:24px;box-shadow:0 2px 4px rgba(0,0,0,0.1)}
.events-table table{width:100%;border-collapse:collapse;font-size:14px}
.events-table th,.events-table td{border-bottom:1px solid #e5e7eb;border-right:1px solid #eef2f7;padding:8px;text-align:left}
.events-table th:last-child,.events-table td:last-child{border-right:none}
.events-table tbody tr:nth-child(even){background:#f7f9fc}
.events-table th{background:#f9fafb;font-weight:600;color:#374151}
.events-table td.qty,.events-table td.amount{text-align:center;white-space:nowrap}
.events-table td.event-kind{font-weight:500;color:#3b82f6}
.events-table td.notes{font-size:13px;color:#64748b}
.agents>h2{margin-bottom:20px;padding:0 20px}
.day-section{margin-bottom:40px;padding-bottom:40px;border-bottom:2px solid #e5e7eb}
.day-section:last-child{border-bottom:none}
.day-header{color:#1f2937;font-size:24px;margin-bottom:24px;padding:12px 0;border-bottom:1px solid #e5e7eb}
.events-section{margin-bottom:24px}
.balances-section{margin-top:24px}
.balances-section>h3{margin-bottom:20px;color:#374151;font-size:20px}
footer{text-align:center;color:#9ca3af;font-size:14px;margin-top:40px;padding:20px}
@media (max-width:768px){.t-account .grid{grid-template-columns:1fr}.meta{flex-direction:column;gap:8px}}



/* Dealer card styling */
.dealer-card {
  background: #fff;
  border-radius: 8px;
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.dealer-card h3 {
  color: #1e40af;
  margin-bottom: 16px;
  border-bottom: 2px solid #dbeafe;
  padding-bottom: 8px;
}
.params-table {
  width: 100%;
  border-collapse: collapse;
}
.params-table th {
  text-align: left;
  padding: 6px 12px;
  color: #64748b;
  font-weight: 500;
  width: 40%;
}
.params-table td {
  text-align: right;
  padding: 6px 12px;
  font-family: 'SF Mono', Monaco, monospace;
  color: #1f2937;
}
.params-table tr.section-header th {
  color: #374151;
  font-weight: 600;
  padding-top: 12px;
  border-bottom: 1px solid #e5e7eb;
}
/* VBT card */
.vbt-card {
  background: linear-gradient(135deg, #f0fdf4, #fff);
  border-left: 4px solid #16a34a;
}
.vbt-card h3 {
  color: #16a34a;
  border-bottom-color: #bbf7d0;
}
/* Event type colors */
.event-trade { color: #3b82f6; }
.event-passthrough { color: #8b5cf6; }
.event-rebucket { color: #f59e0b; }
.event-settlement { color: #16a34a; }
.event-default { color: #dc2626; }
.event-quote { color: #64748b; }
.event-vbt-anchor-update { color: #14b8a6; }
/* Pin indicators */
.pin-indicator {
  display: inline-block;
  width: 8px;
  height: 8px;
  border-radius: 50%;
  margin-left: 4px;
}
.pin-indicator.pinned { background: #f59e0b; }
.pin-indicator.not-pinned { background: #d1d5db; }
/* Grid layouts */
.dealers-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 20px;
  margin-bottom: 24px;
}
.traders-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
  gap: 20px;
}
/* Inventory list */
.inventory-list {
  margin-top: 12px;
  padding-top: 12px;
  border-top: 1px solid #e5e7eb;
}
.inventory-list h4 {
  color: #64748b;
  font-size: 14px;
  margin-bottom: 8px;
}
.inventory-list ul {
  list-style: none;
  padding: 0;
  margin: 0;
  font-size: 13px;
}
.inventory-list li {
  padding: 4px 0;
  color: #4b5563;
  font-family: 'SF Mono', Monaco, monospace;
}

  </style>
</head>
<body>
  <div class="container">
    
<header>
  <h1>Example 5: Dealer Earns Over Time</h1>
  <p class="description">Inventory grows and equity increases through bid-ask spread</p>
  <div class="meta">
    <span><strong>Days:</strong> 1</span>
    <span><strong>Buckets:</strong> short, mid, long</span>
    <span><strong>Traders:</strong> 4</span>
    <span><strong>Tickets:</strong> 5</span>
    <span><strong>Ticket Size (S):</strong> 1</span>
  </div>
</header>


    <main>
      
<section class="day-section">
  <h2 class="day-header">🏁 Day 0 (Setup)</h2>

  
<div class="events-table">
  <h3>Day 0 (Setup) Events</h3>
  <p style="color: #9ca3af; font-style: italic;">No events for this day</p>
</div>


  <div class="balances-section">
    <h3>Market State</h3>
    <div class="dealers-grid">
      
<div class="dealer-card">
  <h3>Dealer: SHORT</h3>
  <table class="params-table">
    <tbody>
      <tr class="section-header"><th colspan="2">Inventory</th></tr>
      <tr><th>Tickets (a)</th><td>0</td></tr>
      <tr><th>Face inventory (x)</th><td>0</td></tr>
      <tr><th>Cash (C)</th><td>0</td></tr>
      <tr><th>Mid-valued (V)</th><td>0</td></tr>
      <tr class="section-header"><th colspan="2">Capacity</th></tr>
      <tr><th>Max tickets (K*)</th><td>0</td></tr>
      <tr><th>One-sided cap (X*)</th><td>0</td></tr>
      <tr><th>Ladder rungs (N)</th><td>1</td></tr>
      <tr><th>Layoff prob (λ)</th><td>1</td></tr>
      <tr class="section-header"><th colspan="2">Quotes</th></tr>
      <tr><th>Inside width (I)</th><td>0</td></tr>
      <tr><th>Midline p(x)</th><td>0</td></tr>
      <tr><th>Bid <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0</td></tr>
      <tr><th>Ask <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0</td></tr>
    </tbody>
  </table>
  
</div>

<div class="dealer-card">
  <h3>Dealer: MID</h3>
  <table class="params-table">
    <tbody>
      <tr class="section-header"><th colspan="2">Inventory</th></tr>
      <tr><th>Tickets (a)</th><td>2</td></tr>
      <tr><th>Face inventory (x)</th><td>2</td></tr>
      <tr><th>Cash (C)</th><td>2</td></tr>
      <tr><th>Mid-valued (V)</th><td>4</td></tr>
      <tr class="section-header"><th colspan="2">Capacity</th></tr>
      <tr><th>Max tickets (K*)</th><td>4</td></tr>
      <tr><th>One-sided cap (X*)</th><td>4</td></tr>
      <tr><th>Ladder rungs (N)</th><td>5</td></tr>
      <tr><th>Layoff prob (λ)</th><td>0.2</td></tr>
      <tr class="section-header"><th colspan="2">Quotes</th></tr>
      <tr><th>Inside width (I)</th><td>0.06</td></tr>
      <tr><th>Midline p(x)</th><td>1</td></tr>
      <tr><th>Bid <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0.97</td></tr>
      <tr><th>Ask <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>1.03</td></tr>
    </tbody>
  </table>
  
  <div class="inventory-list">
    <h4>Inventory (2 tickets)</h4>
    <ul>
      <li>D0 (issuer: issuer, face: 1, τ: 6)</li><li>D1 (issuer: issuer, face: 1, τ: 6)</li>
    </ul>
  </div>

</div>

<div class="dealer-card">
  <h3>Dealer: LONG</h3>
  <table class="params-table">
    <tbody>
      <tr class="section-header"><th colspan="2">Inventory</th></tr>
      <tr><th>Tickets (a)</th><td>0</td></tr>
      <tr><th>Face inventory (x)</th><td>0</td></tr>
      <tr><th>Cash (C)</th><td>0</td></tr>
      <tr><th>Mid-valued (V)</th><td>0</td></tr>
      <tr class="section-header"><th colspan="2">Capacity</th></tr>
      <tr><th>Max tickets (K*)</th><td>0</td></tr>
      <tr><th>One-sided cap (X*)</th><td>0</td></tr>
      <tr><th>Ladder rungs (N)</th><td>1</td></tr>
      <tr><th>Layoff prob (λ)</th><td>1</td></tr>
      <tr class="section-header"><th colspan="2">Quotes</th></tr>
      <tr><th>Inside width (I)</th><td>0</td></tr>
      <tr><th>Midline p(x)</th><td>0</td></tr>
      <tr><th>Bid <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0</td></tr>
      <tr><th>Ask <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0</td></tr>
    </tbody>
  </table>
  
</div>

    </div>
    <div class="dealers-grid">
      
<div class="dealer-card vbt-card">
  <h3>VBT: SHORT</h3>
  <table class="params-table">
    <tbody>
      <tr><th>Mid anchor (M)</th><td>1</td></tr>
      <tr><th>Spread anchor (O)</th><td>0.3</td></tr>
      <tr><th>Ask (A = M + O/2)</th><td>1.15</td></tr>
      <tr><th>Bid (B = M - O/2)</th><td>0.85</td></tr>
      <tr><th>Cash</th><td>0</td></tr>
      <tr><th>Inventory</th><td>0 tickets</td></tr>
    </tbody>
  </table>
</div>

<div class="dealer-card vbt-card">
  <h3>VBT: MID</h3>
  <table class="params-table">
    <tbody>
      <tr><th>Mid anchor (M)</th><td>1</td></tr>
      <tr><th>Spread anchor (O)</th><td>0.3</td></tr>
      <tr><th>Ask (A = M + O/2)</th><td>1.15</td></tr>
      <tr><th>Bid (B = M - O/2)</th><td>0.85</td></tr>
      <tr><th>Cash</th><td>0</td></tr>
      <tr><th>Inventory</th><td>1 tickets</td></tr>
    </tbody>
  </table>
</div>

<div class="dealer-card vbt-card">
  <h3>VBT: LONG</h3>
  <table class="params-table">
    <tbody>
      <tr><th>Mid anchor (M)</th><td>1</td></tr>
      <tr><th>Spread anchor (O)</th><td>0.3</td></tr>
      <tr><th>Ask (A = M + O/2)</th><td>1.15</td></tr>
      <tr><th>Bid (B = M - O/2)</th><td>0.85</td></tr>
      <tr><th>Cash</th><td>0</td></tr>
      <tr><th>Inventory</th><td>0 tickets</td></tr>
    </tbody>
  </table>
</div>

    </div>
  </div>

  
  <div class="balances-section">
    <h3>Trader Balances</h3>
    <div class="traders-grid">
      
<div class="t-account">
  <h3>buyer_1</h3>
  <div class="grid">
    <div class="assets-side">
      <h4>Assets (10)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">Cash</td>
        <td class="val">10</td>
      </tr>
    
      <tr>
        <td colspan="2" class="empty">No tickets owned</td>
      </tr>
        
        </tbody>
      </table>
    </div>
    <div class="liabilities-side">
      <h4>Liabilities (0)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td colspan="2" class="empty">No obligations</td>
      </tr>
        
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="t-account">
  <h3>issuer</h3>
  <div class="grid">
    <div class="assets-side">
      <h4>Assets (100)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">Cash</td>
        <td class="val">100</td>
      </tr>
    
      <tr>
        <td colspan="2" class="empty">No tickets owned</td>
      </tr>
        
        </tbody>
      </table>
    </div>
    <div class="liabilities-side">
      <h4>Liabilities (5)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">D0</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(to dealer_mid_1, mat=200)</span></td>
      </tr>
        
      <tr>
        <td class="name">D1</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(to dealer_mid_1, mat=200)</span></td>
      </tr>
        
      <tr>
        <td class="name">S1</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(to seller_1, mat=200)</span></td>
      </tr>
        
      <tr>
        <td class="name">S2</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(to seller_2, mat=200)</span></td>
      </tr>
        
      <tr>
        <td class="name">VBT0</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(to vbt_mid_5c33, mat=200)</span></td>
      </tr>
        
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="t-account">
  <h3>seller_1</h3>
  <div class="grid">
    <div class="assets-side">
      <h4>Assets (1)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">Cash</td>
        <td class="val">0</td>
      </tr>
    
      <tr>
        <td class="name">S1</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(issuer, τ=6)</span></td>
      </tr>
        
        </tbody>
      </table>
    </div>
    <div class="liabilities-side">
      <h4>Liabilities (0)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td colspan="2" class="empty">No obligations</td>
      </tr>
        
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="t-account">
  <h3>seller_2</h3>
  <div class="grid">
    <div class="assets-side">
      <h4>Assets (1)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">Cash</td>
        <td class="val">0</td>
      </tr>
    
      <tr>
        <td class="name">S2</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(issuer, τ=6)</span></td>
      </tr>
        
        </tbody>
      </table>
    </div>
    <div class="liabilities-side">
      <h4>Liabilities (0)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td colspan="2" class="empty">No obligations</td>
      </tr>
        
        </tbody>
      </table>
    </div>
  </div>
</div>

    </div>
  </div>

</section>

<section class="day-section">
  <h2 class="day-header">📅 Day 1</h2>

  
<div class="events-table">
  <h3>Day 1 Events</h3>
  <table>
    <thead>
      <tr>
        <th style="width: 120px;">Kind</th>
        <th>Details</th>
        <th style="width: 200px;">Notes</th>
      </tr>
    </thead>
    <tbody>
      
          <tr>
            <td class="event-trade">trade</td>
            <td>SELL @ 0.97 [mid]</td>
            <td class="notes">trader: seller_1, ticket: S1</td>
          </tr>
        
          <tr>
            <td class="event-trade">trade</td>
            <td>BUY @ 0.98 [mid]</td>
            <td class="notes">trader: buyer_1, ticket: D0</td>
          </tr>
        
          <tr>
            <td class="event-trade">trade</td>
            <td>SELL @ 0.97 [mid]</td>
            <td class="notes">trader: seller_2, ticket: S2</td>
          </tr>
        
          <tr>
            <td class="event-quote">quote</td>
            <td>[mid] D: 0.92/0.98, VBT: 0.85/1.15</td>
            <td class="notes">inv=3, cap=4</td>
          </tr>
        
    </tbody>
  </table>
</div>


  <div class="balances-section">
    <h3>Market State</h3>
    <div class="dealers-grid">
      
<div class="dealer-card">
  <h3>Dealer: SHORT</h3>
  <table class="params-table">
    <tbody>
      <tr class="section-header"><th colspan="2">Inventory</th></tr>
      <tr><th>Tickets (a)</th><td>0</td></tr>
      <tr><th>Face inventory (x)</th><td>0</td></tr>
      <tr><th>Cash (C)</th><td>0</td></tr>
      <tr><th>Mid-valued (V)</th><td>0</td></tr>
      <tr class="section-header"><th colspan="2">Capacity</th></tr>
      <tr><th>Max tickets (K*)</th><td>0</td></tr>
      <tr><th>One-sided cap (X*)</th><td>0</td></tr>
      <tr><th>Ladder rungs (N)</th><td>1</td></tr>
      <tr><th>Layoff prob (λ)</th><td>1</td></tr>
      <tr class="section-header"><th colspan="2">Quotes</th></tr>
      <tr><th>Inside width (I)</th><td>0</td></tr>
      <tr><th>Midline p(x)</th><td>0</td></tr>
      <tr><th>Bid <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0</td></tr>
      <tr><th>Ask <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0</td></tr>
    </tbody>
  </table>
  
</div>

<div class="dealer-card">
  <h3>Dealer: MID</h3>
  <table class="params-table">
    <tbody>
      <tr class="section-header"><th colspan="2">Inventory</th></tr>
      <tr><th>Tickets (a)</th><td>3</td></tr>
      <tr><th>Face inventory (x)</th><td>3</td></tr>
      <tr><th>Cash (C)</th><td>1.04</td></tr>
      <tr><th>Mid-valued (V)</th><td>4.04</td></tr>
      <tr class="section-header"><th colspan="2">Capacity</th></tr>
      <tr><th>Max tickets (K*)</th><td>4</td></tr>
      <tr><th>One-sided cap (X*)</th><td>4</td></tr>
      <tr><th>Ladder rungs (N)</th><td>5</td></tr>
      <tr><th>Layoff prob (λ)</th><td>0.2</td></tr>
      <tr class="section-header"><th colspan="2">Quotes</th></tr>
      <tr><th>Inside width (I)</th><td>0.06</td></tr>
      <tr><th>Midline p(x)</th><td>0.95</td></tr>
      <tr><th>Bid <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0.92</td></tr>
      <tr><th>Ask <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0.98</td></tr>
    </tbody>
  </table>
  
  <div class="inventory-list">
    <h4>Inventory (3 tickets)</h4>
    <ul>
      <li>D1 (issuer: issuer, face: 1, τ: 6)</li><li>S1 (issuer: issuer, face: 1, τ: 6)</li><li>S2 (issuer: issuer, face: 1, τ: 6)</li>
    </ul>
  </div>

</div>

<div class="dealer-card">
  <h3>Dealer: LONG</h3>
  <table class="params-table">
    <tbody>
      <tr class="section-header"><th colspan="2">Inventory</th></tr>
      <tr><th>Tickets (a)</th><td>0</td></tr>
      <tr><th>Face inventory (x)</th><td>0</td></tr>
      <tr><th>Cash (C)</th><td>0</td></tr>
      <tr><th>Mid-valued (V)</th><td>0</td></tr>
      <tr class="section-header"><th colspan="2">Capacity</th></tr>
      <tr><th>Max tickets (K*)</th><td>0</td></tr>
      <tr><th>One-sided cap (X*)</th><td>0</td></tr>
      <tr><th>Ladder rungs (N)</th><td>1</td></tr>
      <tr><th>Layoff prob (λ)</th><td>1</td></tr>
      <tr class="section-header"><th colspan="2">Quotes</th></tr>
      <tr><th>Inside width (I)</th><td>0</td></tr>
      <tr><th>Midline p(x)</th><td>0</td></tr>
      <tr><th>Bid <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0</td></tr>
      <tr><th>Ask <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0</td></tr>
    </tbody>
  </table>
  
</div>

    </div>
    <div class="dealers-grid">
      
<div class="dealer-card vbt-card">
  <h3>VBT: SHORT</h3>
  <table class="params-table">
    <tbody>
      <tr><th>Mid anchor (M)</th><td>1</td></tr>
      <tr><th>Spread anchor (O)</th><td>0.3</td></tr>
      <tr><th>Ask (A = M + O/2)</th><td>1.15</td></tr>
      <tr><th>Bid (B = M - O/2)</th><td>0.85</td></tr>
      <tr><th>Cash</th><td>0</td></tr>
      <tr><th>Inventory</th><td>0 tickets</td></tr>
    </tbody>
  </table>
</div>

<div class="dealer-card vbt-card">
  <h3>VBT: MID</h3>
  <table class="params-table">
    <tbody>
      <tr><th>Mid anchor (M)</th><td>1</td></tr>
      <tr><th>Spread anchor (O)</th><td>0.3</td></tr>
      <tr><th>Ask (A = M + O/2)</th><td>1.15</td></tr>
      <tr><th>Bid (B = M - O/2)</th><td>0.85</td></tr>
      <tr><th>Cash</th><td>0</td></tr>
      <tr><th>Inventory</th><td>1 tickets</td></tr>
    </tbody>
  </table>
</div>

<div class="dealer-card vbt-card">
  <h3>VBT: LONG</h3>
  <table class="params-table">
    <tbody>
      <tr><th>Mid anchor (M)</th><td>1</td></tr>
      <tr><th>Spread anchor (O)</th><td>0.3</td></tr>
      <tr><th>Ask (A = M + O/2)</th><td>1.15</td></tr>
      <tr><th>Bid (B = M - O/2)</th><td>0.85</td></tr>
      <tr><th>Cash</th><td>0</td></tr>
      <tr><th>Inventory</th><td>0 tickets</td></tr>
    </tbody>
  </table>
</div>

    </div>
  </div>

  
  <div class="balances-section">
    <h3>Trader Balances</h3>
    <div class="traders-grid">
      
<div class="t-account">
  <h3>buyer_1</h3>
  <div class="grid">
    <div class="assets-side">
      <h4>Assets (10.02)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">Cash</td>
        <td class="val">9.02</td>
      </tr>
    
      <tr>
        <td class="name">D0</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(issuer, τ=6)</span></td>
      </tr>
        
        </tbody>
      </table>
    </div>
    <div class="liabilities-side">
      <h4>Liabilities (0)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td colspan="2" class="empty">No obligations</td>
      </tr>
        
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="t-account">
  <h3>issuer</h3>
  <div class="grid">
    <div class="assets-side">
      <h4>Assets (100)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">Cash</td>
        <td class="val">100</td>
      </tr>
    
      <tr>
        <td colspan="2" class="empty">No tickets owned</td>
      </tr>
        
        </tbody>
      </table>
    </div>
    <div class="liabilities-side">
      <h4>Liabilities (5)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">D0</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(to buyer_1, mat=200)</span></td>
      </tr>
        
      <tr>
        <td class="name">D1</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(to dealer_mid_1, mat=200)</span></td>
      </tr>
        
      <tr>
        <td class="name">S1</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(to dealer_mid_1, mat=200)</span></td>
      </tr>
        
      <tr>
        <td class="name">S2</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(to dealer_mid_1, mat=200)</span></td>
      </tr>
        
      <tr>
        <td class="name">VBT0</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(to vbt_mid_5c33, mat=200)</span></td>
      </tr>
        
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="t-account">
  <h3>seller_1</h3>
  <div class="grid">
    <div class="assets-side">
      <h4>Assets (0.97)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">Cash</td>
        <td class="val">0.97</td>
      </tr>
    
      <tr>
        <td colspan="2" class="empty">No tickets owned</td>
      </tr>
        
        </tbody>
      </table>
    </div>
    <div class="liabilities-side">
      <h4>Liabilities (0)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td colspan="2" class="empty">No obligations</td>
      </tr>
        
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="t-account">
  <h3>seller_2</h3>
  <div class="grid">
    <div class="assets-side">
      <h4>Assets (0.97)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">Cash</td>
        <td class="val">0.97</td>
      </tr>
    
      <tr>
        <td colspan="2" class="empty">No tickets owned</td>
      </tr>
        
        </tbody>
      </table>
    </div>
    <div class="liabilities-side">
      <h4>Liabilities (0)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td colspan="2" class="empty">No obligations</td>
      </tr>
        
        </tbody>
      </table>
    </div>
  </div>
</div>

    </div>
  </div>

</section>

    </main>

    <footer>
      Generated by bilancio dealer ring simulation
    </footer>
  </div>
</body>
</html>



################################################################################
# FILE: example6_report.html
# PATH: examples/dealer_ring/out/example6_report.html
################################################################################

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Example 6: Bid-Side Pass-Through</title>
  <style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;line-height:1.6;color:#333;background:#f5f5f5}
.container{max-width:1400px;margin:0 auto;padding:20px}
header{background:#fff;border-radius:8px;padding:24px;margin-bottom:24px;box-shadow:0 2px 4px rgba(0,0,0,0.1)}
h1{color:#2563eb;font-size:28px;margin-bottom:8px}
h2{color:#475569;font-size:20px;margin-bottom:16px}
h3{color:#334155;font-size:18px;margin-bottom:12px}
h4{color:#475569;font-size:16px;margin:8px 0;font-weight:600}
.description{color:#64748b;font-style:italic;margin-bottom:16px}
.meta{display:flex;gap:24px;color:#64748b;font-size:14px}
.meta span{display:inline-block}
.t-account{background:#fff;border-radius:8px;padding:20px;margin-bottom:20px;box-shadow:0 2px 4px rgba(0,0,0,0.1)}
.t-account .grid{display:grid;grid-template-columns:1fr 1fr;gap:20px}
.t-account table.side{width:100%;border-collapse:collapse;font-size:14px}
.t-account th,.t-account td{border-bottom:1px solid #e5e7eb;border-right:1px solid #eef2f7;padding:8px;text-align:left}
.t-account th:last-child,.t-account td:last-child{border-right:none}
.t-account tbody tr:nth-child(even){background:#fafafa}
.t-account th{background:#f9fafb;font-weight:600;color:#374151}
.t-account td.qty,.t-account td.val,.t-account td.mat{text-align:right;white-space:nowrap}
.t-account td.name{font-weight:500}
.t-account td.empty{text-align:center;color:#9ca3af}
.assets-side h4{color:#16a34a}
.liabilities-side h4{color:#dc2626}
.events-table{background:#fff;border-radius:8px;padding:20px;margin-bottom:24px;box-shadow:0 2px 4px rgba(0,0,0,0.1)}
.events-table table{width:100%;border-collapse:collapse;font-size:14px}
.events-table th,.events-table td{border-bottom:1px solid #e5e7eb;border-right:1px solid #eef2f7;padding:8px;text-align:left}
.events-table th:last-child,.events-table td:last-child{border-right:none}
.events-table tbody tr:nth-child(even){background:#f7f9fc}
.events-table th{background:#f9fafb;font-weight:600;color:#374151}
.events-table td.qty,.events-table td.amount{text-align:center;white-space:nowrap}
.events-table td.event-kind{font-weight:500;color:#3b82f6}
.events-table td.notes{font-size:13px;color:#64748b}
.agents>h2{margin-bottom:20px;padding:0 20px}
.day-section{margin-bottom:40px;padding-bottom:40px;border-bottom:2px solid #e5e7eb}
.day-section:last-child{border-bottom:none}
.day-header{color:#1f2937;font-size:24px;margin-bottom:24px;padding:12px 0;border-bottom:1px solid #e5e7eb}
.events-section{margin-bottom:24px}
.balances-section{margin-top:24px}
.balances-section>h3{margin-bottom:20px;color:#374151;font-size:20px}
footer{text-align:center;color:#9ca3af;font-size:14px;margin-top:40px;padding:20px}
@media (max-width:768px){.t-account .grid{grid-template-columns:1fr}.meta{flex-direction:column;gap:8px}}



/* Dealer card styling */
.dealer-card {
  background: #fff;
  border-radius: 8px;
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.dealer-card h3 {
  color: #1e40af;
  margin-bottom: 16px;
  border-bottom: 2px solid #dbeafe;
  padding-bottom: 8px;
}
.params-table {
  width: 100%;
  border-collapse: collapse;
}
.params-table th {
  text-align: left;
  padding: 6px 12px;
  color: #64748b;
  font-weight: 500;
  width: 40%;
}
.params-table td {
  text-align: right;
  padding: 6px 12px;
  font-family: 'SF Mono', Monaco, monospace;
  color: #1f2937;
}
.params-table tr.section-header th {
  color: #374151;
  font-weight: 600;
  padding-top: 12px;
  border-bottom: 1px solid #e5e7eb;
}
/* VBT card */
.vbt-card {
  background: linear-gradient(135deg, #f0fdf4, #fff);
  border-left: 4px solid #16a34a;
}
.vbt-card h3 {
  color: #16a34a;
  border-bottom-color: #bbf7d0;
}
/* Event type colors */
.event-trade { color: #3b82f6; }
.event-passthrough { color: #8b5cf6; }
.event-rebucket { color: #f59e0b; }
.event-settlement { color: #16a34a; }
.event-default { color: #dc2626; }
.event-quote { color: #64748b; }
.event-vbt-anchor-update { color: #14b8a6; }
/* Pin indicators */
.pin-indicator {
  display: inline-block;
  width: 8px;
  height: 8px;
  border-radius: 50%;
  margin-left: 4px;
}
.pin-indicator.pinned { background: #f59e0b; }
.pin-indicator.not-pinned { background: #d1d5db; }
/* Grid layouts */
.dealers-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 20px;
  margin-bottom: 24px;
}
.traders-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
  gap: 20px;
}
/* Inventory list */
.inventory-list {
  margin-top: 12px;
  padding-top: 12px;
  border-top: 1px solid #e5e7eb;
}
.inventory-list h4 {
  color: #64748b;
  font-size: 14px;
  margin-bottom: 8px;
}
.inventory-list ul {
  list-style: none;
  padding: 0;
  margin: 0;
  font-size: 13px;
}
.inventory-list li {
  padding: 4px 0;
  color: #4b5563;
  font-family: 'SF Mono', Monaco, monospace;
}

  </style>
</head>
<body>
  <div class="container">
    
<header>
  <h1>Example 6: Bid-Side Pass-Through</h1>
  <p class="description">Customer SELL routed to VBT when dealer at capacity</p>
  <div class="meta">
    <span><strong>Days:</strong> 1</span>
    <span><strong>Buckets:</strong> short, mid, long</span>
    <span><strong>Traders:</strong> 2</span>
    <span><strong>Tickets:</strong> 3</span>
    <span><strong>Ticket Size (S):</strong> 1</span>
  </div>
</header>


    <main>
      
<section class="day-section">
  <h2 class="day-header">🏁 Day 0 (Setup)</h2>

  
<div class="events-table">
  <h3>Day 0 (Setup) Events</h3>
  <p style="color: #9ca3af; font-style: italic;">No events for this day</p>
</div>


  <div class="balances-section">
    <h3>Market State</h3>
    <div class="dealers-grid">
      
<div class="dealer-card">
  <h3>Dealer: SHORT</h3>
  <table class="params-table">
    <tbody>
      <tr class="section-header"><th colspan="2">Inventory</th></tr>
      <tr><th>Tickets (a)</th><td>0</td></tr>
      <tr><th>Face inventory (x)</th><td>0</td></tr>
      <tr><th>Cash (C)</th><td>0</td></tr>
      <tr><th>Mid-valued (V)</th><td>0</td></tr>
      <tr class="section-header"><th colspan="2">Capacity</th></tr>
      <tr><th>Max tickets (K*)</th><td>0</td></tr>
      <tr><th>One-sided cap (X*)</th><td>0</td></tr>
      <tr><th>Ladder rungs (N)</th><td>1</td></tr>
      <tr><th>Layoff prob (λ)</th><td>1</td></tr>
      <tr class="section-header"><th colspan="2">Quotes</th></tr>
      <tr><th>Inside width (I)</th><td>0</td></tr>
      <tr><th>Midline p(x)</th><td>0</td></tr>
      <tr><th>Bid <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0</td></tr>
      <tr><th>Ask <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0</td></tr>
    </tbody>
  </table>
  
</div>

<div class="dealer-card">
  <h3>Dealer: MID</h3>
  <table class="params-table">
    <tbody>
      <tr class="section-header"><th colspan="2">Inventory</th></tr>
      <tr><th>Tickets (a)</th><td>2</td></tr>
      <tr><th>Face inventory (x)</th><td>2</td></tr>
      <tr><th>Cash (C)</th><td>0.1</td></tr>
      <tr><th>Mid-valued (V)</th><td>2.1</td></tr>
      <tr class="section-header"><th colspan="2">Capacity</th></tr>
      <tr><th>Max tickets (K*)</th><td>2</td></tr>
      <tr><th>One-sided cap (X*)</th><td>2</td></tr>
      <tr><th>Ladder rungs (N)</th><td>3</td></tr>
      <tr><th>Layoff prob (λ)</th><td>0.3333</td></tr>
      <tr class="section-header"><th colspan="2">Quotes</th></tr>
      <tr><th>Inside width (I)</th><td>0.1</td></tr>
      <tr><th>Midline p(x)</th><td>0.925</td></tr>
      <tr><th>Bid <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0.875</td></tr>
      <tr><th>Ask <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0.975</td></tr>
    </tbody>
  </table>
  
  <div class="inventory-list">
    <h4>Inventory (2 tickets)</h4>
    <ul>
      <li>D0 (issuer: issuer, face: 1, τ: 6)</li><li>D1 (issuer: issuer, face: 1, τ: 6)</li>
    </ul>
  </div>

</div>

<div class="dealer-card">
  <h3>Dealer: LONG</h3>
  <table class="params-table">
    <tbody>
      <tr class="section-header"><th colspan="2">Inventory</th></tr>
      <tr><th>Tickets (a)</th><td>0</td></tr>
      <tr><th>Face inventory (x)</th><td>0</td></tr>
      <tr><th>Cash (C)</th><td>0</td></tr>
      <tr><th>Mid-valued (V)</th><td>0</td></tr>
      <tr class="section-header"><th colspan="2">Capacity</th></tr>
      <tr><th>Max tickets (K*)</th><td>0</td></tr>
      <tr><th>One-sided cap (X*)</th><td>0</td></tr>
      <tr><th>Ladder rungs (N)</th><td>1</td></tr>
      <tr><th>Layoff prob (λ)</th><td>1</td></tr>
      <tr class="section-header"><th colspan="2">Quotes</th></tr>
      <tr><th>Inside width (I)</th><td>0</td></tr>
      <tr><th>Midline p(x)</th><td>0</td></tr>
      <tr><th>Bid <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0</td></tr>
      <tr><th>Ask <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0</td></tr>
    </tbody>
  </table>
  
</div>

    </div>
    <div class="dealers-grid">
      
<div class="dealer-card vbt-card">
  <h3>VBT: SHORT</h3>
  <table class="params-table">
    <tbody>
      <tr><th>Mid anchor (M)</th><td>1</td></tr>
      <tr><th>Spread anchor (O)</th><td>0.3</td></tr>
      <tr><th>Ask (A = M + O/2)</th><td>1.15</td></tr>
      <tr><th>Bid (B = M - O/2)</th><td>0.85</td></tr>
      <tr><th>Cash</th><td>0</td></tr>
      <tr><th>Inventory</th><td>0 tickets</td></tr>
    </tbody>
  </table>
</div>

<div class="dealer-card vbt-card">
  <h3>VBT: MID</h3>
  <table class="params-table">
    <tbody>
      <tr><th>Mid anchor (M)</th><td>1</td></tr>
      <tr><th>Spread anchor (O)</th><td>0.3</td></tr>
      <tr><th>Ask (A = M + O/2)</th><td>1.15</td></tr>
      <tr><th>Bid (B = M - O/2)</th><td>0.85</td></tr>
      <tr><th>Cash</th><td>10</td></tr>
      <tr><th>Inventory</th><td>0 tickets</td></tr>
    </tbody>
  </table>
</div>

<div class="dealer-card vbt-card">
  <h3>VBT: LONG</h3>
  <table class="params-table">
    <tbody>
      <tr><th>Mid anchor (M)</th><td>1</td></tr>
      <tr><th>Spread anchor (O)</th><td>0.3</td></tr>
      <tr><th>Ask (A = M + O/2)</th><td>1.15</td></tr>
      <tr><th>Bid (B = M - O/2)</th><td>0.85</td></tr>
      <tr><th>Cash</th><td>0</td></tr>
      <tr><th>Inventory</th><td>0 tickets</td></tr>
    </tbody>
  </table>
</div>

    </div>
  </div>

  
  <div class="balances-section">
    <h3>Trader Balances</h3>
    <div class="traders-grid">
      
<div class="t-account">
  <h3>issuer</h3>
  <div class="grid">
    <div class="assets-side">
      <h4>Assets (100)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">Cash</td>
        <td class="val">100</td>
      </tr>
    
      <tr>
        <td colspan="2" class="empty">No tickets owned</td>
      </tr>
        
        </tbody>
      </table>
    </div>
    <div class="liabilities-side">
      <h4>Liabilities (3)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">D0</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(to dealer_mid_7, mat=200)</span></td>
      </tr>
        
      <tr>
        <td class="name">D1</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(to dealer_mid_7, mat=200)</span></td>
      </tr>
        
      <tr>
        <td class="name">SELL1</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(to seller, mat=200)</span></td>
      </tr>
        
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="t-account">
  <h3>seller</h3>
  <div class="grid">
    <div class="assets-side">
      <h4>Assets (1)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">Cash</td>
        <td class="val">0</td>
      </tr>
    
      <tr>
        <td class="name">SELL1</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(issuer, τ=6)</span></td>
      </tr>
        
        </tbody>
      </table>
    </div>
    <div class="liabilities-side">
      <h4>Liabilities (0)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td colspan="2" class="empty">No obligations</td>
      </tr>
        
        </tbody>
      </table>
    </div>
  </div>
</div>

    </div>
  </div>

</section>

<section class="day-section">
  <h2 class="day-header">📅 Day 1</h2>

  
<div class="events-table">
  <h3>Day 1 Events</h3>
  <table>
    <thead>
      <tr>
        <th style="width: 120px;">Kind</th>
        <th>Details</th>
        <th style="width: 200px;">Notes</th>
      </tr>
    </thead>
    <tbody>
      
          <tr>
            <td class="event-passthrough">trade</td>
            <td>SELL @ 0.85 [mid]</td>
            <td class="notes">trader: seller, ticket: SELL1 (passthrough to VBT)</td>
          </tr>
        
          <tr>
            <td class="event-quote">quote</td>
            <td>[mid] D: 0.875/0.975, VBT: 0.85/1.15</td>
            <td class="notes">inv=2, cap=2</td>
          </tr>
        
    </tbody>
  </table>
</div>


  <div class="balances-section">
    <h3>Market State</h3>
    <div class="dealers-grid">
      
<div class="dealer-card">
  <h3>Dealer: SHORT</h3>
  <table class="params-table">
    <tbody>
      <tr class="section-header"><th colspan="2">Inventory</th></tr>
      <tr><th>Tickets (a)</th><td>0</td></tr>
      <tr><th>Face inventory (x)</th><td>0</td></tr>
      <tr><th>Cash (C)</th><td>0</td></tr>
      <tr><th>Mid-valued (V)</th><td>0</td></tr>
      <tr class="section-header"><th colspan="2">Capacity</th></tr>
      <tr><th>Max tickets (K*)</th><td>0</td></tr>
      <tr><th>One-sided cap (X*)</th><td>0</td></tr>
      <tr><th>Ladder rungs (N)</th><td>1</td></tr>
      <tr><th>Layoff prob (λ)</th><td>1</td></tr>
      <tr class="section-header"><th colspan="2">Quotes</th></tr>
      <tr><th>Inside width (I)</th><td>0</td></tr>
      <tr><th>Midline p(x)</th><td>0</td></tr>
      <tr><th>Bid <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0</td></tr>
      <tr><th>Ask <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0</td></tr>
    </tbody>
  </table>
  
</div>

<div class="dealer-card">
  <h3>Dealer: MID</h3>
  <table class="params-table">
    <tbody>
      <tr class="section-header"><th colspan="2">Inventory</th></tr>
      <tr><th>Tickets (a)</th><td>2</td></tr>
      <tr><th>Face inventory (x)</th><td>2</td></tr>
      <tr><th>Cash (C)</th><td>0.1</td></tr>
      <tr><th>Mid-valued (V)</th><td>2.1</td></tr>
      <tr class="section-header"><th colspan="2">Capacity</th></tr>
      <tr><th>Max tickets (K*)</th><td>2</td></tr>
      <tr><th>One-sided cap (X*)</th><td>2</td></tr>
      <tr><th>Ladder rungs (N)</th><td>3</td></tr>
      <tr><th>Layoff prob (λ)</th><td>0.3333</td></tr>
      <tr class="section-header"><th colspan="2">Quotes</th></tr>
      <tr><th>Inside width (I)</th><td>0.1</td></tr>
      <tr><th>Midline p(x)</th><td>0.925</td></tr>
      <tr><th>Bid <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0.875</td></tr>
      <tr><th>Ask <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0.975</td></tr>
    </tbody>
  </table>
  
  <div class="inventory-list">
    <h4>Inventory (2 tickets)</h4>
    <ul>
      <li>D0 (issuer: issuer, face: 1, τ: 6)</li><li>D1 (issuer: issuer, face: 1, τ: 6)</li>
    </ul>
  </div>

</div>

<div class="dealer-card">
  <h3>Dealer: LONG</h3>
  <table class="params-table">
    <tbody>
      <tr class="section-header"><th colspan="2">Inventory</th></tr>
      <tr><th>Tickets (a)</th><td>0</td></tr>
      <tr><th>Face inventory (x)</th><td>0</td></tr>
      <tr><th>Cash (C)</th><td>0</td></tr>
      <tr><th>Mid-valued (V)</th><td>0</td></tr>
      <tr class="section-header"><th colspan="2">Capacity</th></tr>
      <tr><th>Max tickets (K*)</th><td>0</td></tr>
      <tr><th>One-sided cap (X*)</th><td>0</td></tr>
      <tr><th>Ladder rungs (N)</th><td>1</td></tr>
      <tr><th>Layoff prob (λ)</th><td>1</td></tr>
      <tr class="section-header"><th colspan="2">Quotes</th></tr>
      <tr><th>Inside width (I)</th><td>0</td></tr>
      <tr><th>Midline p(x)</th><td>0</td></tr>
      <tr><th>Bid <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0</td></tr>
      <tr><th>Ask <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0</td></tr>
    </tbody>
  </table>
  
</div>

    </div>
    <div class="dealers-grid">
      
<div class="dealer-card vbt-card">
  <h3>VBT: SHORT</h3>
  <table class="params-table">
    <tbody>
      <tr><th>Mid anchor (M)</th><td>1</td></tr>
      <tr><th>Spread anchor (O)</th><td>0.3</td></tr>
      <tr><th>Ask (A = M + O/2)</th><td>1.15</td></tr>
      <tr><th>Bid (B = M - O/2)</th><td>0.85</td></tr>
      <tr><th>Cash</th><td>0</td></tr>
      <tr><th>Inventory</th><td>0 tickets</td></tr>
    </tbody>
  </table>
</div>

<div class="dealer-card vbt-card">
  <h3>VBT: MID</h3>
  <table class="params-table">
    <tbody>
      <tr><th>Mid anchor (M)</th><td>1</td></tr>
      <tr><th>Spread anchor (O)</th><td>0.3</td></tr>
      <tr><th>Ask (A = M + O/2)</th><td>1.15</td></tr>
      <tr><th>Bid (B = M - O/2)</th><td>0.85</td></tr>
      <tr><th>Cash</th><td>9.15</td></tr>
      <tr><th>Inventory</th><td>1 tickets</td></tr>
    </tbody>
  </table>
</div>

<div class="dealer-card vbt-card">
  <h3>VBT: LONG</h3>
  <table class="params-table">
    <tbody>
      <tr><th>Mid anchor (M)</th><td>1</td></tr>
      <tr><th>Spread anchor (O)</th><td>0.3</td></tr>
      <tr><th>Ask (A = M + O/2)</th><td>1.15</td></tr>
      <tr><th>Bid (B = M - O/2)</th><td>0.85</td></tr>
      <tr><th>Cash</th><td>0</td></tr>
      <tr><th>Inventory</th><td>0 tickets</td></tr>
    </tbody>
  </table>
</div>

    </div>
  </div>

  
  <div class="balances-section">
    <h3>Trader Balances</h3>
    <div class="traders-grid">
      
<div class="t-account">
  <h3>issuer</h3>
  <div class="grid">
    <div class="assets-side">
      <h4>Assets (100)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">Cash</td>
        <td class="val">100</td>
      </tr>
    
      <tr>
        <td colspan="2" class="empty">No tickets owned</td>
      </tr>
        
        </tbody>
      </table>
    </div>
    <div class="liabilities-side">
      <h4>Liabilities (3)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">D0</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(to dealer_mid_7, mat=200)</span></td>
      </tr>
        
      <tr>
        <td class="name">D1</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(to dealer_mid_7, mat=200)</span></td>
      </tr>
        
      <tr>
        <td class="name">SELL1</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(to vbt_mid_a880, mat=200)</span></td>
      </tr>
        
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="t-account">
  <h3>seller</h3>
  <div class="grid">
    <div class="assets-side">
      <h4>Assets (0.85)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">Cash</td>
        <td class="val">0.85</td>
      </tr>
    
      <tr>
        <td colspan="2" class="empty">No tickets owned</td>
      </tr>
        
        </tbody>
      </table>
    </div>
    <div class="liabilities-side">
      <h4>Liabilities (0)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td colspan="2" class="empty">No obligations</td>
      </tr>
        
        </tbody>
      </table>
    </div>
  </div>
</div>

    </div>
  </div>

</section>

    </main>

    <footer>
      Generated by bilancio dealer ring simulation
    </footer>
  </div>
</body>
</html>



################################################################################
# FILE: example7_report.html
# PATH: examples/dealer_ring/out/example7_report.html
################################################################################

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Example 7: No Interior Clipping</title>
  <style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;line-height:1.6;color:#333;background:#f5f5f5}
.container{max-width:1400px;margin:0 auto;padding:20px}
header{background:#fff;border-radius:8px;padding:24px;margin-bottom:24px;box-shadow:0 2px 4px rgba(0,0,0,0.1)}
h1{color:#2563eb;font-size:28px;margin-bottom:8px}
h2{color:#475569;font-size:20px;margin-bottom:16px}
h3{color:#334155;font-size:18px;margin-bottom:12px}
h4{color:#475569;font-size:16px;margin:8px 0;font-weight:600}
.description{color:#64748b;font-style:italic;margin-bottom:16px}
.meta{display:flex;gap:24px;color:#64748b;font-size:14px}
.meta span{display:inline-block}
.t-account{background:#fff;border-radius:8px;padding:20px;margin-bottom:20px;box-shadow:0 2px 4px rgba(0,0,0,0.1)}
.t-account .grid{display:grid;grid-template-columns:1fr 1fr;gap:20px}
.t-account table.side{width:100%;border-collapse:collapse;font-size:14px}
.t-account th,.t-account td{border-bottom:1px solid #e5e7eb;border-right:1px solid #eef2f7;padding:8px;text-align:left}
.t-account th:last-child,.t-account td:last-child{border-right:none}
.t-account tbody tr:nth-child(even){background:#fafafa}
.t-account th{background:#f9fafb;font-weight:600;color:#374151}
.t-account td.qty,.t-account td.val,.t-account td.mat{text-align:right;white-space:nowrap}
.t-account td.name{font-weight:500}
.t-account td.empty{text-align:center;color:#9ca3af}
.assets-side h4{color:#16a34a}
.liabilities-side h4{color:#dc2626}
.events-table{background:#fff;border-radius:8px;padding:20px;margin-bottom:24px;box-shadow:0 2px 4px rgba(0,0,0,0.1)}
.events-table table{width:100%;border-collapse:collapse;font-size:14px}
.events-table th,.events-table td{border-bottom:1px solid #e5e7eb;border-right:1px solid #eef2f7;padding:8px;text-align:left}
.events-table th:last-child,.events-table td:last-child{border-right:none}
.events-table tbody tr:nth-child(even){background:#f7f9fc}
.events-table th{background:#f9fafb;font-weight:600;color:#374151}
.events-table td.qty,.events-table td.amount{text-align:center;white-space:nowrap}
.events-table td.event-kind{font-weight:500;color:#3b82f6}
.events-table td.notes{font-size:13px;color:#64748b}
.agents>h2{margin-bottom:20px;padding:0 20px}
.day-section{margin-bottom:40px;padding-bottom:40px;border-bottom:2px solid #e5e7eb}
.day-section:last-child{border-bottom:none}
.day-header{color:#1f2937;font-size:24px;margin-bottom:24px;padding:12px 0;border-bottom:1px solid #e5e7eb}
.events-section{margin-bottom:24px}
.balances-section{margin-top:24px}
.balances-section>h3{margin-bottom:20px;color:#374151;font-size:20px}
footer{text-align:center;color:#9ca3af;font-size:14px;margin-top:40px;padding:20px}
@media (max-width:768px){.t-account .grid{grid-template-columns:1fr}.meta{flex-direction:column;gap:8px}}



/* Dealer card styling */
.dealer-card {
  background: #fff;
  border-radius: 8px;
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.dealer-card h3 {
  color: #1e40af;
  margin-bottom: 16px;
  border-bottom: 2px solid #dbeafe;
  padding-bottom: 8px;
}
.params-table {
  width: 100%;
  border-collapse: collapse;
}
.params-table th {
  text-align: left;
  padding: 6px 12px;
  color: #64748b;
  font-weight: 500;
  width: 40%;
}
.params-table td {
  text-align: right;
  padding: 6px 12px;
  font-family: 'SF Mono', Monaco, monospace;
  color: #1f2937;
}
.params-table tr.section-header th {
  color: #374151;
  font-weight: 600;
  padding-top: 12px;
  border-bottom: 1px solid #e5e7eb;
}
/* VBT card */
.vbt-card {
  background: linear-gradient(135deg, #f0fdf4, #fff);
  border-left: 4px solid #16a34a;
}
.vbt-card h3 {
  color: #16a34a;
  border-bottom-color: #bbf7d0;
}
/* Event type colors */
.event-trade { color: #3b82f6; }
.event-passthrough { color: #8b5cf6; }
.event-rebucket { color: #f59e0b; }
.event-settlement { color: #16a34a; }
.event-default { color: #dc2626; }
.event-quote { color: #64748b; }
.event-vbt-anchor-update { color: #14b8a6; }
/* Pin indicators */
.pin-indicator {
  display: inline-block;
  width: 8px;
  height: 8px;
  border-radius: 50%;
  margin-left: 4px;
}
.pin-indicator.pinned { background: #f59e0b; }
.pin-indicator.not-pinned { background: #d1d5db; }
/* Grid layouts */
.dealers-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 20px;
  margin-bottom: 24px;
}
.traders-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
  gap: 20px;
}
/* Inventory list */
.inventory-list {
  margin-top: 12px;
  padding-top: 12px;
  border-top: 1px solid #e5e7eb;
}
.inventory-list h4 {
  color: #64748b;
  font-size: 14px;
  margin-bottom: 8px;
}
.inventory-list ul {
  list-style: none;
  padding: 0;
  margin: 0;
  font-size: 13px;
}
.inventory-list li {
  padding: 4px 0;
  color: #4b5563;
  font-family: 'SF Mono', Monaco, monospace;
}

  </style>
</head>
<body>
  <div class="container">
    
<header>
  <h1>Example 7: No Interior Clipping</h1>
  <p class="description">Interior quotes always strictly inside outside quotes</p>
  <div class="meta">
    <span><strong>Days:</strong> 1</span>
    <span><strong>Buckets:</strong> short, mid, long</span>
    <span><strong>Traders:</strong> 1</span>
    <span><strong>Tickets:</strong> 9</span>
    <span><strong>Ticket Size (S):</strong> 1</span>
  </div>
</header>


    <main>
      
<section class="day-section">
  <h2 class="day-header">🏁 Day 0 (Setup)</h2>

  
<div class="events-table">
  <h3>Day 0 (Setup) Events</h3>
  <p style="color: #9ca3af; font-style: italic;">No events for this day</p>
</div>


  <div class="balances-section">
    <h3>Market State</h3>
    <div class="dealers-grid">
      
<div class="dealer-card">
  <h3>Dealer: SHORT</h3>
  <table class="params-table">
    <tbody>
      <tr class="section-header"><th colspan="2">Inventory</th></tr>
      <tr><th>Tickets (a)</th><td>0</td></tr>
      <tr><th>Face inventory (x)</th><td>0</td></tr>
      <tr><th>Cash (C)</th><td>0</td></tr>
      <tr><th>Mid-valued (V)</th><td>0</td></tr>
      <tr class="section-header"><th colspan="2">Capacity</th></tr>
      <tr><th>Max tickets (K*)</th><td>0</td></tr>
      <tr><th>One-sided cap (X*)</th><td>0</td></tr>
      <tr><th>Ladder rungs (N)</th><td>1</td></tr>
      <tr><th>Layoff prob (λ)</th><td>1</td></tr>
      <tr class="section-header"><th colspan="2">Quotes</th></tr>
      <tr><th>Inside width (I)</th><td>0</td></tr>
      <tr><th>Midline p(x)</th><td>0</td></tr>
      <tr><th>Bid <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0</td></tr>
      <tr><th>Ask <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0</td></tr>
    </tbody>
  </table>
  
</div>

<div class="dealer-card">
  <h3>Dealer: MID</h3>
  <table class="params-table">
    <tbody>
      <tr class="section-header"><th colspan="2">Inventory</th></tr>
      <tr><th>Tickets (a)</th><td>4</td></tr>
      <tr><th>Face inventory (x)</th><td>4</td></tr>
      <tr><th>Cash (C)</th><td>0.9</td></tr>
      <tr><th>Mid-valued (V)</th><td>4.9</td></tr>
      <tr class="section-header"><th colspan="2">Capacity</th></tr>
      <tr><th>Max tickets (K*)</th><td>4</td></tr>
      <tr><th>One-sided cap (X*)</th><td>4</td></tr>
      <tr><th>Ladder rungs (N)</th><td>5</td></tr>
      <tr><th>Layoff prob (λ)</th><td>0.2</td></tr>
      <tr class="section-header"><th colspan="2">Quotes</th></tr>
      <tr><th>Inside width (I)</th><td>0.06</td></tr>
      <tr><th>Midline p(x)</th><td>0.9</td></tr>
      <tr><th>Bid <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0.87</td></tr>
      <tr><th>Ask <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0.93</td></tr>
    </tbody>
  </table>
  
  <div class="inventory-list">
    <h4>Inventory (4 tickets)</h4>
    <ul>
      <li>D0 (issuer: issuer, face: 1, τ: 6)</li><li>D1 (issuer: issuer, face: 1, τ: 6)</li><li>D2 (issuer: issuer, face: 1, τ: 6)</li><li>D3 (issuer: issuer, face: 1, τ: 6)</li>
    </ul>
  </div>

</div>

<div class="dealer-card">
  <h3>Dealer: LONG</h3>
  <table class="params-table">
    <tbody>
      <tr class="section-header"><th colspan="2">Inventory</th></tr>
      <tr><th>Tickets (a)</th><td>0</td></tr>
      <tr><th>Face inventory (x)</th><td>0</td></tr>
      <tr><th>Cash (C)</th><td>0</td></tr>
      <tr><th>Mid-valued (V)</th><td>0</td></tr>
      <tr class="section-header"><th colspan="2">Capacity</th></tr>
      <tr><th>Max tickets (K*)</th><td>0</td></tr>
      <tr><th>One-sided cap (X*)</th><td>0</td></tr>
      <tr><th>Ladder rungs (N)</th><td>1</td></tr>
      <tr><th>Layoff prob (λ)</th><td>1</td></tr>
      <tr class="section-header"><th colspan="2">Quotes</th></tr>
      <tr><th>Inside width (I)</th><td>0</td></tr>
      <tr><th>Midline p(x)</th><td>0</td></tr>
      <tr><th>Bid <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0</td></tr>
      <tr><th>Ask <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0</td></tr>
    </tbody>
  </table>
  
</div>

    </div>
    <div class="dealers-grid">
      
<div class="dealer-card vbt-card">
  <h3>VBT: SHORT</h3>
  <table class="params-table">
    <tbody>
      <tr><th>Mid anchor (M)</th><td>1</td></tr>
      <tr><th>Spread anchor (O)</th><td>0.3</td></tr>
      <tr><th>Ask (A = M + O/2)</th><td>1.15</td></tr>
      <tr><th>Bid (B = M - O/2)</th><td>0.85</td></tr>
      <tr><th>Cash</th><td>0</td></tr>
      <tr><th>Inventory</th><td>0 tickets</td></tr>
    </tbody>
  </table>
</div>

<div class="dealer-card vbt-card">
  <h3>VBT: MID</h3>
  <table class="params-table">
    <tbody>
      <tr><th>Mid anchor (M)</th><td>1</td></tr>
      <tr><th>Spread anchor (O)</th><td>0.3</td></tr>
      <tr><th>Ask (A = M + O/2)</th><td>1.15</td></tr>
      <tr><th>Bid (B = M - O/2)</th><td>0.85</td></tr>
      <tr><th>Cash</th><td>0</td></tr>
      <tr><th>Inventory</th><td>5 tickets</td></tr>
    </tbody>
  </table>
</div>

<div class="dealer-card vbt-card">
  <h3>VBT: LONG</h3>
  <table class="params-table">
    <tbody>
      <tr><th>Mid anchor (M)</th><td>1</td></tr>
      <tr><th>Spread anchor (O)</th><td>0.3</td></tr>
      <tr><th>Ask (A = M + O/2)</th><td>1.15</td></tr>
      <tr><th>Bid (B = M - O/2)</th><td>0.85</td></tr>
      <tr><th>Cash</th><td>0</td></tr>
      <tr><th>Inventory</th><td>0 tickets</td></tr>
    </tbody>
  </table>
</div>

    </div>
  </div>

  
  <div class="balances-section">
    <h3>Trader Balances</h3>
    <div class="traders-grid">
      
<div class="t-account">
  <h3>issuer</h3>
  <div class="grid">
    <div class="assets-side">
      <h4>Assets (100)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">Cash</td>
        <td class="val">100</td>
      </tr>
    
      <tr>
        <td colspan="2" class="empty">No tickets owned</td>
      </tr>
        
        </tbody>
      </table>
    </div>
    <div class="liabilities-side">
      <h4>Liabilities (4)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">D0</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(to dealer_mid_7, mat=200)</span></td>
      </tr>
        
      <tr>
        <td class="name">D1</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(to dealer_mid_7, mat=200)</span></td>
      </tr>
        
      <tr>
        <td class="name">D2</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(to dealer_mid_7, mat=200)</span></td>
      </tr>
        
      <tr>
        <td class="name">D3</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(to dealer_mid_7, mat=200)</span></td>
      </tr>
        
        </tbody>
      </table>
    </div>
  </div>
</div>

    </div>
  </div>

</section>

<section class="day-section">
  <h2 class="day-header">📅 Day 1</h2>

  
<div class="events-table">
  <h3>Day 1 Events</h3>
  <p style="color: #9ca3af; font-style: italic;">No events for this day</p>
</div>


  <div class="balances-section">
    <h3>Market State</h3>
    <div class="dealers-grid">
      
<div class="dealer-card">
  <h3>Dealer: SHORT</h3>
  <table class="params-table">
    <tbody>
      <tr class="section-header"><th colspan="2">Inventory</th></tr>
      <tr><th>Tickets (a)</th><td>0</td></tr>
      <tr><th>Face inventory (x)</th><td>0</td></tr>
      <tr><th>Cash (C)</th><td>0</td></tr>
      <tr><th>Mid-valued (V)</th><td>0</td></tr>
      <tr class="section-header"><th colspan="2">Capacity</th></tr>
      <tr><th>Max tickets (K*)</th><td>0</td></tr>
      <tr><th>One-sided cap (X*)</th><td>0</td></tr>
      <tr><th>Ladder rungs (N)</th><td>1</td></tr>
      <tr><th>Layoff prob (λ)</th><td>1</td></tr>
      <tr class="section-header"><th colspan="2">Quotes</th></tr>
      <tr><th>Inside width (I)</th><td>0</td></tr>
      <tr><th>Midline p(x)</th><td>0</td></tr>
      <tr><th>Bid <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0</td></tr>
      <tr><th>Ask <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0</td></tr>
    </tbody>
  </table>
  
</div>

<div class="dealer-card">
  <h3>Dealer: MID</h3>
  <table class="params-table">
    <tbody>
      <tr class="section-header"><th colspan="2">Inventory</th></tr>
      <tr><th>Tickets (a)</th><td>4</td></tr>
      <tr><th>Face inventory (x)</th><td>4</td></tr>
      <tr><th>Cash (C)</th><td>0.9</td></tr>
      <tr><th>Mid-valued (V)</th><td>4.9</td></tr>
      <tr class="section-header"><th colspan="2">Capacity</th></tr>
      <tr><th>Max tickets (K*)</th><td>4</td></tr>
      <tr><th>One-sided cap (X*)</th><td>4</td></tr>
      <tr><th>Ladder rungs (N)</th><td>5</td></tr>
      <tr><th>Layoff prob (λ)</th><td>0.2</td></tr>
      <tr class="section-header"><th colspan="2">Quotes</th></tr>
      <tr><th>Inside width (I)</th><td>0.06</td></tr>
      <tr><th>Midline p(x)</th><td>0.9</td></tr>
      <tr><th>Bid <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0.87</td></tr>
      <tr><th>Ask <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0.93</td></tr>
    </tbody>
  </table>
  
  <div class="inventory-list">
    <h4>Inventory (4 tickets)</h4>
    <ul>
      <li>D0 (issuer: issuer, face: 1, τ: 6)</li><li>D1 (issuer: issuer, face: 1, τ: 6)</li><li>D2 (issuer: issuer, face: 1, τ: 6)</li><li>D3 (issuer: issuer, face: 1, τ: 6)</li>
    </ul>
  </div>

</div>

<div class="dealer-card">
  <h3>Dealer: LONG</h3>
  <table class="params-table">
    <tbody>
      <tr class="section-header"><th colspan="2">Inventory</th></tr>
      <tr><th>Tickets (a)</th><td>0</td></tr>
      <tr><th>Face inventory (x)</th><td>0</td></tr>
      <tr><th>Cash (C)</th><td>0</td></tr>
      <tr><th>Mid-valued (V)</th><td>0</td></tr>
      <tr class="section-header"><th colspan="2">Capacity</th></tr>
      <tr><th>Max tickets (K*)</th><td>0</td></tr>
      <tr><th>One-sided cap (X*)</th><td>0</td></tr>
      <tr><th>Ladder rungs (N)</th><td>1</td></tr>
      <tr><th>Layoff prob (λ)</th><td>1</td></tr>
      <tr class="section-header"><th colspan="2">Quotes</th></tr>
      <tr><th>Inside width (I)</th><td>0</td></tr>
      <tr><th>Midline p(x)</th><td>0</td></tr>
      <tr><th>Bid <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0</td></tr>
      <tr><th>Ask <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0</td></tr>
    </tbody>
  </table>
  
</div>

    </div>
    <div class="dealers-grid">
      
<div class="dealer-card vbt-card">
  <h3>VBT: SHORT</h3>
  <table class="params-table">
    <tbody>
      <tr><th>Mid anchor (M)</th><td>1</td></tr>
      <tr><th>Spread anchor (O)</th><td>0.3</td></tr>
      <tr><th>Ask (A = M + O/2)</th><td>1.15</td></tr>
      <tr><th>Bid (B = M - O/2)</th><td>0.85</td></tr>
      <tr><th>Cash</th><td>0</td></tr>
      <tr><th>Inventory</th><td>0 tickets</td></tr>
    </tbody>
  </table>
</div>

<div class="dealer-card vbt-card">
  <h3>VBT: MID</h3>
  <table class="params-table">
    <tbody>
      <tr><th>Mid anchor (M)</th><td>1</td></tr>
      <tr><th>Spread anchor (O)</th><td>0.3</td></tr>
      <tr><th>Ask (A = M + O/2)</th><td>1.15</td></tr>
      <tr><th>Bid (B = M - O/2)</th><td>0.85</td></tr>
      <tr><th>Cash</th><td>0</td></tr>
      <tr><th>Inventory</th><td>5 tickets</td></tr>
    </tbody>
  </table>
</div>

<div class="dealer-card vbt-card">
  <h3>VBT: LONG</h3>
  <table class="params-table">
    <tbody>
      <tr><th>Mid anchor (M)</th><td>1</td></tr>
      <tr><th>Spread anchor (O)</th><td>0.3</td></tr>
      <tr><th>Ask (A = M + O/2)</th><td>1.15</td></tr>
      <tr><th>Bid (B = M - O/2)</th><td>0.85</td></tr>
      <tr><th>Cash</th><td>0</td></tr>
      <tr><th>Inventory</th><td>0 tickets</td></tr>
    </tbody>
  </table>
</div>

    </div>
  </div>

  
  <div class="balances-section">
    <h3>Trader Balances</h3>
    <div class="traders-grid">
      
<div class="t-account">
  <h3>issuer</h3>
  <div class="grid">
    <div class="assets-side">
      <h4>Assets (100)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">Cash</td>
        <td class="val">100</td>
      </tr>
    
      <tr>
        <td colspan="2" class="empty">No tickets owned</td>
      </tr>
        
        </tbody>
      </table>
    </div>
    <div class="liabilities-side">
      <h4>Liabilities (4)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">D0</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(to dealer_mid_7, mat=200)</span></td>
      </tr>
        
      <tr>
        <td class="name">D1</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(to dealer_mid_7, mat=200)</span></td>
      </tr>
        
      <tr>
        <td class="name">D2</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(to dealer_mid_7, mat=200)</span></td>
      </tr>
        
      <tr>
        <td class="name">D3</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(to dealer_mid_7, mat=200)</span></td>
      </tr>
        
        </tbody>
      </table>
    </div>
  </div>
</div>

    </div>
  </div>

</section>

    </main>

    <footer>
      Generated by bilancio dealer ring simulation
    </footer>
  </div>
</body>
</html>



################################################################################
# FILE: example8_report.html
# PATH: examples/dealer_ring/out/example8_report.html
################################################################################

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Example 8: Guard at Low M</title>
  <style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;line-height:1.6;color:#333;background:#f5f5f5}
.container{max-width:1400px;margin:0 auto;padding:20px}
header{background:#fff;border-radius:8px;padding:24px;margin-bottom:24px;box-shadow:0 2px 4px rgba(0,0,0,0.1)}
h1{color:#2563eb;font-size:28px;margin-bottom:8px}
h2{color:#475569;font-size:20px;margin-bottom:16px}
h3{color:#334155;font-size:18px;margin-bottom:12px}
h4{color:#475569;font-size:16px;margin:8px 0;font-weight:600}
.description{color:#64748b;font-style:italic;margin-bottom:16px}
.meta{display:flex;gap:24px;color:#64748b;font-size:14px}
.meta span{display:inline-block}
.t-account{background:#fff;border-radius:8px;padding:20px;margin-bottom:20px;box-shadow:0 2px 4px rgba(0,0,0,0.1)}
.t-account .grid{display:grid;grid-template-columns:1fr 1fr;gap:20px}
.t-account table.side{width:100%;border-collapse:collapse;font-size:14px}
.t-account th,.t-account td{border-bottom:1px solid #e5e7eb;border-right:1px solid #eef2f7;padding:8px;text-align:left}
.t-account th:last-child,.t-account td:last-child{border-right:none}
.t-account tbody tr:nth-child(even){background:#fafafa}
.t-account th{background:#f9fafb;font-weight:600;color:#374151}
.t-account td.qty,.t-account td.val,.t-account td.mat{text-align:right;white-space:nowrap}
.t-account td.name{font-weight:500}
.t-account td.empty{text-align:center;color:#9ca3af}
.assets-side h4{color:#16a34a}
.liabilities-side h4{color:#dc2626}
.events-table{background:#fff;border-radius:8px;padding:20px;margin-bottom:24px;box-shadow:0 2px 4px rgba(0,0,0,0.1)}
.events-table table{width:100%;border-collapse:collapse;font-size:14px}
.events-table th,.events-table td{border-bottom:1px solid #e5e7eb;border-right:1px solid #eef2f7;padding:8px;text-align:left}
.events-table th:last-child,.events-table td:last-child{border-right:none}
.events-table tbody tr:nth-child(even){background:#f7f9fc}
.events-table th{background:#f9fafb;font-weight:600;color:#374151}
.events-table td.qty,.events-table td.amount{text-align:center;white-space:nowrap}
.events-table td.event-kind{font-weight:500;color:#3b82f6}
.events-table td.notes{font-size:13px;color:#64748b}
.agents>h2{margin-bottom:20px;padding:0 20px}
.day-section{margin-bottom:40px;padding-bottom:40px;border-bottom:2px solid #e5e7eb}
.day-section:last-child{border-bottom:none}
.day-header{color:#1f2937;font-size:24px;margin-bottom:24px;padding:12px 0;border-bottom:1px solid #e5e7eb}
.events-section{margin-bottom:24px}
.balances-section{margin-top:24px}
.balances-section>h3{margin-bottom:20px;color:#374151;font-size:20px}
footer{text-align:center;color:#9ca3af;font-size:14px;margin-top:40px;padding:20px}
@media (max-width:768px){.t-account .grid{grid-template-columns:1fr}.meta{flex-direction:column;gap:8px}}



/* Dealer card styling */
.dealer-card {
  background: #fff;
  border-radius: 8px;
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.dealer-card h3 {
  color: #1e40af;
  margin-bottom: 16px;
  border-bottom: 2px solid #dbeafe;
  padding-bottom: 8px;
}
.params-table {
  width: 100%;
  border-collapse: collapse;
}
.params-table th {
  text-align: left;
  padding: 6px 12px;
  color: #64748b;
  font-weight: 500;
  width: 40%;
}
.params-table td {
  text-align: right;
  padding: 6px 12px;
  font-family: 'SF Mono', Monaco, monospace;
  color: #1f2937;
}
.params-table tr.section-header th {
  color: #374151;
  font-weight: 600;
  padding-top: 12px;
  border-bottom: 1px solid #e5e7eb;
}
/* VBT card */
.vbt-card {
  background: linear-gradient(135deg, #f0fdf4, #fff);
  border-left: 4px solid #16a34a;
}
.vbt-card h3 {
  color: #16a34a;
  border-bottom-color: #bbf7d0;
}
/* Event type colors */
.event-trade { color: #3b82f6; }
.event-passthrough { color: #8b5cf6; }
.event-rebucket { color: #f59e0b; }
.event-settlement { color: #16a34a; }
.event-default { color: #dc2626; }
.event-quote { color: #64748b; }
.event-vbt-anchor-update { color: #14b8a6; }
/* Pin indicators */
.pin-indicator {
  display: inline-block;
  width: 8px;
  height: 8px;
  border-radius: 50%;
  margin-left: 4px;
}
.pin-indicator.pinned { background: #f59e0b; }
.pin-indicator.not-pinned { background: #d1d5db; }
/* Grid layouts */
.dealers-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 20px;
  margin-bottom: 24px;
}
.traders-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
  gap: 20px;
}
/* Inventory list */
.inventory-list {
  margin-top: 12px;
  padding-top: 12px;
  border-top: 1px solid #e5e7eb;
}
.inventory-list h4 {
  color: #64748b;
  font-size: 14px;
  margin-bottom: 8px;
}
.inventory-list ul {
  list-style: none;
  padding: 0;
  margin: 0;
  font-size: 13px;
}
.inventory-list li {
  padding: 4px 0;
  color: #4b5563;
  font-family: 'SF Mono', Monaco, monospace;
}

  </style>
</head>
<body>
  <div class="container">
    
<header>
  <h1>Example 8: Guard at Low M</h1>
  <p class="description">All trades route to VBT when M &lt;= M_min</p>
  <div class="meta">
    <span><strong>Days:</strong> 1</span>
    <span><strong>Buckets:</strong> short, mid, long</span>
    <span><strong>Traders:</strong> 3</span>
    <span><strong>Tickets:</strong> 8</span>
    <span><strong>Ticket Size (S):</strong> 1</span>
  </div>
</header>


    <main>
      
<section class="day-section">
  <h2 class="day-header">🏁 Day 0 (Setup)</h2>

  
<div class="events-table">
  <h3>Day 0 (Setup) Events</h3>
  <p style="color: #9ca3af; font-style: italic;">No events for this day</p>
</div>


  <div class="balances-section">
    <h3>Market State</h3>
    <div class="dealers-grid">
      
<div class="dealer-card">
  <h3>Dealer: SHORT</h3>
  <table class="params-table">
    <tbody>
      <tr class="section-header"><th colspan="2">Inventory</th></tr>
      <tr><th>Tickets (a)</th><td>0</td></tr>
      <tr><th>Face inventory (x)</th><td>0</td></tr>
      <tr><th>Cash (C)</th><td>0</td></tr>
      <tr><th>Mid-valued (V)</th><td>0</td></tr>
      <tr class="section-header"><th colspan="2">Capacity</th></tr>
      <tr><th>Max tickets (K*)</th><td>0</td></tr>
      <tr><th>One-sided cap (X*)</th><td>0</td></tr>
      <tr><th>Ladder rungs (N)</th><td>1</td></tr>
      <tr><th>Layoff prob (λ)</th><td>1</td></tr>
      <tr class="section-header"><th colspan="2">Quotes</th></tr>
      <tr><th>Inside width (I)</th><td>0</td></tr>
      <tr><th>Midline p(x)</th><td>0</td></tr>
      <tr><th>Bid <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0</td></tr>
      <tr><th>Ask <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0</td></tr>
    </tbody>
  </table>
  
</div>

<div class="dealer-card">
  <h3>Dealer: MID</h3>
  <table class="params-table">
    <tbody>
      <tr class="section-header"><th colspan="2">Inventory</th></tr>
      <tr><th>Tickets (a)</th><td>2</td></tr>
      <tr><th>Face inventory (x)</th><td>2</td></tr>
      <tr><th>Cash (C)</th><td>1</td></tr>
      <tr><th>Mid-valued (V)</th><td>1</td></tr>
      <tr class="section-header"><th colspan="2">Capacity</th></tr>
      <tr><th>Max tickets (K*)</th><td>0</td></tr>
      <tr><th>One-sided cap (X*)</th><td>0</td></tr>
      <tr><th>Ladder rungs (N)</th><td>1</td></tr>
      <tr><th>Layoff prob (λ)</th><td>1</td></tr>
      <tr class="section-header"><th colspan="2">Quotes</th></tr>
      <tr><th>Inside width (I)</th><td>0.01</td></tr>
      <tr><th>Midline p(x)</th><td>0.01</td></tr>
      <tr><th>Bid <span class="pin-indicator pinned" title="Pinned at VBT bid"></span></th><td>0.005</td></tr>
      <tr><th>Ask <span class="pin-indicator pinned" title="Pinned at VBT ask"></span></th><td>0.015</td></tr>
    </tbody>
  </table>
  
  <div class="inventory-list">
    <h4>Inventory (2 tickets)</h4>
    <ul>
      <li>D0 (issuer: issuer, face: 1, τ: 6)</li><li>D1 (issuer: issuer, face: 1, τ: 6)</li>
    </ul>
  </div>

</div>

<div class="dealer-card">
  <h3>Dealer: LONG</h3>
  <table class="params-table">
    <tbody>
      <tr class="section-header"><th colspan="2">Inventory</th></tr>
      <tr><th>Tickets (a)</th><td>0</td></tr>
      <tr><th>Face inventory (x)</th><td>0</td></tr>
      <tr><th>Cash (C)</th><td>0</td></tr>
      <tr><th>Mid-valued (V)</th><td>0</td></tr>
      <tr class="section-header"><th colspan="2">Capacity</th></tr>
      <tr><th>Max tickets (K*)</th><td>0</td></tr>
      <tr><th>One-sided cap (X*)</th><td>0</td></tr>
      <tr><th>Ladder rungs (N)</th><td>1</td></tr>
      <tr><th>Layoff prob (λ)</th><td>1</td></tr>
      <tr class="section-header"><th colspan="2">Quotes</th></tr>
      <tr><th>Inside width (I)</th><td>0</td></tr>
      <tr><th>Midline p(x)</th><td>0</td></tr>
      <tr><th>Bid <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0</td></tr>
      <tr><th>Ask <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0</td></tr>
    </tbody>
  </table>
  
</div>

    </div>
    <div class="dealers-grid">
      
<div class="dealer-card vbt-card">
  <h3>VBT: SHORT</h3>
  <table class="params-table">
    <tbody>
      <tr><th>Mid anchor (M)</th><td>0.01</td></tr>
      <tr><th>Spread anchor (O)</th><td>0.01</td></tr>
      <tr><th>Ask (A = M + O/2)</th><td>0.015</td></tr>
      <tr><th>Bid (B = M - O/2)</th><td>0.005</td></tr>
      <tr><th>Cash</th><td>0</td></tr>
      <tr><th>Inventory</th><td>0 tickets</td></tr>
    </tbody>
  </table>
</div>

<div class="dealer-card vbt-card">
  <h3>VBT: MID</h3>
  <table class="params-table">
    <tbody>
      <tr><th>Mid anchor (M)</th><td>0.01</td></tr>
      <tr><th>Spread anchor (O)</th><td>0.01</td></tr>
      <tr><th>Ask (A = M + O/2)</th><td>0.015</td></tr>
      <tr><th>Bid (B = M - O/2)</th><td>0.005</td></tr>
      <tr><th>Cash</th><td>10</td></tr>
      <tr><th>Inventory</th><td>5 tickets</td></tr>
    </tbody>
  </table>
</div>

<div class="dealer-card vbt-card">
  <h3>VBT: LONG</h3>
  <table class="params-table">
    <tbody>
      <tr><th>Mid anchor (M)</th><td>0.01</td></tr>
      <tr><th>Spread anchor (O)</th><td>0.01</td></tr>
      <tr><th>Ask (A = M + O/2)</th><td>0.015</td></tr>
      <tr><th>Bid (B = M - O/2)</th><td>0.005</td></tr>
      <tr><th>Cash</th><td>0</td></tr>
      <tr><th>Inventory</th><td>0 tickets</td></tr>
    </tbody>
  </table>
</div>

    </div>
  </div>

  
  <div class="balances-section">
    <h3>Trader Balances</h3>
    <div class="traders-grid">
      
<div class="t-account">
  <h3>buyer</h3>
  <div class="grid">
    <div class="assets-side">
      <h4>Assets (10)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">Cash</td>
        <td class="val">10</td>
      </tr>
    
      <tr>
        <td colspan="2" class="empty">No tickets owned</td>
      </tr>
        
        </tbody>
      </table>
    </div>
    <div class="liabilities-side">
      <h4>Liabilities (0)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td colspan="2" class="empty">No obligations</td>
      </tr>
        
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="t-account">
  <h3>issuer</h3>
  <div class="grid">
    <div class="assets-side">
      <h4>Assets (100)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">Cash</td>
        <td class="val">100</td>
      </tr>
    
      <tr>
        <td colspan="2" class="empty">No tickets owned</td>
      </tr>
        
        </tbody>
      </table>
    </div>
    <div class="liabilities-side">
      <h4>Liabilities (3)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">D0</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(to dealer_mid_0, mat=200)</span></td>
      </tr>
        
      <tr>
        <td class="name">D1</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(to dealer_mid_0, mat=200)</span></td>
      </tr>
        
      <tr>
        <td class="name">SELL1</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(to seller, mat=200)</span></td>
      </tr>
        
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="t-account">
  <h3>seller</h3>
  <div class="grid">
    <div class="assets-side">
      <h4>Assets (1)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">Cash</td>
        <td class="val">0</td>
      </tr>
    
      <tr>
        <td class="name">SELL1</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(issuer, τ=6)</span></td>
      </tr>
        
        </tbody>
      </table>
    </div>
    <div class="liabilities-side">
      <h4>Liabilities (0)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td colspan="2" class="empty">No obligations</td>
      </tr>
        
        </tbody>
      </table>
    </div>
  </div>
</div>

    </div>
  </div>

</section>

<section class="day-section">
  <h2 class="day-header">📅 Day 1</h2>

  
<div class="events-table">
  <h3>Day 1 Events</h3>
  <table>
    <thead>
      <tr>
        <th style="width: 120px;">Kind</th>
        <th>Details</th>
        <th style="width: 200px;">Notes</th>
      </tr>
    </thead>
    <tbody>
      
          <tr>
            <td class="event-passthrough">trade</td>
            <td>SELL @ 0.005 [mid]</td>
            <td class="notes">trader: seller, ticket: SELL1 (passthrough to VBT)</td>
          </tr>
        
          <tr>
            <td class="event-passthrough">trade</td>
            <td>BUY @ 0.015 [mid]</td>
            <td class="notes">trader: buyer, ticket: SELL1 (passthrough to VBT)</td>
          </tr>
        
          <tr>
            <td class="event-quote">quote</td>
            <td>[mid] D: 0.005/0.015, VBT: 0.005/0.015</td>
            <td class="notes">inv=2, cap=0</td>
          </tr>
        
    </tbody>
  </table>
</div>


  <div class="balances-section">
    <h3>Market State</h3>
    <div class="dealers-grid">
      
<div class="dealer-card">
  <h3>Dealer: SHORT</h3>
  <table class="params-table">
    <tbody>
      <tr class="section-header"><th colspan="2">Inventory</th></tr>
      <tr><th>Tickets (a)</th><td>0</td></tr>
      <tr><th>Face inventory (x)</th><td>0</td></tr>
      <tr><th>Cash (C)</th><td>0</td></tr>
      <tr><th>Mid-valued (V)</th><td>0</td></tr>
      <tr class="section-header"><th colspan="2">Capacity</th></tr>
      <tr><th>Max tickets (K*)</th><td>0</td></tr>
      <tr><th>One-sided cap (X*)</th><td>0</td></tr>
      <tr><th>Ladder rungs (N)</th><td>1</td></tr>
      <tr><th>Layoff prob (λ)</th><td>1</td></tr>
      <tr class="section-header"><th colspan="2">Quotes</th></tr>
      <tr><th>Inside width (I)</th><td>0</td></tr>
      <tr><th>Midline p(x)</th><td>0</td></tr>
      <tr><th>Bid <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0</td></tr>
      <tr><th>Ask <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0</td></tr>
    </tbody>
  </table>
  
</div>

<div class="dealer-card">
  <h3>Dealer: MID</h3>
  <table class="params-table">
    <tbody>
      <tr class="section-header"><th colspan="2">Inventory</th></tr>
      <tr><th>Tickets (a)</th><td>2</td></tr>
      <tr><th>Face inventory (x)</th><td>2</td></tr>
      <tr><th>Cash (C)</th><td>1</td></tr>
      <tr><th>Mid-valued (V)</th><td>1</td></tr>
      <tr class="section-header"><th colspan="2">Capacity</th></tr>
      <tr><th>Max tickets (K*)</th><td>0</td></tr>
      <tr><th>One-sided cap (X*)</th><td>0</td></tr>
      <tr><th>Ladder rungs (N)</th><td>1</td></tr>
      <tr><th>Layoff prob (λ)</th><td>1</td></tr>
      <tr class="section-header"><th colspan="2">Quotes</th></tr>
      <tr><th>Inside width (I)</th><td>0.01</td></tr>
      <tr><th>Midline p(x)</th><td>0.01</td></tr>
      <tr><th>Bid <span class="pin-indicator pinned" title="Pinned at VBT bid"></span></th><td>0.005</td></tr>
      <tr><th>Ask <span class="pin-indicator pinned" title="Pinned at VBT ask"></span></th><td>0.015</td></tr>
    </tbody>
  </table>
  
  <div class="inventory-list">
    <h4>Inventory (2 tickets)</h4>
    <ul>
      <li>D0 (issuer: issuer, face: 1, τ: 6)</li><li>D1 (issuer: issuer, face: 1, τ: 6)</li>
    </ul>
  </div>

</div>

<div class="dealer-card">
  <h3>Dealer: LONG</h3>
  <table class="params-table">
    <tbody>
      <tr class="section-header"><th colspan="2">Inventory</th></tr>
      <tr><th>Tickets (a)</th><td>0</td></tr>
      <tr><th>Face inventory (x)</th><td>0</td></tr>
      <tr><th>Cash (C)</th><td>0</td></tr>
      <tr><th>Mid-valued (V)</th><td>0</td></tr>
      <tr class="section-header"><th colspan="2">Capacity</th></tr>
      <tr><th>Max tickets (K*)</th><td>0</td></tr>
      <tr><th>One-sided cap (X*)</th><td>0</td></tr>
      <tr><th>Ladder rungs (N)</th><td>1</td></tr>
      <tr><th>Layoff prob (λ)</th><td>1</td></tr>
      <tr class="section-header"><th colspan="2">Quotes</th></tr>
      <tr><th>Inside width (I)</th><td>0</td></tr>
      <tr><th>Midline p(x)</th><td>0</td></tr>
      <tr><th>Bid <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0</td></tr>
      <tr><th>Ask <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0</td></tr>
    </tbody>
  </table>
  
</div>

    </div>
    <div class="dealers-grid">
      
<div class="dealer-card vbt-card">
  <h3>VBT: SHORT</h3>
  <table class="params-table">
    <tbody>
      <tr><th>Mid anchor (M)</th><td>0.01</td></tr>
      <tr><th>Spread anchor (O)</th><td>0.01</td></tr>
      <tr><th>Ask (A = M + O/2)</th><td>0.015</td></tr>
      <tr><th>Bid (B = M - O/2)</th><td>0.005</td></tr>
      <tr><th>Cash</th><td>0</td></tr>
      <tr><th>Inventory</th><td>0 tickets</td></tr>
    </tbody>
  </table>
</div>

<div class="dealer-card vbt-card">
  <h3>VBT: MID</h3>
  <table class="params-table">
    <tbody>
      <tr><th>Mid anchor (M)</th><td>0.01</td></tr>
      <tr><th>Spread anchor (O)</th><td>0.01</td></tr>
      <tr><th>Ask (A = M + O/2)</th><td>0.015</td></tr>
      <tr><th>Bid (B = M - O/2)</th><td>0.005</td></tr>
      <tr><th>Cash</th><td>10.01</td></tr>
      <tr><th>Inventory</th><td>5 tickets</td></tr>
    </tbody>
  </table>
</div>

<div class="dealer-card vbt-card">
  <h3>VBT: LONG</h3>
  <table class="params-table">
    <tbody>
      <tr><th>Mid anchor (M)</th><td>0.01</td></tr>
      <tr><th>Spread anchor (O)</th><td>0.01</td></tr>
      <tr><th>Ask (A = M + O/2)</th><td>0.015</td></tr>
      <tr><th>Bid (B = M - O/2)</th><td>0.005</td></tr>
      <tr><th>Cash</th><td>0</td></tr>
      <tr><th>Inventory</th><td>0 tickets</td></tr>
    </tbody>
  </table>
</div>

    </div>
  </div>

  
  <div class="balances-section">
    <h3>Trader Balances</h3>
    <div class="traders-grid">
      
<div class="t-account">
  <h3>buyer</h3>
  <div class="grid">
    <div class="assets-side">
      <h4>Assets (10.98)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">Cash</td>
        <td class="val">9.98</td>
      </tr>
    
      <tr>
        <td class="name">SELL1</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(issuer, τ=6)</span></td>
      </tr>
        
        </tbody>
      </table>
    </div>
    <div class="liabilities-side">
      <h4>Liabilities (0)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td colspan="2" class="empty">No obligations</td>
      </tr>
        
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="t-account">
  <h3>issuer</h3>
  <div class="grid">
    <div class="assets-side">
      <h4>Assets (100)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">Cash</td>
        <td class="val">100</td>
      </tr>
    
      <tr>
        <td colspan="2" class="empty">No tickets owned</td>
      </tr>
        
        </tbody>
      </table>
    </div>
    <div class="liabilities-side">
      <h4>Liabilities (3)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">D0</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(to dealer_mid_0, mat=200)</span></td>
      </tr>
        
      <tr>
        <td class="name">D1</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(to dealer_mid_0, mat=200)</span></td>
      </tr>
        
      <tr>
        <td class="name">SELL1</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(to buyer, mat=200)</span></td>
      </tr>
        
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="t-account">
  <h3>seller</h3>
  <div class="grid">
    <div class="assets-side">
      <h4>Assets (0)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">Cash</td>
        <td class="val">0</td>
      </tr>
    
      <tr>
        <td colspan="2" class="empty">No tickets owned</td>
      </tr>
        
        </tbody>
      </table>
    </div>
    <div class="liabilities-side">
      <h4>Liabilities (0)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td colspan="2" class="empty">No obligations</td>
      </tr>
        
        </tbody>
      </table>
    </div>
  </div>
</div>

    </div>
  </div>

</section>

    </main>

    <footer>
      Generated by bilancio dealer ring simulation
    </footer>
  </div>
</body>
</html>



################################################################################
# FILE: example9_report.html
# PATH: examples/dealer_ring/out/example9_report.html
################################################################################

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Example 9: Partial-Recovery Default (R=0.375)</title>
  <style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;line-height:1.6;color:#333;background:#f5f5f5}
.container{max-width:1400px;margin:0 auto;padding:20px}
header{background:#fff;border-radius:8px;padding:24px;margin-bottom:24px;box-shadow:0 2px 4px rgba(0,0,0,0.1)}
h1{color:#2563eb;font-size:28px;margin-bottom:8px}
h2{color:#475569;font-size:20px;margin-bottom:16px}
h3{color:#334155;font-size:18px;margin-bottom:12px}
h4{color:#475569;font-size:16px;margin:8px 0;font-weight:600}
.description{color:#64748b;font-style:italic;margin-bottom:16px}
.meta{display:flex;gap:24px;color:#64748b;font-size:14px}
.meta span{display:inline-block}
.t-account{background:#fff;border-radius:8px;padding:20px;margin-bottom:20px;box-shadow:0 2px 4px rgba(0,0,0,0.1)}
.t-account .grid{display:grid;grid-template-columns:1fr 1fr;gap:20px}
.t-account table.side{width:100%;border-collapse:collapse;font-size:14px}
.t-account th,.t-account td{border-bottom:1px solid #e5e7eb;border-right:1px solid #eef2f7;padding:8px;text-align:left}
.t-account th:last-child,.t-account td:last-child{border-right:none}
.t-account tbody tr:nth-child(even){background:#fafafa}
.t-account th{background:#f9fafb;font-weight:600;color:#374151}
.t-account td.qty,.t-account td.val,.t-account td.mat{text-align:right;white-space:nowrap}
.t-account td.name{font-weight:500}
.t-account td.empty{text-align:center;color:#9ca3af}
.assets-side h4{color:#16a34a}
.liabilities-side h4{color:#dc2626}
.events-table{background:#fff;border-radius:8px;padding:20px;margin-bottom:24px;box-shadow:0 2px 4px rgba(0,0,0,0.1)}
.events-table table{width:100%;border-collapse:collapse;font-size:14px}
.events-table th,.events-table td{border-bottom:1px solid #e5e7eb;border-right:1px solid #eef2f7;padding:8px;text-align:left}
.events-table th:last-child,.events-table td:last-child{border-right:none}
.events-table tbody tr:nth-child(even){background:#f7f9fc}
.events-table th{background:#f9fafb;font-weight:600;color:#374151}
.events-table td.qty,.events-table td.amount{text-align:center;white-space:nowrap}
.events-table td.event-kind{font-weight:500;color:#3b82f6}
.events-table td.notes{font-size:13px;color:#64748b}
.agents>h2{margin-bottom:20px;padding:0 20px}
.day-section{margin-bottom:40px;padding-bottom:40px;border-bottom:2px solid #e5e7eb}
.day-section:last-child{border-bottom:none}
.day-header{color:#1f2937;font-size:24px;margin-bottom:24px;padding:12px 0;border-bottom:1px solid #e5e7eb}
.events-section{margin-bottom:24px}
.balances-section{margin-top:24px}
.balances-section>h3{margin-bottom:20px;color:#374151;font-size:20px}
footer{text-align:center;color:#9ca3af;font-size:14px;margin-top:40px;padding:20px}
@media (max-width:768px){.t-account .grid{grid-template-columns:1fr}.meta{flex-direction:column;gap:8px}}



/* Dealer card styling */
.dealer-card {
  background: #fff;
  border-radius: 8px;
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.dealer-card h3 {
  color: #1e40af;
  margin-bottom: 16px;
  border-bottom: 2px solid #dbeafe;
  padding-bottom: 8px;
}
.params-table {
  width: 100%;
  border-collapse: collapse;
}
.params-table th {
  text-align: left;
  padding: 6px 12px;
  color: #64748b;
  font-weight: 500;
  width: 40%;
}
.params-table td {
  text-align: right;
  padding: 6px 12px;
  font-family: 'SF Mono', Monaco, monospace;
  color: #1f2937;
}
.params-table tr.section-header th {
  color: #374151;
  font-weight: 600;
  padding-top: 12px;
  border-bottom: 1px solid #e5e7eb;
}
/* VBT card */
.vbt-card {
  background: linear-gradient(135deg, #f0fdf4, #fff);
  border-left: 4px solid #16a34a;
}
.vbt-card h3 {
  color: #16a34a;
  border-bottom-color: #bbf7d0;
}
/* Event type colors */
.event-trade { color: #3b82f6; }
.event-passthrough { color: #8b5cf6; }
.event-rebucket { color: #f59e0b; }
.event-settlement { color: #16a34a; }
.event-default { color: #dc2626; }
.event-quote { color: #64748b; }
.event-vbt-anchor-update { color: #14b8a6; }
/* Pin indicators */
.pin-indicator {
  display: inline-block;
  width: 8px;
  height: 8px;
  border-radius: 50%;
  margin-left: 4px;
}
.pin-indicator.pinned { background: #f59e0b; }
.pin-indicator.not-pinned { background: #d1d5db; }
/* Grid layouts */
.dealers-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 20px;
  margin-bottom: 24px;
}
.traders-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
  gap: 20px;
}
/* Inventory list */
.inventory-list {
  margin-top: 12px;
  padding-top: 12px;
  border-top: 1px solid #e5e7eb;
}
.inventory-list h4 {
  color: #64748b;
  font-size: 14px;
  margin-bottom: 8px;
}
.inventory-list ul {
  list-style: none;
  padding: 0;
  margin: 0;
  font-size: 13px;
}
.inventory-list li {
  padding: 4px 0;
  color: #4b5563;
  font-family: 'SF Mono', Monaco, monospace;
}

  </style>
</head>
<body>
  <div class="container">
    
<header>
  <h1>Example 9: Partial-Recovery Default (R=0.375)</h1>
  <p class="description">Multiple claimant types: Dealer (3), VBT (2), Trader (3)</p>
  <div class="meta">
    <span><strong>Days:</strong> 1</span>
    <span><strong>Buckets:</strong> short, mid, long</span>
    <span><strong>Traders:</strong> 2</span>
    <span><strong>Tickets:</strong> 8</span>
    <span><strong>Ticket Size (S):</strong> 1</span>
  </div>
</header>


    <main>
      
<section class="day-section">
  <h2 class="day-header">🏁 Day 0 (Setup)</h2>

  
<div class="events-table">
  <h3>Day 0 (Setup) Events</h3>
  <p style="color: #9ca3af; font-style: italic;">No events for this day</p>
</div>


  <div class="balances-section">
    <h3>Market State</h3>
    <div class="dealers-grid">
      
<div class="dealer-card">
  <h3>Dealer: SHORT</h3>
  <table class="params-table">
    <tbody>
      <tr class="section-header"><th colspan="2">Inventory</th></tr>
      <tr><th>Tickets (a)</th><td>0</td></tr>
      <tr><th>Face inventory (x)</th><td>0</td></tr>
      <tr><th>Cash (C)</th><td>0</td></tr>
      <tr><th>Mid-valued (V)</th><td>0</td></tr>
      <tr class="section-header"><th colspan="2">Capacity</th></tr>
      <tr><th>Max tickets (K*)</th><td>0</td></tr>
      <tr><th>One-sided cap (X*)</th><td>0</td></tr>
      <tr><th>Ladder rungs (N)</th><td>1</td></tr>
      <tr><th>Layoff prob (λ)</th><td>1</td></tr>
      <tr class="section-header"><th colspan="2">Quotes</th></tr>
      <tr><th>Inside width (I)</th><td>0</td></tr>
      <tr><th>Midline p(x)</th><td>0</td></tr>
      <tr><th>Bid <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0</td></tr>
      <tr><th>Ask <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0</td></tr>
    </tbody>
  </table>
  
</div>

<div class="dealer-card">
  <h3>Dealer: MID</h3>
  <table class="params-table">
    <tbody>
      <tr class="section-header"><th colspan="2">Inventory</th></tr>
      <tr><th>Tickets (a)</th><td>3</td></tr>
      <tr><th>Face inventory (x)</th><td>3</td></tr>
      <tr><th>Cash (C)</th><td>10</td></tr>
      <tr><th>Mid-valued (V)</th><td>13</td></tr>
      <tr class="section-header"><th colspan="2">Capacity</th></tr>
      <tr><th>Max tickets (K*)</th><td>13</td></tr>
      <tr><th>One-sided cap (X*)</th><td>13</td></tr>
      <tr><th>Ladder rungs (N)</th><td>14</td></tr>
      <tr><th>Layoff prob (λ)</th><td>0.0714</td></tr>
      <tr class="section-header"><th colspan="2">Quotes</th></tr>
      <tr><th>Inside width (I)</th><td>0.0214</td></tr>
      <tr><th>Midline p(x)</th><td>1.07</td></tr>
      <tr><th>Bid <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>1.0593</td></tr>
      <tr><th>Ask <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>1.0807</td></tr>
    </tbody>
  </table>
  
  <div class="inventory-list">
    <h4>Inventory (3 tickets)</h4>
    <ul>
      <li>T_D0 (issuer: issuer_I, face: 1, τ: 1)</li><li>T_D1 (issuer: issuer_I, face: 1, τ: 1)</li><li>T_D2 (issuer: issuer_I, face: 1, τ: 1)</li>
    </ul>
  </div>

</div>

<div class="dealer-card">
  <h3>Dealer: LONG</h3>
  <table class="params-table">
    <tbody>
      <tr class="section-header"><th colspan="2">Inventory</th></tr>
      <tr><th>Tickets (a)</th><td>0</td></tr>
      <tr><th>Face inventory (x)</th><td>0</td></tr>
      <tr><th>Cash (C)</th><td>0</td></tr>
      <tr><th>Mid-valued (V)</th><td>0</td></tr>
      <tr class="section-header"><th colspan="2">Capacity</th></tr>
      <tr><th>Max tickets (K*)</th><td>0</td></tr>
      <tr><th>One-sided cap (X*)</th><td>0</td></tr>
      <tr><th>Ladder rungs (N)</th><td>1</td></tr>
      <tr><th>Layoff prob (λ)</th><td>1</td></tr>
      <tr class="section-header"><th colspan="2">Quotes</th></tr>
      <tr><th>Inside width (I)</th><td>0</td></tr>
      <tr><th>Midline p(x)</th><td>0</td></tr>
      <tr><th>Bid <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0</td></tr>
      <tr><th>Ask <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0</td></tr>
    </tbody>
  </table>
  
</div>

    </div>
    <div class="dealers-grid">
      
<div class="dealer-card vbt-card">
  <h3>VBT: SHORT</h3>
  <table class="params-table">
    <tbody>
      <tr><th>Mid anchor (M)</th><td>1</td></tr>
      <tr><th>Spread anchor (O)</th><td>0.3</td></tr>
      <tr><th>Ask (A = M + O/2)</th><td>1.15</td></tr>
      <tr><th>Bid (B = M - O/2)</th><td>0.85</td></tr>
      <tr><th>Cash</th><td>0</td></tr>
      <tr><th>Inventory</th><td>0 tickets</td></tr>
    </tbody>
  </table>
</div>

<div class="dealer-card vbt-card">
  <h3>VBT: MID</h3>
  <table class="params-table">
    <tbody>
      <tr><th>Mid anchor (M)</th><td>1</td></tr>
      <tr><th>Spread anchor (O)</th><td>0.3</td></tr>
      <tr><th>Ask (A = M + O/2)</th><td>1.15</td></tr>
      <tr><th>Bid (B = M - O/2)</th><td>0.85</td></tr>
      <tr><th>Cash</th><td>5</td></tr>
      <tr><th>Inventory</th><td>2 tickets</td></tr>
    </tbody>
  </table>
</div>

<div class="dealer-card vbt-card">
  <h3>VBT: LONG</h3>
  <table class="params-table">
    <tbody>
      <tr><th>Mid anchor (M)</th><td>1</td></tr>
      <tr><th>Spread anchor (O)</th><td>0.3</td></tr>
      <tr><th>Ask (A = M + O/2)</th><td>1.15</td></tr>
      <tr><th>Bid (B = M - O/2)</th><td>0.85</td></tr>
      <tr><th>Cash</th><td>0</td></tr>
      <tr><th>Inventory</th><td>0 tickets</td></tr>
    </tbody>
  </table>
</div>

    </div>
  </div>

  
  <div class="balances-section">
    <h3>Trader Balances</h3>
    <div class="traders-grid">
      
<div class="t-account">
  <h3>issuer_I</h3>
  <div class="grid">
    <div class="assets-side">
      <h4>Assets (3)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">Cash</td>
        <td class="val">3</td>
      </tr>
    
      <tr>
        <td colspan="2" class="empty">No tickets owned</td>
      </tr>
        
        </tbody>
      </table>
    </div>
    <div class="liabilities-side">
      <h4>Liabilities (8)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">T_D0</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(to dealer_mid_5, mat=1)</span></td>
      </tr>
        
      <tr>
        <td class="name">T_D1</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(to dealer_mid_5, mat=1)</span></td>
      </tr>
        
      <tr>
        <td class="name">T_D2</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(to dealer_mid_5, mat=1)</span></td>
      </tr>
        
      <tr>
        <td class="name">T_V0</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(to vbt_mid_3a35, mat=1)</span></td>
      </tr>
        
      <tr>
        <td class="name">T_V1</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(to vbt_mid_3a35, mat=1)</span></td>
      </tr>
        
      <tr>
        <td class="name">T_K0</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(to trader_K, mat=1)</span></td>
      </tr>
        
      <tr>
        <td class="name">T_K1</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(to trader_K, mat=1)</span></td>
      </tr>
        
      <tr>
        <td class="name">T_K2</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(to trader_K, mat=1)</span></td>
      </tr>
        
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="t-account">
  <h3>trader_K</h3>
  <div class="grid">
    <div class="assets-side">
      <h4>Assets (3)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">Cash</td>
        <td class="val">0</td>
      </tr>
    
      <tr>
        <td class="name">T_K0</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(issuer_I, τ=1)</span></td>
      </tr>
        
      <tr>
        <td class="name">T_K1</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(issuer_I, τ=1)</span></td>
      </tr>
        
      <tr>
        <td class="name">T_K2</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(issuer_I, τ=1)</span></td>
      </tr>
        
        </tbody>
      </table>
    </div>
    <div class="liabilities-side">
      <h4>Liabilities (0)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td colspan="2" class="empty">No obligations</td>
      </tr>
        
        </tbody>
      </table>
    </div>
  </div>
</div>

    </div>
  </div>

</section>

<section class="day-section">
  <h2 class="day-header">📅 Day 1</h2>

  
<div class="events-table">
  <h3>Day 1 Events</h3>
  <table>
    <thead>
      <tr>
        <th style="width: 120px;">Kind</th>
        <th>Details</th>
        <th style="width: 200px;">Notes</th>
      </tr>
    </thead>
    <tbody>
      
          <tr>
            <td class="event-default">default</td>
            <td>Recovery 0.38 (due: 8, paid: 3)</td>
            <td class="notes">issuer: issuer_I, bucket: mid</td>
          </tr>
        
          <tr>
            <td class="event-quote">quote</td>
            <td>[mid] D: 1.1144/1.1394, VBT: 0.85/1.15</td>
            <td class="notes">inv=0, cap=11</td>
          </tr>
        
    </tbody>
  </table>
</div>


  <div class="balances-section">
    <h3>Market State</h3>
    <div class="dealers-grid">
      
<div class="dealer-card">
  <h3>Dealer: SHORT</h3>
  <table class="params-table">
    <tbody>
      <tr class="section-header"><th colspan="2">Inventory</th></tr>
      <tr><th>Tickets (a)</th><td>0</td></tr>
      <tr><th>Face inventory (x)</th><td>0</td></tr>
      <tr><th>Cash (C)</th><td>0</td></tr>
      <tr><th>Mid-valued (V)</th><td>0</td></tr>
      <tr class="section-header"><th colspan="2">Capacity</th></tr>
      <tr><th>Max tickets (K*)</th><td>0</td></tr>
      <tr><th>One-sided cap (X*)</th><td>0</td></tr>
      <tr><th>Ladder rungs (N)</th><td>1</td></tr>
      <tr><th>Layoff prob (λ)</th><td>1</td></tr>
      <tr class="section-header"><th colspan="2">Quotes</th></tr>
      <tr><th>Inside width (I)</th><td>0</td></tr>
      <tr><th>Midline p(x)</th><td>0</td></tr>
      <tr><th>Bid <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0</td></tr>
      <tr><th>Ask <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0</td></tr>
    </tbody>
  </table>
  
</div>

<div class="dealer-card">
  <h3>Dealer: MID</h3>
  <table class="params-table">
    <tbody>
      <tr class="section-header"><th colspan="2">Inventory</th></tr>
      <tr><th>Tickets (a)</th><td>0</td></tr>
      <tr><th>Face inventory (x)</th><td>0</td></tr>
      <tr><th>Cash (C)</th><td>11.125</td></tr>
      <tr><th>Mid-valued (V)</th><td>11.125</td></tr>
      <tr class="section-header"><th colspan="2">Capacity</th></tr>
      <tr><th>Max tickets (K*)</th><td>11</td></tr>
      <tr><th>One-sided cap (X*)</th><td>11</td></tr>
      <tr><th>Ladder rungs (N)</th><td>12</td></tr>
      <tr><th>Layoff prob (λ)</th><td>0.0833</td></tr>
      <tr class="section-header"><th colspan="2">Quotes</th></tr>
      <tr><th>Inside width (I)</th><td>0.025</td></tr>
      <tr><th>Midline p(x)</th><td>1.1269</td></tr>
      <tr><th>Bid <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>1.1144</td></tr>
      <tr><th>Ask <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>1.1394</td></tr>
    </tbody>
  </table>
  
</div>

<div class="dealer-card">
  <h3>Dealer: LONG</h3>
  <table class="params-table">
    <tbody>
      <tr class="section-header"><th colspan="2">Inventory</th></tr>
      <tr><th>Tickets (a)</th><td>0</td></tr>
      <tr><th>Face inventory (x)</th><td>0</td></tr>
      <tr><th>Cash (C)</th><td>0</td></tr>
      <tr><th>Mid-valued (V)</th><td>0</td></tr>
      <tr class="section-header"><th colspan="2">Capacity</th></tr>
      <tr><th>Max tickets (K*)</th><td>0</td></tr>
      <tr><th>One-sided cap (X*)</th><td>0</td></tr>
      <tr><th>Ladder rungs (N)</th><td>1</td></tr>
      <tr><th>Layoff prob (λ)</th><td>1</td></tr>
      <tr class="section-header"><th colspan="2">Quotes</th></tr>
      <tr><th>Inside width (I)</th><td>0</td></tr>
      <tr><th>Midline p(x)</th><td>0</td></tr>
      <tr><th>Bid <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0</td></tr>
      <tr><th>Ask <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0</td></tr>
    </tbody>
  </table>
  
</div>

    </div>
    <div class="dealers-grid">
      
<div class="dealer-card vbt-card">
  <h3>VBT: SHORT</h3>
  <table class="params-table">
    <tbody>
      <tr><th>Mid anchor (M)</th><td>1</td></tr>
      <tr><th>Spread anchor (O)</th><td>0.3</td></tr>
      <tr><th>Ask (A = M + O/2)</th><td>1.15</td></tr>
      <tr><th>Bid (B = M - O/2)</th><td>0.85</td></tr>
      <tr><th>Cash</th><td>0</td></tr>
      <tr><th>Inventory</th><td>0 tickets</td></tr>
    </tbody>
  </table>
</div>

<div class="dealer-card vbt-card">
  <h3>VBT: MID</h3>
  <table class="params-table">
    <tbody>
      <tr><th>Mid anchor (M)</th><td>1</td></tr>
      <tr><th>Spread anchor (O)</th><td>0.3</td></tr>
      <tr><th>Ask (A = M + O/2)</th><td>1.15</td></tr>
      <tr><th>Bid (B = M - O/2)</th><td>0.85</td></tr>
      <tr><th>Cash</th><td>5.75</td></tr>
      <tr><th>Inventory</th><td>0 tickets</td></tr>
    </tbody>
  </table>
</div>

<div class="dealer-card vbt-card">
  <h3>VBT: LONG</h3>
  <table class="params-table">
    <tbody>
      <tr><th>Mid anchor (M)</th><td>1</td></tr>
      <tr><th>Spread anchor (O)</th><td>0.3</td></tr>
      <tr><th>Ask (A = M + O/2)</th><td>1.15</td></tr>
      <tr><th>Bid (B = M - O/2)</th><td>0.85</td></tr>
      <tr><th>Cash</th><td>0</td></tr>
      <tr><th>Inventory</th><td>0 tickets</td></tr>
    </tbody>
  </table>
</div>

    </div>
  </div>

  
  <div class="balances-section">
    <h3>Trader Balances</h3>
    <div class="traders-grid">
      
<div class="t-account">
  <h3>issuer_I<span style="color: #dc2626; font-weight: 600;"> [DEFAULTED]</span></h3>
  <div class="grid">
    <div class="assets-side">
      <h4>Assets (0)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">Cash</td>
        <td class="val">0</td>
      </tr>
    
      <tr>
        <td colspan="2" class="empty">No tickets owned</td>
      </tr>
        
        </tbody>
      </table>
    </div>
    <div class="liabilities-side">
      <h4>Liabilities (0)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td colspan="2" class="empty">No obligations</td>
      </tr>
        
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="t-account">
  <h3>trader_K</h3>
  <div class="grid">
    <div class="assets-side">
      <h4>Assets (1.12)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">Cash</td>
        <td class="val">1.12</td>
      </tr>
    
      <tr>
        <td colspan="2" class="empty">No tickets owned</td>
      </tr>
        
        </tbody>
      </table>
    </div>
    <div class="liabilities-side">
      <h4>Liabilities (0)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td colspan="2" class="empty">No obligations</td>
      </tr>
        
        </tbody>
      </table>
    </div>
  </div>
</div>

    </div>
  </div>

</section>

    </main>

    <footer>
      Generated by bilancio dealer ring simulation
    </footer>
  </div>
</body>
</html>



################################################################################
# FILE: example10_report.html
# PATH: examples/dealer_ring/out/example10_report.html
################################################################################

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Example 10: Trader-Held Rebucketing</title>
  <style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;line-height:1.6;color:#333;background:#f5f5f5}
.container{max-width:1400px;margin:0 auto;padding:20px}
header{background:#fff;border-radius:8px;padding:24px;margin-bottom:24px;box-shadow:0 2px 4px rgba(0,0,0,0.1)}
h1{color:#2563eb;font-size:28px;margin-bottom:8px}
h2{color:#475569;font-size:20px;margin-bottom:16px}
h3{color:#334155;font-size:18px;margin-bottom:12px}
h4{color:#475569;font-size:16px;margin:8px 0;font-weight:600}
.description{color:#64748b;font-style:italic;margin-bottom:16px}
.meta{display:flex;gap:24px;color:#64748b;font-size:14px}
.meta span{display:inline-block}
.t-account{background:#fff;border-radius:8px;padding:20px;margin-bottom:20px;box-shadow:0 2px 4px rgba(0,0,0,0.1)}
.t-account .grid{display:grid;grid-template-columns:1fr 1fr;gap:20px}
.t-account table.side{width:100%;border-collapse:collapse;font-size:14px}
.t-account th,.t-account td{border-bottom:1px solid #e5e7eb;border-right:1px solid #eef2f7;padding:8px;text-align:left}
.t-account th:last-child,.t-account td:last-child{border-right:none}
.t-account tbody tr:nth-child(even){background:#fafafa}
.t-account th{background:#f9fafb;font-weight:600;color:#374151}
.t-account td.qty,.t-account td.val,.t-account td.mat{text-align:right;white-space:nowrap}
.t-account td.name{font-weight:500}
.t-account td.empty{text-align:center;color:#9ca3af}
.assets-side h4{color:#16a34a}
.liabilities-side h4{color:#dc2626}
.events-table{background:#fff;border-radius:8px;padding:20px;margin-bottom:24px;box-shadow:0 2px 4px rgba(0,0,0,0.1)}
.events-table table{width:100%;border-collapse:collapse;font-size:14px}
.events-table th,.events-table td{border-bottom:1px solid #e5e7eb;border-right:1px solid #eef2f7;padding:8px;text-align:left}
.events-table th:last-child,.events-table td:last-child{border-right:none}
.events-table tbody tr:nth-child(even){background:#f7f9fc}
.events-table th{background:#f9fafb;font-weight:600;color:#374151}
.events-table td.qty,.events-table td.amount{text-align:center;white-space:nowrap}
.events-table td.event-kind{font-weight:500;color:#3b82f6}
.events-table td.notes{font-size:13px;color:#64748b}
.agents>h2{margin-bottom:20px;padding:0 20px}
.day-section{margin-bottom:40px;padding-bottom:40px;border-bottom:2px solid #e5e7eb}
.day-section:last-child{border-bottom:none}
.day-header{color:#1f2937;font-size:24px;margin-bottom:24px;padding:12px 0;border-bottom:1px solid #e5e7eb}
.events-section{margin-bottom:24px}
.balances-section{margin-top:24px}
.balances-section>h3{margin-bottom:20px;color:#374151;font-size:20px}
footer{text-align:center;color:#9ca3af;font-size:14px;margin-top:40px;padding:20px}
@media (max-width:768px){.t-account .grid{grid-template-columns:1fr}.meta{flex-direction:column;gap:8px}}



/* Dealer card styling */
.dealer-card {
  background: #fff;
  border-radius: 8px;
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.dealer-card h3 {
  color: #1e40af;
  margin-bottom: 16px;
  border-bottom: 2px solid #dbeafe;
  padding-bottom: 8px;
}
.params-table {
  width: 100%;
  border-collapse: collapse;
}
.params-table th {
  text-align: left;
  padding: 6px 12px;
  color: #64748b;
  font-weight: 500;
  width: 40%;
}
.params-table td {
  text-align: right;
  padding: 6px 12px;
  font-family: 'SF Mono', Monaco, monospace;
  color: #1f2937;
}
.params-table tr.section-header th {
  color: #374151;
  font-weight: 600;
  padding-top: 12px;
  border-bottom: 1px solid #e5e7eb;
}
/* VBT card */
.vbt-card {
  background: linear-gradient(135deg, #f0fdf4, #fff);
  border-left: 4px solid #16a34a;
}
.vbt-card h3 {
  color: #16a34a;
  border-bottom-color: #bbf7d0;
}
/* Event type colors */
.event-trade { color: #3b82f6; }
.event-passthrough { color: #8b5cf6; }
.event-rebucket { color: #f59e0b; }
.event-settlement { color: #16a34a; }
.event-default { color: #dc2626; }
.event-quote { color: #64748b; }
.event-vbt-anchor-update { color: #14b8a6; }
/* Pin indicators */
.pin-indicator {
  display: inline-block;
  width: 8px;
  height: 8px;
  border-radius: 50%;
  margin-left: 4px;
}
.pin-indicator.pinned { background: #f59e0b; }
.pin-indicator.not-pinned { background: #d1d5db; }
/* Grid layouts */
.dealers-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 20px;
  margin-bottom: 24px;
}
.traders-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
  gap: 20px;
}
/* Inventory list */
.inventory-list {
  margin-top: 12px;
  padding-top: 12px;
  border-top: 1px solid #e5e7eb;
}
.inventory-list h4 {
  color: #64748b;
  font-size: 14px;
  margin-bottom: 8px;
}
.inventory-list ul {
  list-style: none;
  padding: 0;
  margin: 0;
  font-size: 13px;
}
.inventory-list li {
  padding: 4px 0;
  color: #4b5563;
  font-family: 'SF Mono', Monaco, monospace;
}

  </style>
</head>
<body>
  <div class="container">
    
<header>
  <h1>Example 10: Trader-Held Rebucketing</h1>
  <p class="description">Only bucket_id changes, no dealer-dealer transfer</p>
  <div class="meta">
    <span><strong>Days:</strong> 1</span>
    <span><strong>Buckets:</strong> short, mid, long</span>
    <span><strong>Traders:</strong> 2</span>
    <span><strong>Tickets:</strong> 5</span>
    <span><strong>Ticket Size (S):</strong> 1</span>
  </div>
</header>


    <main>
      
<section class="day-section">
  <h2 class="day-header">🏁 Day 0 (Setup)</h2>

  
<div class="events-table">
  <h3>Day 0 (Setup) Events</h3>
  <p style="color: #9ca3af; font-style: italic;">No events for this day</p>
</div>


  <div class="balances-section">
    <h3>Market State</h3>
    <div class="dealers-grid">
      
<div class="dealer-card">
  <h3>Dealer: SHORT</h3>
  <table class="params-table">
    <tbody>
      <tr class="section-header"><th colspan="2">Inventory</th></tr>
      <tr><th>Tickets (a)</th><td>0</td></tr>
      <tr><th>Face inventory (x)</th><td>0</td></tr>
      <tr><th>Cash (C)</th><td>0</td></tr>
      <tr><th>Mid-valued (V)</th><td>0</td></tr>
      <tr class="section-header"><th colspan="2">Capacity</th></tr>
      <tr><th>Max tickets (K*)</th><td>0</td></tr>
      <tr><th>One-sided cap (X*)</th><td>0</td></tr>
      <tr><th>Ladder rungs (N)</th><td>1</td></tr>
      <tr><th>Layoff prob (λ)</th><td>1</td></tr>
      <tr class="section-header"><th colspan="2">Quotes</th></tr>
      <tr><th>Inside width (I)</th><td>0</td></tr>
      <tr><th>Midline p(x)</th><td>0</td></tr>
      <tr><th>Bid <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0</td></tr>
      <tr><th>Ask <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0</td></tr>
    </tbody>
  </table>
  
</div>

<div class="dealer-card">
  <h3>Dealer: MID</h3>
  <table class="params-table">
    <tbody>
      <tr class="section-header"><th colspan="2">Inventory</th></tr>
      <tr><th>Tickets (a)</th><td>2</td></tr>
      <tr><th>Face inventory (x)</th><td>2</td></tr>
      <tr><th>Cash (C)</th><td>3</td></tr>
      <tr><th>Mid-valued (V)</th><td>5</td></tr>
      <tr class="section-header"><th colspan="2">Capacity</th></tr>
      <tr><th>Max tickets (K*)</th><td>5</td></tr>
      <tr><th>One-sided cap (X*)</th><td>5</td></tr>
      <tr><th>Ladder rungs (N)</th><td>6</td></tr>
      <tr><th>Layoff prob (λ)</th><td>0.1667</td></tr>
      <tr class="section-header"><th colspan="2">Quotes</th></tr>
      <tr><th>Inside width (I)</th><td>0.05</td></tr>
      <tr><th>Midline p(x)</th><td>1.0214</td></tr>
      <tr><th>Bid <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0.9964</td></tr>
      <tr><th>Ask <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>1.0464</td></tr>
    </tbody>
  </table>
  
  <div class="inventory-list">
    <h4>Inventory (2 tickets)</h4>
    <ul>
      <li>D_mid_0 (issuer: issuer_J, face: 1, τ: 6)</li><li>D_mid_1 (issuer: issuer_J, face: 1, τ: 6)</li>
    </ul>
  </div>

</div>

<div class="dealer-card">
  <h3>Dealer: LONG</h3>
  <table class="params-table">
    <tbody>
      <tr class="section-header"><th colspan="2">Inventory</th></tr>
      <tr><th>Tickets (a)</th><td>2</td></tr>
      <tr><th>Face inventory (x)</th><td>2</td></tr>
      <tr><th>Cash (C)</th><td>2</td></tr>
      <tr><th>Mid-valued (V)</th><td>4</td></tr>
      <tr class="section-header"><th colspan="2">Capacity</th></tr>
      <tr><th>Max tickets (K*)</th><td>4</td></tr>
      <tr><th>One-sided cap (X*)</th><td>4</td></tr>
      <tr><th>Ladder rungs (N)</th><td>5</td></tr>
      <tr><th>Layoff prob (λ)</th><td>0.2</td></tr>
      <tr class="section-header"><th colspan="2">Quotes</th></tr>
      <tr><th>Inside width (I)</th><td>0.06</td></tr>
      <tr><th>Midline p(x)</th><td>1</td></tr>
      <tr><th>Bid <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0.97</td></tr>
      <tr><th>Ask <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>1.03</td></tr>
    </tbody>
  </table>
  
  <div class="inventory-list">
    <h4>Inventory (2 tickets)</h4>
    <ul>
      <li>D_long_0 (issuer: issuer_J, face: 1, τ: 15)</li><li>D_long_1 (issuer: issuer_J, face: 1, τ: 15)</li>
    </ul>
  </div>

</div>

    </div>
    <div class="dealers-grid">
      
<div class="dealer-card vbt-card">
  <h3>VBT: SHORT</h3>
  <table class="params-table">
    <tbody>
      <tr><th>Mid anchor (M)</th><td>1</td></tr>
      <tr><th>Spread anchor (O)</th><td>0.3</td></tr>
      <tr><th>Ask (A = M + O/2)</th><td>1.15</td></tr>
      <tr><th>Bid (B = M - O/2)</th><td>0.85</td></tr>
      <tr><th>Cash</th><td>0</td></tr>
      <tr><th>Inventory</th><td>0 tickets</td></tr>
    </tbody>
  </table>
</div>

<div class="dealer-card vbt-card">
  <h3>VBT: MID</h3>
  <table class="params-table">
    <tbody>
      <tr><th>Mid anchor (M)</th><td>1</td></tr>
      <tr><th>Spread anchor (O)</th><td>0.3</td></tr>
      <tr><th>Ask (A = M + O/2)</th><td>1.15</td></tr>
      <tr><th>Bid (B = M - O/2)</th><td>0.85</td></tr>
      <tr><th>Cash</th><td>0</td></tr>
      <tr><th>Inventory</th><td>0 tickets</td></tr>
    </tbody>
  </table>
</div>

<div class="dealer-card vbt-card">
  <h3>VBT: LONG</h3>
  <table class="params-table">
    <tbody>
      <tr><th>Mid anchor (M)</th><td>1</td></tr>
      <tr><th>Spread anchor (O)</th><td>0.3</td></tr>
      <tr><th>Ask (A = M + O/2)</th><td>1.15</td></tr>
      <tr><th>Bid (B = M - O/2)</th><td>0.85</td></tr>
      <tr><th>Cash</th><td>0</td></tr>
      <tr><th>Inventory</th><td>0 tickets</td></tr>
    </tbody>
  </table>
</div>

    </div>
  </div>

  
  <div class="balances-section">
    <h3>Trader Balances</h3>
    <div class="traders-grid">
      
<div class="t-account">
  <h3>issuer_J</h3>
  <div class="grid">
    <div class="assets-side">
      <h4>Assets (100)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">Cash</td>
        <td class="val">100</td>
      </tr>
    
      <tr>
        <td colspan="2" class="empty">No tickets owned</td>
      </tr>
        
        </tbody>
      </table>
    </div>
    <div class="liabilities-side">
      <h4>Liabilities (1)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">T_star</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(to trader_T, mat=9)</span></td>
      </tr>
        
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="t-account">
  <h3>trader_T</h3>
  <div class="grid">
    <div class="assets-side">
      <h4>Assets (6)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">Cash</td>
        <td class="val">5</td>
      </tr>
    
      <tr>
        <td class="name">T_star</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(issuer_J, τ=9)</span></td>
      </tr>
        
        </tbody>
      </table>
    </div>
    <div class="liabilities-side">
      <h4>Liabilities (0)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td colspan="2" class="empty">No obligations</td>
      </tr>
        
        </tbody>
      </table>
    </div>
  </div>
</div>

    </div>
  </div>

</section>

<section class="day-section">
  <h2 class="day-header">📅 Day 1</h2>

  
<div class="events-table">
  <h3>Day 1 Events</h3>
  <table>
    <thead>
      <tr>
        <th style="width: 120px;">Kind</th>
        <th>Details</th>
        <th style="width: 200px;">Notes</th>
      </tr>
    </thead>
    <tbody>
      
          <tr>
            <td class="event-quote">quote</td>
            <td>[long] D: 0.97/1.03, VBT: 0.85/1.15</td>
            <td class="notes">inv=2, cap=4</td>
          </tr>
        
          <tr>
            <td class="event-quote">quote</td>
            <td>[mid] D: 0.9964/1.0464, VBT: 0.85/1.15</td>
            <td class="notes">inv=2, cap=5</td>
          </tr>
        
    </tbody>
  </table>
</div>


  <div class="balances-section">
    <h3>Market State</h3>
    <div class="dealers-grid">
      
<div class="dealer-card">
  <h3>Dealer: SHORT</h3>
  <table class="params-table">
    <tbody>
      <tr class="section-header"><th colspan="2">Inventory</th></tr>
      <tr><th>Tickets (a)</th><td>0</td></tr>
      <tr><th>Face inventory (x)</th><td>0</td></tr>
      <tr><th>Cash (C)</th><td>0</td></tr>
      <tr><th>Mid-valued (V)</th><td>0</td></tr>
      <tr class="section-header"><th colspan="2">Capacity</th></tr>
      <tr><th>Max tickets (K*)</th><td>0</td></tr>
      <tr><th>One-sided cap (X*)</th><td>0</td></tr>
      <tr><th>Ladder rungs (N)</th><td>1</td></tr>
      <tr><th>Layoff prob (λ)</th><td>1</td></tr>
      <tr class="section-header"><th colspan="2">Quotes</th></tr>
      <tr><th>Inside width (I)</th><td>0</td></tr>
      <tr><th>Midline p(x)</th><td>0</td></tr>
      <tr><th>Bid <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0</td></tr>
      <tr><th>Ask <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0</td></tr>
    </tbody>
  </table>
  
</div>

<div class="dealer-card">
  <h3>Dealer: MID</h3>
  <table class="params-table">
    <tbody>
      <tr class="section-header"><th colspan="2">Inventory</th></tr>
      <tr><th>Tickets (a)</th><td>2</td></tr>
      <tr><th>Face inventory (x)</th><td>2</td></tr>
      <tr><th>Cash (C)</th><td>3</td></tr>
      <tr><th>Mid-valued (V)</th><td>5</td></tr>
      <tr class="section-header"><th colspan="2">Capacity</th></tr>
      <tr><th>Max tickets (K*)</th><td>5</td></tr>
      <tr><th>One-sided cap (X*)</th><td>5</td></tr>
      <tr><th>Ladder rungs (N)</th><td>6</td></tr>
      <tr><th>Layoff prob (λ)</th><td>0.1667</td></tr>
      <tr class="section-header"><th colspan="2">Quotes</th></tr>
      <tr><th>Inside width (I)</th><td>0.05</td></tr>
      <tr><th>Midline p(x)</th><td>1.0214</td></tr>
      <tr><th>Bid <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0.9964</td></tr>
      <tr><th>Ask <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>1.0464</td></tr>
    </tbody>
  </table>
  
  <div class="inventory-list">
    <h4>Inventory (2 tickets)</h4>
    <ul>
      <li>D_mid_0 (issuer: issuer_J, face: 1, τ: 5)</li><li>D_mid_1 (issuer: issuer_J, face: 1, τ: 5)</li>
    </ul>
  </div>

</div>

<div class="dealer-card">
  <h3>Dealer: LONG</h3>
  <table class="params-table">
    <tbody>
      <tr class="section-header"><th colspan="2">Inventory</th></tr>
      <tr><th>Tickets (a)</th><td>2</td></tr>
      <tr><th>Face inventory (x)</th><td>2</td></tr>
      <tr><th>Cash (C)</th><td>2</td></tr>
      <tr><th>Mid-valued (V)</th><td>4</td></tr>
      <tr class="section-header"><th colspan="2">Capacity</th></tr>
      <tr><th>Max tickets (K*)</th><td>4</td></tr>
      <tr><th>One-sided cap (X*)</th><td>4</td></tr>
      <tr><th>Ladder rungs (N)</th><td>5</td></tr>
      <tr><th>Layoff prob (λ)</th><td>0.2</td></tr>
      <tr class="section-header"><th colspan="2">Quotes</th></tr>
      <tr><th>Inside width (I)</th><td>0.06</td></tr>
      <tr><th>Midline p(x)</th><td>1</td></tr>
      <tr><th>Bid <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0.97</td></tr>
      <tr><th>Ask <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>1.03</td></tr>
    </tbody>
  </table>
  
  <div class="inventory-list">
    <h4>Inventory (2 tickets)</h4>
    <ul>
      <li>D_long_0 (issuer: issuer_J, face: 1, τ: 14)</li><li>D_long_1 (issuer: issuer_J, face: 1, τ: 14)</li>
    </ul>
  </div>

</div>

    </div>
    <div class="dealers-grid">
      
<div class="dealer-card vbt-card">
  <h3>VBT: SHORT</h3>
  <table class="params-table">
    <tbody>
      <tr><th>Mid anchor (M)</th><td>1</td></tr>
      <tr><th>Spread anchor (O)</th><td>0.3</td></tr>
      <tr><th>Ask (A = M + O/2)</th><td>1.15</td></tr>
      <tr><th>Bid (B = M - O/2)</th><td>0.85</td></tr>
      <tr><th>Cash</th><td>0</td></tr>
      <tr><th>Inventory</th><td>0 tickets</td></tr>
    </tbody>
  </table>
</div>

<div class="dealer-card vbt-card">
  <h3>VBT: MID</h3>
  <table class="params-table">
    <tbody>
      <tr><th>Mid anchor (M)</th><td>1</td></tr>
      <tr><th>Spread anchor (O)</th><td>0.3</td></tr>
      <tr><th>Ask (A = M + O/2)</th><td>1.15</td></tr>
      <tr><th>Bid (B = M - O/2)</th><td>0.85</td></tr>
      <tr><th>Cash</th><td>0</td></tr>
      <tr><th>Inventory</th><td>0 tickets</td></tr>
    </tbody>
  </table>
</div>

<div class="dealer-card vbt-card">
  <h3>VBT: LONG</h3>
  <table class="params-table">
    <tbody>
      <tr><th>Mid anchor (M)</th><td>1</td></tr>
      <tr><th>Spread anchor (O)</th><td>0.3</td></tr>
      <tr><th>Ask (A = M + O/2)</th><td>1.15</td></tr>
      <tr><th>Bid (B = M - O/2)</th><td>0.85</td></tr>
      <tr><th>Cash</th><td>0</td></tr>
      <tr><th>Inventory</th><td>0 tickets</td></tr>
    </tbody>
  </table>
</div>

    </div>
  </div>

  
  <div class="balances-section">
    <h3>Trader Balances</h3>
    <div class="traders-grid">
      
<div class="t-account">
  <h3>issuer_J</h3>
  <div class="grid">
    <div class="assets-side">
      <h4>Assets (100)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">Cash</td>
        <td class="val">100</td>
      </tr>
    
      <tr>
        <td colspan="2" class="empty">No tickets owned</td>
      </tr>
        
        </tbody>
      </table>
    </div>
    <div class="liabilities-side">
      <h4>Liabilities (1)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">T_star</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(to trader_T, mat=9)</span></td>
      </tr>
        
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="t-account">
  <h3>trader_T</h3>
  <div class="grid">
    <div class="assets-side">
      <h4>Assets (6)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">Cash</td>
        <td class="val">5</td>
      </tr>
    
      <tr>
        <td class="name">T_star</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(issuer_J, τ=8)</span></td>
      </tr>
        
        </tbody>
      </table>
    </div>
    <div class="liabilities-side">
      <h4>Liabilities (0)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td colspan="2" class="empty">No obligations</td>
      </tr>
        
        </tbody>
      </table>
    </div>
  </div>
</div>

    </div>
  </div>

</section>

    </main>

    <footer>
      Generated by bilancio dealer ring simulation
    </footer>
  </div>
</body>
</html>



################################################################################
# FILE: example11_report.html
# PATH: examples/dealer_ring/out/example11_report.html
################################################################################

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Example 11: Partial-Recovery Default (R=0.6)</title>
  <style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;line-height:1.6;color:#333;background:#f5f5f5}
.container{max-width:1400px;margin:0 auto;padding:20px}
header{background:#fff;border-radius:8px;padding:24px;margin-bottom:24px;box-shadow:0 2px 4px rgba(0,0,0,0.1)}
h1{color:#2563eb;font-size:28px;margin-bottom:8px}
h2{color:#475569;font-size:20px;margin-bottom:16px}
h3{color:#334155;font-size:18px;margin-bottom:12px}
h4{color:#475569;font-size:16px;margin:8px 0;font-weight:600}
.description{color:#64748b;font-style:italic;margin-bottom:16px}
.meta{display:flex;gap:24px;color:#64748b;font-size:14px}
.meta span{display:inline-block}
.t-account{background:#fff;border-radius:8px;padding:20px;margin-bottom:20px;box-shadow:0 2px 4px rgba(0,0,0,0.1)}
.t-account .grid{display:grid;grid-template-columns:1fr 1fr;gap:20px}
.t-account table.side{width:100%;border-collapse:collapse;font-size:14px}
.t-account th,.t-account td{border-bottom:1px solid #e5e7eb;border-right:1px solid #eef2f7;padding:8px;text-align:left}
.t-account th:last-child,.t-account td:last-child{border-right:none}
.t-account tbody tr:nth-child(even){background:#fafafa}
.t-account th{background:#f9fafb;font-weight:600;color:#374151}
.t-account td.qty,.t-account td.val,.t-account td.mat{text-align:right;white-space:nowrap}
.t-account td.name{font-weight:500}
.t-account td.empty{text-align:center;color:#9ca3af}
.assets-side h4{color:#16a34a}
.liabilities-side h4{color:#dc2626}
.events-table{background:#fff;border-radius:8px;padding:20px;margin-bottom:24px;box-shadow:0 2px 4px rgba(0,0,0,0.1)}
.events-table table{width:100%;border-collapse:collapse;font-size:14px}
.events-table th,.events-table td{border-bottom:1px solid #e5e7eb;border-right:1px solid #eef2f7;padding:8px;text-align:left}
.events-table th:last-child,.events-table td:last-child{border-right:none}
.events-table tbody tr:nth-child(even){background:#f7f9fc}
.events-table th{background:#f9fafb;font-weight:600;color:#374151}
.events-table td.qty,.events-table td.amount{text-align:center;white-space:nowrap}
.events-table td.event-kind{font-weight:500;color:#3b82f6}
.events-table td.notes{font-size:13px;color:#64748b}
.agents>h2{margin-bottom:20px;padding:0 20px}
.day-section{margin-bottom:40px;padding-bottom:40px;border-bottom:2px solid #e5e7eb}
.day-section:last-child{border-bottom:none}
.day-header{color:#1f2937;font-size:24px;margin-bottom:24px;padding:12px 0;border-bottom:1px solid #e5e7eb}
.events-section{margin-bottom:24px}
.balances-section{margin-top:24px}
.balances-section>h3{margin-bottom:20px;color:#374151;font-size:20px}
footer{text-align:center;color:#9ca3af;font-size:14px;margin-top:40px;padding:20px}
@media (max-width:768px){.t-account .grid{grid-template-columns:1fr}.meta{flex-direction:column;gap:8px}}



/* Dealer card styling */
.dealer-card {
  background: #fff;
  border-radius: 8px;
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.dealer-card h3 {
  color: #1e40af;
  margin-bottom: 16px;
  border-bottom: 2px solid #dbeafe;
  padding-bottom: 8px;
}
.params-table {
  width: 100%;
  border-collapse: collapse;
}
.params-table th {
  text-align: left;
  padding: 6px 12px;
  color: #64748b;
  font-weight: 500;
  width: 40%;
}
.params-table td {
  text-align: right;
  padding: 6px 12px;
  font-family: 'SF Mono', Monaco, monospace;
  color: #1f2937;
}
.params-table tr.section-header th {
  color: #374151;
  font-weight: 600;
  padding-top: 12px;
  border-bottom: 1px solid #e5e7eb;
}
/* VBT card */
.vbt-card {
  background: linear-gradient(135deg, #f0fdf4, #fff);
  border-left: 4px solid #16a34a;
}
.vbt-card h3 {
  color: #16a34a;
  border-bottom-color: #bbf7d0;
}
/* Event type colors */
.event-trade { color: #3b82f6; }
.event-passthrough { color: #8b5cf6; }
.event-rebucket { color: #f59e0b; }
.event-settlement { color: #16a34a; }
.event-default { color: #dc2626; }
.event-quote { color: #64748b; }
.event-vbt-anchor-update { color: #14b8a6; }
/* Pin indicators */
.pin-indicator {
  display: inline-block;
  width: 8px;
  height: 8px;
  border-radius: 50%;
  margin-left: 4px;
}
.pin-indicator.pinned { background: #f59e0b; }
.pin-indicator.not-pinned { background: #d1d5db; }
/* Grid layouts */
.dealers-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 20px;
  margin-bottom: 24px;
}
.traders-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
  gap: 20px;
}
/* Inventory list */
.inventory-list {
  margin-top: 12px;
  padding-top: 12px;
  border-top: 1px solid #e5e7eb;
}
.inventory-list h4 {
  color: #64748b;
  font-size: 14px;
  margin-bottom: 8px;
}
.inventory-list ul {
  list-style: none;
  padding: 0;
  margin: 0;
  font-size: 13px;
}
.inventory-list li {
  padding: 4px 0;
  color: #4b5563;
  font-family: 'SF Mono', Monaco, monospace;
}

  </style>
</head>
<body>
  <div class="container">
    
<header>
  <h1>Example 11: Partial-Recovery Default (R=0.6)</h1>
  <p class="description">Multiple claimant types receive proportional recovery</p>
  <div class="meta">
    <span><strong>Days:</strong> 1</span>
    <span><strong>Buckets:</strong> short, mid, long</span>
    <span><strong>Traders:</strong> 2</span>
    <span><strong>Tickets:</strong> 5</span>
    <span><strong>Ticket Size (S):</strong> 1</span>
  </div>
</header>


    <main>
      
<section class="day-section">
  <h2 class="day-header">🏁 Day 0 (Setup)</h2>

  
<div class="events-table">
  <h3>Day 0 (Setup) Events</h3>
  <p style="color: #9ca3af; font-style: italic;">No events for this day</p>
</div>


  <div class="balances-section">
    <h3>Market State</h3>
    <div class="dealers-grid">
      
<div class="dealer-card">
  <h3>Dealer: SHORT</h3>
  <table class="params-table">
    <tbody>
      <tr class="section-header"><th colspan="2">Inventory</th></tr>
      <tr><th>Tickets (a)</th><td>0</td></tr>
      <tr><th>Face inventory (x)</th><td>0</td></tr>
      <tr><th>Cash (C)</th><td>0</td></tr>
      <tr><th>Mid-valued (V)</th><td>0</td></tr>
      <tr class="section-header"><th colspan="2">Capacity</th></tr>
      <tr><th>Max tickets (K*)</th><td>0</td></tr>
      <tr><th>One-sided cap (X*)</th><td>0</td></tr>
      <tr><th>Ladder rungs (N)</th><td>1</td></tr>
      <tr><th>Layoff prob (λ)</th><td>1</td></tr>
      <tr class="section-header"><th colspan="2">Quotes</th></tr>
      <tr><th>Inside width (I)</th><td>0</td></tr>
      <tr><th>Midline p(x)</th><td>0</td></tr>
      <tr><th>Bid <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0</td></tr>
      <tr><th>Ask <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0</td></tr>
    </tbody>
  </table>
  
</div>

<div class="dealer-card">
  <h3>Dealer: MID</h3>
  <table class="params-table">
    <tbody>
      <tr class="section-header"><th colspan="2">Inventory</th></tr>
      <tr><th>Tickets (a)</th><td>2</td></tr>
      <tr><th>Face inventory (x)</th><td>2</td></tr>
      <tr><th>Cash (C)</th><td>5</td></tr>
      <tr><th>Mid-valued (V)</th><td>7</td></tr>
      <tr class="section-header"><th colspan="2">Capacity</th></tr>
      <tr><th>Max tickets (K*)</th><td>7</td></tr>
      <tr><th>One-sided cap (X*)</th><td>7</td></tr>
      <tr><th>Ladder rungs (N)</th><td>8</td></tr>
      <tr><th>Layoff prob (λ)</th><td>0.125</td></tr>
      <tr class="section-header"><th colspan="2">Quotes</th></tr>
      <tr><th>Inside width (I)</th><td>0.0375</td></tr>
      <tr><th>Midline p(x)</th><td>1.05</td></tr>
      <tr><th>Bid <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>1.0312</td></tr>
      <tr><th>Ask <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>1.0688</td></tr>
    </tbody>
  </table>
  
  <div class="inventory-list">
    <h4>Inventory (2 tickets)</h4>
    <ul>
      <li>D0 (issuer: issuer_I, face: 1, τ: 6)</li><li>D1 (issuer: issuer_I, face: 1, τ: 6)</li>
    </ul>
  </div>

</div>

<div class="dealer-card">
  <h3>Dealer: LONG</h3>
  <table class="params-table">
    <tbody>
      <tr class="section-header"><th colspan="2">Inventory</th></tr>
      <tr><th>Tickets (a)</th><td>0</td></tr>
      <tr><th>Face inventory (x)</th><td>0</td></tr>
      <tr><th>Cash (C)</th><td>0</td></tr>
      <tr><th>Mid-valued (V)</th><td>0</td></tr>
      <tr class="section-header"><th colspan="2">Capacity</th></tr>
      <tr><th>Max tickets (K*)</th><td>0</td></tr>
      <tr><th>One-sided cap (X*)</th><td>0</td></tr>
      <tr><th>Ladder rungs (N)</th><td>1</td></tr>
      <tr><th>Layoff prob (λ)</th><td>1</td></tr>
      <tr class="section-header"><th colspan="2">Quotes</th></tr>
      <tr><th>Inside width (I)</th><td>0</td></tr>
      <tr><th>Midline p(x)</th><td>0</td></tr>
      <tr><th>Bid <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0</td></tr>
      <tr><th>Ask <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0</td></tr>
    </tbody>
  </table>
  
</div>

    </div>
    <div class="dealers-grid">
      
<div class="dealer-card vbt-card">
  <h3>VBT: SHORT</h3>
  <table class="params-table">
    <tbody>
      <tr><th>Mid anchor (M)</th><td>1</td></tr>
      <tr><th>Spread anchor (O)</th><td>0.3</td></tr>
      <tr><th>Ask (A = M + O/2)</th><td>1.15</td></tr>
      <tr><th>Bid (B = M - O/2)</th><td>0.85</td></tr>
      <tr><th>Cash</th><td>0</td></tr>
      <tr><th>Inventory</th><td>0 tickets</td></tr>
    </tbody>
  </table>
</div>

<div class="dealer-card vbt-card">
  <h3>VBT: MID</h3>
  <table class="params-table">
    <tbody>
      <tr><th>Mid anchor (M)</th><td>1</td></tr>
      <tr><th>Spread anchor (O)</th><td>0.3</td></tr>
      <tr><th>Ask (A = M + O/2)</th><td>1.15</td></tr>
      <tr><th>Bid (B = M - O/2)</th><td>0.85</td></tr>
      <tr><th>Cash</th><td>10</td></tr>
      <tr><th>Inventory</th><td>2 tickets</td></tr>
    </tbody>
  </table>
</div>

<div class="dealer-card vbt-card">
  <h3>VBT: LONG</h3>
  <table class="params-table">
    <tbody>
      <tr><th>Mid anchor (M)</th><td>1</td></tr>
      <tr><th>Spread anchor (O)</th><td>0.3</td></tr>
      <tr><th>Ask (A = M + O/2)</th><td>1.15</td></tr>
      <tr><th>Bid (B = M - O/2)</th><td>0.85</td></tr>
      <tr><th>Cash</th><td>0</td></tr>
      <tr><th>Inventory</th><td>0 tickets</td></tr>
    </tbody>
  </table>
</div>

    </div>
  </div>

  
  <div class="balances-section">
    <h3>Trader Balances</h3>
    <div class="traders-grid">
      
<div class="t-account">
  <h3>issuer_I</h3>
  <div class="grid">
    <div class="assets-side">
      <h4>Assets (3)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">Cash</td>
        <td class="val">3</td>
      </tr>
    
      <tr>
        <td colspan="2" class="empty">No tickets owned</td>
      </tr>
        
        </tbody>
      </table>
    </div>
    <div class="liabilities-side">
      <h4>Liabilities (5)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">D0</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(to dealer_mid_5, mat=1)</span></td>
      </tr>
        
      <tr>
        <td class="name">D1</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(to dealer_mid_5, mat=1)</span></td>
      </tr>
        
      <tr>
        <td class="name">V0</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(to vbt_mid_857a, mat=1)</span></td>
      </tr>
        
      <tr>
        <td class="name">V1</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(to vbt_mid_857a, mat=1)</span></td>
      </tr>
        
      <tr>
        <td class="name">K0</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(to trader_K, mat=1)</span></td>
      </tr>
        
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="t-account">
  <h3>trader_K</h3>
  <div class="grid">
    <div class="assets-side">
      <h4>Assets (1)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">Cash</td>
        <td class="val">0</td>
      </tr>
    
      <tr>
        <td class="name">K0</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(issuer_I, τ=6)</span></td>
      </tr>
        
        </tbody>
      </table>
    </div>
    <div class="liabilities-side">
      <h4>Liabilities (0)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td colspan="2" class="empty">No obligations</td>
      </tr>
        
        </tbody>
      </table>
    </div>
  </div>
</div>

    </div>
  </div>

</section>

<section class="day-section">
  <h2 class="day-header">📅 Day 1</h2>

  
<div class="events-table">
  <h3>Day 1 Events</h3>
  <table>
    <thead>
      <tr>
        <th style="width: 120px;">Kind</th>
        <th>Details</th>
        <th style="width: 200px;">Notes</th>
      </tr>
    </thead>
    <tbody>
      
          <tr>
            <td class="event-default">default</td>
            <td>Recovery 0.6 (due: 5, paid: 3)</td>
            <td class="notes">issuer: issuer_I, bucket: mid</td>
          </tr>
        
          <tr>
            <td class="event-quote">quote</td>
            <td>[mid] D: 1.0911/1.1339, VBT: 0.85/1.15</td>
            <td class="notes">inv=0, cap=6</td>
          </tr>
        
    </tbody>
  </table>
</div>


  <div class="balances-section">
    <h3>Market State</h3>
    <div class="dealers-grid">
      
<div class="dealer-card">
  <h3>Dealer: SHORT</h3>
  <table class="params-table">
    <tbody>
      <tr class="section-header"><th colspan="2">Inventory</th></tr>
      <tr><th>Tickets (a)</th><td>0</td></tr>
      <tr><th>Face inventory (x)</th><td>0</td></tr>
      <tr><th>Cash (C)</th><td>0</td></tr>
      <tr><th>Mid-valued (V)</th><td>0</td></tr>
      <tr class="section-header"><th colspan="2">Capacity</th></tr>
      <tr><th>Max tickets (K*)</th><td>0</td></tr>
      <tr><th>One-sided cap (X*)</th><td>0</td></tr>
      <tr><th>Ladder rungs (N)</th><td>1</td></tr>
      <tr><th>Layoff prob (λ)</th><td>1</td></tr>
      <tr class="section-header"><th colspan="2">Quotes</th></tr>
      <tr><th>Inside width (I)</th><td>0</td></tr>
      <tr><th>Midline p(x)</th><td>0</td></tr>
      <tr><th>Bid <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0</td></tr>
      <tr><th>Ask <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0</td></tr>
    </tbody>
  </table>
  
</div>

<div class="dealer-card">
  <h3>Dealer: MID</h3>
  <table class="params-table">
    <tbody>
      <tr class="section-header"><th colspan="2">Inventory</th></tr>
      <tr><th>Tickets (a)</th><td>0</td></tr>
      <tr><th>Face inventory (x)</th><td>0</td></tr>
      <tr><th>Cash (C)</th><td>6.2</td></tr>
      <tr><th>Mid-valued (V)</th><td>6.2</td></tr>
      <tr class="section-header"><th colspan="2">Capacity</th></tr>
      <tr><th>Max tickets (K*)</th><td>6</td></tr>
      <tr><th>One-sided cap (X*)</th><td>6</td></tr>
      <tr><th>Ladder rungs (N)</th><td>7</td></tr>
      <tr><th>Layoff prob (λ)</th><td>0.1429</td></tr>
      <tr class="section-header"><th colspan="2">Quotes</th></tr>
      <tr><th>Inside width (I)</th><td>0.0429</td></tr>
      <tr><th>Midline p(x)</th><td>1.1125</td></tr>
      <tr><th>Bid <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>1.0911</td></tr>
      <tr><th>Ask <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>1.1339</td></tr>
    </tbody>
  </table>
  
</div>

<div class="dealer-card">
  <h3>Dealer: LONG</h3>
  <table class="params-table">
    <tbody>
      <tr class="section-header"><th colspan="2">Inventory</th></tr>
      <tr><th>Tickets (a)</th><td>0</td></tr>
      <tr><th>Face inventory (x)</th><td>0</td></tr>
      <tr><th>Cash (C)</th><td>0</td></tr>
      <tr><th>Mid-valued (V)</th><td>0</td></tr>
      <tr class="section-header"><th colspan="2">Capacity</th></tr>
      <tr><th>Max tickets (K*)</th><td>0</td></tr>
      <tr><th>One-sided cap (X*)</th><td>0</td></tr>
      <tr><th>Ladder rungs (N)</th><td>1</td></tr>
      <tr><th>Layoff prob (λ)</th><td>1</td></tr>
      <tr class="section-header"><th colspan="2">Quotes</th></tr>
      <tr><th>Inside width (I)</th><td>0</td></tr>
      <tr><th>Midline p(x)</th><td>0</td></tr>
      <tr><th>Bid <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0</td></tr>
      <tr><th>Ask <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0</td></tr>
    </tbody>
  </table>
  
</div>

    </div>
    <div class="dealers-grid">
      
<div class="dealer-card vbt-card">
  <h3>VBT: SHORT</h3>
  <table class="params-table">
    <tbody>
      <tr><th>Mid anchor (M)</th><td>1</td></tr>
      <tr><th>Spread anchor (O)</th><td>0.3</td></tr>
      <tr><th>Ask (A = M + O/2)</th><td>1.15</td></tr>
      <tr><th>Bid (B = M - O/2)</th><td>0.85</td></tr>
      <tr><th>Cash</th><td>0</td></tr>
      <tr><th>Inventory</th><td>0 tickets</td></tr>
    </tbody>
  </table>
</div>

<div class="dealer-card vbt-card">
  <h3>VBT: MID</h3>
  <table class="params-table">
    <tbody>
      <tr><th>Mid anchor (M)</th><td>1</td></tr>
      <tr><th>Spread anchor (O)</th><td>0.3</td></tr>
      <tr><th>Ask (A = M + O/2)</th><td>1.15</td></tr>
      <tr><th>Bid (B = M - O/2)</th><td>0.85</td></tr>
      <tr><th>Cash</th><td>11.2</td></tr>
      <tr><th>Inventory</th><td>0 tickets</td></tr>
    </tbody>
  </table>
</div>

<div class="dealer-card vbt-card">
  <h3>VBT: LONG</h3>
  <table class="params-table">
    <tbody>
      <tr><th>Mid anchor (M)</th><td>1</td></tr>
      <tr><th>Spread anchor (O)</th><td>0.3</td></tr>
      <tr><th>Ask (A = M + O/2)</th><td>1.15</td></tr>
      <tr><th>Bid (B = M - O/2)</th><td>0.85</td></tr>
      <tr><th>Cash</th><td>0</td></tr>
      <tr><th>Inventory</th><td>0 tickets</td></tr>
    </tbody>
  </table>
</div>

    </div>
  </div>

  
  <div class="balances-section">
    <h3>Trader Balances</h3>
    <div class="traders-grid">
      
<div class="t-account">
  <h3>issuer_I<span style="color: #dc2626; font-weight: 600;"> [DEFAULTED]</span></h3>
  <div class="grid">
    <div class="assets-side">
      <h4>Assets (0)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">Cash</td>
        <td class="val">0</td>
      </tr>
    
      <tr>
        <td colspan="2" class="empty">No tickets owned</td>
      </tr>
        
        </tbody>
      </table>
    </div>
    <div class="liabilities-side">
      <h4>Liabilities (0)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td colspan="2" class="empty">No obligations</td>
      </tr>
        
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="t-account">
  <h3>trader_K</h3>
  <div class="grid">
    <div class="assets-side">
      <h4>Assets (0.6)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">Cash</td>
        <td class="val">0.6</td>
      </tr>
    
      <tr>
        <td colspan="2" class="empty">No tickets owned</td>
      </tr>
        
        </tbody>
      </table>
    </div>
    <div class="liabilities-side">
      <h4>Liabilities (0)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td colspan="2" class="empty">No obligations</td>
      </tr>
        
        </tbody>
      </table>
    </div>
  </div>
</div>

    </div>
  </div>

</section>

    </main>

    <footer>
      Generated by bilancio dealer ring simulation
    </footer>
  </div>
</body>
</html>



################################################################################
# FILE: example12_report.html
# PATH: examples/dealer_ring/out/example12_report.html
################################################################################

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Example 12: Capacity Integer Crossing</title>
  <style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;line-height:1.6;color:#333;background:#f5f5f5}
.container{max-width:1400px;margin:0 auto;padding:20px}
header{background:#fff;border-radius:8px;padding:24px;margin-bottom:24px;box-shadow:0 2px 4px rgba(0,0,0,0.1)}
h1{color:#2563eb;font-size:28px;margin-bottom:8px}
h2{color:#475569;font-size:20px;margin-bottom:16px}
h3{color:#334155;font-size:18px;margin-bottom:12px}
h4{color:#475569;font-size:16px;margin:8px 0;font-weight:600}
.description{color:#64748b;font-style:italic;margin-bottom:16px}
.meta{display:flex;gap:24px;color:#64748b;font-size:14px}
.meta span{display:inline-block}
.t-account{background:#fff;border-radius:8px;padding:20px;margin-bottom:20px;box-shadow:0 2px 4px rgba(0,0,0,0.1)}
.t-account .grid{display:grid;grid-template-columns:1fr 1fr;gap:20px}
.t-account table.side{width:100%;border-collapse:collapse;font-size:14px}
.t-account th,.t-account td{border-bottom:1px solid #e5e7eb;border-right:1px solid #eef2f7;padding:8px;text-align:left}
.t-account th:last-child,.t-account td:last-child{border-right:none}
.t-account tbody tr:nth-child(even){background:#fafafa}
.t-account th{background:#f9fafb;font-weight:600;color:#374151}
.t-account td.qty,.t-account td.val,.t-account td.mat{text-align:right;white-space:nowrap}
.t-account td.name{font-weight:500}
.t-account td.empty{text-align:center;color:#9ca3af}
.assets-side h4{color:#16a34a}
.liabilities-side h4{color:#dc2626}
.events-table{background:#fff;border-radius:8px;padding:20px;margin-bottom:24px;box-shadow:0 2px 4px rgba(0,0,0,0.1)}
.events-table table{width:100%;border-collapse:collapse;font-size:14px}
.events-table th,.events-table td{border-bottom:1px solid #e5e7eb;border-right:1px solid #eef2f7;padding:8px;text-align:left}
.events-table th:last-child,.events-table td:last-child{border-right:none}
.events-table tbody tr:nth-child(even){background:#f7f9fc}
.events-table th{background:#f9fafb;font-weight:600;color:#374151}
.events-table td.qty,.events-table td.amount{text-align:center;white-space:nowrap}
.events-table td.event-kind{font-weight:500;color:#3b82f6}
.events-table td.notes{font-size:13px;color:#64748b}
.agents>h2{margin-bottom:20px;padding:0 20px}
.day-section{margin-bottom:40px;padding-bottom:40px;border-bottom:2px solid #e5e7eb}
.day-section:last-child{border-bottom:none}
.day-header{color:#1f2937;font-size:24px;margin-bottom:24px;padding:12px 0;border-bottom:1px solid #e5e7eb}
.events-section{margin-bottom:24px}
.balances-section{margin-top:24px}
.balances-section>h3{margin-bottom:20px;color:#374151;font-size:20px}
footer{text-align:center;color:#9ca3af;font-size:14px;margin-top:40px;padding:20px}
@media (max-width:768px){.t-account .grid{grid-template-columns:1fr}.meta{flex-direction:column;gap:8px}}



/* Dealer card styling */
.dealer-card {
  background: #fff;
  border-radius: 8px;
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.dealer-card h3 {
  color: #1e40af;
  margin-bottom: 16px;
  border-bottom: 2px solid #dbeafe;
  padding-bottom: 8px;
}
.params-table {
  width: 100%;
  border-collapse: collapse;
}
.params-table th {
  text-align: left;
  padding: 6px 12px;
  color: #64748b;
  font-weight: 500;
  width: 40%;
}
.params-table td {
  text-align: right;
  padding: 6px 12px;
  font-family: 'SF Mono', Monaco, monospace;
  color: #1f2937;
}
.params-table tr.section-header th {
  color: #374151;
  font-weight: 600;
  padding-top: 12px;
  border-bottom: 1px solid #e5e7eb;
}
/* VBT card */
.vbt-card {
  background: linear-gradient(135deg, #f0fdf4, #fff);
  border-left: 4px solid #16a34a;
}
.vbt-card h3 {
  color: #16a34a;
  border-bottom-color: #bbf7d0;
}
/* Event type colors */
.event-trade { color: #3b82f6; }
.event-passthrough { color: #8b5cf6; }
.event-rebucket { color: #f59e0b; }
.event-settlement { color: #16a34a; }
.event-default { color: #dc2626; }
.event-quote { color: #64748b; }
.event-vbt-anchor-update { color: #14b8a6; }
/* Pin indicators */
.pin-indicator {
  display: inline-block;
  width: 8px;
  height: 8px;
  border-radius: 50%;
  margin-left: 4px;
}
.pin-indicator.pinned { background: #f59e0b; }
.pin-indicator.not-pinned { background: #d1d5db; }
/* Grid layouts */
.dealers-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 20px;
  margin-bottom: 24px;
}
.traders-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
  gap: 20px;
}
/* Inventory list */
.inventory-list {
  margin-top: 12px;
  padding-top: 12px;
  border-top: 1px solid #e5e7eb;
}
.inventory-list h4 {
  color: #64748b;
  font-size: 14px;
  margin-bottom: 8px;
}
.inventory-list ul {
  list-style: none;
  padding: 0;
  margin: 0;
  font-size: 13px;
}
.inventory-list li {
  padding: 4px 0;
  color: #4b5563;
  font-family: 'SF Mono', Monaco, monospace;
}

  </style>
</head>
<body>
  <div class="container">
    
<header>
  <h1>Example 12: Capacity Integer Crossing</h1>
  <p class="description">K* jumps discretely when V crosses integer boundary</p>
  <div class="meta">
    <span><strong>Days:</strong> 1</span>
    <span><strong>Buckets:</strong> short, mid, long</span>
    <span><strong>Traders:</strong> 2</span>
    <span><strong>Tickets:</strong> 3</span>
    <span><strong>Ticket Size (S):</strong> 1</span>
  </div>
</header>


    <main>
      
<section class="day-section">
  <h2 class="day-header">🏁 Day 0 (Setup)</h2>

  
<div class="events-table">
  <h3>Day 0 (Setup) Events</h3>
  <p style="color: #9ca3af; font-style: italic;">No events for this day</p>
</div>


  <div class="balances-section">
    <h3>Market State</h3>
    <div class="dealers-grid">
      
<div class="dealer-card">
  <h3>Dealer: SHORT</h3>
  <table class="params-table">
    <tbody>
      <tr class="section-header"><th colspan="2">Inventory</th></tr>
      <tr><th>Tickets (a)</th><td>0</td></tr>
      <tr><th>Face inventory (x)</th><td>0</td></tr>
      <tr><th>Cash (C)</th><td>0</td></tr>
      <tr><th>Mid-valued (V)</th><td>0</td></tr>
      <tr class="section-header"><th colspan="2">Capacity</th></tr>
      <tr><th>Max tickets (K*)</th><td>0</td></tr>
      <tr><th>One-sided cap (X*)</th><td>0</td></tr>
      <tr><th>Ladder rungs (N)</th><td>1</td></tr>
      <tr><th>Layoff prob (λ)</th><td>1</td></tr>
      <tr class="section-header"><th colspan="2">Quotes</th></tr>
      <tr><th>Inside width (I)</th><td>0</td></tr>
      <tr><th>Midline p(x)</th><td>0</td></tr>
      <tr><th>Bid <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0</td></tr>
      <tr><th>Ask <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0</td></tr>
    </tbody>
  </table>
  
</div>

<div class="dealer-card">
  <h3>Dealer: MID</h3>
  <table class="params-table">
    <tbody>
      <tr class="section-header"><th colspan="2">Inventory</th></tr>
      <tr><th>Tickets (a)</th><td>2</td></tr>
      <tr><th>Face inventory (x)</th><td>2</td></tr>
      <tr><th>Cash (C)</th><td>1.97</td></tr>
      <tr><th>Mid-valued (V)</th><td>3.97</td></tr>
      <tr class="section-header"><th colspan="2">Capacity</th></tr>
      <tr><th>Max tickets (K*)</th><td>3</td></tr>
      <tr><th>One-sided cap (X*)</th><td>3</td></tr>
      <tr><th>Ladder rungs (N)</th><td>4</td></tr>
      <tr><th>Layoff prob (λ)</th><td>0.25</td></tr>
      <tr class="section-header"><th colspan="2">Quotes</th></tr>
      <tr><th>Inside width (I)</th><td>0.075</td></tr>
      <tr><th>Midline p(x)</th><td>0.97</td></tr>
      <tr><th>Bid <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0.9325</td></tr>
      <tr><th>Ask <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>1.0075</td></tr>
    </tbody>
  </table>
  
  <div class="inventory-list">
    <h4>Inventory (2 tickets)</h4>
    <ul>
      <li>D0 (issuer: issuer, face: 1, τ: 6)</li><li>D1 (issuer: issuer, face: 1, τ: 6)</li>
    </ul>
  </div>

</div>

<div class="dealer-card">
  <h3>Dealer: LONG</h3>
  <table class="params-table">
    <tbody>
      <tr class="section-header"><th colspan="2">Inventory</th></tr>
      <tr><th>Tickets (a)</th><td>0</td></tr>
      <tr><th>Face inventory (x)</th><td>0</td></tr>
      <tr><th>Cash (C)</th><td>0</td></tr>
      <tr><th>Mid-valued (V)</th><td>0</td></tr>
      <tr class="section-header"><th colspan="2">Capacity</th></tr>
      <tr><th>Max tickets (K*)</th><td>0</td></tr>
      <tr><th>One-sided cap (X*)</th><td>0</td></tr>
      <tr><th>Ladder rungs (N)</th><td>1</td></tr>
      <tr><th>Layoff prob (λ)</th><td>1</td></tr>
      <tr class="section-header"><th colspan="2">Quotes</th></tr>
      <tr><th>Inside width (I)</th><td>0</td></tr>
      <tr><th>Midline p(x)</th><td>0</td></tr>
      <tr><th>Bid <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0</td></tr>
      <tr><th>Ask <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0</td></tr>
    </tbody>
  </table>
  
</div>

    </div>
    <div class="dealers-grid">
      
<div class="dealer-card vbt-card">
  <h3>VBT: SHORT</h3>
  <table class="params-table">
    <tbody>
      <tr><th>Mid anchor (M)</th><td>1</td></tr>
      <tr><th>Spread anchor (O)</th><td>0.3</td></tr>
      <tr><th>Ask (A = M + O/2)</th><td>1.15</td></tr>
      <tr><th>Bid (B = M - O/2)</th><td>0.85</td></tr>
      <tr><th>Cash</th><td>0</td></tr>
      <tr><th>Inventory</th><td>0 tickets</td></tr>
    </tbody>
  </table>
</div>

<div class="dealer-card vbt-card">
  <h3>VBT: MID</h3>
  <table class="params-table">
    <tbody>
      <tr><th>Mid anchor (M)</th><td>1</td></tr>
      <tr><th>Spread anchor (O)</th><td>0.3</td></tr>
      <tr><th>Ask (A = M + O/2)</th><td>1.15</td></tr>
      <tr><th>Bid (B = M - O/2)</th><td>0.85</td></tr>
      <tr><th>Cash</th><td>10</td></tr>
      <tr><th>Inventory</th><td>0 tickets</td></tr>
    </tbody>
  </table>
</div>

<div class="dealer-card vbt-card">
  <h3>VBT: LONG</h3>
  <table class="params-table">
    <tbody>
      <tr><th>Mid anchor (M)</th><td>1</td></tr>
      <tr><th>Spread anchor (O)</th><td>0.3</td></tr>
      <tr><th>Ask (A = M + O/2)</th><td>1.15</td></tr>
      <tr><th>Bid (B = M - O/2)</th><td>0.85</td></tr>
      <tr><th>Cash</th><td>0</td></tr>
      <tr><th>Inventory</th><td>0 tickets</td></tr>
    </tbody>
  </table>
</div>

    </div>
  </div>

  
  <div class="balances-section">
    <h3>Trader Balances</h3>
    <div class="traders-grid">
      
<div class="t-account">
  <h3>issuer</h3>
  <div class="grid">
    <div class="assets-side">
      <h4>Assets (100)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">Cash</td>
        <td class="val">100</td>
      </tr>
    
      <tr>
        <td colspan="2" class="empty">No tickets owned</td>
      </tr>
        
        </tbody>
      </table>
    </div>
    <div class="liabilities-side">
      <h4>Liabilities (3)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">D0</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(to dealer_mid_6, mat=200)</span></td>
      </tr>
        
      <tr>
        <td class="name">D1</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(to dealer_mid_6, mat=200)</span></td>
      </tr>
        
      <tr>
        <td class="name">SELL1</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(to seller, mat=200)</span></td>
      </tr>
        
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="t-account">
  <h3>seller</h3>
  <div class="grid">
    <div class="assets-side">
      <h4>Assets (1)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">Cash</td>
        <td class="val">0</td>
      </tr>
    
      <tr>
        <td class="name">SELL1</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(issuer, τ=6)</span></td>
      </tr>
        
        </tbody>
      </table>
    </div>
    <div class="liabilities-side">
      <h4>Liabilities (0)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td colspan="2" class="empty">No obligations</td>
      </tr>
        
        </tbody>
      </table>
    </div>
  </div>
</div>

    </div>
  </div>

</section>

<section class="day-section">
  <h2 class="day-header">📅 Day 1</h2>

  
<div class="events-table">
  <h3>Day 1 Events</h3>
  <table>
    <thead>
      <tr>
        <th style="width: 120px;">Kind</th>
        <th>Details</th>
        <th style="width: 200px;">Notes</th>
      </tr>
    </thead>
    <tbody>
      
          <tr>
            <td class="event-quote">quote</td>
            <td>[mid] D: 0.92/0.98, VBT: 0.85/1.15</td>
            <td class="notes">inv=3, cap=4</td>
          </tr>
        
    </tbody>
  </table>
</div>


  <div class="balances-section">
    <h3>Market State</h3>
    <div class="dealers-grid">
      
<div class="dealer-card">
  <h3>Dealer: SHORT</h3>
  <table class="params-table">
    <tbody>
      <tr class="section-header"><th colspan="2">Inventory</th></tr>
      <tr><th>Tickets (a)</th><td>0</td></tr>
      <tr><th>Face inventory (x)</th><td>0</td></tr>
      <tr><th>Cash (C)</th><td>0</td></tr>
      <tr><th>Mid-valued (V)</th><td>0</td></tr>
      <tr class="section-header"><th colspan="2">Capacity</th></tr>
      <tr><th>Max tickets (K*)</th><td>0</td></tr>
      <tr><th>One-sided cap (X*)</th><td>0</td></tr>
      <tr><th>Ladder rungs (N)</th><td>1</td></tr>
      <tr><th>Layoff prob (λ)</th><td>1</td></tr>
      <tr class="section-header"><th colspan="2">Quotes</th></tr>
      <tr><th>Inside width (I)</th><td>0</td></tr>
      <tr><th>Midline p(x)</th><td>0</td></tr>
      <tr><th>Bid <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0</td></tr>
      <tr><th>Ask <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0</td></tr>
    </tbody>
  </table>
  
</div>

<div class="dealer-card">
  <h3>Dealer: MID</h3>
  <table class="params-table">
    <tbody>
      <tr class="section-header"><th colspan="2">Inventory</th></tr>
      <tr><th>Tickets (a)</th><td>3</td></tr>
      <tr><th>Face inventory (x)</th><td>3</td></tr>
      <tr><th>Cash (C)</th><td>1.0375</td></tr>
      <tr><th>Mid-valued (V)</th><td>4.0375</td></tr>
      <tr class="section-header"><th colspan="2">Capacity</th></tr>
      <tr><th>Max tickets (K*)</th><td>4</td></tr>
      <tr><th>One-sided cap (X*)</th><td>4</td></tr>
      <tr><th>Ladder rungs (N)</th><td>5</td></tr>
      <tr><th>Layoff prob (λ)</th><td>0.2</td></tr>
      <tr class="section-header"><th colspan="2">Quotes</th></tr>
      <tr><th>Inside width (I)</th><td>0.06</td></tr>
      <tr><th>Midline p(x)</th><td>0.95</td></tr>
      <tr><th>Bid <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0.92</td></tr>
      <tr><th>Ask <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0.98</td></tr>
    </tbody>
  </table>
  
  <div class="inventory-list">
    <h4>Inventory (3 tickets)</h4>
    <ul>
      <li>D0 (issuer: issuer, face: 1, τ: 6)</li><li>D1 (issuer: issuer, face: 1, τ: 6)</li><li>SELL1 (issuer: issuer, face: 1, τ: 6)</li>
    </ul>
  </div>

</div>

<div class="dealer-card">
  <h3>Dealer: LONG</h3>
  <table class="params-table">
    <tbody>
      <tr class="section-header"><th colspan="2">Inventory</th></tr>
      <tr><th>Tickets (a)</th><td>0</td></tr>
      <tr><th>Face inventory (x)</th><td>0</td></tr>
      <tr><th>Cash (C)</th><td>0</td></tr>
      <tr><th>Mid-valued (V)</th><td>0</td></tr>
      <tr class="section-header"><th colspan="2">Capacity</th></tr>
      <tr><th>Max tickets (K*)</th><td>0</td></tr>
      <tr><th>One-sided cap (X*)</th><td>0</td></tr>
      <tr><th>Ladder rungs (N)</th><td>1</td></tr>
      <tr><th>Layoff prob (λ)</th><td>1</td></tr>
      <tr class="section-header"><th colspan="2">Quotes</th></tr>
      <tr><th>Inside width (I)</th><td>0</td></tr>
      <tr><th>Midline p(x)</th><td>0</td></tr>
      <tr><th>Bid <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0</td></tr>
      <tr><th>Ask <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0</td></tr>
    </tbody>
  </table>
  
</div>

    </div>
    <div class="dealers-grid">
      
<div class="dealer-card vbt-card">
  <h3>VBT: SHORT</h3>
  <table class="params-table">
    <tbody>
      <tr><th>Mid anchor (M)</th><td>1</td></tr>
      <tr><th>Spread anchor (O)</th><td>0.3</td></tr>
      <tr><th>Ask (A = M + O/2)</th><td>1.15</td></tr>
      <tr><th>Bid (B = M - O/2)</th><td>0.85</td></tr>
      <tr><th>Cash</th><td>0</td></tr>
      <tr><th>Inventory</th><td>0 tickets</td></tr>
    </tbody>
  </table>
</div>

<div class="dealer-card vbt-card">
  <h3>VBT: MID</h3>
  <table class="params-table">
    <tbody>
      <tr><th>Mid anchor (M)</th><td>1</td></tr>
      <tr><th>Spread anchor (O)</th><td>0.3</td></tr>
      <tr><th>Ask (A = M + O/2)</th><td>1.15</td></tr>
      <tr><th>Bid (B = M - O/2)</th><td>0.85</td></tr>
      <tr><th>Cash</th><td>10</td></tr>
      <tr><th>Inventory</th><td>0 tickets</td></tr>
    </tbody>
  </table>
</div>

<div class="dealer-card vbt-card">
  <h3>VBT: LONG</h3>
  <table class="params-table">
    <tbody>
      <tr><th>Mid anchor (M)</th><td>1</td></tr>
      <tr><th>Spread anchor (O)</th><td>0.3</td></tr>
      <tr><th>Ask (A = M + O/2)</th><td>1.15</td></tr>
      <tr><th>Bid (B = M - O/2)</th><td>0.85</td></tr>
      <tr><th>Cash</th><td>0</td></tr>
      <tr><th>Inventory</th><td>0 tickets</td></tr>
    </tbody>
  </table>
</div>

    </div>
  </div>

  
  <div class="balances-section">
    <h3>Trader Balances</h3>
    <div class="traders-grid">
      
<div class="t-account">
  <h3>issuer</h3>
  <div class="grid">
    <div class="assets-side">
      <h4>Assets (100)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">Cash</td>
        <td class="val">100</td>
      </tr>
    
      <tr>
        <td colspan="2" class="empty">No tickets owned</td>
      </tr>
        
        </tbody>
      </table>
    </div>
    <div class="liabilities-side">
      <h4>Liabilities (3)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">D0</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(to dealer_mid_6, mat=200)</span></td>
      </tr>
        
      <tr>
        <td class="name">D1</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(to dealer_mid_6, mat=200)</span></td>
      </tr>
        
      <tr>
        <td class="name">SELL1</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(to dealer_mid_6, mat=200)</span></td>
      </tr>
        
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="t-account">
  <h3>seller</h3>
  <div class="grid">
    <div class="assets-side">
      <h4>Assets (0.93)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">Cash</td>
        <td class="val">0.93</td>
      </tr>
    
      <tr>
        <td colspan="2" class="empty">No tickets owned</td>
      </tr>
        
        </tbody>
      </table>
    </div>
    <div class="liabilities-side">
      <h4>Liabilities (0)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td colspan="2" class="empty">No obligations</td>
      </tr>
        
        </tbody>
      </table>
    </div>
  </div>
</div>

    </div>
  </div>

</section>

    </main>

    <footer>
      Generated by bilancio dealer ring simulation
    </footer>
  </div>
</body>
</html>



################################################################################
# FILE: example13_report.html
# PATH: examples/dealer_ring/out/example13_report.html
################################################################################

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Example 13: Event-Loop Harness</title>
  <style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;line-height:1.6;color:#333;background:#f5f5f5}
.container{max-width:1400px;margin:0 auto;padding:20px}
header{background:#fff;border-radius:8px;padding:24px;margin-bottom:24px;box-shadow:0 2px 4px rgba(0,0,0,0.1)}
h1{color:#2563eb;font-size:28px;margin-bottom:8px}
h2{color:#475569;font-size:20px;margin-bottom:16px}
h3{color:#334155;font-size:18px;margin-bottom:12px}
h4{color:#475569;font-size:16px;margin:8px 0;font-weight:600}
.description{color:#64748b;font-style:italic;margin-bottom:16px}
.meta{display:flex;gap:24px;color:#64748b;font-size:14px}
.meta span{display:inline-block}
.t-account{background:#fff;border-radius:8px;padding:20px;margin-bottom:20px;box-shadow:0 2px 4px rgba(0,0,0,0.1)}
.t-account .grid{display:grid;grid-template-columns:1fr 1fr;gap:20px}
.t-account table.side{width:100%;border-collapse:collapse;font-size:14px}
.t-account th,.t-account td{border-bottom:1px solid #e5e7eb;border-right:1px solid #eef2f7;padding:8px;text-align:left}
.t-account th:last-child,.t-account td:last-child{border-right:none}
.t-account tbody tr:nth-child(even){background:#fafafa}
.t-account th{background:#f9fafb;font-weight:600;color:#374151}
.t-account td.qty,.t-account td.val,.t-account td.mat{text-align:right;white-space:nowrap}
.t-account td.name{font-weight:500}
.t-account td.empty{text-align:center;color:#9ca3af}
.assets-side h4{color:#16a34a}
.liabilities-side h4{color:#dc2626}
.events-table{background:#fff;border-radius:8px;padding:20px;margin-bottom:24px;box-shadow:0 2px 4px rgba(0,0,0,0.1)}
.events-table table{width:100%;border-collapse:collapse;font-size:14px}
.events-table th,.events-table td{border-bottom:1px solid #e5e7eb;border-right:1px solid #eef2f7;padding:8px;text-align:left}
.events-table th:last-child,.events-table td:last-child{border-right:none}
.events-table tbody tr:nth-child(even){background:#f7f9fc}
.events-table th{background:#f9fafb;font-weight:600;color:#374151}
.events-table td.qty,.events-table td.amount{text-align:center;white-space:nowrap}
.events-table td.event-kind{font-weight:500;color:#3b82f6}
.events-table td.notes{font-size:13px;color:#64748b}
.agents>h2{margin-bottom:20px;padding:0 20px}
.day-section{margin-bottom:40px;padding-bottom:40px;border-bottom:2px solid #e5e7eb}
.day-section:last-child{border-bottom:none}
.day-header{color:#1f2937;font-size:24px;margin-bottom:24px;padding:12px 0;border-bottom:1px solid #e5e7eb}
.events-section{margin-bottom:24px}
.balances-section{margin-top:24px}
.balances-section>h3{margin-bottom:20px;color:#374151;font-size:20px}
footer{text-align:center;color:#9ca3af;font-size:14px;margin-top:40px;padding:20px}
@media (max-width:768px){.t-account .grid{grid-template-columns:1fr}.meta{flex-direction:column;gap:8px}}



/* Dealer card styling */
.dealer-card {
  background: #fff;
  border-radius: 8px;
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.dealer-card h3 {
  color: #1e40af;
  margin-bottom: 16px;
  border-bottom: 2px solid #dbeafe;
  padding-bottom: 8px;
}
.params-table {
  width: 100%;
  border-collapse: collapse;
}
.params-table th {
  text-align: left;
  padding: 6px 12px;
  color: #64748b;
  font-weight: 500;
  width: 40%;
}
.params-table td {
  text-align: right;
  padding: 6px 12px;
  font-family: 'SF Mono', Monaco, monospace;
  color: #1f2937;
}
.params-table tr.section-header th {
  color: #374151;
  font-weight: 600;
  padding-top: 12px;
  border-bottom: 1px solid #e5e7eb;
}
/* VBT card */
.vbt-card {
  background: linear-gradient(135deg, #f0fdf4, #fff);
  border-left: 4px solid #16a34a;
}
.vbt-card h3 {
  color: #16a34a;
  border-bottom-color: #bbf7d0;
}
/* Event type colors */
.event-trade { color: #3b82f6; }
.event-passthrough { color: #8b5cf6; }
.event-rebucket { color: #f59e0b; }
.event-settlement { color: #16a34a; }
.event-default { color: #dc2626; }
.event-quote { color: #64748b; }
.event-vbt-anchor-update { color: #14b8a6; }
/* Pin indicators */
.pin-indicator {
  display: inline-block;
  width: 8px;
  height: 8px;
  border-radius: 50%;
  margin-left: 4px;
}
.pin-indicator.pinned { background: #f59e0b; }
.pin-indicator.not-pinned { background: #d1d5db; }
/* Grid layouts */
.dealers-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 20px;
  margin-bottom: 24px;
}
.traders-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
  gap: 20px;
}
/* Inventory list */
.inventory-list {
  margin-top: 12px;
  padding-top: 12px;
  border-top: 1px solid #e5e7eb;
}
.inventory-list h4 {
  color: #64748b;
  font-size: 14px;
  margin-bottom: 8px;
}
.inventory-list ul {
  list-style: none;
  padding: 0;
  margin: 0;
  font-size: 13px;
}
.inventory-list li {
  padding: 4px 0;
  color: #4b5563;
  font-family: 'SF Mono', Monaco, monospace;
}

  </style>
</head>
<body>
  <div class="container">
    
<header>
  <h1>Example 13: Event-Loop Harness</h1>
  <p class="description">Eligibility sets, fallback, and no-feasible retention</p>
  <div class="meta">
    <span><strong>Days:</strong> 1</span>
    <span><strong>Buckets:</strong> short, mid, long</span>
    <span><strong>Traders:</strong> 4</span>
    <span><strong>Tickets:</strong> 6</span>
    <span><strong>Ticket Size (S):</strong> 1</span>
  </div>
</header>


    <main>
      
<section class="day-section">
  <h2 class="day-header">🏁 Day 0 (Setup)</h2>

  
<div class="events-table">
  <h3>Day 0 (Setup) Events</h3>
  <p style="color: #9ca3af; font-style: italic;">No events for this day</p>
</div>


  <div class="balances-section">
    <h3>Market State</h3>
    <div class="dealers-grid">
      
<div class="dealer-card">
  <h3>Dealer: SHORT</h3>
  <table class="params-table">
    <tbody>
      <tr class="section-header"><th colspan="2">Inventory</th></tr>
      <tr><th>Tickets (a)</th><td>0</td></tr>
      <tr><th>Face inventory (x)</th><td>0</td></tr>
      <tr><th>Cash (C)</th><td>0</td></tr>
      <tr><th>Mid-valued (V)</th><td>0</td></tr>
      <tr class="section-header"><th colspan="2">Capacity</th></tr>
      <tr><th>Max tickets (K*)</th><td>0</td></tr>
      <tr><th>One-sided cap (X*)</th><td>0</td></tr>
      <tr><th>Ladder rungs (N)</th><td>1</td></tr>
      <tr><th>Layoff prob (λ)</th><td>1</td></tr>
      <tr class="section-header"><th colspan="2">Quotes</th></tr>
      <tr><th>Inside width (I)</th><td>0</td></tr>
      <tr><th>Midline p(x)</th><td>0</td></tr>
      <tr><th>Bid <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0</td></tr>
      <tr><th>Ask <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0</td></tr>
    </tbody>
  </table>
  
</div>

<div class="dealer-card">
  <h3>Dealer: MID</h3>
  <table class="params-table">
    <tbody>
      <tr class="section-header"><th colspan="2">Inventory</th></tr>
      <tr><th>Tickets (a)</th><td>2</td></tr>
      <tr><th>Face inventory (x)</th><td>2</td></tr>
      <tr><th>Cash (C)</th><td>2</td></tr>
      <tr><th>Mid-valued (V)</th><td>4</td></tr>
      <tr class="section-header"><th colspan="2">Capacity</th></tr>
      <tr><th>Max tickets (K*)</th><td>4</td></tr>
      <tr><th>One-sided cap (X*)</th><td>4</td></tr>
      <tr><th>Ladder rungs (N)</th><td>5</td></tr>
      <tr><th>Layoff prob (λ)</th><td>0.2</td></tr>
      <tr class="section-header"><th colspan="2">Quotes</th></tr>
      <tr><th>Inside width (I)</th><td>0.06</td></tr>
      <tr><th>Midline p(x)</th><td>1</td></tr>
      <tr><th>Bid <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0.97</td></tr>
      <tr><th>Ask <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>1.03</td></tr>
    </tbody>
  </table>
  
  <div class="inventory-list">
    <h4>Inventory (2 tickets)</h4>
    <ul>
      <li>D0 (issuer: issuer, face: 1, τ: 6)</li><li>D1 (issuer: issuer, face: 1, τ: 6)</li>
    </ul>
  </div>

</div>

<div class="dealer-card">
  <h3>Dealer: LONG</h3>
  <table class="params-table">
    <tbody>
      <tr class="section-header"><th colspan="2">Inventory</th></tr>
      <tr><th>Tickets (a)</th><td>0</td></tr>
      <tr><th>Face inventory (x)</th><td>0</td></tr>
      <tr><th>Cash (C)</th><td>0</td></tr>
      <tr><th>Mid-valued (V)</th><td>0</td></tr>
      <tr class="section-header"><th colspan="2">Capacity</th></tr>
      <tr><th>Max tickets (K*)</th><td>0</td></tr>
      <tr><th>One-sided cap (X*)</th><td>0</td></tr>
      <tr><th>Ladder rungs (N)</th><td>1</td></tr>
      <tr><th>Layoff prob (λ)</th><td>1</td></tr>
      <tr class="section-header"><th colspan="2">Quotes</th></tr>
      <tr><th>Inside width (I)</th><td>0</td></tr>
      <tr><th>Midline p(x)</th><td>0</td></tr>
      <tr><th>Bid <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0</td></tr>
      <tr><th>Ask <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0</td></tr>
    </tbody>
  </table>
  
</div>

    </div>
    <div class="dealers-grid">
      
<div class="dealer-card vbt-card">
  <h3>VBT: SHORT</h3>
  <table class="params-table">
    <tbody>
      <tr><th>Mid anchor (M)</th><td>1</td></tr>
      <tr><th>Spread anchor (O)</th><td>0.3</td></tr>
      <tr><th>Ask (A = M + O/2)</th><td>1.15</td></tr>
      <tr><th>Bid (B = M - O/2)</th><td>0.85</td></tr>
      <tr><th>Cash</th><td>0</td></tr>
      <tr><th>Inventory</th><td>0 tickets</td></tr>
    </tbody>
  </table>
</div>

<div class="dealer-card vbt-card">
  <h3>VBT: MID</h3>
  <table class="params-table">
    <tbody>
      <tr><th>Mid anchor (M)</th><td>1</td></tr>
      <tr><th>Spread anchor (O)</th><td>0.3</td></tr>
      <tr><th>Ask (A = M + O/2)</th><td>1.15</td></tr>
      <tr><th>Bid (B = M - O/2)</th><td>0.85</td></tr>
      <tr><th>Cash</th><td>10</td></tr>
      <tr><th>Inventory</th><td>3 tickets</td></tr>
    </tbody>
  </table>
</div>

<div class="dealer-card vbt-card">
  <h3>VBT: LONG</h3>
  <table class="params-table">
    <tbody>
      <tr><th>Mid anchor (M)</th><td>1</td></tr>
      <tr><th>Spread anchor (O)</th><td>0.3</td></tr>
      <tr><th>Ask (A = M + O/2)</th><td>1.15</td></tr>
      <tr><th>Bid (B = M - O/2)</th><td>0.85</td></tr>
      <tr><th>Cash</th><td>0</td></tr>
      <tr><th>Inventory</th><td>0 tickets</td></tr>
    </tbody>
  </table>
</div>

    </div>
  </div>

  
  <div class="balances-section">
    <h3>Trader Balances</h3>
    <div class="traders-grid">
      
<div class="t-account">
  <h3>B_1</h3>
  <div class="grid">
    <div class="assets-side">
      <h4>Assets (2)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">Cash</td>
        <td class="val">2</td>
      </tr>
    
      <tr>
        <td colspan="2" class="empty">No tickets owned</td>
      </tr>
        
        </tbody>
      </table>
    </div>
    <div class="liabilities-side">
      <h4>Liabilities (0)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td colspan="2" class="empty">No obligations</td>
      </tr>
        
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="t-account">
  <h3>B_2</h3>
  <div class="grid">
    <div class="assets-side">
      <h4>Assets (0.9)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">Cash</td>
        <td class="val">0.9</td>
      </tr>
    
      <tr>
        <td colspan="2" class="empty">No tickets owned</td>
      </tr>
        
        </tbody>
      </table>
    </div>
    <div class="liabilities-side">
      <h4>Liabilities (0)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td colspan="2" class="empty">No obligations</td>
      </tr>
        
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="t-account">
  <h3>S_1</h3>
  <div class="grid">
    <div class="assets-side">
      <h4>Assets (1.5)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">Cash</td>
        <td class="val">0.5</td>
      </tr>
    
      <tr>
        <td class="name">S1_T</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(issuer, τ=6)</span></td>
      </tr>
        
        </tbody>
      </table>
    </div>
    <div class="liabilities-side">
      <h4>Liabilities (0)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td colspan="2" class="empty">No obligations</td>
      </tr>
        
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="t-account">
  <h3>issuer</h3>
  <div class="grid">
    <div class="assets-side">
      <h4>Assets (100)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">Cash</td>
        <td class="val">100</td>
      </tr>
    
      <tr>
        <td colspan="2" class="empty">No tickets owned</td>
      </tr>
        
        </tbody>
      </table>
    </div>
    <div class="liabilities-side">
      <h4>Liabilities (3)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">S1_T</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(to S_1, mat=200)</span></td>
      </tr>
        
      <tr>
        <td class="name">D0</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(to dealer_mid_6, mat=200)</span></td>
      </tr>
        
      <tr>
        <td class="name">D1</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(to dealer_mid_6, mat=200)</span></td>
      </tr>
        
        </tbody>
      </table>
    </div>
  </div>
</div>

    </div>
  </div>

</section>

<section class="day-section">
  <h2 class="day-header">📅 Day 1</h2>

  
<div class="events-table">
  <h3>Day 1 Events</h3>
  <table>
    <thead>
      <tr>
        <th style="width: 120px;">Kind</th>
        <th>Details</th>
        <th style="width: 200px;">Notes</th>
      </tr>
    </thead>
    <tbody>
      
          <tr>
            <td class="event-quote">quote</td>
            <td>[mid] D: 0.97/1.03, VBT: 0.85/1.15</td>
            <td class="notes">inv=2, cap=4</td>
          </tr>
        
    </tbody>
  </table>
</div>


  <div class="balances-section">
    <h3>Market State</h3>
    <div class="dealers-grid">
      
<div class="dealer-card">
  <h3>Dealer: SHORT</h3>
  <table class="params-table">
    <tbody>
      <tr class="section-header"><th colspan="2">Inventory</th></tr>
      <tr><th>Tickets (a)</th><td>0</td></tr>
      <tr><th>Face inventory (x)</th><td>0</td></tr>
      <tr><th>Cash (C)</th><td>0</td></tr>
      <tr><th>Mid-valued (V)</th><td>0</td></tr>
      <tr class="section-header"><th colspan="2">Capacity</th></tr>
      <tr><th>Max tickets (K*)</th><td>0</td></tr>
      <tr><th>One-sided cap (X*)</th><td>0</td></tr>
      <tr><th>Ladder rungs (N)</th><td>1</td></tr>
      <tr><th>Layoff prob (λ)</th><td>1</td></tr>
      <tr class="section-header"><th colspan="2">Quotes</th></tr>
      <tr><th>Inside width (I)</th><td>0</td></tr>
      <tr><th>Midline p(x)</th><td>0</td></tr>
      <tr><th>Bid <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0</td></tr>
      <tr><th>Ask <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0</td></tr>
    </tbody>
  </table>
  
</div>

<div class="dealer-card">
  <h3>Dealer: MID</h3>
  <table class="params-table">
    <tbody>
      <tr class="section-header"><th colspan="2">Inventory</th></tr>
      <tr><th>Tickets (a)</th><td>2</td></tr>
      <tr><th>Face inventory (x)</th><td>2</td></tr>
      <tr><th>Cash (C)</th><td>2.01</td></tr>
      <tr><th>Mid-valued (V)</th><td>4.01</td></tr>
      <tr class="section-header"><th colspan="2">Capacity</th></tr>
      <tr><th>Max tickets (K*)</th><td>4</td></tr>
      <tr><th>One-sided cap (X*)</th><td>4</td></tr>
      <tr><th>Ladder rungs (N)</th><td>5</td></tr>
      <tr><th>Layoff prob (λ)</th><td>0.2</td></tr>
      <tr class="section-header"><th colspan="2">Quotes</th></tr>
      <tr><th>Inside width (I)</th><td>0.06</td></tr>
      <tr><th>Midline p(x)</th><td>1</td></tr>
      <tr><th>Bid <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0.97</td></tr>
      <tr><th>Ask <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>1.03</td></tr>
    </tbody>
  </table>
  
  <div class="inventory-list">
    <h4>Inventory (2 tickets)</h4>
    <ul>
      <li>D0 (issuer: issuer, face: 1, τ: 6)</li><li>D1 (issuer: issuer, face: 1, τ: 6)</li>
    </ul>
  </div>

</div>

<div class="dealer-card">
  <h3>Dealer: LONG</h3>
  <table class="params-table">
    <tbody>
      <tr class="section-header"><th colspan="2">Inventory</th></tr>
      <tr><th>Tickets (a)</th><td>0</td></tr>
      <tr><th>Face inventory (x)</th><td>0</td></tr>
      <tr><th>Cash (C)</th><td>0</td></tr>
      <tr><th>Mid-valued (V)</th><td>0</td></tr>
      <tr class="section-header"><th colspan="2">Capacity</th></tr>
      <tr><th>Max tickets (K*)</th><td>0</td></tr>
      <tr><th>One-sided cap (X*)</th><td>0</td></tr>
      <tr><th>Ladder rungs (N)</th><td>1</td></tr>
      <tr><th>Layoff prob (λ)</th><td>1</td></tr>
      <tr class="section-header"><th colspan="2">Quotes</th></tr>
      <tr><th>Inside width (I)</th><td>0</td></tr>
      <tr><th>Midline p(x)</th><td>0</td></tr>
      <tr><th>Bid <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0</td></tr>
      <tr><th>Ask <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0</td></tr>
    </tbody>
  </table>
  
</div>

    </div>
    <div class="dealers-grid">
      
<div class="dealer-card vbt-card">
  <h3>VBT: SHORT</h3>
  <table class="params-table">
    <tbody>
      <tr><th>Mid anchor (M)</th><td>1</td></tr>
      <tr><th>Spread anchor (O)</th><td>0.3</td></tr>
      <tr><th>Ask (A = M + O/2)</th><td>1.15</td></tr>
      <tr><th>Bid (B = M - O/2)</th><td>0.85</td></tr>
      <tr><th>Cash</th><td>0</td></tr>
      <tr><th>Inventory</th><td>0 tickets</td></tr>
    </tbody>
  </table>
</div>

<div class="dealer-card vbt-card">
  <h3>VBT: MID</h3>
  <table class="params-table">
    <tbody>
      <tr><th>Mid anchor (M)</th><td>1</td></tr>
      <tr><th>Spread anchor (O)</th><td>0.3</td></tr>
      <tr><th>Ask (A = M + O/2)</th><td>1.15</td></tr>
      <tr><th>Bid (B = M - O/2)</th><td>0.85</td></tr>
      <tr><th>Cash</th><td>10</td></tr>
      <tr><th>Inventory</th><td>3 tickets</td></tr>
    </tbody>
  </table>
</div>

<div class="dealer-card vbt-card">
  <h3>VBT: LONG</h3>
  <table class="params-table">
    <tbody>
      <tr><th>Mid anchor (M)</th><td>1</td></tr>
      <tr><th>Spread anchor (O)</th><td>0.3</td></tr>
      <tr><th>Ask (A = M + O/2)</th><td>1.15</td></tr>
      <tr><th>Bid (B = M - O/2)</th><td>0.85</td></tr>
      <tr><th>Cash</th><td>0</td></tr>
      <tr><th>Inventory</th><td>0 tickets</td></tr>
    </tbody>
  </table>
</div>

    </div>
  </div>

  
  <div class="balances-section">
    <h3>Trader Balances</h3>
    <div class="traders-grid">
      
<div class="t-account">
  <h3>B_1</h3>
  <div class="grid">
    <div class="assets-side">
      <h4>Assets (2.02)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">Cash</td>
        <td class="val">1.02</td>
      </tr>
    
      <tr>
        <td class="name">S1_T</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(issuer, τ=6)</span></td>
      </tr>
        
        </tbody>
      </table>
    </div>
    <div class="liabilities-side">
      <h4>Liabilities (0)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td colspan="2" class="empty">No obligations</td>
      </tr>
        
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="t-account">
  <h3>B_2</h3>
  <div class="grid">
    <div class="assets-side">
      <h4>Assets (0.9)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">Cash</td>
        <td class="val">0.9</td>
      </tr>
    
      <tr>
        <td colspan="2" class="empty">No tickets owned</td>
      </tr>
        
        </tbody>
      </table>
    </div>
    <div class="liabilities-side">
      <h4>Liabilities (0)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td colspan="2" class="empty">No obligations</td>
      </tr>
        
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="t-account">
  <h3>S_1</h3>
  <div class="grid">
    <div class="assets-side">
      <h4>Assets (1.47)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">Cash</td>
        <td class="val">1.47</td>
      </tr>
    
      <tr>
        <td colspan="2" class="empty">No tickets owned</td>
      </tr>
        
        </tbody>
      </table>
    </div>
    <div class="liabilities-side">
      <h4>Liabilities (0)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td colspan="2" class="empty">No obligations</td>
      </tr>
        
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="t-account">
  <h3>issuer</h3>
  <div class="grid">
    <div class="assets-side">
      <h4>Assets (100)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">Cash</td>
        <td class="val">100</td>
      </tr>
    
      <tr>
        <td colspan="2" class="empty">No tickets owned</td>
      </tr>
        
        </tbody>
      </table>
    </div>
    <div class="liabilities-side">
      <h4>Liabilities (3)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">S1_T</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(to B_1, mat=200)</span></td>
      </tr>
        
      <tr>
        <td class="name">D0</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(to dealer_mid_6, mat=200)</span></td>
      </tr>
        
      <tr>
        <td class="name">D1</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(to dealer_mid_6, mat=200)</span></td>
      </tr>
        
        </tbody>
      </table>
    </div>
  </div>
</div>

    </div>
  </div>

</section>

    </main>

    <footer>
      Generated by bilancio dealer ring simulation
    </footer>
  </div>
</body>
</html>



################################################################################
# FILE: example14_report.html
# PATH: examples/dealer_ring/out/example14_report.html
################################################################################

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Example 14: Ticket-Level Transfer</title>
  <style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;line-height:1.6;color:#333;background:#f5f5f5}
.container{max-width:1400px;margin:0 auto;padding:20px}
header{background:#fff;border-radius:8px;padding:24px;margin-bottom:24px;box-shadow:0 2px 4px rgba(0,0,0,0.1)}
h1{color:#2563eb;font-size:28px;margin-bottom:8px}
h2{color:#475569;font-size:20px;margin-bottom:16px}
h3{color:#334155;font-size:18px;margin-bottom:12px}
h4{color:#475569;font-size:16px;margin:8px 0;font-weight:600}
.description{color:#64748b;font-style:italic;margin-bottom:16px}
.meta{display:flex;gap:24px;color:#64748b;font-size:14px}
.meta span{display:inline-block}
.t-account{background:#fff;border-radius:8px;padding:20px;margin-bottom:20px;box-shadow:0 2px 4px rgba(0,0,0,0.1)}
.t-account .grid{display:grid;grid-template-columns:1fr 1fr;gap:20px}
.t-account table.side{width:100%;border-collapse:collapse;font-size:14px}
.t-account th,.t-account td{border-bottom:1px solid #e5e7eb;border-right:1px solid #eef2f7;padding:8px;text-align:left}
.t-account th:last-child,.t-account td:last-child{border-right:none}
.t-account tbody tr:nth-child(even){background:#fafafa}
.t-account th{background:#f9fafb;font-weight:600;color:#374151}
.t-account td.qty,.t-account td.val,.t-account td.mat{text-align:right;white-space:nowrap}
.t-account td.name{font-weight:500}
.t-account td.empty{text-align:center;color:#9ca3af}
.assets-side h4{color:#16a34a}
.liabilities-side h4{color:#dc2626}
.events-table{background:#fff;border-radius:8px;padding:20px;margin-bottom:24px;box-shadow:0 2px 4px rgba(0,0,0,0.1)}
.events-table table{width:100%;border-collapse:collapse;font-size:14px}
.events-table th,.events-table td{border-bottom:1px solid #e5e7eb;border-right:1px solid #eef2f7;padding:8px;text-align:left}
.events-table th:last-child,.events-table td:last-child{border-right:none}
.events-table tbody tr:nth-child(even){background:#f7f9fc}
.events-table th{background:#f9fafb;font-weight:600;color:#374151}
.events-table td.qty,.events-table td.amount{text-align:center;white-space:nowrap}
.events-table td.event-kind{font-weight:500;color:#3b82f6}
.events-table td.notes{font-size:13px;color:#64748b}
.agents>h2{margin-bottom:20px;padding:0 20px}
.day-section{margin-bottom:40px;padding-bottom:40px;border-bottom:2px solid #e5e7eb}
.day-section:last-child{border-bottom:none}
.day-header{color:#1f2937;font-size:24px;margin-bottom:24px;padding:12px 0;border-bottom:1px solid #e5e7eb}
.events-section{margin-bottom:24px}
.balances-section{margin-top:24px}
.balances-section>h3{margin-bottom:20px;color:#374151;font-size:20px}
footer{text-align:center;color:#9ca3af;font-size:14px;margin-top:40px;padding:20px}
@media (max-width:768px){.t-account .grid{grid-template-columns:1fr}.meta{flex-direction:column;gap:8px}}



/* Dealer card styling */
.dealer-card {
  background: #fff;
  border-radius: 8px;
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.dealer-card h3 {
  color: #1e40af;
  margin-bottom: 16px;
  border-bottom: 2px solid #dbeafe;
  padding-bottom: 8px;
}
.params-table {
  width: 100%;
  border-collapse: collapse;
}
.params-table th {
  text-align: left;
  padding: 6px 12px;
  color: #64748b;
  font-weight: 500;
  width: 40%;
}
.params-table td {
  text-align: right;
  padding: 6px 12px;
  font-family: 'SF Mono', Monaco, monospace;
  color: #1f2937;
}
.params-table tr.section-header th {
  color: #374151;
  font-weight: 600;
  padding-top: 12px;
  border-bottom: 1px solid #e5e7eb;
}
/* VBT card */
.vbt-card {
  background: linear-gradient(135deg, #f0fdf4, #fff);
  border-left: 4px solid #16a34a;
}
.vbt-card h3 {
  color: #16a34a;
  border-bottom-color: #bbf7d0;
}
/* Event type colors */
.event-trade { color: #3b82f6; }
.event-passthrough { color: #8b5cf6; }
.event-rebucket { color: #f59e0b; }
.event-settlement { color: #16a34a; }
.event-default { color: #dc2626; }
.event-quote { color: #64748b; }
.event-vbt-anchor-update { color: #14b8a6; }
/* Pin indicators */
.pin-indicator {
  display: inline-block;
  width: 8px;
  height: 8px;
  border-radius: 50%;
  margin-left: 4px;
}
.pin-indicator.pinned { background: #f59e0b; }
.pin-indicator.not-pinned { background: #d1d5db; }
/* Grid layouts */
.dealers-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 20px;
  margin-bottom: 24px;
}
.traders-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
  gap: 20px;
}
/* Inventory list */
.inventory-list {
  margin-top: 12px;
  padding-top: 12px;
  border-top: 1px solid #e5e7eb;
}
.inventory-list h4 {
  color: #64748b;
  font-size: 14px;
  margin-bottom: 8px;
}
.inventory-list ul {
  list-style: none;
  padding: 0;
  margin: 0;
  font-size: 13px;
}
.inventory-list li {
  padding: 4px 0;
  color: #4b5563;
  font-family: 'SF Mono', Monaco, monospace;
}

  </style>
</head>
<body>
  <div class="container">
    
<header>
  <h1>Example 14: Ticket-Level Transfer</h1>
  <p class="description">No generic materialization - specific IDs transferred</p>
  <div class="meta">
    <span><strong>Days:</strong> 1</span>
    <span><strong>Buckets:</strong> short, mid, long</span>
    <span><strong>Traders:</strong> 3</span>
    <span><strong>Tickets:</strong> 2</span>
    <span><strong>Ticket Size (S):</strong> 1</span>
  </div>
</header>


    <main>
      
<section class="day-section">
  <h2 class="day-header">🏁 Day 0 (Setup)</h2>

  
<div class="events-table">
  <h3>Day 0 (Setup) Events</h3>
  <p style="color: #9ca3af; font-style: italic;">No events for this day</p>
</div>


  <div class="balances-section">
    <h3>Market State</h3>
    <div class="dealers-grid">
      
<div class="dealer-card">
  <h3>Dealer: SHORT</h3>
  <table class="params-table">
    <tbody>
      <tr class="section-header"><th colspan="2">Inventory</th></tr>
      <tr><th>Tickets (a)</th><td>0</td></tr>
      <tr><th>Face inventory (x)</th><td>0</td></tr>
      <tr><th>Cash (C)</th><td>0</td></tr>
      <tr><th>Mid-valued (V)</th><td>0</td></tr>
      <tr class="section-header"><th colspan="2">Capacity</th></tr>
      <tr><th>Max tickets (K*)</th><td>0</td></tr>
      <tr><th>One-sided cap (X*)</th><td>0</td></tr>
      <tr><th>Ladder rungs (N)</th><td>1</td></tr>
      <tr><th>Layoff prob (λ)</th><td>1</td></tr>
      <tr class="section-header"><th colspan="2">Quotes</th></tr>
      <tr><th>Inside width (I)</th><td>0</td></tr>
      <tr><th>Midline p(x)</th><td>0</td></tr>
      <tr><th>Bid <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0</td></tr>
      <tr><th>Ask <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0</td></tr>
    </tbody>
  </table>
  
</div>

<div class="dealer-card">
  <h3>Dealer: MID</h3>
  <table class="params-table">
    <tbody>
      <tr class="section-header"><th colspan="2">Inventory</th></tr>
      <tr><th>Tickets (a)</th><td>2</td></tr>
      <tr><th>Face inventory (x)</th><td>2</td></tr>
      <tr><th>Cash (C)</th><td>2</td></tr>
      <tr><th>Mid-valued (V)</th><td>4</td></tr>
      <tr class="section-header"><th colspan="2">Capacity</th></tr>
      <tr><th>Max tickets (K*)</th><td>4</td></tr>
      <tr><th>One-sided cap (X*)</th><td>4</td></tr>
      <tr><th>Ladder rungs (N)</th><td>5</td></tr>
      <tr><th>Layoff prob (λ)</th><td>0.2</td></tr>
      <tr class="section-header"><th colspan="2">Quotes</th></tr>
      <tr><th>Inside width (I)</th><td>0.06</td></tr>
      <tr><th>Midline p(x)</th><td>1</td></tr>
      <tr><th>Bid <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0.97</td></tr>
      <tr><th>Ask <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>1.03</td></tr>
    </tbody>
  </table>
  
  <div class="inventory-list">
    <h4>Inventory (2 tickets)</h4>
    <ul>
      <li>k1 (issuer: I1, face: 1, τ: 6)</li><li>k2 (issuer: I2, face: 1, τ: 5)</li>
    </ul>
  </div>

</div>

<div class="dealer-card">
  <h3>Dealer: LONG</h3>
  <table class="params-table">
    <tbody>
      <tr class="section-header"><th colspan="2">Inventory</th></tr>
      <tr><th>Tickets (a)</th><td>0</td></tr>
      <tr><th>Face inventory (x)</th><td>0</td></tr>
      <tr><th>Cash (C)</th><td>0</td></tr>
      <tr><th>Mid-valued (V)</th><td>0</td></tr>
      <tr class="section-header"><th colspan="2">Capacity</th></tr>
      <tr><th>Max tickets (K*)</th><td>0</td></tr>
      <tr><th>One-sided cap (X*)</th><td>0</td></tr>
      <tr><th>Ladder rungs (N)</th><td>1</td></tr>
      <tr><th>Layoff prob (λ)</th><td>1</td></tr>
      <tr class="section-header"><th colspan="2">Quotes</th></tr>
      <tr><th>Inside width (I)</th><td>0</td></tr>
      <tr><th>Midline p(x)</th><td>0</td></tr>
      <tr><th>Bid <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0</td></tr>
      <tr><th>Ask <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0</td></tr>
    </tbody>
  </table>
  
</div>

    </div>
    <div class="dealers-grid">
      
<div class="dealer-card vbt-card">
  <h3>VBT: SHORT</h3>
  <table class="params-table">
    <tbody>
      <tr><th>Mid anchor (M)</th><td>1</td></tr>
      <tr><th>Spread anchor (O)</th><td>0.3</td></tr>
      <tr><th>Ask (A = M + O/2)</th><td>1.15</td></tr>
      <tr><th>Bid (B = M - O/2)</th><td>0.85</td></tr>
      <tr><th>Cash</th><td>0</td></tr>
      <tr><th>Inventory</th><td>0 tickets</td></tr>
    </tbody>
  </table>
</div>

<div class="dealer-card vbt-card">
  <h3>VBT: MID</h3>
  <table class="params-table">
    <tbody>
      <tr><th>Mid anchor (M)</th><td>1</td></tr>
      <tr><th>Spread anchor (O)</th><td>0.3</td></tr>
      <tr><th>Ask (A = M + O/2)</th><td>1.15</td></tr>
      <tr><th>Bid (B = M - O/2)</th><td>0.85</td></tr>
      <tr><th>Cash</th><td>10</td></tr>
      <tr><th>Inventory</th><td>0 tickets</td></tr>
    </tbody>
  </table>
</div>

<div class="dealer-card vbt-card">
  <h3>VBT: LONG</h3>
  <table class="params-table">
    <tbody>
      <tr><th>Mid anchor (M)</th><td>1</td></tr>
      <tr><th>Spread anchor (O)</th><td>0.3</td></tr>
      <tr><th>Ask (A = M + O/2)</th><td>1.15</td></tr>
      <tr><th>Bid (B = M - O/2)</th><td>0.85</td></tr>
      <tr><th>Cash</th><td>0</td></tr>
      <tr><th>Inventory</th><td>0 tickets</td></tr>
    </tbody>
  </table>
</div>

    </div>
  </div>

  
  <div class="balances-section">
    <h3>Trader Balances</h3>
    <div class="traders-grid">
      
<div class="t-account">
  <h3>I1</h3>
  <div class="grid">
    <div class="assets-side">
      <h4>Assets (100)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">Cash</td>
        <td class="val">100</td>
      </tr>
    
      <tr>
        <td colspan="2" class="empty">No tickets owned</td>
      </tr>
        
        </tbody>
      </table>
    </div>
    <div class="liabilities-side">
      <h4>Liabilities (1)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">k1</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(to dealer_mid_1, mat=6)</span></td>
      </tr>
        
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="t-account">
  <h3>I2</h3>
  <div class="grid">
    <div class="assets-side">
      <h4>Assets (100)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">Cash</td>
        <td class="val">100</td>
      </tr>
    
      <tr>
        <td colspan="2" class="empty">No tickets owned</td>
      </tr>
        
        </tbody>
      </table>
    </div>
    <div class="liabilities-side">
      <h4>Liabilities (1)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">k2</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(to dealer_mid_1, mat=5)</span></td>
      </tr>
        
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="t-account">
  <h3>buyer_B</h3>
  <div class="grid">
    <div class="assets-side">
      <h4>Assets (2)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">Cash</td>
        <td class="val">2</td>
      </tr>
    
      <tr>
        <td colspan="2" class="empty">No tickets owned</td>
      </tr>
        
        </tbody>
      </table>
    </div>
    <div class="liabilities-side">
      <h4>Liabilities (0)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td colspan="2" class="empty">No obligations</td>
      </tr>
        
        </tbody>
      </table>
    </div>
  </div>
</div>

    </div>
  </div>

</section>

<section class="day-section">
  <h2 class="day-header">📅 Day 1</h2>

  
<div class="events-table">
  <h3>Day 1 Events</h3>
  <table>
    <thead>
      <tr>
        <th style="width: 120px;">Kind</th>
        <th>Details</th>
        <th style="width: 200px;">Notes</th>
      </tr>
    </thead>
    <tbody>
      
          <tr>
            <td class="event-quote">quote</td>
            <td>[mid] D: 1.02/1.08, VBT: 0.85/1.15</td>
            <td class="notes">inv=1, cap=4</td>
          </tr>
        
    </tbody>
  </table>
</div>


  <div class="balances-section">
    <h3>Market State</h3>
    <div class="dealers-grid">
      
<div class="dealer-card">
  <h3>Dealer: SHORT</h3>
  <table class="params-table">
    <tbody>
      <tr class="section-header"><th colspan="2">Inventory</th></tr>
      <tr><th>Tickets (a)</th><td>0</td></tr>
      <tr><th>Face inventory (x)</th><td>0</td></tr>
      <tr><th>Cash (C)</th><td>0</td></tr>
      <tr><th>Mid-valued (V)</th><td>0</td></tr>
      <tr class="section-header"><th colspan="2">Capacity</th></tr>
      <tr><th>Max tickets (K*)</th><td>0</td></tr>
      <tr><th>One-sided cap (X*)</th><td>0</td></tr>
      <tr><th>Ladder rungs (N)</th><td>1</td></tr>
      <tr><th>Layoff prob (λ)</th><td>1</td></tr>
      <tr class="section-header"><th colspan="2">Quotes</th></tr>
      <tr><th>Inside width (I)</th><td>0</td></tr>
      <tr><th>Midline p(x)</th><td>0</td></tr>
      <tr><th>Bid <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0</td></tr>
      <tr><th>Ask <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0</td></tr>
    </tbody>
  </table>
  
</div>

<div class="dealer-card">
  <h3>Dealer: MID</h3>
  <table class="params-table">
    <tbody>
      <tr class="section-header"><th colspan="2">Inventory</th></tr>
      <tr><th>Tickets (a)</th><td>1</td></tr>
      <tr><th>Face inventory (x)</th><td>1</td></tr>
      <tr><th>Cash (C)</th><td>3.03</td></tr>
      <tr><th>Mid-valued (V)</th><td>4.03</td></tr>
      <tr class="section-header"><th colspan="2">Capacity</th></tr>
      <tr><th>Max tickets (K*)</th><td>4</td></tr>
      <tr><th>One-sided cap (X*)</th><td>4</td></tr>
      <tr><th>Ladder rungs (N)</th><td>5</td></tr>
      <tr><th>Layoff prob (λ)</th><td>0.2</td></tr>
      <tr class="section-header"><th colspan="2">Quotes</th></tr>
      <tr><th>Inside width (I)</th><td>0.06</td></tr>
      <tr><th>Midline p(x)</th><td>1.05</td></tr>
      <tr><th>Bid <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>1.02</td></tr>
      <tr><th>Ask <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>1.08</td></tr>
    </tbody>
  </table>
  
  <div class="inventory-list">
    <h4>Inventory (1 tickets)</h4>
    <ul>
      <li>k1 (issuer: I1, face: 1, τ: 6)</li>
    </ul>
  </div>

</div>

<div class="dealer-card">
  <h3>Dealer: LONG</h3>
  <table class="params-table">
    <tbody>
      <tr class="section-header"><th colspan="2">Inventory</th></tr>
      <tr><th>Tickets (a)</th><td>0</td></tr>
      <tr><th>Face inventory (x)</th><td>0</td></tr>
      <tr><th>Cash (C)</th><td>0</td></tr>
      <tr><th>Mid-valued (V)</th><td>0</td></tr>
      <tr class="section-header"><th colspan="2">Capacity</th></tr>
      <tr><th>Max tickets (K*)</th><td>0</td></tr>
      <tr><th>One-sided cap (X*)</th><td>0</td></tr>
      <tr><th>Ladder rungs (N)</th><td>1</td></tr>
      <tr><th>Layoff prob (λ)</th><td>1</td></tr>
      <tr class="section-header"><th colspan="2">Quotes</th></tr>
      <tr><th>Inside width (I)</th><td>0</td></tr>
      <tr><th>Midline p(x)</th><td>0</td></tr>
      <tr><th>Bid <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0</td></tr>
      <tr><th>Ask <span class="pin-indicator not-pinned" title="Not pinned"></span></th><td>0</td></tr>
    </tbody>
  </table>
  
</div>

    </div>
    <div class="dealers-grid">
      
<div class="dealer-card vbt-card">
  <h3>VBT: SHORT</h3>
  <table class="params-table">
    <tbody>
      <tr><th>Mid anchor (M)</th><td>1</td></tr>
      <tr><th>Spread anchor (O)</th><td>0.3</td></tr>
      <tr><th>Ask (A = M + O/2)</th><td>1.15</td></tr>
      <tr><th>Bid (B = M - O/2)</th><td>0.85</td></tr>
      <tr><th>Cash</th><td>0</td></tr>
      <tr><th>Inventory</th><td>0 tickets</td></tr>
    </tbody>
  </table>
</div>

<div class="dealer-card vbt-card">
  <h3>VBT: MID</h3>
  <table class="params-table">
    <tbody>
      <tr><th>Mid anchor (M)</th><td>1</td></tr>
      <tr><th>Spread anchor (O)</th><td>0.3</td></tr>
      <tr><th>Ask (A = M + O/2)</th><td>1.15</td></tr>
      <tr><th>Bid (B = M - O/2)</th><td>0.85</td></tr>
      <tr><th>Cash</th><td>10</td></tr>
      <tr><th>Inventory</th><td>0 tickets</td></tr>
    </tbody>
  </table>
</div>

<div class="dealer-card vbt-card">
  <h3>VBT: LONG</h3>
  <table class="params-table">
    <tbody>
      <tr><th>Mid anchor (M)</th><td>1</td></tr>
      <tr><th>Spread anchor (O)</th><td>0.3</td></tr>
      <tr><th>Ask (A = M + O/2)</th><td>1.15</td></tr>
      <tr><th>Bid (B = M - O/2)</th><td>0.85</td></tr>
      <tr><th>Cash</th><td>0</td></tr>
      <tr><th>Inventory</th><td>0 tickets</td></tr>
    </tbody>
  </table>
</div>

    </div>
  </div>

  
  <div class="balances-section">
    <h3>Trader Balances</h3>
    <div class="traders-grid">
      
<div class="t-account">
  <h3>I1</h3>
  <div class="grid">
    <div class="assets-side">
      <h4>Assets (100)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">Cash</td>
        <td class="val">100</td>
      </tr>
    
      <tr>
        <td colspan="2" class="empty">No tickets owned</td>
      </tr>
        
        </tbody>
      </table>
    </div>
    <div class="liabilities-side">
      <h4>Liabilities (1)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">k1</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(to dealer_mid_1, mat=6)</span></td>
      </tr>
        
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="t-account">
  <h3>I2</h3>
  <div class="grid">
    <div class="assets-side">
      <h4>Assets (100)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">Cash</td>
        <td class="val">100</td>
      </tr>
    
      <tr>
        <td colspan="2" class="empty">No tickets owned</td>
      </tr>
        
        </tbody>
      </table>
    </div>
    <div class="liabilities-side">
      <h4>Liabilities (1)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">k2</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(to buyer_B, mat=5)</span></td>
      </tr>
        
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="t-account">
  <h3>buyer_B</h3>
  <div class="grid">
    <div class="assets-side">
      <h4>Assets (1.97)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td class="name">Cash</td>
        <td class="val">0.97</td>
      </tr>
    
      <tr>
        <td class="name">k2</td>
        <td class="val">1 <span style="color: #9ca3af; font-size: 12px;">(I2, τ=5)</span></td>
      </tr>
        
        </tbody>
      </table>
    </div>
    <div class="liabilities-side">
      <h4>Liabilities (0)</h4>
      <table class="side">
        <tbody>
          
      <tr>
        <td colspan="2" class="empty">No obligations</td>
      </tr>
        
        </tbody>
      </table>
    </div>
  </div>
</div>

    </div>
  </div>

</section>

    </main>

    <footer>
      Generated by bilancio dealer ring simulation
    </footer>
  </div>
</body>
</html>


